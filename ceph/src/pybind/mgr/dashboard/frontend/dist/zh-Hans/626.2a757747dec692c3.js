"use strict";(self.webpackChunkceph_dashboard=self.webpackChunkceph_dashboard||[]).push([[626],{40626:(ut,Me,m)=>{m.r(Me),m.d(Me,{BlockModule:()=>io,RoutedBlockModule:()=>Hc});var d=m(56610),l=m(37222),p=m(19102),A=m(95819),ue=m(13421),F=m(54372),ie=m(1811),q=m(6955),Ce=m(93887),X=m(36651),f=m.n(X),J=m(35629),Oe=m(53026),Ge=m(26409),Ke=m(80697),e=m(23279);let le=class dt{http;constructor(a){this.http=a}listTargets(){return this.http.get("api/iscsi/target")}getTarget(a){return this.http.get(`api/iscsi/target/${a}`)}updateTarget(a,t){return this.http.put(`api/iscsi/target/${a}`,t,{observe:"response"})}status(){return this.http.get("ui-api/iscsi/status")}settings(){return this.http.get("ui-api/iscsi/settings")}version(){return this.http.get("ui-api/iscsi/version")}portals(){return this.http.get("ui-api/iscsi/portals")}createTarget(a){return this.http.post("api/iscsi/target",a,{observe:"response"})}deleteTarget(a){return this.http.delete(`api/iscsi/target/${a}`,{observe:"response"})}getDiscovery(){return this.http.get("api/iscsi/discoveryauth")}updateDiscovery(a){return this.http.put("api/iscsi/discoveryauth",a)}overview(){return this.http.get("ui-api/iscsi/overview")}static \u0275fac=function(t){return new(t||dt)(e.KVO(Ge.Qq))};static \u0275prov=e.jDH({token:dt,factory:dt.\u0275fac,providedIn:"root"})};le=(0,Oe.Cg)([Ke.G,(0,Oe.Sn)("design:paramtypes",[Ge.Qq])],le);var Z=m(75180),he=m(66668),oe=m(31345),C=m(46045),we=m(74902),j=m(58384),h=m(3687),ee=m(48856),R=m(85481),I=m(50813),Q=m(69081),V=m(59781),z=m(90476),pe=m(10142),b=m(78708),k=m(37966),g=m(34382);function T(s,a){if(1&s&&(e.j41(0,"option",8),e.EFF(1),e.k0s()),2&s){const t=a.$implicit;e.Y8G("ngValue",t),e.R7$(),e.JRh(t)}}function $(s,a){if(1&s&&(e.j41(0,"select",7),e.nrm(1,"option",8),e.DNE(2,T,2,2,"option",9),e.k0s()),2&s){const t=e.XpG();e.FS9("id",t.setting),e.FS9("name",t.setting),e.Y8G("formControlName",t.setting),e.R7$(),e.Y8G("ngValue",null),e.R7$(),e.Y8G("ngForOf",t.limits.values)}}function v(s,a){if(1&s&&e.nrm(0,"input",12),2&s){const t=e.XpG(2);e.Y8G("formControlName",t.setting)}}function Y(s,a){if(1&s&&e.nrm(0,"input",13),2&s){const t=e.XpG(2);e.Y8G("formControlName",t.setting)}}function ze(s,a){if(1&s&&(e.qex(0),e.nrm(1,"br"),e.j41(2,"div",14),e.nrm(3,"input",15),e.j41(4,"label",16),e.EFF(5,"Yes"),e.k0s()(),e.j41(6,"div",14),e.nrm(7,"input",15),e.j41(8,"label",16),e.EFF(9,"No"),e.k0s()(),e.bVm()),2&s){const t=e.XpG(2);e.R7$(3),e.Y8G("id",t.setting+"True")("value",!0)("formControlName",t.setting),e.R7$(),e.Y8G("for",t.setting+"True"),e.R7$(3),e.Y8G("id",t.setting+"False")("value",!1)("formControlName",t.setting),e.R7$(),e.Y8G("for",t.setting+"False")}}function vo(s,a){if(1&s&&(e.j41(0,"span"),e.DNE(1,v,1,1,"input",10)(2,Y,1,1,"input",11)(3,ze,10,8,"ng-container",5),e.k0s()),2&s){const t=e.XpG();e.R7$(),e.Y8G("ngIf","int"===t.limits.type),e.R7$(),e.Y8G("ngIf","str"===t.limits.type),e.R7$(),e.Y8G("ngIf","bool"===t.limits.type)}}function Lo(s,a){if(1&s&&(e.j41(0,"span",17),e.qex(1),e.pXf(2,0),e.bVm(),e.k0s()),2&s){const t=e.XpG();e.R7$(2),e.uP7(t.limits.min),e.nnv(2)}}function Go(s,a){if(1&s&&(e.j41(0,"span",17),e.qex(1),e.pXf(2,1),e.bVm(),e.k0s()),2&s){const t=e.XpG();e.R7$(2),e.uP7(t.limits.max),e.nnv(2)}}let vt=(()=>{class s{settingsForm;formDir;setting;limits;ngOnInit(){const t=[];"min"in this.limits&&t.push(l.k0.min(Number(this.limits.min))),"max"in this.limits&&t.push(l.k0.max(Number(this.limits.max))),this.settingsForm.get(this.setting).setValidators(t)}static \u0275fac=function(o){return new(o||s)};static \u0275cmp=e.VBU({type:s,selectors:[["cd-iscsi-setting"]],inputs:{settingsForm:"settingsForm",formDir:"formDir",setting:"setting",limits:"limits"},decls:7,vars:7,consts:()=>{let t,o;return t="\u5FC5\u987B\u5927\u4E8E\u6216\u7B49\u4E8E " + "\ufffd0\ufffd" + "\u3002",o="\u5FC5\u987B\u5C0F\u4E8E\u6216\u7B49\u4E8E " + "\ufffd0\ufffd" + "\u3002",[t,o,[1,"form-group",3,"formGroup"],[1,"col-form-label",3,"for"],["class","form-control",3,"id","name","formControlName",4,"ngIf"],[4,"ngIf"],["class","invalid-feedback",4,"ngIf"],[1,"form-control",3,"id","name","formControlName"],[3,"ngValue"],[3,"ngValue",4,"ngFor","ngForOf"],["type","number","class","form-control",3,"formControlName",4,"ngIf"],["type","text","class","form-control",3,"formControlName",4,"ngIf"],["type","number",1,"form-control",3,"formControlName"],["type","text",1,"form-control",3,"formControlName"],[1,"custom-control","custom-radio","custom-control-inline"],["type","radio",1,"custom-control-input",3,"id","value","formControlName"],[1,"custom-control-label",3,"for"],[1,"invalid-feedback"]]},template:function(o,n){1&o&&(e.j41(0,"div",2)(1,"label",3),e.EFF(2),e.k0s(),e.DNE(3,$,3,5,"select",4)(4,vo,4,3,"span",5)(5,Lo,3,1,"span",6)(6,Go,3,1,"span",6),e.k0s()),2&o&&(e.Y8G("formGroup",n.settingsForm),e.R7$(),e.FS9("for",n.setting),e.R7$(),e.JRh(n.setting),e.R7$(),e.Y8G("ngIf","enum"===n.limits.type),e.R7$(),e.Y8G("ngIf","enum"!==n.limits.type),e.R7$(),e.Y8G("ngIf",n.settingsForm.showError(n.setting,n.formDir,"min")),e.R7$(),e.Y8G("ngIf",n.settingsForm.showError(n.setting,n.formDir,"max")))},dependencies:[d.Sq,d.bT,l.xH,l.y7,l.me,l.Q0,l.wz,l.Fm,l.BC,l.cb,l.j4,l.JD,z.S,pe.a,b.C,k.E,g.c$]})}return s})();var st=m(82680);function Bo(s,a){1&s&&(e.j41(0,"span",30),e.pXf(1,8),e.k0s())}function yo(s,a){if(1&s&&(e.j41(0,"span")(1,"legend",16),e.pXf(2,5),e.k0s(),e.j41(3,"div",17)(4,"div",18)(5,"label",25),e.pXf(6,6),e.k0s(),e.nrm(7,"input",26),e.DNE(8,Bo,2,0,"span",27),e.k0s()(),e.j41(9,"div",17)(10,"div",18)(11,"label",28),e.pXf(12,7),e.k0s(),e.nrm(13,"input",29),e.k0s()()()),2&s){const t=e.XpG(),o=e.sdS(9);e.R7$(8),e.Y8G("ngIf",t.settingsForm.showError("lun",o,"required"))}}function Xo(s,a){if(1&s&&(e.j41(0,"option",31),e.EFF(1),e.nI1(2,"iscsiBackstore"),e.k0s()),2&s){const t=a.$implicit;e.Y8G("value",t),e.R7$(),e.JRh(e.bMT(2,2,t))}}function ko(s,a){if(1&s&&(e.j41(0,"div",17)(1,"div",18),e.nrm(2,"cd-iscsi-setting",33),e.k0s()()),2&s){const t=a.$implicit,o=e.XpG(2).$implicit,n=e.XpG(),i=e.sdS(9);e.R7$(2),e.Y8G("settingsForm",n.settingsForm)("formDir",i)("setting",t.key)("limits",n.getDiskControlLimits(o,t.key))}}function Vo(s,a){if(1&s&&(e.qex(0),e.DNE(1,ko,3,4,"div",32),e.nI1(2,"keyvalue"),e.bVm()),2&s){const t=e.XpG().$implicit,o=e.XpG();e.R7$(),e.Y8G("ngForOf",e.bMT(2,1,o.disk_default_controls[t]))}}function wo(s,a){if(1&s&&(e.qex(0),e.DNE(1,Vo,3,3,"ng-container",15),e.bVm()),2&s){const t=a.$implicit,o=e.XpG();e.R7$(),e.Y8G("ngIf",o.settingsForm.value.backstore===t)}}let xo=(()=>{class s{activeModal;iscsiService;actionLabels;image;imagesSettings;api_version;disk_default_controls;disk_controls_limits;backstores;control;settingsForm;constructor(t,o,n){this.activeModal=t,this.iscsiService=o,this.actionLabels=n}ngOnInit(){const t={backstore:new l.hs(this.imagesSettings[this.image].backstore),lun:new l.hs(this.imagesSettings[this.image].lun),wwn:new l.hs(this.imagesSettings[this.image].wwn)};f().forEach(this.backstores,o=>{const n=this.imagesSettings[this.image][o]||{};f().forIn(this.disk_default_controls[o],(i,r)=>{t[r]=new l.hs(n[r])})}),this.settingsForm=new j.$(t)}getDiskControlLimits(t,o){return this.disk_controls_limits?this.disk_controls_limits[t][o]:{type:"int"}}save(){const t=this.settingsForm.controls.backstore.value,o=this.settingsForm.controls.lun.value,n=this.settingsForm.controls.wwn.value,i={};f().forIn(this.settingsForm.controls,(r,_)=>{""!==r.value&&null!==r.value&&_ in this.disk_default_controls[this.settingsForm.value.backstore]&&(i[_]=r.value,f().forEach(this.backstores,c=>{c!==t&&_ in(this.imagesSettings[this.image][c]||{})&&(this.imagesSettings[this.image][c][_]=r.value)}))}),this.imagesSettings[this.image].backstore=t,this.imagesSettings[this.image].lun=o,this.imagesSettings[this.image].wwn=n,this.imagesSettings[this.image][t]=i,this.imagesSettings={...this.imagesSettings},this.control.updateValueAndValidity({emitEvent:!1}),this.activeModal.close()}static \u0275fac=function(o){return new(o||s)(e.rXU(A.Lw),e.rXU(le),e.rXU(F.Ss))};static \u0275cmp=e.VBU({type:s,selectors:[["cd-iscsi-target-image-settings-modal"]],decls:25,vars:8,consts:()=>{let t,o,n,i,r,_,c,u;return t="\u914D\u7F6E",o="\u901A\u5E38\u65E0\u987B\u66F4\u6539\u8FD9\u4E9B\u9ED8\u8BA4\u53C2\u6570\u503C\u3002",n="\u8BBE\u7F6E",i="\u540E\u5907\u5B58\u50A8",r="\u6807\u8BC6\u7B26",_="lun",c="wwn",u="\u8FD9\u662F\u5FC5\u586B\u5B57\u6BB5\uFF01",[["formDir","ngForm"],t,o,n,i,r,_,c,u,[3,"modalRef"],[1,"modal-title"],[1,"modal-content"],["name","settingsForm","novalidate","",1,"form",3,"formGroup"],[1,"modal-body"],[1,"alert-warning"],[4,"ngIf"],[1,"cd-header"],[1,"form-group","row"],[1,"col-sm-12"],[1,"col-form-label"],["id","backstore","name","backstore","formControlName","backstore",1,"form-select"],[3,"value",4,"ngFor","ngForOf"],[4,"ngFor","ngForOf"],[1,"modal-footer"],[3,"submitActionEvent","form","submitText"],["for","lun",1,"col-form-label","required"],["type","number","id","lun","name","lun","formControlName","lun",1,"form-control"],["class","invalid-feedback",4,"ngIf"],["for","wwn",1,"col-form-label"],["type","text","id","wwn","name","wwn","formControlName","wwn",1,"form-control"],[1,"invalid-feedback"],[3,"value"],["class","form-group row",4,"ngFor","ngForOf"],[3,"settingsForm","formDir","setting","limits"]]},template:function(o,n){if(1&o){const i=e.RV6();e.j41(0,"cd-modal",9),e.qex(1,10)(2),e.pXf(3,1),e.bVm(),e.EFF(4,"\xa0 "),e.j41(5,"small"),e.EFF(6),e.k0s(),e.bVm(),e.qex(7,11),e.j41(8,"form",12,0)(10,"div",13)(11,"p",14),e.pXf(12,2),e.k0s(),e.DNE(13,yo,14,1,"span",15),e.j41(14,"legend",16),e.pXf(15,3),e.k0s(),e.j41(16,"div",17)(17,"div",18)(18,"label",19),e.pXf(19,4),e.k0s(),e.j41(20,"select",20),e.DNE(21,Xo,3,4,"option",21),e.k0s()()(),e.DNE(22,wo,2,1,"ng-container",22),e.k0s(),e.j41(23,"div",23)(24,"cd-form-button-panel",24),e.bIt("submitActionEvent",function(){return e.eBV(i),e.Njj(n.save())}),e.k0s()()(),e.bVm(),e.k0s()}2&o&&(e.Y8G("modalRef",n.activeModal),e.R7$(6),e.JRh(n.image),e.R7$(2),e.Y8G("formGroup",n.settingsForm),e.R7$(5),e.Y8G("ngIf",n.api_version>=1),e.R7$(8),e.Y8G("ngForOf",n.backstores),e.R7$(),e.Y8G("ngForOf",n.backstores),e.R7$(2),e.Y8G("form",n.settingsForm)("submitText",n.actionLabels.UPDATE))},dependencies:[d.Sq,d.bT,l.qT,l.xH,l.y7,l.me,l.Q0,l.wz,l.BC,l.cb,l.j4,l.JD,Q.z,V.e,z.S,pe.a,b.C,k.E,g.c$,vt,d.lG,st.k]})}return s})();function Ho(s,a){if(1&s&&(e.j41(0,"div",12)(1,"div",13),e.nrm(2,"cd-iscsi-setting",14),e.k0s()()),2&s){const t=a.$implicit,o=e.XpG(),n=e.sdS(5);e.R7$(2),e.Y8G("settingsForm",o.settingsForm)("formDir",n)("setting",t.key)("limits",o.getTargetControlLimits(t.key))}}let jo=(()=>{class s{activeModal;iscsiService;actionLabels;target_controls;target_default_controls;target_controls_limits;settingsForm;constructor(t,o,n){this.activeModal=t,this.iscsiService=o,this.actionLabels=n}ngOnInit(){const t={};f().forIn(this.target_default_controls,(o,n)=>{t[n]=new l.hs(this.target_controls.value[n])}),this.settingsForm=new j.$(t)}save(){const t={};f().forIn(this.settingsForm.controls,(o,n)=>{""===o.value||null===o.value||(t[n]=o.value)}),this.target_controls.setValue(t),this.activeModal.close()}getTargetControlLimits(t){return this.target_controls_limits?this.target_controls_limits[t]:["Yes","No"].includes(this.target_default_controls[t])?{type:"bool"}:{type:"int"}}static \u0275fac=function(o){return new(o||s)(e.rXU(A.Lw),e.rXU(le),e.rXU(F.Ss))};static \u0275cmp=e.VBU({type:s,selectors:[["cd-iscsi-target-iqn-settings-modal"]],decls:13,vars:7,consts:()=>{let t,o;return t="\u9AD8\u7EA7\u8BBE\u7F6E",o="\u901A\u5E38\u65E0\u987B\u66F4\u6539\u8FD9\u4E9B\u9ED8\u8BA4\u53C2\u6570\u503C\u3002",[["formDir","ngForm"],t,o,[3,"modalRef"],[1,"modal-title"],[1,"modal-content"],["name","settingsForm","novalidate","",3,"formGroup"],[1,"modal-body"],[1,"alert-warning"],["class","form-group row",4,"ngFor","ngForOf"],[1,"modal-footer"],[3,"submitActionEvent","form","submitText"],[1,"form-group","row"],[1,"col-sm-12"],[3,"settingsForm","formDir","setting","limits"]]},template:function(o,n){if(1&o){const i=e.RV6();e.j41(0,"cd-modal",3),e.qex(1,4),e.pXf(2,1),e.bVm(),e.qex(3,5),e.j41(4,"form",6,0)(6,"div",7)(7,"p",8),e.pXf(8,2),e.k0s(),e.DNE(9,Ho,3,4,"div",9),e.nI1(10,"keyvalue"),e.k0s(),e.j41(11,"div",10)(12,"cd-form-button-panel",11),e.bIt("submitActionEvent",function(){return e.eBV(i),e.Njj(n.save())}),e.k0s()()(),e.bVm(),e.k0s()}2&o&&(e.Y8G("modalRef",n.activeModal),e.R7$(4),e.Y8G("formGroup",n.settingsForm),e.R7$(5),e.Y8G("ngForOf",e.bMT(10,5,n.settingsForm.controls)),e.R7$(3),e.Y8G("form",n.settingsForm)("submitText",n.actionLabels.UPDATE))},dependencies:[d.Sq,l.qT,l.cb,l.j4,Q.z,V.e,b.C,k.E,vt,d.lG]})}return s})();var Yo=m(77867),Ko=m(92619),it=m(50889),Lt=m(12302),zo=m(70946),Gt=m(56677),Be=m(37353);const ne=s=>[s];function Uo(s,a){1&s&&(e.j41(0,"span",95),e.pXf(1,8),e.k0s())}function qo(s,a){1&s&&(e.j41(0,"span",95),e.pXf(1,9),e.k0s())}function Qo(s,a){1&s&&(e.j41(0,"span",95),e.qex(1),e.pXf(2,10),e.bVm(),e.nrm(3,"br"),e.qex(4),e.pXf(5,11),e.bVm(),e.nrm(6,"br"),e.j41(7,"a",96),e.pXf(8,12),e.k0s()())}function Wo(s,a){1&s&&(e.j41(0,"span",97),e.pXf(1,13),e.k0s())}function Jo(s,a){if(1&s){const t=e.RV6();e.qex(0),e.j41(1,"div",98),e.nrm(2,"input",99),e.j41(3,"button",100),e.bIt("click",function(){const n=e.eBV(t),i=n.$implicit,r=n.index,_=e.XpG(2);return e.Njj(_.removePortal(r,i))}),e.nrm(4,"i",75),e.k0s()(),e.bVm()}if(2&s){const t=a.$implicit,o=e.XpG(2);e.R7$(2),e.Y8G("value",t),e.R7$(2),e.Y8G("ngClass",e.eq3(2,ne,o.icons.destroy))}}function Zo(s,a){if(1&s&&(e.j41(0,"span",95),e.pXf(1,14),e.k0s()),2&s){const t=e.XpG(2);e.R7$(),e.uP7(t.minimum_gateways),e.nnv(1)}}function en(s,a){if(1&s&&(e.j41(0,"div",103),e.EFF(1),e.k0s()),2&s){const t=e.XpG().$implicit,o=e.XpG(2);e.R7$(),e.SpI("lun: ",o.imagesSettings[t].lun,"")}}function tn(s,a){if(1&s&&(e.qex(0),e.pXf(1,15),e.nI1(2,"iscsiBackstore"),e.bVm()),2&s){const t=e.XpG().$implicit,o=e.XpG(2);e.R7$(2),e.uP7(e.bMT(2,1,o.imagesSettings[t].backstore)),e.nnv(1)}}function on(s,a){1&s&&(e.qex(0),e.pXf(1,16),e.bVm())}function nn(s,a){if(1&s){const t=e.RV6();e.qex(0),e.j41(1,"div",98),e.nrm(2,"input",99),e.DNE(3,en,2,1,"div",101),e.j41(4,"button",100),e.bIt("click",function(){const n=e.eBV(t).$implicit,i=e.XpG(2);return e.Njj(i.imageSettingsModal(n))}),e.nrm(5,"i",75),e.k0s(),e.j41(6,"button",100),e.bIt("click",function(){const n=e.eBV(t),i=n.$implicit,r=n.index,_=e.XpG(2);return e.Njj(_.removeImage(r,i))}),e.nrm(7,"i",75),e.k0s()(),e.j41(8,"span",97),e.DNE(9,tn,3,3,"ng-container",102)(10,on,2,0,"ng-container",102),e.k0s(),e.bVm()}if(2&s){const t=a.$implicit,o=e.XpG(2);e.R7$(2),e.Y8G("value",t),e.R7$(),e.Y8G("ngIf",o.api_version>=1),e.R7$(2),e.Y8G("ngClass",e.eq3(6,ne,o.icons.deepCheck)),e.R7$(2),e.Y8G("ngClass",e.eq3(8,ne,o.icons.destroy)),e.R7$(2),e.Y8G("ngIf",o.backstores.length>1),e.R7$(),e.Y8G("ngIf",o.hasAdvancedSettings(o.imagesSettings[t][o.imagesSettings[t].backstore]))}}function sn(s,a){1&s&&(e.j41(0,"span",95),e.pXf(1,17),e.k0s())}function an(s,a){1&s&&(e.j41(0,"span",95),e.pXf(1,18),e.k0s())}function rn(s,a){1&s&&(e.j41(0,"span",95),e.pXf(1,23),e.k0s())}function _n(s,a){1&s&&(e.j41(0,"span",95),e.pXf(1,24),e.k0s())}function ln(s,a){1&s&&(e.j41(0,"span",95),e.pXf(1,25),e.k0s())}function cn(s,a){1&s&&(e.j41(0,"span",95),e.pXf(1,26),e.k0s())}function dn(s,a){1&s&&(e.j41(0,"span",95),e.pXf(1,27),e.k0s())}function mn(s,a){1&s&&(e.j41(0,"span",95),e.pXf(1,28),e.k0s())}function un(s,a){1&s&&(e.j41(0,"span",95),e.pXf(1,29),e.k0s())}function pn(s,a){1&s&&(e.j41(0,"span",95),e.pXf(1,30),e.k0s())}function gn(s,a){if(1&s&&(e.j41(0,"div",104)(1,"div",69)(2,"label",105),e.qex(3),e.pXf(4,19),e.bVm(),e.k0s(),e.j41(5,"div",71),e.nrm(6,"input",106),e.DNE(7,rn,2,0,"span",76)(8,_n,2,0,"span",76),e.k0s()(),e.j41(9,"div",69)(10,"label",107),e.qex(11),e.pXf(12,20),e.bVm(),e.k0s(),e.j41(13,"div",71)(14,"div",72),e.nrm(15,"input",108)(16,"button",109)(17,"cd-copy-2-clipboard-button",110),e.k0s(),e.DNE(18,ln,2,0,"span",76)(19,cn,2,0,"span",76),e.k0s()(),e.j41(20,"div",69)(21,"label",111),e.qex(22),e.pXf(23,21),e.bVm(),e.k0s(),e.j41(24,"div",71),e.nrm(25,"input",112),e.DNE(26,dn,2,0,"span",76)(27,mn,2,0,"span",76),e.k0s()(),e.j41(28,"div",69)(29,"label",113),e.qex(30),e.pXf(31,22),e.bVm(),e.k0s(),e.j41(32,"div",71)(33,"div",72),e.nrm(34,"input",114)(35,"button",115)(36,"cd-copy-2-clipboard-button",116),e.k0s(),e.DNE(37,un,2,0,"span",76)(38,pn,2,0,"span",76),e.k0s()()()),2&s){e.XpG();const t=e.sdS(2),o=e.XpG();e.R7$(7),e.Y8G("ngIf",o.targetForm.showError("user",t,"required")),e.R7$(),e.Y8G("ngIf",o.targetForm.showError("user",t,"pattern")),e.R7$(10),e.Y8G("ngIf",o.targetForm.showError("password",t,"required")),e.R7$(),e.Y8G("ngIf",o.targetForm.showError("password",t,"pattern")),e.R7$(7),e.Y8G("ngIf",o.targetForm.showError("mutual_user",t,"required")),e.R7$(),e.Y8G("ngIf",o.targetForm.showError("mutual_user",t,"pattern")),e.R7$(10),e.Y8G("ngIf",o.targetForm.showError("mutual_password",t,"required")),e.R7$(),e.Y8G("ngIf",o.targetForm.showError("mutual_password",t,"pattern"))}}function fn(s,a){1&s&&(e.j41(0,"span",95),e.pXf(1,40),e.k0s())}function Tn(s,a){1&s&&(e.j41(0,"span",95),e.pXf(1,41),e.k0s())}function Sn(s,a){1&s&&(e.j41(0,"span",95),e.pXf(1,42),e.k0s())}function En(s,a){1&s&&(e.j41(0,"span",95),e.pXf(1,43),e.k0s())}function Cn(s,a){1&s&&(e.j41(0,"span",95),e.pXf(1,44),e.k0s())}function Fn(s,a){1&s&&(e.j41(0,"span",95),e.pXf(1,45),e.k0s())}function Rn(s,a){1&s&&(e.j41(0,"span",95),e.pXf(1,46),e.k0s())}function Mn(s,a){1&s&&(e.j41(0,"span",95),e.pXf(1,47),e.k0s())}function On(s,a){1&s&&(e.j41(0,"span",95),e.pXf(1,48),e.k0s())}function hn(s,a){1&s&&(e.j41(0,"span",95),e.pXf(1,49),e.k0s())}function bn(s,a){1&s&&(e.j41(0,"span",95),e.pXf(1,50),e.k0s())}function Nn(s,a){if(1&s){const t=e.RV6();e.qex(0),e.j41(1,"div",98),e.nrm(2,"input",99),e.j41(3,"button",100),e.bIt("click",function(){const n=e.eBV(t),i=n.$implicit,r=n.index,_=e.XpG(),c=_.$implicit,u=_.index,S=e.XpG(3);return e.Njj(S.removeInitiatorImage(c,r,u,i))}),e.nrm(4,"i",75),e.k0s()(),e.bVm()}if(2&s){const t=a.$implicit,o=e.XpG(4);e.R7$(2),e.Y8G("value",t),e.R7$(2),e.Y8G("ngClass",e.eq3(2,ne,o.icons.destroy))}}function Pn(s,a){1&s&&(e.j41(0,"span"),e.pXf(1,51),e.k0s())}function In(s,a){if(1&s&&(e.j41(0,"div",80)(1,"div",81)(2,"cd-select",137),e.nrm(3,"i",83),e.qex(4),e.pXf(5,52),e.bVm(),e.k0s()()()),2&s){const t=e.XpG(),o=t.$implicit,n=t.index,i=e.XpG(3);e.R7$(2),e.Y8G("data",o.getValue("luns"))("options",i.imagesInitiatorSelections[n])("messages",i.messages.initiatorImage),e.R7$(),e.Y8G("ngClass",e.eq3(4,ne,i.icons.add))}}function An(s,a){if(1&s){const t=e.RV6();e.j41(0,"div",121)(1,"div",67),e.qex(2),e.pXf(3,33),e.bVm(),e.EFF(4),e.j41(5,"button",122),e.bIt("click",function(){const n=e.eBV(t).index,i=e.XpG(3);return e.Njj(i.removeInitiator(n))}),e.k0s()(),e.j41(6,"div",68)(7,"div",69)(8,"label",123),e.pXf(9,34),e.k0s(),e.j41(10,"div",71)(11,"input",124),e.bIt("blur",function(){e.eBV(t);const n=e.XpG(3);return e.Njj(n.updatedInitiatorSelector())}),e.k0s(),e.DNE(12,fn,2,0,"span",76)(13,Tn,2,0,"span",76)(14,Sn,2,0,"span",76),e.k0s()(),e.qex(15,104),e.j41(16,"div",69)(17,"label",125),e.pXf(18,35),e.k0s(),e.j41(19,"div",71),e.nrm(20,"input",126),e.DNE(21,En,2,0,"span",76)(22,Cn,2,0,"span",76),e.k0s()(),e.j41(23,"div",69)(24,"label",127),e.pXf(25,36),e.k0s(),e.j41(26,"div",71)(27,"div",72),e.nrm(28,"input",128)(29,"button",129)(30,"cd-copy-2-clipboard-button",130),e.k0s(),e.DNE(31,Fn,2,0,"span",76)(32,Rn,2,0,"span",76),e.k0s()(),e.j41(33,"div",69)(34,"label",131),e.qex(35),e.pXf(36,37),e.bVm(),e.k0s(),e.j41(37,"div",71),e.nrm(38,"input",132),e.DNE(39,Mn,2,0,"span",76)(40,On,2,0,"span",76),e.k0s()(),e.j41(41,"div",69)(42,"label",133),e.pXf(43,38),e.k0s(),e.j41(44,"div",71)(45,"div",72),e.nrm(46,"input",134)(47,"button",129)(48,"cd-copy-2-clipboard-button",130),e.k0s(),e.DNE(49,hn,2,0,"span",76)(50,bn,2,0,"span",76),e.k0s()(),e.bVm(),e.j41(51,"div",69)(52,"label",135),e.pXf(53,39),e.k0s(),e.j41(54,"div",71),e.DNE(55,Nn,5,4,"ng-container",79)(56,Pn,2,0,"span",102)(57,In,6,6,"div",136),e.k0s()()()()}if(2&s){const t=a.$implicit,o=a.index;e.XpG(2);const n=e.sdS(2);e.Y8G("formGroup",t),e.R7$(4),e.SpI(": ",t.getValue("client_iqn")," "),e.R7$(8),e.Y8G("ngIf",t.showError("client_iqn",n,"notUnique")),e.R7$(),e.Y8G("ngIf",t.showError("client_iqn",n,"required")),e.R7$(),e.Y8G("ngIf",t.showError("client_iqn",n,"pattern")),e.R7$(6),e.Y8G("id","user"+o),e.R7$(),e.Y8G("ngIf",t.showError("user",n,"required")),e.R7$(),e.Y8G("ngIf",t.showError("user",n,"pattern")),e.R7$(6),e.Y8G("id","password"+o),e.R7$(),e.Y8G("cdPasswordButton","password"+o),e.R7$(),e.Y8G("source","password"+o),e.R7$(),e.Y8G("ngIf",t.showError("password",n,"required")),e.R7$(),e.Y8G("ngIf",t.showError("password",n,"pattern")),e.R7$(6),e.Y8G("id","mutual_user"+o),e.R7$(),e.Y8G("ngIf",t.showError("mutual_user",n,"required")),e.R7$(),e.Y8G("ngIf",t.showError("mutual_user",n,"pattern")),e.R7$(6),e.Y8G("id","mutual_password"+o),e.R7$(),e.Y8G("cdPasswordButton","mutual_password"+o),e.R7$(),e.Y8G("source","mutual_password"+o),e.R7$(),e.Y8G("ngIf",t.showError("mutual_password",n,"required")),e.R7$(),e.Y8G("ngIf",t.showError("mutual_password",n,"pattern")),e.R7$(5),e.Y8G("ngForOf",t.getValue("luns")),e.R7$(),e.Y8G("ngIf",t.getValue("cdIsInGroup")),e.R7$(),e.Y8G("ngIf",!t.getValue("cdIsInGroup"))}}function Dn(s,a){1&s&&(e.j41(0,"span",97),e.pXf(1,53),e.k0s())}function $n(s,a){if(1&s){const t=e.RV6();e.j41(0,"div",69)(1,"label",117),e.pXf(2,31),e.k0s(),e.j41(3,"div",118),e.DNE(4,An,58,24,"div",119),e.j41(5,"div",80)(6,"div",81),e.DNE(7,Dn,2,0,"span",77),e.j41(8,"button",120),e.bIt("click",function(){return e.eBV(t),e.XpG(2).addInitiator(),e.Njj(!1)}),e.nrm(9,"i",83),e.qex(10),e.pXf(11,32),e.bVm(),e.k0s()()(),e.nrm(12,"hr"),e.k0s()()}if(2&s){const t=e.XpG(2);e.R7$(4),e.Y8G("ngForOf",t.initiators.controls),e.R7$(3),e.Y8G("ngIf",0===t.initiators.controls.length),e.R7$(2),e.Y8G("ngClass",e.eq3(3,ne,t.icons.add))}}function vn(s,a){if(1&s){const t=e.RV6();e.qex(0),e.j41(1,"div",98),e.nrm(2,"input",99),e.j41(3,"button",100),e.bIt("click",function(){const n=e.eBV(t).index,i=e.XpG(),r=i.$implicit,_=i.index,c=e.XpG(3);return e.Njj(c.removeGroupInitiator(r,n,_))}),e.nrm(4,"i",75),e.k0s()(),e.bVm()}if(2&s){const t=a.$implicit,o=e.XpG(4);e.R7$(2),e.Y8G("value",t),e.R7$(2),e.Y8G("ngClass",e.eq3(2,ne,o.icons.destroy))}}function Ln(s,a){if(1&s){const t=e.RV6();e.qex(0),e.j41(1,"div",98),e.nrm(2,"input",99),e.j41(3,"button",100),e.bIt("click",function(){const n=e.eBV(t).index,i=e.XpG(),r=i.$implicit,_=i.index,c=e.XpG(3);return e.Njj(c.removeGroupDisk(r,n,_))}),e.nrm(4,"i",75),e.k0s()(),e.bVm()}if(2&s){const t=a.$implicit,o=e.XpG(4);e.R7$(2),e.Y8G("value",t),e.R7$(2),e.Y8G("ngClass",e.eq3(2,ne,o.icons.destroy))}}function Gn(s,a){if(1&s){const t=e.RV6();e.j41(0,"div",121)(1,"div",67),e.qex(2),e.pXf(3,56),e.bVm(),e.EFF(4),e.j41(5,"button",122),e.bIt("click",function(){const n=e.eBV(t).index,i=e.XpG(3);return e.Njj(i.removeGroup(n))}),e.k0s()(),e.j41(6,"div",68)(7,"div",69)(8,"label",139),e.pXf(9,57),e.k0s(),e.j41(10,"div",71),e.nrm(11,"input",140),e.k0s()(),e.j41(12,"div",69)(13,"label",141),e.qex(14),e.pXf(15,58),e.bVm(),e.k0s(),e.j41(16,"div",71),e.DNE(17,vn,5,4,"ng-container",79),e.j41(18,"div",80)(19,"div",81)(20,"cd-select",82),e.bIt("selection",function(n){const i=e.eBV(t).index,r=e.XpG(3);return e.Njj(r.onGroupMemberSelection(n,i))}),e.nrm(21,"i",83),e.qex(22),e.pXf(23,59),e.bVm(),e.k0s()()(),e.nrm(24,"hr"),e.k0s()(),e.j41(25,"div",69)(26,"label",85),e.qex(27),e.pXf(28,60),e.bVm(),e.k0s(),e.j41(29,"div",71),e.DNE(30,Ln,5,4,"ng-container",79),e.j41(31,"div",80)(32,"div",81)(33,"cd-select",137),e.nrm(34,"i",83),e.qex(35),e.pXf(36,61),e.bVm(),e.k0s()()(),e.nrm(37,"hr"),e.k0s()()()()}if(2&s){const t=a.$implicit,o=a.index,n=e.XpG(3);e.Y8G("formGroup",t),e.R7$(4),e.SpI(": ",t.getValue("group_id")," "),e.R7$(13),e.Y8G("ngForOf",t.getValue("members")),e.R7$(3),e.Y8G("data",t.getValue("members"))("options",n.groupMembersSelections[o])("messages",n.messages.groupInitiator),e.R7$(),e.Y8G("ngClass",e.eq3(12,ne,n.icons.add)),e.R7$(9),e.Y8G("ngForOf",t.getValue("disks")),e.R7$(3),e.Y8G("data",t.getValue("disks"))("options",n.groupDiskSelections[o])("messages",n.messages.initiatorImage),e.R7$(),e.Y8G("ngClass",e.eq3(14,ne,n.icons.add))}}function Bn(s,a){1&s&&(e.j41(0,"span",97),e.pXf(1,62),e.k0s())}function yn(s,a){if(1&s){const t=e.RV6();e.j41(0,"div",69)(1,"label",117),e.pXf(2,54),e.k0s(),e.j41(3,"div",138),e.DNE(4,Gn,38,16,"div",119),e.j41(5,"div",80)(6,"div",81),e.DNE(7,Bn,2,0,"span",77),e.j41(8,"button",120),e.bIt("click",function(){return e.eBV(t),e.XpG(2).addGroup(),e.Njj(!1)}),e.nrm(9,"i",83),e.qex(10),e.pXf(11,55),e.bVm(),e.k0s()()()()()}if(2&s){const t=e.XpG(2);e.R7$(4),e.Y8G("ngForOf",t.groups.controls),e.R7$(3),e.Y8G("ngIf",0===t.groups.controls.length),e.R7$(2),e.Y8G("ngClass",e.eq3(3,ne,t.icons.add))}}function Xn(s,a){if(1&s){const t=e.RV6();e.j41(0,"div",64)(1,"form",65,0)(3,"div",66)(4,"div",67),e.pXf(5,1),e.nI1(6,"titlecase"),e.nI1(7,"upperFirst"),e.k0s(),e.j41(8,"div",68)(9,"div",69)(10,"label",70),e.pXf(11,2),e.k0s(),e.j41(12,"div",71)(13,"div",72),e.nrm(14,"input",73),e.j41(15,"button",74),e.bIt("click",function(){e.eBV(t);const n=e.XpG();return e.Njj(n.targetSettingsModal())}),e.nrm(16,"i",75),e.k0s()(),e.DNE(17,Uo,2,0,"span",76)(18,qo,2,0,"span",76)(19,Qo,9,0,"span",76)(20,Wo,2,0,"span",77),e.nrm(21,"hr"),e.k0s()(),e.j41(22,"div",69)(23,"label",78),e.pXf(24,3),e.k0s(),e.j41(25,"div",71),e.DNE(26,Jo,5,4,"ng-container",79),e.j41(27,"div",80)(28,"div",81)(29,"cd-select",82),e.bIt("selection",function(n){e.eBV(t);const i=e.XpG();return e.Njj(i.onPortalSelection(n))}),e.nrm(30,"i",83),e.qex(31),e.pXf(32,4),e.bVm(),e.k0s()()(),e.nrm(33,"input",84),e.DNE(34,Zo,2,1,"span",76),e.nrm(35,"hr"),e.k0s()(),e.j41(36,"div",69)(37,"label",85),e.pXf(38,5),e.k0s(),e.j41(39,"div",71),e.DNE(40,nn,11,10,"ng-container",79),e.nrm(41,"input",86),e.DNE(42,sn,2,0,"span",76)(43,an,2,0,"span",76),e.j41(44,"div",80)(45,"div",81)(46,"cd-select",82),e.bIt("selection",function(n){e.eBV(t);const i=e.XpG();return e.Njj(i.onImageSelection(n))}),e.nrm(47,"i",83),e.qex(48),e.pXf(49,6),e.bVm(),e.k0s()()(),e.nrm(50,"hr"),e.k0s()(),e.j41(51,"div",69)(52,"div",87)(53,"div",88),e.nrm(54,"input",89),e.j41(55,"label",90),e.pXf(56,7),e.k0s()(),e.nrm(57,"hr"),e.k0s()(),e.DNE(58,gn,39,8,"div",91)(59,$n,13,5,"div",92)(60,yn,12,5,"div",92),e.k0s(),e.j41(61,"div",93)(62,"cd-form-button-panel",94),e.nI1(63,"titlecase"),e.nI1(64,"upperFirst"),e.bIt("submitActionEvent",function(){e.eBV(t);const n=e.XpG();return e.Njj(n.submit())}),e.k0s()()()()()}if(2&s){const t=e.sdS(2),o=e.XpG();e.R7$(),e.Y8G("formGroup",o.targetForm),e.R7$(6),e.uP7(e.bMT(6,26,o.action))(e.bMT(7,28,o.resource)),e.nnv(5),e.R7$(9),e.Y8G("ngClass",e.eq3(34,ne,o.icons.deepCheck)),e.R7$(),e.Y8G("ngIf",o.targetForm.showError("target_iqn",t,"required")),e.R7$(),e.Y8G("ngIf",o.targetForm.showError("target_iqn",t,"pattern")),e.R7$(),e.Y8G("ngIf",o.targetForm.showError("target_iqn",t,"iqn")),e.R7$(),e.Y8G("ngIf",o.hasAdvancedSettings(o.targetForm.getValue("target_controls"))),e.R7$(6),e.Y8G("ngForOf",o.portals.value),e.R7$(3),e.Y8G("data",o.portals.value)("options",o.portalsSelections)("messages",o.messages.portals),e.R7$(),e.Y8G("ngClass",e.eq3(36,ne,o.icons.add)),e.R7$(4),e.Y8G("ngIf",o.targetForm.showError("portals",t,"minGateways")),e.R7$(6),e.Y8G("ngForOf",o.targetForm.getValue("disks")),e.R7$(2),e.Y8G("ngIf",o.targetForm.showError("disks",t,"dupLunId")),e.R7$(),e.Y8G("ngIf",o.targetForm.showError("disks",t,"dupWwn")),e.R7$(3),e.Y8G("data",o.disks.value)("options",o.imagesSelections)("messages",o.messages.images),e.R7$(),e.Y8G("ngClass",e.eq3(38,ne,o.icons.add)),e.R7$(11),e.Y8G("ngIf",o.cephIscsiConfigVersion>10&&!o.targetForm.getValue("acl_enabled")),e.R7$(),e.Y8G("ngIf",o.targetForm.getValue("acl_enabled")),e.R7$(),e.Y8G("ngIf",o.targetForm.getValue("acl_enabled")),e.R7$(2),e.Y8G("form",o.targetForm)("submitText",e.bMT(63,30,o.action)+" "+e.bMT(64,32,o.resource))}}let Bt=(()=>{class s extends we.g{iscsiService;modalService;rbdService;router;route;taskWrapper;actionLabels;cephIscsiConfigVersion;targetForm;modalRef;api_version=0;minimum_gateways=1;target_default_controls;target_controls_limits;disk_default_controls;disk_controls_limits;backstores;default_backstore;unsupported_rbd_features;required_rbd_features;icons=C.F;isEdit=!1;target_iqn;imagesAll;imagesSelections;portalsSelections=[];imagesInitiatorSelections=[];groupDiskSelections=[];groupMembersSelections=[];imagesSettings={};messages={portals:new he.z({noOptions:"\u6CA1\u6709\u53EF\u7528\u7684\u7AEF\u53E3\u3002"}),images:new he.z({noOptions:"\u6CA1\u6709\u53EF\u7528\u7684\u6620\u50CF\u3002"}),initiatorImage:new he.z({noOptions:"\u6CA1\u6709\u53EF\u7528\u7684\u6620\u50CF\u3002\u8BF7\u786E\u4FDD\u4E3A\u76EE\u6807\u6DFB\u52A0\u4E00\u4E2A\u6620\u50CF\u3002"}),groupInitiator:new he.z({noOptions:"\u6CA1\u6709\u53EF\u7528\u7684\u6388\u6743\u4EBA\u3002\u8BF7\u786E\u4FDD\u4E3A\u76EE\u6807\u6DFB\u52A0\u4E00\u4E2A\u6388\u6743\u4EBA\u3002"})};IQN_REGEX=/^iqn\.(19|20)\d\d-(0[1-9]|1[0-2])\.\D{2,3}(\.[A-Za-z0-9-]+)+(:[A-Za-z0-9-\.]+)*$/;USER_REGEX=/^[\w\.:@_-]{8,64}$/;PASSWORD_REGEX=/^[\w@\-_\/]{12,16}$/;action;resource;constructor(t,o,n,i,r,_,c){super(),this.iscsiService=t,this.modalService=o,this.rbdService=n,this.router=i,this.route=r,this.taskWrapper=_,this.actionLabels=c,this.resource="\u76EE\u6807"}ngOnInit(){const t=new ee.n(()=>{});t.pageInfo.limit=-1;const o=[this.iscsiService.listTargets(),this.rbdService.list(t.toParams()),this.iscsiService.portals(),this.iscsiService.settings(),this.iscsiService.version()];this.router.url.startsWith("/block/iscsi/targets/edit")&&(this.isEdit=!0,this.route.params.subscribe(n=>{this.target_iqn=decodeURIComponent(n.target_iqn),o.push(this.iscsiService.getTarget(this.target_iqn))})),this.action=this.isEdit?this.actionLabels.EDIT:this.actionLabels.CREATE,(0,J.p)(o).subscribe(n=>{const i=f()(n[0]).filter(_=>_.target_iqn!==this.target_iqn).flatMap(_=>_.disks).map(_=>`${_.pool}/${_.image}`).value();"api_version"in n[3]&&(this.api_version=n[3].api_version),this.minimum_gateways=n[3].config.minimum_gateways,this.target_default_controls=n[3].target_default_controls,this.target_controls_limits=n[3].target_controls_limits,this.disk_default_controls=n[3].disk_default_controls,this.disk_controls_limits=n[3].disk_controls_limits,this.backstores=n[3].backstores,this.default_backstore=n[3].default_backstore,this.unsupported_rbd_features=n[3].unsupported_rbd_features,this.required_rbd_features=n[3].required_rbd_features,this.imagesAll=f()(n[1]).flatMap(_=>_.value).filter(_=>!_.namespace&&!(-1!==i.indexOf(`${_.pool_name}/${_.name}`)||0===this.getValidBackstores(_).length)).value(),this.imagesSelections=this.imagesAll.map(_=>new oe.O(!1,`${_.pool_name}/${_.name}`,""));const r=[];n[2].forEach(_=>{_.ip_addresses.forEach(c=>{r.push(new oe.O(!1,_.name+":"+c,""))})}),this.portalsSelections=[...r],this.cephIscsiConfigVersion=n[4].ceph_iscsi_config_version,this.createForm(),n[5]&&this.resolveModel(n[5]),this.loadingReady()})}createForm(){if(this.targetForm=new j.$({target_iqn:new l.hs("iqn.2001-07.com.ceph:"+Date.now(),{validators:[l.k0.required,l.k0.pattern(this.IQN_REGEX)]}),target_controls:new l.hs({}),portals:new l.hs([],{validators:[h.xQ.custom("minGateways",t=>f().uniq(t.map(n=>n.split(":")[0])).length<Math.max(1,this.minimum_gateways))]}),disks:new l.hs([],{validators:[h.xQ.custom("dupLunId",t=>{const o=this.getLunIds(t);return o.length!==f().uniq(o).length}),h.xQ.custom("dupWwn",t=>{const o=this.getWwns(t);return o.length!==f().uniq(o).length})]}),initiators:new l.Bm([]),groups:new l.Bm([]),acl_enabled:new l.hs(!1)}),this.cephIscsiConfigVersion>10){const t=new j.$({user:new l.hs(""),password:new l.hs(""),mutual_user:new l.hs(""),mutual_password:new l.hs("")});this.setAuthValidator(t),this.targetForm.addControl("auth",t)}}resolveModel(t){this.targetForm.patchValue({target_iqn:t.target_iqn,target_controls:t.target_controls,acl_enabled:t.acl_enabled}),this.cephIscsiConfigVersion>10&&this.targetForm.patchValue({auth:t.auth});const o=[];f().forEach(t.portals,i=>{o.push(`${i.host}:${i.ip}`)}),this.targetForm.patchValue({portals:o});const n=[];f().forEach(t.disks,i=>{const r=`${i.pool}/${i.image}`;n.push(r),this.imagesSettings[r]={backstore:i.backstore},this.imagesSettings[r][i.backstore]=i.controls,"lun"in i&&(this.imagesSettings[r].lun=i.lun),"wwn"in i&&(this.imagesSettings[r].wwn=i.wwn),this.onImageSelection({option:{name:r,selected:!0}})}),this.targetForm.patchValue({disks:n}),f().forEach(t.clients,i=>{const r=this.addInitiator();i.luns=f().map(i.luns,_=>`${_.pool}/${_.image}`),r.patchValue(i)}),t.groups.forEach((i,r)=>{const _=this.addGroup();i.disks=f().map(i.disks,c=>`${c.pool}/${c.image}`),_.patchValue(i),f().forEach(i.members,c=>{this.onGroupMemberSelection({option:new oe.O(!0,c,"")},r)})})}hasAdvancedSettings(t){return Object.values(t).length>0}get portals(){return this.targetForm.get("portals")}onPortalSelection(){this.portals.setValue(this.portals.value)}removePortal(t,o){return this.portalsSelections.forEach(n=>{n.name===o&&(n.selected=!1)}),this.portals.value.splice(t,1),this.portals.setValue(this.portals.value),!1}get disks(){return this.targetForm.get("disks")}removeImage(t,o){return this.imagesSelections.forEach(n=>{n.name===o&&(n.selected=!1)}),this.disks.value.splice(t,1),this.removeImageRefs(o),this.targetForm.get("disks").updateValueAndValidity({emitEvent:!1}),!1}removeImageRefs(t){this.initiators.controls.forEach(o=>{const n=o.value.luns.filter(i=>i!==t);o.get("luns").setValue(n)}),this.groups.controls.forEach(o=>{const n=o.value.disks.filter(i=>i!==t);o.get("disks").setValue(n)}),f().forEach(this.imagesInitiatorSelections,(o,n)=>{this.imagesInitiatorSelections[n]=o.filter(i=>i.name!==t)}),f().forEach(this.groupDiskSelections,(o,n)=>{this.groupDiskSelections[n]=o.filter(i=>i.name!==t)})}getDefaultBackstore(t){let o=this.default_backstore;const n=this.getImageById(t);return this.validFeatures(n,this.default_backstore)||this.backstores.forEach(i=>{i!==this.default_backstore&&this.validFeatures(n,i)&&(o=i)}),o}isLunIdInUse(t,o){const n=this.disks.value.filter(i=>i!==o);return this.getLunIds(n).includes(t)}getLunIds(t){return f().map(t,o=>this.imagesSettings[o].lun)}nextLunId(t){const o=this.disks.value.filter(r=>r!==t),n=this.getLunIds(o);let i=0;for(;n.includes(i);)i++;return i}getWwns(t){return f().map(t,n=>this.imagesSettings[n].wwn).filter(n=>f().isString(n)&&""!==n)}onImageSelection(t){const o=t.option;if(o.selected){if(this.imagesSettings[o.name])this.isLunIdInUse(this.imagesSettings[o.name].lun,o.name)&&(this.imagesSettings[o.name].lun=this.nextLunId(o.name));else{const n=this.getDefaultBackstore(o.name);this.imagesSettings[o.name]={backstore:n,lun:this.nextLunId(o.name)},this.imagesSettings[o.name][n]={}}f().forEach(this.imagesInitiatorSelections,(n,i)=>{n.push(new oe.O(!1,o.name,"")),this.imagesInitiatorSelections[i]=[...n]}),f().forEach(this.groupDiskSelections,(n,i)=>{n.push(new oe.O(!1,o.name,"")),this.groupDiskSelections[i]=[...n]})}else this.removeImageRefs(o.name);this.targetForm.get("disks").updateValueAndValidity({emitEvent:!1})}get initiators(){return this.targetForm.get("initiators")}addInitiator(){const t=new j.$({client_iqn:new l.hs("",{validators:[l.k0.required,h.xQ.custom("notUnique",n=>{const i=this.initiators.controls.reduce(function(r,_){return r.concat(_.value.client_iqn)},[]);return i.indexOf(n)!==i.lastIndexOf(n)}),l.k0.pattern(this.IQN_REGEX)]}),auth:new j.$({user:new l.hs(""),password:new l.hs(""),mutual_user:new l.hs(""),mutual_password:new l.hs("")}),luns:new l.hs([]),cdIsInGroup:new l.hs(!1)});this.setAuthValidator(t),this.initiators.push(t),f().forEach(this.groupMembersSelections,(n,i)=>{n.push(new oe.O(!1,"","")),this.groupMembersSelections[i]=[...n]});const o=f().map(this.targetForm.getValue("disks"),n=>new oe.O(!1,n,""));return this.imagesInitiatorSelections.push(o),t}setAuthValidator(t){h.xQ.validateIf(t.get("user"),()=>t.getValue("password")||t.getValue("mutual_user")||t.getValue("mutual_password"),[l.k0.required],[l.k0.pattern(this.USER_REGEX)],[t.get("password"),t.get("mutual_user"),t.get("mutual_password")]),h.xQ.validateIf(t.get("password"),()=>t.getValue("user")||t.getValue("mutual_user")||t.getValue("mutual_password"),[l.k0.required],[l.k0.pattern(this.PASSWORD_REGEX)],[t.get("user"),t.get("mutual_user"),t.get("mutual_password")]),h.xQ.validateIf(t.get("mutual_user"),()=>t.getValue("mutual_password"),[l.k0.required],[l.k0.pattern(this.USER_REGEX)],[t.get("user"),t.get("password"),t.get("mutual_password")]),h.xQ.validateIf(t.get("mutual_password"),()=>t.getValue("mutual_user"),[l.k0.required],[l.k0.pattern(this.PASSWORD_REGEX)],[t.get("user"),t.get("password"),t.get("mutual_user")])}removeInitiator(t){const o=this.initiators.value[t];this.initiators.removeAt(t),f().forEach(this.groupMembersSelections,(n,i)=>{n.splice(t,1),this.groupMembersSelections[i]=[...n]}),this.groups.controls.forEach(n=>{const i=n.value.members.filter(r=>r!==o.client_iqn);n.get("members").setValue(i)}),this.imagesInitiatorSelections.splice(t,1)}updatedInitiatorSelector(){this.initiators.controls.forEach(t=>{t.get("client_iqn").updateValueAndValidity({emitEvent:!1})}),f().forEach(this.groupMembersSelections,(t,o)=>{f().forEach(t,(n,i)=>{const r=n.name;n.name=this.initiators.controls[i].value.client_iqn,this.groups.controls.forEach(_=>{const c=_.value.members,u=c.indexOf(r);-1!==u&&(c[u]=n.name),_.get("members").setValue(c)})}),this.groupMembersSelections[o]=[...this.groupMembersSelections[o]]})}removeInitiatorImage(t,o,n,i){const r=t.getValue("luns");return r.splice(o,1),t.patchValue({luns:r}),this.imagesInitiatorSelections[n].forEach(_=>{_.name===i&&(_.selected=!1)}),!1}get groups(){return this.targetForm.get("groups")}addGroup(){const t=new j.$({group_id:new l.hs("",{validators:[l.k0.required]}),members:new l.hs([]),disks:new l.hs([])});this.groups.push(t);const o=f().map(this.targetForm.getValue("disks"),i=>new oe.O(!1,i,""));this.groupDiskSelections.push(o);const n=f().map(this.initiators.value,i=>new oe.O(!1,i.client_iqn,"",!i.cdIsInGroup));return this.groupMembersSelections.push(n),t}removeGroup(t){this.groups.removeAt(t),this.groupMembersSelections[t].filter(n=>n.selected).forEach(n=>{n.selected=!1,this.onGroupMemberSelection({option:n},t)}),this.groupMembersSelections.splice(t,1),this.groupDiskSelections.splice(t,1)}onGroupMemberSelection(t,o){const n=t.option;let i=[];n.selected||(i=this.groupDiskSelections[o].filter(_=>_.selected).map(_=>_.name)),this.initiators.controls.forEach((r,_)=>{r.value.client_iqn===n.name&&(r.patchValue({luns:i}),r.get("cdIsInGroup").setValue(n.selected),f().forEach(this.groupMembersSelections,c=>{c[_].enabled=!n.selected}),this.imagesInitiatorSelections[_].forEach(c=>{c.selected=i.includes(c.name)}))})}removeGroupInitiator(t,o,n){const i=t.getValue("members")[o];t.getValue("members").splice(o,1),this.onGroupMemberSelection({option:new oe.O(!1,i,"")},n)}removeGroupDisk(t,o,n){const i=t.getValue("disks")[o];t.getValue("disks").splice(o,1),this.groupDiskSelections[n].forEach(r=>{r.name===i&&(r.selected=!1)}),this.groupDiskSelections[n]=[...this.groupDiskSelections[n]]}submit(){const t=f().cloneDeep(this.targetForm.value),o={target_iqn:this.targetForm.getValue("target_iqn"),target_controls:this.targetForm.getValue("target_controls"),acl_enabled:this.targetForm.getValue("acl_enabled"),portals:[],disks:[],clients:[],groups:[]};if(this.cephIscsiConfigVersion>10){const i=this.targetForm.get("auth");i.getValue("user")||i.get("user").setValue(""),i.getValue("password")||i.get("password").setValue(""),i.getValue("mutual_user")||i.get("mutual_user").setValue(""),i.getValue("mutual_password")||i.get("mutual_password").setValue("");const r=this.targetForm.getValue("acl_enabled");o.auth={user:r?"":i.getValue("user"),password:r?"":i.getValue("password"),mutual_user:r?"":i.getValue("mutual_user"),mutual_password:r?"":i.getValue("mutual_password")}}let n;t.disks.forEach(i=>{const r=i.split("/"),_=this.imagesSettings[i].backstore;o.disks.push({pool:r[0],image:r[1],backstore:_,controls:this.imagesSettings[i][_],lun:this.imagesSettings[i].lun,wwn:this.imagesSettings[i].wwn})}),t.portals.forEach(i=>{const r=i.indexOf(":");o.portals.push({host:i.substring(0,r),ip:i.substring(r+1)})}),o.acl_enabled&&(t.initiators.forEach(i=>{i.auth.user||(i.auth.user=""),i.auth.password||(i.auth.password=""),i.auth.mutual_user||(i.auth.mutual_user=""),i.auth.mutual_password||(i.auth.mutual_password=""),delete i.cdIsInGroup;const r=[];i.luns.forEach(_=>{const c=_.split("/");r.push({pool:c[0],image:c[1]})}),i.luns=r}),o.clients=t.initiators),o.acl_enabled&&(t.groups.forEach(i=>{const r=[];i.disks.forEach(_=>{const c=_.split("/");r.push({pool:c[0],image:c[1]})}),i.disks=r}),o.groups=t.groups),this.isEdit?(o.new_target_iqn=o.target_iqn,o.target_iqn=this.target_iqn,n=this.taskWrapper.wrapTaskAroundCall({task:new R.O("iscsi/target/edit",{target_iqn:o.target_iqn}),call:this.iscsiService.updateTarget(this.target_iqn,o)})):n=this.taskWrapper.wrapTaskAroundCall({task:new R.O("iscsi/target/create",{target_iqn:o.target_iqn}),call:this.iscsiService.createTarget(o)}),n.subscribe({error:()=>{this.targetForm.setErrors({cdSubmitButton:!0})},complete:()=>this.router.navigate(["/block/iscsi/targets"])})}targetSettingsModal(){const t={target_controls:this.targetForm.get("target_controls"),target_default_controls:this.target_default_controls,target_controls_limits:this.target_controls_limits};this.modalRef=this.modalService.show(jo,t)}imageSettingsModal(t){const o={imagesSettings:this.imagesSettings,image:t,api_version:this.api_version,disk_default_controls:this.disk_default_controls,disk_controls_limits:this.disk_controls_limits,backstores:this.getValidBackstores(this.getImageById(t)),control:this.targetForm.get("disks")};this.modalRef=this.modalService.show(xo,o)}validFeatures(t,o){const n=t.features,i=this.required_rbd_features[o];return(n&i)===i&&!(n&this.unsupported_rbd_features[o])}getImageById(t){return this.imagesAll.find(o=>t===`${o.pool_name}/${o.name}`)}getValidBackstores(t){return this.backstores.filter(o=>this.validFeatures(t,o))}static \u0275fac=function(o){return new(o||s)(e.rXU(le),e.rXU(Yo.B),e.rXU(Z.U),e.rXU(p.Ix),e.rXU(p.nX),e.rXU(I.a),e.rXU(F.Ss))};static \u0275cmp=e.VBU({type:s,selectors:[["cd-iscsi-target-form"]],features:[e.Vt3],decls:1,vars:1,consts:()=>{let t,o,n,i,r,_,c,u,S,M,E,N,G,y,x,ae,re,_e,H,Ee,L,Ne,Pe,Ie,Ae,De,$e,ve,Le,B,Ze,et,tt,ot,nt,D,ao,ro,_o,lo,co,mo,uo,po,go,fo,To,So,Eo,Co,Fo,Ro,Mo,Oo,ho,bo,No,Po,Io,Ao,Do,$o;return t="" + "\ufffd0\ufffd" + " " + "\ufffd1\ufffd" + "",o="\u76EE\u6807 IQN",n="\u7AEF\u53E3",i="\u6DFB\u52A0\u7AEF\u53E3",r="\u6620\u50CF",_="\u6DFB\u52A0\u6620\u50CF",c="ACL \u8EAB\u4EFD\u9A8C\u8BC1",u="\u8FD9\u662F\u5FC5\u586B\u5B57\u6BB5\uFF01",S="IQN \u683C\u5F0F\u9519\u8BEF\u3002",M="IQN \u5E94\u7531\u4EE5\u4E0B\u683C\u5F0F\u6784\u6210\uFF1A\u201Ciqn.$year-$month.$reversedAddress:$definedName\u201D",E="\u4F8B\u5982\uFF1Aiqn.2016-06.org.dashboard:storage:disk.sn-a8675309",N="\u66F4\u591A\u4FE1\u606F",G="\u6B64\u76EE\u6807\u7684\u9AD8\u7EA7\u8BBE\u7F6E\u4FEE\u6539\u8FC7\u3002",y="\u81F3\u5C11\u9700\u8981 " + "\ufffd0\ufffd" + " \u4E2A\u7F51\u5173\u3002",x="\u540E\u5907\u5B58\u50A8\uFF1A" + "\ufffd0\ufffd" + "\u3002",ae="\u6B64\u6620\u50CF\u7684\u8BBE\u7F6E\u4FEE\u6539\u8FC7\u3002",re="\u91CD\u590D\u7684 LUN \u7F16\u53F7\u3002",_e="\u91CD\u590D\u7684 WWN\u3002",H="\u7528\u6237",Ee="\u5BC6\u7801",L="\u4E92\u8BA4\u8BC1\u7528\u6237",Ne="\u4E92\u8BA4\u8BC1\u5BC6\u7801",Pe="\u8FD9\u662F\u5FC5\u586B\u5B57\u6BB5\uFF01",Ie="\u7528\u6237\u540D\u957F\u5EA6\u5FC5\u987B\u4E3A 8 \u81F3 64 \u4E2A\u5B57\u7B26\uFF0C\u53EF\u4EE5\u5305\u542B\u5B57\u6BCD\u6570\u5B57\u5B57\u7B26\u3001\".\"\u3001\"@\"\u3001\"-\"\u3001\"_\" \u6216 \":\"\u3002",Ae="\u8FD9\u662F\u5FC5\u586B\u5B57\u6BB5\uFF01",De="\u5BC6\u7801\u957F\u5EA6\u5FC5\u987B\u4E3A 12 \u81F3 16 \u4E2A\u5B57\u7B26\uFF0C\u53EF\u4EE5\u5305\u542B\u5B57\u6BCD\u6570\u5B57\u5B57\u7B26\u3001\"@\"\u3001\"-\"\u3001\"_\" \u6216 \"/\"\u3002",$e="\u8FD9\u662F\u5FC5\u586B\u5B57\u6BB5\uFF01",ve="\u7528\u6237\u540D\u957F\u5EA6\u5FC5\u987B\u4E3A 8 \u81F3 64 \u4E2A\u5B57\u7B26\uFF0C\u53EF\u4EE5\u5305\u542B\u5B57\u6BCD\u6570\u5B57\u5B57\u7B26\u3001\".\"\u3001\"@\"\u3001\"-\"\u3001\"_\" \u6216 \":\"\u3002",Le="\u8FD9\u662F\u5FC5\u586B\u5B57\u6BB5\uFF01",B="\u5BC6\u7801\u957F\u5EA6\u5FC5\u987B\u4E3A 12 \u81F3 16 \u4E2A\u5B57\u7B26\uFF0C\u53EF\u4EE5\u5305\u542B\u5B57\u6BCD\u6570\u5B57\u5B57\u7B26\u3001\"@\"\u3001\"-\"\u3001\"_\" \u6216 \"/\"\u3002",Ze="\u6388\u6743\u4EBA",et="\u6DFB\u52A0\u6388\u6743\u4EBA",tt="\u6388\u6743\u4EBA",ot="\u5BA2\u6237\u7AEF IQN",nt="\u7528\u6237",D="\u5BC6\u7801",ao="\u4E92\u8BA4\u8BC1\u7528\u6237",ro="\u4E92\u8BA4\u8BC1\u5BC6\u7801",_o="\u6620\u50CF",lo="\u6388\u6743\u4EBA IQN \u5FC5\u987B\u552F\u4E00\u3002",co="\u8FD9\u662F\u5FC5\u586B\u5B57\u6BB5\uFF01",mo="IQN \u683C\u5F0F\u9519\u8BEF\u3002",uo="\u8FD9\u662F\u5FC5\u586B\u5B57\u6BB5\uFF01",po="\u7528\u6237\u540D\u957F\u5EA6\u5FC5\u987B\u4E3A 8 \u81F3 64 \u4E2A\u5B57\u7B26\uFF0C\u53EF\u4EE5\u5305\u542B\u5B57\u6BCD\u6570\u5B57\u5B57\u7B26\u3001\".\"\u3001\"@\"\u3001\"-\"\u3001\"_\" \u6216 \":\"\u3002",go="\u8FD9\u662F\u5FC5\u586B\u5B57\u6BB5\uFF01",fo="\u5BC6\u7801\u957F\u5EA6\u5FC5\u987B\u4E3A 12 \u81F3 16 \u4E2A\u5B57\u7B26\uFF0C\u53EF\u4EE5\u5305\u542B\u5B57\u6BCD\u6570\u5B57\u5B57\u7B26\u3001\"@\"\u3001\"-\"\u3001\"_\" \u6216 \"/\"\u3002",To="\u8FD9\u662F\u5FC5\u586B\u5B57\u6BB5\uFF01",So="\u7528\u6237\u540D\u957F\u5EA6\u5FC5\u987B\u4E3A 8 \u81F3 64 \u4E2A\u5B57\u7B26\uFF0C\u53EF\u4EE5\u5305\u542B\u5B57\u6BCD\u6570\u5B57\u5B57\u7B26\u3001\".\"\u3001\"@\"\u3001\"-\"\u3001\"_\" \u6216 \":\"\u3002",Eo="\u8FD9\u662F\u5FC5\u586B\u5B57\u6BB5\uFF01",Co="\u5BC6\u7801\u957F\u5EA6\u5FC5\u987B\u4E3A 12 \u81F3 16 \u4E2A\u5B57\u7B26\uFF0C\u53EF\u4EE5\u5305\u542B\u5B57\u6BCD\u6570\u5B57\u5B57\u7B26\u3001\"@\"\u3001\"-\"\u3001\"_\" \u6216 \"/\"\u3002",Fo="\u6388\u6743\u4EBA\u5C5E\u4E8E\u67D0\u4E2A\u7EC4\u3002\u5C06\u5728\u7EC4\u4E2D\u914D\u7F6E\u6620\u50CF\u3002",Ro="\u6DFB\u52A0\u6620\u50CF",Mo="\u672A\u6DFB\u52A0\u9879\u76EE\u3002",Oo="\u7EC4",ho="\u6DFB\u52A0\u7EC4",bo="\u7EC4",No="\u540D\u79F0",Po="\u6388\u6743\u4EBA",Io="\u6DFB\u52A0\u6388\u6743\u4EBA",Ao="\u6620\u50CF",Do="\u6DFB\u52A0\u6620\u50CF",$o="\u672A\u6DFB\u52A0\u9879\u76EE\u3002",[["formDir","ngForm"],t,o,n,i,r,_,c,u,S,M,E,N,G,y,x,ae,re,_e,H,Ee,L,Ne,Pe,Ie,Ae,De,$e,ve,Le,B,Ze,et,tt,ot,nt,D,ao,ro,_o,lo,co,mo,uo,po,go,fo,To,So,Eo,Co,Fo,Ro,Mo,Oo,ho,bo,No,Po,Io,Ao,Do,$o,["class","cd-col-form",4,"cdFormLoading"],[1,"cd-col-form"],["name","targetForm","novalidate","",3,"formGroup"],[1,"card"],[1,"card-header"],[1,"card-body"],[1,"form-group","row"],["for","target_iqn",1,"cd-col-form-label","required"],[1,"cd-col-form-input"],[1,"input-group"],["type","text","id","target_iqn","name","target_iqn","formControlName","target_iqn","cdTrim","",1,"form-control"],["id","ecp-info-button","type","button",1,"btn","btn-light",3,"click"],["aria-hidden","true",3,"ngClass"],["class","invalid-feedback",4,"ngIf"],["class","form-text text-muted",4,"ngIf"],["for","portals",1,"cd-col-form-label","required"],[4,"ngFor","ngForOf"],[1,"row"],[1,"col-md-12"],["elemClass","btn btn-light float-end",3,"selection","data","options","messages"],[3,"ngClass"],["type","hidden","id","portals","name","portals","formControlName","portals",1,"form-control"],["for","disks",1,"cd-col-form-label"],["type","hidden","id","disks","name","disks","formControlName","disks",1,"form-control"],[1,"cd-col-form-offset"],[1,"custom-control","custom-checkbox"],["type","checkbox","formControlName","acl_enabled","name","acl_enabled","id","acl_enabled",1,"custom-control-input"],["for","acl_enabled",1,"custom-control-label"],["formGroupName","auth",4,"ngIf"],["class","form-group row",4,"ngIf"],[1,"card-footer"],["wrappingClass","text-right",3,"submitActionEvent","form","submitText"],[1,"invalid-feedback"],["target","_blank","href","https://en.wikipedia.org/wiki/ISCSI#Addressing"],[1,"form-text","text-muted"],[1,"input-group","cd-mb"],["type","text","disabled","",1,"cd-form-control",3,"value"],["type","button",1,"btn","btn-light",3,"click"],["class","input-group-text",4,"ngIf"],[4,"ngIf"],[1,"input-group-text"],["formGroupName","auth"],["for","target_user",1,"cd-col-form-label"],["type","text","autocomplete","off","id","target_user","name","target_user","formControlName","user",1,"form-control"],["for","target_password",1,"cd-col-form-label"],["type","password","autocomplete","new-password","id","target_password","name","target_password","formControlName","password",1,"form-control"],["type","button","cdPasswordButton","target_password",1,"btn","btn-light"],["source","target_password"],["for","target_mutual_user",1,"cd-col-form-label"],["type","text","autocomplete","off","id","target_mutual_user","name","target_mutual_user","formControlName","mutual_user",1,"form-control"],["for","target_mutual_password",1,"cd-col-form-label"],["type","password","autocomplete","new-password","id","target_mutual_password","name","target_mutual_password","formControlName","mutual_password",1,"form-control"],["type","button","cdPasswordButton","target_mutual_password",1,"btn","btn-light"],["source","target_mutual_password"],["for","initiators",1,"cd-col-form-label"],["formArrayName","initiators",1,"cd-col-form-input"],["class","card mb-2",3,"formGroup",4,"ngFor","ngForOf"],[1,"btn","btn-light","float-end",3,"click"],[1,"card","mb-2",3,"formGroup"],["type","button",1,"btn-close","float-end",3,"click"],["for","client_iqn",1,"cd-col-form-label","required"],["type","text","formControlName","client_iqn","cdTrim","",1,"form-control",3,"blur"],["for","user",1,"cd-col-form-label"],["formControlName","user","autocomplete","off","type","text",1,"form-control",3,"id"],["for","password",1,"cd-col-form-label"],["formControlName","password","autocomplete","new-password","type","password",1,"form-control",3,"id"],["type","button",1,"btn","btn-light",3,"cdPasswordButton"],[3,"source"],["for","mutual_user",1,"cd-col-form-label"],["formControlName","mutual_user","autocomplete","off","type","text",1,"form-control",3,"id"],["for","mutual_password",1,"cd-col-form-label"],["formControlName","mutual_password","autocomplete","new-password","type","password",1,"form-control",3,"id"],["for","luns",1,"cd-col-form-label"],["class","row",4,"ngIf"],["elemClass","btn btn-light float-end",3,"data","options","messages"],["formArrayName","groups",1,"cd-col-form-input"],["for","group_id",1,"cd-col-form-label","required"],["type","text","formControlName","group_id",1,"form-control"],["for","members",1,"cd-col-form-label"]]},template:function(o,n){1&o&&e.DNE(0,Xn,65,40,"div",63),2&o&&e.Y8G("cdFormLoading",n.loading)},dependencies:[d.YU,d.Sq,d.bT,l.qT,l.me,l.Zm,l.BC,l.cb,l.j4,l.JD,l.$R,l.v8,Ko.w,it.N,V.e,Lt.h,zo.c,Gt.G,z.S,pe.a,b.C,k.E,d.PV,st.k,Be.r],styles:[".cd-mb[_ngcontent-%COMP%]{margin-bottom:10px}"]})}return s})();var pt=m(25947),ce=m(84821),W=m(62847),xe=m(2148),de=m(19380),yt=m(91653),Fe=m(58510),gt=m(88285),Ue=m(88701),U=m(82254);function kn(s,a){1&s&&(e.j41(0,"span",37),e.pXf(1,6),e.k0s())}function Vn(s,a){1&s&&(e.j41(0,"span",37),e.pXf(1,7),e.k0s())}function wn(s,a){1&s&&(e.j41(0,"span",37),e.pXf(1,8),e.k0s())}function xn(s,a){1&s&&(e.j41(0,"span",37),e.pXf(1,9),e.k0s())}function Hn(s,a){1&s&&(e.j41(0,"span",37),e.pXf(1,10),e.k0s())}function jn(s,a){1&s&&(e.j41(0,"span",37),e.pXf(1,11),e.k0s())}function Yn(s,a){1&s&&(e.j41(0,"span",37),e.pXf(1,12),e.k0s())}function Kn(s,a){1&s&&(e.j41(0,"span",37),e.pXf(1,13),e.k0s())}let zn=(()=>{class s{authStorageService;activeModal;actionLabels;iscsiService;notificationService;discoveryForm;permission;hasPermission;USER_REGEX=/^[\w\.:@_-]{8,64}$/;PASSWORD_REGEX=/^[\w@\-_\/]{12,16}$/;constructor(t,o,n,i,r){this.authStorageService=t,this.activeModal=o,this.actionLabels=n,this.iscsiService=i,this.notificationService=r,this.permission=this.authStorageService.getPermissions().iscsi}ngOnInit(){this.hasPermission=this.permission.update,this.createForm(),this.iscsiService.getDiscovery().subscribe(t=>{this.discoveryForm.patchValue(t)})}createForm(){this.discoveryForm=new j.$({user:new l.hs({value:"",disabled:!this.hasPermission}),password:new l.hs({value:"",disabled:!this.hasPermission}),mutual_user:new l.hs({value:"",disabled:!this.hasPermission}),mutual_password:new l.hs({value:"",disabled:!this.hasPermission})}),h.xQ.validateIf(this.discoveryForm.get("user"),()=>this.discoveryForm.getValue("password")||this.discoveryForm.getValue("mutual_user")||this.discoveryForm.getValue("mutual_password"),[l.k0.required],[l.k0.pattern(this.USER_REGEX)],[this.discoveryForm.get("password"),this.discoveryForm.get("mutual_user"),this.discoveryForm.get("mutual_password")]),h.xQ.validateIf(this.discoveryForm.get("password"),()=>this.discoveryForm.getValue("user")||this.discoveryForm.getValue("mutual_user")||this.discoveryForm.getValue("mutual_password"),[l.k0.required],[l.k0.pattern(this.PASSWORD_REGEX)],[this.discoveryForm.get("user"),this.discoveryForm.get("mutual_user"),this.discoveryForm.get("mutual_password")]),h.xQ.validateIf(this.discoveryForm.get("mutual_user"),()=>this.discoveryForm.getValue("mutual_password"),[l.k0.required],[l.k0.pattern(this.USER_REGEX)],[this.discoveryForm.get("user"),this.discoveryForm.get("password"),this.discoveryForm.get("mutual_password")]),h.xQ.validateIf(this.discoveryForm.get("mutual_password"),()=>this.discoveryForm.getValue("mutual_user"),[l.k0.required],[l.k0.pattern(this.PASSWORD_REGEX)],[this.discoveryForm.get("user"),this.discoveryForm.get("password"),this.discoveryForm.get("mutual_user")])}submitAction(){this.iscsiService.updateDiscovery(this.discoveryForm.value).subscribe(()=>{this.notificationService.show(gt._.success,"\u5DF2\u66F4\u65B0\u53D1\u73B0\u8EAB\u4EFD\u9A8C\u8BC1"),this.activeModal.close()},()=>{this.discoveryForm.setErrors({cdSubmitButton:!0})})}static \u0275fac=function(o){return new(o||s)(e.rXU(U.v),e.rXU(A.Lw),e.rXU(F.Ss),e.rXU(le),e.rXU(Ue.J))};static \u0275cmp=e.VBU({type:s,selectors:[["cd-iscsi-target-discovery-modal"]],decls:44,vars:13,consts:()=>{let t,o,n,i,r,_,c,u,S,M,E,N,G;return t="\u53D1\u73B0\u8EAB\u4EFD\u9A8C\u8BC1",o="\u7528\u6237",n="\u5BC6\u7801",i="\u4E92\u8BA4\u8BC1\u7528\u6237",r="\u4E92\u8BA4\u8BC1\u5BC6\u7801",_="\u8FD9\u662F\u5FC5\u586B\u5B57\u6BB5\uFF01",c="\u7528\u6237\u540D\u957F\u5EA6\u5FC5\u987B\u4E3A 8 \u81F3 64 \u4E2A\u5B57\u7B26\uFF0C\u53EF\u4EE5\u5305\u542B\u5B57\u6BCD\u6570\u5B57\u5B57\u7B26\u3001\".\"\u3001\"@\"\u3001\"-\"\u3001\"_\" \u6216 \":\"\u3002",u="\u8FD9\u662F\u5FC5\u586B\u5B57\u6BB5\uFF01",S="\u5BC6\u7801\u957F\u5EA6\u5FC5\u987B\u4E3A 12 \u81F3 16 \u4E2A\u5B57\u7B26\uFF0C\u53EF\u4EE5\u5305\u542B\u5B57\u6BCD\u6570\u5B57\u5B57\u7B26\u3001\"@\"\u3001\"-\"\u3001\"_\" \u6216 \"/\"\u3002",M="\u8FD9\u662F\u5FC5\u586B\u5B57\u6BB5\uFF01",E="\u7528\u6237\u540D\u957F\u5EA6\u5FC5\u987B\u4E3A 8 \u81F3 64 \u4E2A\u5B57\u7B26\uFF0C\u53EF\u4EE5\u5305\u542B\u5B57\u6BCD\u6570\u5B57\u5B57\u7B26\u3001\".\"\u3001\"@\"\u3001\"-\"\u3001\"_\" \u6216 \":\"\u3002",N="\u8FD9\u662F\u5FC5\u586B\u5B57\u6BB5\uFF01",G="\u5BC6\u7801\u957F\u5EA6\u5FC5\u987B\u4E3A 12 \u81F3 16 \u4E2A\u5B57\u7B26\uFF0C\u53EF\u4EE5\u5305\u542B\u5B57\u6BCD\u6570\u5B57\u5B57\u7B26\u3001\"@\"\u3001\"-\"\u3001\"_\" \u6216 \"/\"\u3002",[["formDir","ngForm"],t,o,n,i,r,_,c,u,S,M,E,N,G,[3,"modalRef"],[1,"modal-title"],[1,"modal-content"],["name","discoveryForm","novalidate","",3,"formGroup"],[1,"modal-body"],[1,"form-group","row"],["for","user",1,"cd-col-form-label"],[1,"cd-col-form-input"],["id","user","formControlName","user","type","text","autocomplete","off",1,"form-control"],["class","invalid-feedback",4,"ngIf"],["for","password",1,"cd-col-form-label"],[1,"input-group"],["id","password","formControlName","password","type","password","autocomplete","new-password",1,"form-control"],["type","button","cdPasswordButton","password",1,"btn","btn-light"],["source","password"],["for","mutual_user",1,"cd-col-form-label"],["id","mutual_user","formControlName","mutual_user","type","text","autocomplete","off",1,"form-control"],["for","mutual_password",1,"cd-col-form-label"],["id","mutual_password","formControlName","mutual_password","type","password","autocomplete","new-password",1,"form-control"],["type","button","cdPasswordButton","mutual_password",1,"btn","btn-light"],["source","mutual_password"],[1,"modal-footer"],[3,"submitActionEvent","form","showSubmit","submitText"],[1,"invalid-feedback"]]},template:function(o,n){if(1&o){const i=e.RV6();e.j41(0,"cd-modal",14),e.qex(1,15),e.pXf(2,1),e.bVm(),e.qex(3,16),e.j41(4,"form",17,0)(6,"div",18)(7,"div",19)(8,"label",20),e.pXf(9,2),e.k0s(),e.j41(10,"div",21),e.nrm(11,"input",22),e.DNE(12,kn,2,0,"span",23)(13,Vn,2,0,"span",23),e.k0s()(),e.j41(14,"div",19)(15,"label",24),e.pXf(16,3),e.k0s(),e.j41(17,"div",21)(18,"div",25),e.nrm(19,"input",26)(20,"button",27)(21,"cd-copy-2-clipboard-button",28),e.k0s(),e.DNE(22,wn,2,0,"span",23)(23,xn,2,0,"span",23),e.k0s()(),e.j41(24,"div",19)(25,"label",29),e.qex(26),e.pXf(27,4),e.bVm(),e.k0s(),e.j41(28,"div",21),e.nrm(29,"input",30),e.DNE(30,Hn,2,0,"span",23)(31,jn,2,0,"span",23),e.k0s()(),e.j41(32,"div",19)(33,"label",31),e.pXf(34,5),e.k0s(),e.j41(35,"div",21)(36,"div",25),e.nrm(37,"input",32)(38,"button",33)(39,"cd-copy-2-clipboard-button",34),e.k0s(),e.DNE(40,Yn,2,0,"span",23)(41,Kn,2,0,"span",23),e.k0s()()(),e.j41(42,"div",35)(43,"cd-form-button-panel",36),e.bIt("submitActionEvent",function(){return e.eBV(i),e.Njj(n.submitAction())}),e.k0s()()(),e.bVm(),e.k0s()}if(2&o){const i=e.sdS(5);e.Y8G("modalRef",n.activeModal),e.R7$(4),e.Y8G("formGroup",n.discoveryForm),e.R7$(8),e.Y8G("ngIf",n.discoveryForm.showError("user",i,"required")),e.R7$(),e.Y8G("ngIf",n.discoveryForm.showError("user",i,"pattern")),e.R7$(9),e.Y8G("ngIf",n.discoveryForm.showError("password",i,"required")),e.R7$(),e.Y8G("ngIf",n.discoveryForm.showError("password",i,"pattern")),e.R7$(7),e.Y8G("ngIf",n.discoveryForm.showError("mutual_user",i,"required")),e.R7$(),e.Y8G("ngIf",n.discoveryForm.showError("mutual_user",i,"pattern")),e.R7$(9),e.Y8G("ngIf",n.discoveryForm.showError("mutual_password",i,"required")),e.R7$(),e.Y8G("ngIf",n.discoveryForm.showError("mutual_password",i,"pattern")),e.R7$(2),e.Y8G("form",n.discoveryForm)("showSubmit",n.hasPermission)("submitText",n.actionLabels.SUBMIT)}},dependencies:[d.bT,l.qT,l.me,l.BC,l.cb,l.j4,l.JD,Q.z,it.N,V.e,Lt.h,z.S,pe.a,b.C,k.E]})}return s})();var Un=m(47782),me=m(94254),He=m(92805),qn=m(87837),ge=m(32295),ft=m(45843);let Xt=(()=>{class s{static \u0275fac=function(o){return new(o||s)};static \u0275cmp=e.VBU({type:s,selectors:[["cd-iscsi-tabs"]],decls:7,vars:0,consts:()=>{let t,o;return t="\u6982\u89C8",o="\u76EE\u6807",[t,o,[1,"nav","nav-tabs"],[1,"nav-item"],["routerLink","/block/iscsi/overview","routerLinkActive","active","ariaCurrentWhenActive","page",1,"nav-link"],["routerLink","/block/iscsi/targets","routerLinkActive","active","ariaCurrentWhenActive","page",1,"nav-link"]]},template:function(o,n){1&o&&(e.j41(0,"ul",2)(1,"li",3)(2,"a",4),e.pXf(3,0),e.k0s()(),e.j41(4,"li",3)(5,"a",5),e.pXf(6,1),e.k0s()()())},dependencies:[p.Wk,p.wQ]})}return s})();var Qn=m(30540),Wn=m(91822),kt=m(45269);const Jn=["highlightTpl"],Zn=["detailTable"],es=["treeNodeTemplate"],ts=()=>["logged_in"],os=()=>["logged_out"],ns=(s,a)=>({"badge-success":s,"badge-danger":a});function ss(s,a){if(1&s&&(e.nrm(0,"i"),e.j41(1,"span"),e.EFF(2),e.k0s(),e.EFF(3," \xa0 "),e.j41(4,"span",9),e.EFF(5),e.k0s()),2&s){const t=a.$implicit;e.HbH(null==t?null:t.cdIcon),e.R7$(2),e.JRh(null==t?null:t.name),e.R7$(2),e.Y8G("ngClass",e.l_i(7,ns,e.lJ4(5,ts).includes(null==t?null:t.status),e.lJ4(6,os).includes(null==t?null:t.status))),e.R7$(),e.SpI(" ",null==t?null:t.status," ")}}function is(s,a){if(1&s&&(e.j41(0,"div",10)(1,"legend"),e.EFF(2),e.k0s(),e.nrm(3,"cd-table",11,3),e.k0s()),2&s){const t=e.XpG();e.R7$(2),e.JRh(t.title),e.R7$(),e.Y8G("data",t.data)("columns",t.columns)("limit",0)}}function as(s,a){if(1&s&&(e.j41(0,"span"),e.EFF(1),e.k0s()),2&s){const t=e.XpG().data.value;e.R7$(),e.JRh(t)}}function rs(s,a){if(1&s&&(e.j41(0,"strong"),e.EFF(1),e.k0s()),2&s){const t=e.XpG().data.value;e.R7$(),e.JRh(t)}}function _s(s,a){if(1&s&&e.DNE(0,as,2,1,"span",12)(1,rs,2,1,"strong",12),2&s){const t=a.data.row;e.Y8G("ngIf",void 0===t.default||t.default===t.current),e.R7$(),e.Y8G("ngIf",void 0!==t.default&&t.default!==t.current)}}let ls=(()=>{class s{iscsiBackstorePipe;booleanTextPipe;treeViewService;selection;settings;cephIscsiConfigVersion;highlightTpl;detailTable;set content(t){this.detailTable=t,t&&t.updateColumns()}labelTpl;icons=C.F;columns;data;metadata={};selectedItem;title;nodes=[];constructor(t,o,n){this.iscsiBackstorePipe=t,this.booleanTextPipe=o,this.treeViewService=n}ngOnInit(){this.columns=[{prop:"displayName",name:"\u540D\u79F0",flexGrow:1,cellTemplate:this.highlightTpl},{prop:"current",name:"\u5F53\u524D",flexGrow:1,cellTemplate:this.highlightTpl},{prop:"default",name:"\u9ED8\u8BA4\u503C",flexGrow:1,cellTemplate:this.highlightTpl}]}ngOnChanges(){this.selection&&(this.selectedItem=this.selection,this.generateTree()),this.data=void 0}generateTree(){const t=f().cloneDeep(this.selectedItem.target_controls);this.cephIscsiConfigVersion>10&&f().extend(t,f().cloneDeep(this.selectedItem.auth)),this.metadata={root:t};const o={target:{expanded:f().join(this.selectedItem.cdExecuting?[C.F.large,C.F.spinner,C.F.spin]:[C.F.large,C.F.bullseye]," ")},initiators:{expanded:f().join([C.F.large,C.F.user]," "),leaf:f().join([C.F.user]," ")},groups:{expanded:f().join([C.F.large,C.F.users]," "),leaf:f().join([C.F.users]," ")},disks:{expanded:f().join([C.F.large,C.F.disk]," "),leaf:f().join([C.F.disk]," ")},portals:{expanded:f().join([C.F.large,C.F.server]," "),leaf:f().join([C.F.server]," ")}},n=[];f().forEach(this.selectedItem.disks,c=>{const u="disk_"+c.pool+"_"+c.image;this.metadata[u]={controls:c.controls,backstore:c.backstore},["wwn","lun"].forEach(S=>{S in c&&(this.metadata[u][S]=c[S])}),n.push({id:u,name:`${c.pool}/${c.image}`,label:`${c.pool}/${c.image}`,value:{cdIcon:o.disks.leaf}})});const i=[];f().forEach(this.selectedItem.portals,c=>{i.push({label:this.labelTpl,labelContext:{name:`${c.host}:${c.ip}`,cdIcon:o.portals.leaf},value:{name:`${c.host}:${c.ip}`,cdIcon:o.portals.leaf}})});const r=[];f().forEach(this.selectedItem.clients,c=>{const u=f().cloneDeep(c.auth);c.info&&(f().extend(u,c.info),delete u.state,f().forEach(Object.keys(c.info.state),E=>{u[E.toLowerCase()]=c.info.state[E]})),this.metadata["client_"+c.client_iqn]=u;const S=[];c.luns.forEach(E=>{S.push({label:this.labelTpl,labelContext:{name:`${E.pool}/${E.image}`,cdIcon:o.disks.leaf},value:{name:`${E.pool}/${E.image}`,cdIcon:o.disks.leaf},id:"disk_"+E.pool+"_"+E.image})});let M="";c.info&&(M=Object.keys(c.info.state).includes("LOGGED_IN")?"logged_in":"logged_out"),r.push({label:this.labelTpl,labelContext:{name:c.client_iqn,status:M,cdIcon:o.initiators.leaf},value:{name:c.client_iqn,status:M,cdIcon:o.initiators.leaf},id:"client_"+c.client_iqn,children:S})});const _=[];f().forEach(this.selectedItem.groups,c=>{const u=[];c.disks.forEach(M=>{u.push({label:this.labelTpl,labelContext:{name:`${M.pool}/${M.image}`,cdIcon:o.disks.leaf},value:{name:`${M.pool}/${M.image}`,cdIcon:o.disks.leaf},id:"disk_"+M.pool+"_"+M.image})});const S=[];c.members.forEach(M=>{S.push({label:this.labelTpl,labelContext:{name:M},value:{name:M},id:"client_"+M})}),_.push({label:this.labelTpl,labelContext:{name:c.group_id,cdIcon:o.groups.leaf},value:{name:c.group_id,cdIcon:o.groups.leaf},children:[{label:this.labelTpl,labelContext:{name:"Disks",cdIcon:o.disks.expanded},value:{name:"Disks",cdIcon:o.disks.expanded},children:u},{label:this.labelTpl,labelContext:{name:"Initiators",cdIcon:o.initiators.expanded},value:{name:"Initiators",cdIcon:o.initiators.expanded},children:S}]})}),this.nodes=[{id:"root",label:this.labelTpl,labelContext:{name:this.selectedItem.target_iqn,cdIcon:o.target.expanded},value:{name:this.selectedItem.target_iqn,cdIcon:o.target.expanded},expanded:!0,children:[{label:this.labelTpl,labelContext:{name:"Disks",cdIcon:o.disks.expanded},value:{name:"Disks",cdIcon:o.disks.expanded},expanded:!0,children:n},{label:this.labelTpl,labelContext:{name:"Portals",cdIcon:o.portals.expanded},value:{name:"Portals",cdIcon:o.portals.expanded},expanded:!0,children:i},{label:this.labelTpl,labelContext:{name:"Initiators",cdIcon:o.initiators.expanded},value:{name:"Initiators",cdIcon:o.initiators.expanded},expanded:!0,children:r},{label:this.labelTpl,labelContext:{name:"Groups",cdIcon:o.groups.expanded},value:{name:"Groups",cdIcon:o.groups.expanded},expanded:!0,children:_}]}]}format(t){return"boolean"==typeof t?this.booleanTextPipe.transform(t):t}onNodeSelected(t){if(t.id){this.title=t?.value?.name;const o=this.metadata[t.id]||{};"root"===t.id?(this.detailTable?.toggleColumn({prop:"default",isHidden:!0}),this.data=f().map(this.settings.target_default_controls,(n,i)=>({displayName:i,default:n=this.format(n),current:f().isUndefined(o[i])?n:this.format(o[i])})),this.cephIscsiConfigVersion>10&&["user","password","mutual_user","mutual_password"].forEach(n=>{this.data.push({displayName:n,default:null,current:o[n]})})):t.id.toString().startsWith("disk_")?(this.detailTable?.toggleColumn({prop:"default",isHidden:!0}),this.data=f().map(this.settings.disk_default_controls[o.backstore],(n,i)=>({displayName:i,default:n=this.format(n),current:f().isUndefined(o.controls[i])?n:this.format(o.controls[i])})),this.data.push({displayName:"backstore",default:this.iscsiBackstorePipe.transform(this.settings.default_backstore),current:this.iscsiBackstorePipe.transform(o.backstore)}),["wwn","lun"].forEach(n=>{n in o&&this.data.push({displayName:n,default:void 0,current:o[n]})})):(this.detailTable?.toggleColumn({prop:"default",isHidden:!1}),this.data=f().map(o,(n,i)=>({displayName:i,default:void 0,current:this.format(n)})))}else this.data=void 0;this.detailTable?.updateColumns()}static \u0275fac=function(o){return new(o||s)(e.rXU(st.k),e.rXU(Wn.s),e.rXU(Qn.X))};static \u0275cmp=e.VBU({type:s,selectors:[["cd-iscsi-target-details"]],viewQuery:function(o,n){if(1&o&&(e.GBs(Jn,7),e.GBs(Zn,5),e.GBs(es,7)),2&o){let i;e.mGM(i=e.lsd())&&(n.highlightTpl=i.first),e.mGM(i=e.lsd())&&(n.content=i.first),e.mGM(i=e.lsd())&&(n.labelTpl=i.first)}},inputs:{selection:"selection",settings:"settings",cephIscsiConfigVersion:"cephIscsiConfigVersion"},features:[e.OA$],decls:11,vars:2,consts:()=>{let t;return t="iSCSI \u7ED3\u6784\u56FE",[["tree",""],["treeNodeTemplate",""],["highlightTpl",""],["detailTable",""],t,[1,"row"],[1,"col-6","card-tree"],[3,"select","tree"],["class","col-6 metadata",4,"ngIf"],[1,"badge",3,"ngClass"],[1,"col-6","metadata"],["columnMode","flex",3,"data","columns","limit"],[4,"ngIf"]]},template:function(o,n){if(1&o){const i=e.RV6();e.j41(0,"div",5)(1,"div",6)(2,"legend"),e.pXf(3,4),e.k0s(),e.j41(4,"cds-tree-view",7,0),e.bIt("select",function(_){return e.eBV(i),e.Njj(n.onNodeSelected(_))}),e.k0s(),e.DNE(6,ss,6,10,"ng-template",null,1,e.C5r),e.k0s(),e.DNE(8,is,5,4,"div",8),e.k0s(),e.DNE(9,_s,2,2,"ng-template",null,2,e.C5r)}2&o&&(e.R7$(4),e.Y8G("tree",n.nodes),e.R7$(4),e.Y8G("ngIf",n.data))},dependencies:[d.YU,d.bT,W.O,kt.xf],styles:[".card-tree[_ngcontent-%COMP%]{height:50vh;overflow-y:auto}"]})}return s})();const cs=s=>[s];function ds(s,a){if(1&s&&(e.qex(0),e.nrm(1,"br"),e.j41(2,"span"),e.pXf(3,2),e.k0s(),e.j41(4,"pre"),e.EFF(5),e.k0s(),e.bVm()),2&s){const t=e.XpG(2);e.R7$(5),e.JRh(t.status)}}function ms(s,a){if(1&s&&(e.j41(0,"cd-alert-panel",6),e.qex(1),e.PLo(2,1),e.nrm(3,"cd-doc",7),e.YFu(),e.bVm(),e.DNE(4,ds,6,1,"ng-container",8),e.k0s()),2&s){const t=e.XpG();e.R7$(4),e.Y8G("ngIf",t.status)}}function us(s,a){if(1&s&&e.nrm(0,"cd-iscsi-target-details",15),2&s){const t=e.XpG(3);e.Y8G("cephIscsiConfigVersion",t.cephIscsiConfigVersion)("selection",t.expandedRow)("settings",t.settings)}}function ps(s,a){1&s&&(e.qex(0),e.DNE(1,us,1,3,"cd-iscsi-target-details",14),e.bVm())}function gs(s,a){if(1&s){const t=e.RV6();e.j41(0,"cd-table",9,0),e.bIt("fetchData",function(){e.eBV(t);const n=e.XpG();return e.Njj(n.getTargets())})("setExpandedRow",function(n){e.eBV(t);const i=e.XpG();return e.Njj(i.setExpandedRow(n))})("updateSelection",function(n){e.eBV(t);const i=e.XpG();return e.Njj(i.updateSelection(n))}),e.j41(2,"div",10),e.nrm(3,"cd-table-actions",11),e.j41(4,"button",12),e.bIt("click",function(){e.eBV(t);const n=e.XpG();return e.Njj(n.configureDiscoveryAuth())}),e.nrm(5,"i",13),e.qex(6),e.pXf(7,3),e.bVm(),e.k0s()(),e.DNE(8,ps,2,0,"ng-container",8),e.k0s()}if(2&s){const t=e.XpG();e.Y8G("data",t.targets)("columns",t.columns)("hasDetails",!0)("autoReload",!1)("status",t.tableStatus),e.R7$(3),e.Y8G("permission",t.permission)("selection",t.selection)("tableActions",t.tableActions),e.R7$(2),e.Y8G("ngClass",e.eq3(10,cs,t.icons.key)),e.R7$(3),e.Y8G("ngIf",t.expandedRow)}}let fs=(()=>{class s extends pt.D{authStorageService;iscsiService;joinPipe;taskListService;notAvailablePipe;modalService;taskWrapper;actionLabels;ngZone;table;available=void 0;columns;modalRef;permission;selection=new de.y;cephIscsiConfigVersion;settings;status;summaryDataSubscription;tableActions;targets=[];icons=C.F;builders={"iscsi/target/create":t=>({target_iqn:t.target_iqn})};constructor(t,o,n,i,r,_,c,u,S){super(S),this.authStorageService=t,this.iscsiService=o,this.joinPipe=n,this.taskListService=i,this.notAvailablePipe=r,this.modalService=_,this.taskWrapper=c,this.actionLabels=u,this.ngZone=S,this.permission=this.authStorageService.getPermissions().iscsi,this.tableActions=[{permission:"create",icon:C.F.add,routerLink:()=>"/block/iscsi/targets/create",name:this.actionLabels.CREATE},{permission:"update",icon:C.F.edit,routerLink:()=>`/block/iscsi/targets/edit/${this.selection.first().target_iqn}`,name:this.actionLabels.EDIT,disable:()=>this.getEditDisableDesc()},{permission:"delete",icon:C.F.destroy,click:()=>this.deleteIscsiTargetModal(),name:this.actionLabels.DELETE,disable:()=>this.getDeleteDisableDesc()}]}ngOnInit(){this.columns=[{name:"\u76EE\u6807",prop:"target_iqn",flexGrow:2,cellTransformation:xe.x.executing},{name:"\u7AEF\u53E3",prop:"cdPortals",pipe:this.joinPipe,flexGrow:2},{name:"\u6620\u50CF",prop:"cdImages",pipe:this.joinPipe,flexGrow:2},{name:"\u4F1A\u8BDD\u6570\u91CF",prop:"info.num_sessions",pipe:this.notAvailablePipe,flexGrow:1}],this.iscsiService.status().subscribe(t=>{this.available=t.available,t.available||(this.status=t.message)})}getTargets(){this.available&&(this.setTableRefreshTimeout(),this.iscsiService.version().subscribe(t=>{this.cephIscsiConfigVersion=t.ceph_iscsi_config_version}),this.taskListService.init(()=>this.iscsiService.listTargets(),t=>this.prepareResponse(t),t=>this.targets=t,()=>this.onFetchError(),this.taskFilter,this.itemFilter,this.builders),this.iscsiService.settings().subscribe(t=>{this.settings=t}))}ngOnDestroy(){this.summaryDataSubscription&&this.summaryDataSubscription.unsubscribe()}getEditDisableDesc(){const t=this.selection.first();return t&&t?.cdExecuting?t.cdExecuting:t&&f().isUndefined(t?.info)?"\u4E0D\u53EF\u7528\u7684\u7F51\u5173":!t}getDeleteDisableDesc(){const t=this.selection.first();return t?.cdExecuting?t.cdExecuting:t&&f().isUndefined(t?.info)?"\u4E0D\u53EF\u7528\u7684\u7F51\u5173":t&&t?.info?.num_sessions?"\u76EE\u6807\u5177\u6709\u6D3B\u8DC3\u4F1A\u8BDD":!t}prepareResponse(t){return t.forEach(o=>{o.cdPortals=o.portals.map(n=>`${n.host}:${n.ip}`),o.cdImages=o.disks.map(n=>`${n.pool}/${n.image}`)}),t}onFetchError(){this.table.reset()}itemFilter(t,o){return t.target_iqn===o.metadata.target_iqn}taskFilter(t){return["iscsi/target/create","iscsi/target/edit","iscsi/target/delete"].includes(t.name)}updateSelection(t){this.selection=t}deleteIscsiTargetModal(){const t=this.selection.first().target_iqn;this.modalRef=this.modalService.show(ce.D,{itemDescription:"iSCSI \u76EE\u6807",itemNames:[t],submitActionObservable:()=>this.taskWrapper.wrapTaskAroundCall({task:new R.O("iscsi/target/delete",{target_iqn:t}),call:this.iscsiService.deleteTarget(t)})})}configureDiscoveryAuth(){this.modalService.show(zn)}static \u0275fac=function(o){return new(o||s)(e.rXU(U.v),e.rXU(le),e.rXU(Un.r),e.rXU(Fe.D),e.rXU(yt.z),e.rXU(me.V),e.rXU(I.a),e.rXU(F.Ss),e.rXU(e.SKi))};static \u0275cmp=e.VBU({type:s,selectors:[["cd-iscsi-target-list"]],viewQuery:function(o,n){if(1&o&&e.GBs(W.O,5),2&o){let i;e.mGM(i=e.lsd())&&(n.table=i.first)}},features:[e.Jv_([Fe.D]),e.Vt3],decls:3,vars:2,consts:()=>{let t,o,n,i;return t="\u6CA1\u6709\u53EF\u7528\u7684 iSCSI \u76EE\u6807",o="Please consult the\xA0" + "\ufffd#3\ufffd" + "" + "\ufffd/#3\ufffd" + "\xA0on how to configure and enable the iSCSI Targets management functionality.",n="\u53EF\u7528\u4FE1\u606F\uFF1A",i="\u53D1\u73B0\u8EAB\u4EFD\u9A8C\u8BC1",[["table",""],o,n,i,["type","info","title",t,4,"ngIf"],["columnMode","flex","identifier","target_iqn","forceIdentifier","true","selectionType","single",3,"data","columns","hasDetails","autoReload","status","fetchData","setExpandedRow","updateSelection",4,"ngIf"],["type","info","title",t],["section","iscsi"],[4,"ngIf"],["columnMode","flex","identifier","target_iqn","forceIdentifier","true","selectionType","single",3,"fetchData","setExpandedRow","updateSelection","data","columns","hasDetails","autoReload","status"],[1,"table-actions"],[1,"btn-group",3,"permission","selection","tableActions"],["type","button",1,"btn","btn-light",3,"click"],["aria-hidden","true",3,"ngClass"],[3,"cephIscsiConfigVersion","selection","settings",4,"cdTableDetail"],[3,"cephIscsiConfigVersion","selection","settings"]]},template:function(o,n){1&o&&(e.nrm(0,"cd-iscsi-tabs"),e.DNE(1,ms,5,1,"cd-alert-panel",4)(2,gs,9,12,"cd-table",5)),2&o&&(e.R7$(),e.Y8G("ngIf",!1===n.available),e.R7$(),e.Y8G("ngIf",!0===n.available))},dependencies:[d.YU,d.bT,He.m,qn.C,W.O,ge.j,ft.N,z.S,Xt,ls]})}return s})();var Tt=m(18457),Ts=m(5661),Ss=m(39113);const Es=["iscsiSparklineTpl"],Cs=["iscsiPerSecondTpl"],Fs=["iscsiRelativeDateTpl"];function Rs(s,a){if(1&s&&(e.j41(0,"span"),e.nrm(1,"cd-sparkline",9),e.k0s()),2&s){const t=e.XpG(),o=t.data.row,n=t.data.value;e.R7$(),e.Y8G("data",n)("isBinary",o.cdIsBinary)}}function Ms(s,a){1&s&&(e.j41(0,"span",10),e.EFF(1," n/a "),e.k0s())}function Os(s,a){if(1&s&&e.DNE(0,Rs,2,2,"span",7)(1,Ms,2,0,"span",8),2&s){const t=a.data.row;e.Y8G("ngIf","user:rbd"===t.backstore),e.R7$(),e.Y8G("ngIf","user:rbd"!==t.backstore)}}function hs(s,a){if(1&s&&(e.j41(0,"span"),e.EFF(1),e.k0s()),2&s){const t=e.XpG().data.value;e.R7$(),e.SpI(" ",t," /s ")}}function bs(s,a){1&s&&(e.j41(0,"span",10),e.EFF(1," n/a "),e.k0s())}function Ns(s,a){if(1&s&&e.DNE(0,hs,2,1,"span",7)(1,bs,2,0,"span",8),2&s){const t=a.data.row;e.Y8G("ngIf","user:rbd"===t.backstore),e.R7$(),e.Y8G("ngIf","user:rbd"!==t.backstore)}}function Ps(s,a){if(1&s&&(e.j41(0,"span"),e.EFF(1),e.nI1(2,"relativeDate"),e.nI1(3,"notAvailable"),e.k0s()),2&s){const t=e.XpG().data.value;e.R7$(),e.SpI(" ",e.bMT(3,3,e.bMT(2,1,t))," ")}}function Is(s,a){1&s&&(e.j41(0,"span",10),e.EFF(1," n/a "),e.k0s())}function As(s,a){if(1&s&&e.DNE(0,Ps,4,5,"span",7)(1,Is,2,0,"span",8),2&s){const t=a.data.row;e.Y8G("ngIf","user:rbd"===t.backstore),e.R7$(),e.Y8G("ngIf","user:rbd"!==t.backstore)}}let Ds=(()=>{class s{iscsiService;dimlessPipe;iscsiBackstorePipe;iscsiSparklineTpl;iscsiPerSecondTpl;iscsiRelativeDateTpl;gateways=[];gatewaysColumns;images=[];imagesColumns;constructor(t,o,n){this.iscsiService=t,this.dimlessPipe=o,this.iscsiBackstorePipe=n}ngOnInit(){this.gatewaysColumns=[{name:"\u540D\u79F0",prop:"name"},{name:"\u72B6\u6001",prop:"state",flexGrow:1,cellTransformation:xe.x.badge,customTemplateConfig:{map:{up:{class:"badge-success"},down:{class:"badge-danger"}}}},{name:"\u76EE\u6807\u6570\u91CF",prop:"num_targets"},{name:"\u4F1A\u8BDD\u6570\u91CF",prop:"num_sessions"}],this.imagesColumns=[{name:"\u5B58\u50A8\u6C60",prop:"pool"},{name:"\u6620\u50CF",prop:"image"},{name:"\u540E\u5907\u5B58\u50A8",prop:"backstore",pipe:this.iscsiBackstorePipe},{name:"\u8BFB\u5B57\u8282\u6570",prop:"stats_history.rd_bytes",cellTemplate:this.iscsiSparklineTpl},{name:"\u5199\u5B57\u8282\u6570",prop:"stats_history.wr_bytes",cellTemplate:this.iscsiSparklineTpl},{name:"\u8BFB\u64CD\u4F5C\u6570",prop:"stats.rd",pipe:this.dimlessPipe,cellTemplate:this.iscsiPerSecondTpl},{name:"\u5199\u64CD\u4F5C\u6570",prop:"stats.wr",pipe:this.dimlessPipe,cellTemplate:this.iscsiPerSecondTpl},{name:"\u6D3B\u52A8/\u4F18\u5316\u5F00\u59CB\u65F6\u95F4",prop:"optimized_since",cellTemplate:this.iscsiRelativeDateTpl}]}refresh(){this.iscsiService.overview().subscribe(t=>{this.gateways=t.gateways,this.images=t.images,this.images.map(o=>(o.stats_history&&(o.stats_history.rd_bytes=o.stats_history.rd_bytes.map(n=>n[1]),o.stats_history.wr_bytes=o.stats_history.wr_bytes.map(n=>n[1])),o.cdIsBinary=!0,o))})}static \u0275fac=function(o){return new(o||s)(e.rXU(le),e.rXU(Tt.u),e.rXU(st.k))};static \u0275cmp=e.VBU({type:s,selectors:[["cd-iscsi"]],viewQuery:function(o,n){if(1&o&&(e.GBs(Es,7),e.GBs(Cs,7),e.GBs(Fs,7)),2&o){let i;e.mGM(i=e.lsd())&&(n.iscsiSparklineTpl=i.first),e.mGM(i=e.lsd())&&(n.iscsiPerSecondTpl=i.first),e.mGM(i=e.lsd())&&(n.iscsiRelativeDateTpl=i.first)}},decls:15,vars:4,consts:()=>{let t,o;return t="\u7F51\u5173",o="\u6620\u50CF",[["iscsiSparklineTpl",""],["iscsiPerSecondTpl",""],["iscsiRelativeDateTpl",""],t,o,[3,"fetchData","data","columns"],[3,"data","columns"],[4,"ngIf"],["class","text-muted",4,"ngIf"],[3,"data","isBinary"],[1,"text-muted"]]},template:function(o,n){if(1&o){const i=e.RV6();e.nrm(0,"cd-iscsi-tabs"),e.j41(1,"legend"),e.pXf(2,3),e.k0s(),e.j41(3,"div")(4,"cd-table",5),e.bIt("fetchData",function(){return e.eBV(i),e.Njj(n.refresh())}),e.k0s()(),e.j41(5,"legend"),e.pXf(6,4),e.k0s(),e.j41(7,"div"),e.nrm(8,"cd-table",6),e.k0s(),e.DNE(9,Os,2,2,"ng-template",null,0,e.C5r)(11,Ns,2,2,"ng-template",null,1,e.C5r)(13,As,2,2,"ng-template",null,2,e.C5r)}2&o&&(e.R7$(4),e.Y8G("data",n.gateways)("columns",n.gatewaysColumns),e.R7$(4),e.Y8G("data",n.images)("columns",n.imagesColumns))},dependencies:[d.bT,Ts.B,W.O,Xt,Ss.D,yt.z]})}return s})();var P=m(95269),K=m(96930),ye=m(65645),je=m(12342),qe=m(43074),Ye=m(13313),$s={elem:"svg",attrs:{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 32 32",fill:"currentColor",width:32,height:32},content:[{elem:"path",attrs:{d:"M2 26H30V28H2zM25.4 9c.8-.8.8-2 0-2.8 0 0 0 0 0 0l-3.6-3.6c-.8-.8-2-.8-2.8 0 0 0 0 0 0 0l-15 15V24h6.4L25.4 9zM20.4 4L24 7.6l-3 3L17.4 7 20.4 4zM6 22v-3.6l10-10 3.6 3.6-10 10H6z"}}],name:"edit",size:32},vs={elem:"svg",attrs:{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 32 32",fill:"currentColor",width:32,height:32},content:[{elem:"path",attrs:{d:"M13 24L4 15 5.414 13.586 13 21.171 26.586 7.586 28 9 13 24z"}}],name:"checkmark",size:32},Vt=m(88263),Ls={elem:"svg",attrs:{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 32 32",fill:"currentColor",width:16,height:16},content:[{elem:"path",attrs:{d:"M30 24L26 24 26 20 24 20 24 24 20 24 20 26 24 26 24 30 26 30 26 26 30 26 30 24z"}},{elem:"path",attrs:{d:"M16,28H8V4h8v6a2.0058,2.0058,0,0,0,2,2h6v4h2V10a.9092.9092,0,0,0-.3-.7l-7-7A.9087.9087,0,0,0,18,2H8A2.0058,2.0058,0,0,0,6,4V28a2.0058,2.0058,0,0,0,2,2h8ZM18,4.4,23.6,10H18Z"}}],name:"document--add",size:16},Gs={elem:"svg",attrs:{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 32 32",fill:"currentColor",width:16,height:16},content:[{elem:"path",attrs:{d:"M28 19L14.83 19 17.41 16.41 16 15 11 20 16 25 17.41 23.59 14.83 21 28 21 28 19z"}},{elem:"path",attrs:{d:"M24,14V10a1,1,0,0,0-.29-.71l-7-7A1,1,0,0,0,16,2H6A2,2,0,0,0,4,4V28a2,2,0,0,0,2,2H22a2,2,0,0,0,2-2V26H22v2H6V4h8v6a2,2,0,0,0,2,2h6v2Zm-8-4V4.41L21.59,10Z"}}],name:"document--import",size:16};let Bs=(()=>{class s{iconService;constructor(t){this.iconService=t,this.iconService.registerAll([$s,vs,Vt.A,Ls,Gs])}static \u0275fac=function(o){return new(o||s)(e.KVO(Ye.fM))};static \u0275mod=e.$C({type:s});static \u0275inj=e.G2t({imports:[d.MD,Ce.G,A.Pv,p.iI,l.YN,l.X1,A.Gk,A.n8,P.Q_,K.x1,ye.q4,g.py,je.pc,qe.tm,Ye.op]})}return s})();var ys=m(66313),fe=m(6872),St=m(91151),Xs=m(37480),wt=m(15065),ks=m(35141),Xe=m(23603),be=m(51862);function Vs(s,a){1&s&&(e.j41(0,"span",28),e.pXf(1,8),e.k0s())}function ws(s,a){if(1&s&&e.DNE(0,Vs,2,0,"span",21),2&s){const t=e.XpG(),o=e.sdS(6);e.Y8G("ngIf",t.createBootstrapForm.showError("siteName",o,"required"))}}function xs(s,a){if(1&s&&(e.qex(0),e.j41(1,"cds-checkbox",29),e.EFF(2),e.k0s(),e.bVm()),2&s){const t=a.$implicit;e.R7$(),e.Y8G("id",t.name)("name",t.name)("formControlName",t.name),e.R7$(),e.SpI(" ",t.name," ")}}function Hs(s,a){1&s&&(e.j41(0,"span",28),e.pXf(1,9),e.k0s())}let js=(()=>{class s extends P.dW{rbdMirroringService;taskWrapper;changeDetectorRef;siteName;pools=[];token;subs;createBootstrapForm;constructor(t,o,n,i){super(),this.rbdMirroringService=t,this.taskWrapper=o,this.changeDetectorRef=n,this.siteName=i,this.createForm()}ngAfterViewInit(){this.changeDetectorRef.detectChanges()}createForm(){this.createBootstrapForm=new j.$({siteName:new l.hs("",{validators:[l.k0.required]}),pools:new l.J3({},{validators:[this.validatePools()]}),token:new l.hs("",{})})}ngOnInit(){this.createBootstrapForm.get("siteName").setValue(this.siteName),this.rbdMirroringService.getSiteName().subscribe(t=>{this.createBootstrapForm.get("siteName").setValue(t.site_name)}),this.subs=this.rbdMirroringService.subscribeSummary(t=>{this.pools=t.content_data.pools.reduce((i,r)=>(i.push({name:r.name,mirror_mode:r.mirror_mode}),i),[]);const n=this.createBootstrapForm.get("pools");f().each(this.pools,i=>{const r=i.name,_="disabled"===i.mirror_mode,c=n.controls[r];c?_&&c.disabled?c.enable():!_&&c.enabled&&(c.disable(),c.setValue(!0)):n.addControl(r,new l.hs({value:!_,disabled:!_}))})})}ngOnDestroy(){this.subs&&this.subs.unsubscribe()}validatePools(){return t=>{let o=0;return f().each(t.controls,n=>{!0===n.value&&++o}),o>0?null:{requirePool:!0}}}generate(){this.createBootstrapForm.get("token").setValue("");let t="";const o=[],n=this.createBootstrapForm.get("pools");f().each(n.controls,(u,S)=>{!0===u.value&&(t=S,u.disabled||o.push(S))});const i={mirror_mode:"image"},r=(0,St.x)(this.rbdMirroringService.setSiteName(this.createBootstrapForm.getValue("siteName")),(0,J.p)(o.map(u=>this.rbdMirroringService.updatePool(u,i))),this.rbdMirroringService.createBootstrapToken(t).pipe((0,Xs.M)(u=>this.createBootstrapForm.get("token").setValue(u.token)))).pipe((0,wt.H)()),_=()=>{this.rbdMirroringService.refresh(),this.createBootstrapForm.setErrors({cdSubmitButton:!0})};this.taskWrapper.wrapTaskAroundCall({task:new R.O("rbd/mirroring/bootstrap/create",{}),call:r}).subscribe({error:_,complete:_})}static \u0275fac=function(o){return new(o||s)(e.rXU(fe.B),e.rXU(I.a),e.rXU(e.gRc),e.rXU("siteName",8))};static \u0275cmp=e.VBU({type:s,selectors:[["cd-bootstrap-create-modal"]],features:[e.Vt3],decls:31,vars:11,consts:()=>{let t,o,n,i,r,_,c,u,S,M;return t="\u540D\u79F0...",o="\u751F\u6210\u7684\u4EE4\u724C...",n="\u521B\u5EFA\u5F15\u5BFC\u4EE4\u724C",i="\u8981\u521B\u5EFA\u53EF\u7531\u5BF9\u7B49\u7AD9\u70B9\u96C6\u7FA4\u5BFC\u5165\u7684\u5F15\u5BFC\u4EE4\u724C\uFF0C\u8BF7\u63D0\u4F9B\u672C\u5730\u7AD9\u70B9\u7684\u540D\u79F0\uFF0C\u9009\u62E9\u5C06\u4E3A\u5176\u542F\u7528\u955C\u50CF\u7684\u5B58\u50A8\u6C60\uFF0C \u7136\u540E\u70B9\u51FB" + "\ufffd#10\ufffd" + "\u751F\u6210" + "\ufffd/#10\ufffd" + "\u3002",r="Site Name " + "\ufffd#14\ufffd\ufffd/#14\ufffd" + "",_="\u5B58\u50A8\u6C60",c="\u751F\u6210",u="Token " + "\ufffd#28\ufffd" + "          " + "\ufffd/#28\ufffd" + "",S="\u8FD9\u662F\u5FC5\u586B\u5B57\u6BB5\uFF01",M="\u81F3\u5C11\u9700\u6307\u5B9A\u4E00\u4E2A\u5B58\u50A8\u6C60\u3002",[["formDir","ngForm"],["siteNameError",""],n,i,r,_,c,u,S,M,["size","md",3,"overlaySelected","open","hasScrollingContent"],[3,"closeSelect"],["cdsModalHeaderHeading",""],["cdsModalContent",""],["name","createBootstrapForm","novalidate","",1,"form",3,"formGroup"],[1,"form-item"],["for","siteName","cdRequiredField","Site Name",3,"invalid","invalidText"],["cdsText","","placeholder",t,"id","siteName","name","siteName","formControlName","siteName","autofocus","",3,"invalid"],["formGroupName","pools",1,"form-item"],["for","pools",1,"cds--label"],[4,"ngFor","ngForOf"],["class","invalid-feedback",4,"ngIf"],[3,"submitAction","form"],[1,"form-item","mt-2"],["for","token"],["cdsTextArea","","placeholder",o,"id","token","formControlName","token","cols","200","rows","5","readonly",""],["source","token",1,"float-end"],["cancelText","Close",3,"backAction","showSubmit","modalForm"],[1,"invalid-feedback"],[3,"id","name","formControlName"]]},template:function(o,n){if(1&o){const i=e.RV6();e.j41(0,"cds-modal",10),e.bIt("overlaySelected",function(){return e.eBV(i),e.Njj(n.closeModal())}),e.j41(1,"cds-modal-header",11),e.bIt("closeSelect",function(){return e.eBV(i),e.Njj(n.closeModal())}),e.j41(2,"h3",12),e.pXf(3,2),e.k0s()(),e.j41(4,"section",13)(5,"form",14,0)(7,"p"),e.qex(8),e.PLo(9,3),e.nrm(10,"kbd"),e.YFu(),e.bVm(),e.k0s(),e.j41(11,"div",15)(12,"cds-text-label",16),e.PLo(13,4),e.nrm(14,"input",17),e.YFu(),e.k0s(),e.DNE(15,ws,1,1,"ng-template",null,1,e.C5r),e.k0s(),e.j41(17,"div",18)(18,"fieldset")(19,"label",19),e.pXf(20,5),e.k0s(),e.DNE(21,xs,3,4,"ng-container",20),e.k0s(),e.DNE(22,Hs,2,0,"span",21),e.k0s(),e.j41(23,"cd-submit-button",22),e.bIt("submitAction",function(){return e.eBV(i),e.Njj(n.generate())}),e.pXf(24,6),e.k0s(),e.j41(25,"div",23)(26,"cds-textarea-label",24),e.PLo(27,7),e.nrm(28,"textarea",25),e.YFu(),e.k0s(),e.nrm(29,"cd-copy-2-clipboard-button",26),e.k0s()()(),e.j41(30,"cd-form-button-panel",27),e.bIt("backAction",function(){return e.eBV(i),e.Njj(n.closeModal())}),e.k0s()()}if(2&o){const i=e.sdS(6),r=e.sdS(16);e.Y8G("open",n.open)("hasScrollingContent",!0),e.R7$(5),e.Y8G("formGroup",n.createBootstrapForm),e.R7$(7),e.Y8G("invalid",!n.createBootstrapForm.controls.siteName.valid&&(n.createBootstrapForm.controls.siteName.dirty||n.createBootstrapForm.controls.siteName.touched))("invalidText",r),e.R7$(2),e.Y8G("invalid",!n.createBootstrapForm.controls.siteName.valid&&(n.createBootstrapForm.controls.siteName.dirty||n.createBootstrapForm.controls.siteName.touched)),e.R7$(7),e.Y8G("ngForOf",n.pools),e.R7$(),e.Y8G("ngIf",n.createBootstrapForm.showError("pools",i,"requirePool")),e.R7$(),e.Y8G("form",n.createBootstrapForm),e.R7$(7),e.Y8G("showSubmit",!1)("modalForm",!0)}},dependencies:[d.Sq,d.bT,ks._,it.N,V.e,Xe.B,z.S,k.E,be.P,l.qT,l.me,l.BC,l.cb,l.j4,l.JD,l.$R,P.aF,P.rQ,P.$m,P.hN,K._P,K.Zt,K.ks,K.fs,ye.Sc],styles:[".form-group.ng-invalid[_ngcontent-%COMP%]   .invalid-feedback[_ngcontent-%COMP%]{display:block}"]})}return s})();function Ys(s,a){1&s&&(e.j41(0,"span",29),e.pXf(1,8),e.k0s())}function Ks(s,a){if(1&s&&e.DNE(0,Ys,2,0,"span",25),2&s){const t=e.XpG(),o=e.sdS(6);e.Y8G("ngIf",t.importBootstrapForm.showError("siteName",o,"required"))}}function zs(s,a){if(1&s&&(e.j41(0,"option",30),e.EFF(1),e.k0s()),2&s){const t=a.$implicit;e.Y8G("value",t.key),e.R7$(),e.JRh(t.desc)}}function Us(s,a){if(1&s&&(e.qex(0),e.j41(1,"cds-checkbox",31),e.EFF(2),e.k0s(),e.bVm()),2&s){const t=a.$implicit;e.R7$(),e.Y8G("id",t.name)("name",t.name)("formControlName",t.name),e.R7$(),e.SpI(" ",t.name," ")}}function qs(s,a){1&s&&(e.j41(0,"span",29),e.pXf(1,9),e.k0s())}function Qs(s,a){1&s&&(e.j41(0,"span",29),e.pXf(1,10),e.k0s())}function Ws(s,a){1&s&&(e.j41(0,"span",29),e.pXf(1,11),e.k0s())}function Js(s,a){if(1&s&&e.DNE(0,Qs,2,0,"span",25)(1,Ws,2,0,"span",25),2&s){const t=e.XpG(),o=e.sdS(6);e.Y8G("ngIf",t.importBootstrapForm.showError("token",o,"required")),e.R7$(),e.Y8G("ngIf",t.importBootstrapForm.showError("token",o,"invalidToken"))}}let Zs=(()=>{class s extends P.dW{actionLabels;rbdMirroringService;taskWrapper;siteName;pools=[];token;subs;importBootstrapForm;directions=[{key:"rx-tx",desc:"Bidirectional"},{key:"rx",desc:"Unidirectional (receive-only)"}];constructor(t,o,n,i){super(),this.actionLabels=t,this.rbdMirroringService=o,this.taskWrapper=n,this.siteName=i,this.createForm()}createForm(){this.importBootstrapForm=new j.$({siteName:new l.hs("",{validators:[l.k0.required]}),direction:new l.hs("rx-tx",{}),pools:new l.J3({},{validators:[this.validatePools()]}),token:new l.hs("",{validators:[l.k0.required,this.validateToken()]})})}ngOnInit(){this.rbdMirroringService.getSiteName().subscribe(t=>{this.importBootstrapForm.get("siteName").setValue(t.site_name)}),this.subs=this.rbdMirroringService.subscribeSummary(t=>{this.pools=t.content_data.pools.reduce((i,r)=>(i.push({name:r.name,mirror_mode:r.mirror_mode}),i),[]);const n=this.importBootstrapForm.get("pools");f().each(this.pools,i=>{const r=i.name,_="disabled"===i.mirror_mode,c=n.controls[r];c?_&&c.disabled?c.enable():!_&&c.enabled&&(c.disable(),c.setValue(!0)):n.addControl(r,new l.hs({value:!_,disabled:!_}))})})}ngOnDestroy(){this.subs&&this.subs.unsubscribe()}validatePools(){return t=>{let o=0;return f().each(t.controls,n=>{!0===n.value&&++o}),o>0?null:{requirePool:!0}}}validateToken(){return t=>{try{if(JSON.parse(atob(t.value)))return null}catch{}return{invalidToken:!0}}}import(){const t=[],o=[],n=this.importBootstrapForm.get("pools");f().each(n.controls,(u,S)=>{!0===u.value&&(t.push(S),u.disabled||o.push(S))});const i={mirror_mode:"image"};let r=(0,St.x)(this.rbdMirroringService.setSiteName(this.importBootstrapForm.getValue("siteName")),(0,J.p)(o.map(u=>this.rbdMirroringService.updatePool(u,i))));r=t.reduce((u,S)=>(0,St.x)(u,this.rbdMirroringService.importBootstrapToken(S,this.importBootstrapForm.getValue("direction"),this.importBootstrapForm.getValue("token"))),r).pipe((0,wt.H)());const _=()=>{this.rbdMirroringService.refresh(),this.importBootstrapForm.setErrors({cdSubmitButton:!0})};this.taskWrapper.wrapTaskAroundCall({task:new R.O("rbd/mirroring/bootstrap/import",{}),call:r}).subscribe({error:_,complete:()=>{_(),this.closeModal()}})}static \u0275fac=function(o){return new(o||s)(e.rXU(F.Ss),e.rXU(fe.B),e.rXU(I.a),e.rXU("siteName",8))};static \u0275cmp=e.VBU({type:s,selectors:[["cd-bootstrap-import-modal"]],features:[e.Vt3],decls:33,vars:14,consts:()=>{let t,o,n,i,r,_,c,u,S,M,E;return t="\u540D\u79F0...",o="\u751F\u6210\u7684\u4EE4\u724C...",n="\u5BFC\u5165\u5F15\u5BFC\u4EE4\u724C",i="\u8981\u5BFC\u5165\u7531\u5BF9\u7B49\u7AD9\u70B9\u96C6\u7FA4\u521B\u5EFA\u7684\u5F15\u5BFC\u4EE4\u724C\uFF0C\u8BF7\u63D0\u4F9B\u672C\u5730\u7AD9\u70B9\u7684\u540D\u79F0\uFF0C\u9009\u62E9\u5C06\u4E3A\u5176\u542F\u7528\u955C\u50CF\u7684\u5B58\u50A8\u6C60\uFF0C\u63D0\u4F9B\u751F\u6210\u7684\u4EE4\u724C\uFF0C \u7136\u540E\u70B9\u51FB" + "\ufffd#10\ufffd" + "\u5BFC\u5165" + "\ufffd/#10\ufffd" + "\u3002",r="Site Name " + "\ufffd#14\ufffd\ufffd/#14\ufffd" + "",_="\u5B58\u50A8\u6C60",c="Token " + "\ufffd#29\ufffd" + "          " + "\ufffd/#29\ufffd" + "",u="\u8FD9\u662F\u5FC5\u586B\u5B57\u6BB5\uFF01",S="\u81F3\u5C11\u9700\u6307\u5B9A\u4E00\u4E2A\u5B58\u50A8\u6C60\u3002",M="\u8FD9\u662F\u5FC5\u586B\u5B57\u6BB5\uFF01",E="\u4EE4\u724C\u65E0\u6548\u3002",[["formDir","ngForm"],["siteNameError",""],["tokenError",""],n,i,r,_,c,u,S,M,E,["size","md",3,"overlaySelected","open"],[3,"closeSelect"],["cdsModalHeaderHeading",""],["cdsModalContent",""],["name","importBootstrapForm","novalidate","",1,"form",3,"formGroup"],[1,"form-item"],["for","siteName","cdRequiredField","Site Name",3,"invalid","invalidText"],["cdsText","","placeholder",t,"id","siteName","name","siteName","formControlName","siteName","autofocus","",3,"invalid"],["label","Direction","for","direction","name","direction","id","direction","formControlName","direction"],[3,"value",4,"ngFor","ngForOf"],["formGroupName","pools",1,"form-item"],["for","pools",1,"cds--label"],[4,"ngFor","ngForOf"],["class","invalid-feedback",4,"ngIf"],["for","token","cdRequiredField","Token",3,"invalid","invalidText"],["cdsTextArea","","placeholder",o,"id","token","formControlName","token","cols","200","rows","5",3,"invalid"],[3,"submitActionEvent","form","submitText","modalForm"],[1,"invalid-feedback"],[3,"value"],[3,"id","name","formControlName"]]},template:function(o,n){if(1&o){const i=e.RV6();e.j41(0,"cds-modal",12),e.bIt("overlaySelected",function(){return e.eBV(i),e.Njj(n.closeModal())}),e.j41(1,"cds-modal-header",13),e.bIt("closeSelect",function(){return e.eBV(i),e.Njj(n.closeModal())}),e.j41(2,"h3",14),e.pXf(3,3),e.k0s()(),e.j41(4,"section",15)(5,"form",16,0)(7,"p"),e.qex(8),e.PLo(9,4),e.nrm(10,"kbd"),e.YFu(),e.bVm(),e.k0s(),e.j41(11,"div",17)(12,"cds-text-label",18),e.PLo(13,5),e.nrm(14,"input",19),e.YFu(),e.k0s(),e.DNE(15,Ks,1,1,"ng-template",null,1,e.C5r),e.k0s(),e.j41(17,"div",17)(18,"cds-select",20),e.DNE(19,zs,2,2,"option",21),e.k0s()(),e.j41(20,"div",22)(21,"fieldset")(22,"label",23),e.pXf(23,6),e.k0s(),e.DNE(24,Us,3,4,"ng-container",24),e.k0s(),e.DNE(25,qs,2,0,"span",25),e.k0s(),e.j41(26,"div",17)(27,"cds-textarea-label",26),e.PLo(28,7),e.nrm(29,"textarea",27),e.YFu(),e.k0s(),e.DNE(30,Js,2,2,"ng-template",null,2,e.C5r),e.k0s()()(),e.j41(32,"cd-form-button-panel",28),e.bIt("submitActionEvent",function(){return e.eBV(i),e.Njj(n.import())}),e.k0s()()}if(2&o){const i=e.sdS(6),r=e.sdS(16),_=e.sdS(31);e.Y8G("open",n.open),e.R7$(5),e.Y8G("formGroup",n.importBootstrapForm),e.R7$(7),e.Y8G("invalid",!n.importBootstrapForm.controls.siteName.valid&&n.importBootstrapForm.controls.siteName.dirty)("invalidText",r),e.R7$(2),e.Y8G("invalid",!n.importBootstrapForm.controls.siteName.valid&&n.importBootstrapForm.controls.siteName.dirty),e.R7$(5),e.Y8G("ngForOf",n.directions),e.R7$(5),e.Y8G("ngForOf",n.pools),e.R7$(),e.Y8G("ngIf",n.importBootstrapForm.showError("pools",i,"requirePool")),e.R7$(2),e.Y8G("invalid",n.importBootstrapForm.controls.token.invalid&&n.importBootstrapForm.controls.token.dirty)("invalidText",_),e.R7$(2),e.Y8G("invalid",n.importBootstrapForm.controls.token.invalid&&n.importBootstrapForm.controls.token.dirty),e.R7$(3),e.Y8G("form",n.importBootstrapForm)("submitText",n.actionLabels.SUBMIT)("modalForm",!0)}},dependencies:[d.Sq,d.bT,V.e,Xe.B,z.S,k.E,be.P,l.qT,l.xH,l.y7,l.me,l.BC,l.cb,l.j4,l.JD,l.$R,P.aF,P.rQ,P.$m,P.hN,K._P,K.Zt,K.ks,K.fs,ye.Sc,g.l6,g.c$]})}return s})();var Te=m(2243),ei=m(16748);let Et=(()=>{class s{transform(t){return"warning"===t?"badge badge-warning":"error"===t?"badge badge-danger":"success"===t?"badge badge-success":"badge badge-info"}static \u0275fac=function(o){return new(o||s)};static \u0275pipe=e.EJ8({name:"mirrorHealthColor",type:s,pure:!0})}return s})();const ti=["healthTmpl"];function oi(s,a){if(1&s&&(e.j41(0,"span",2),e.nI1(1,"mirrorHealthColor"),e.EFF(2),e.k0s()),2&s){const o=a.data.value;e.Y8G("ngClass",e.bMT(1,2,a.data.row.health_color)),e.R7$(2),e.JRh(o)}}let ni=(()=>{class s{rbdMirroringService;cephShortVersionPipe;healthTmpl;subs;data;columns;tableStatus=new Te.m;constructor(t,o){this.rbdMirroringService=t,this.cephShortVersionPipe=o}ngOnInit(){this.columns=[{prop:"instance_id",name:"\u5B9E\u4F8B",flexGrow:2},{prop:"id",name:"ID",flexGrow:2},{prop:"server_hostname",name:"\u4E3B\u673A\u540D",flexGrow:2},{prop:"version",name:"\u7248\u672C",pipe:this.cephShortVersionPipe,flexGrow:2},{prop:"health",name:"\u5065\u5EB7\u72B6\u51B5",cellTemplate:this.healthTmpl,flexGrow:1}],this.subs=this.rbdMirroringService.subscribeSummary(t=>{this.data=t.content_data.daemons,this.tableStatus=new Te.m(t.status)})}ngOnDestroy(){this.subs.unsubscribe()}refresh(){this.rbdMirroringService.refresh()}static \u0275fac=function(o){return new(o||s)(e.rXU(fe.B),e.rXU(ei.Z))};static \u0275cmp=e.VBU({type:s,selectors:[["cd-mirroring-daemons"]],viewQuery:function(o,n){if(1&o&&e.GBs(ti,7),2&o){let i;e.mGM(i=e.lsd())&&(n.healthTmpl=i.first)}},decls:3,vars:4,consts:[["healthTmpl",""],["columnMode","flex",3,"fetchData","data","columns","autoReload","status"],[3,"ngClass"]],template:function(o,n){if(1&o){const i=e.RV6();e.j41(0,"cd-table",1),e.bIt("fetchData",function(){return e.eBV(i),e.Njj(n.refresh())}),e.k0s(),e.DNE(1,oi,3,4,"ng-template",null,0,e.C5r)}2&o&&e.Y8G("data",n.data)("columns",n.columns)("autoReload",-1)("status",n.tableStatus)},dependencies:[d.YU,W.O,Et]})}return s})();var Ct=m(62988);const si=["stateTmpl"],ii=["syncTmpl"],ai=["progressTmpl"],ri=["entriesBehindPrimaryTpl"];function _i(s,a){if(1&s){const t=e.RV6();e.j41(0,"cd-table",14),e.bIt("fetchData",function(){e.eBV(t);const n=e.XpG();return e.Njj(n.refresh())}),e.k0s()}if(2&s){const t=e.XpG();e.Y8G("data",t.image_error.data)("columns",t.image_error.columns)("autoReload",-1)("status",t.tableStatus)}}function li(s,a){if(1&s){const t=e.RV6();e.j41(0,"cd-table",14),e.bIt("fetchData",function(){e.eBV(t);const n=e.XpG();return e.Njj(n.refresh())}),e.k0s()}if(2&s){const t=e.XpG();e.Y8G("data",t.image_syncing.data)("columns",t.image_syncing.columns)("autoReload",-1)("status",t.tableStatus)}}function ci(s,a){if(1&s){const t=e.RV6();e.j41(0,"cd-table",14),e.bIt("fetchData",function(){e.eBV(t);const n=e.XpG();return e.Njj(n.refresh())}),e.k0s()}if(2&s){const t=e.XpG();e.Y8G("data",t.image_ready.data)("columns",t.image_ready.columns)("autoReload",-1)("status",t.tableStatus)}}function di(s,a){if(1&s&&(e.j41(0,"span",15),e.nI1(1,"mirrorHealthColor"),e.EFF(2),e.k0s()),2&s){const o=a.data.value;e.Y8G("ngClass",e.bMT(1,2,a.data.row.state_color)),e.R7$(2),e.JRh(o)}}function mi(s,a){1&s&&e.nrm(0,"div")}function ui(s,a){if(1&s&&e.nrm(0,"ngb-progressbar",19),2&s){const t=e.XpG().data.value;e.Y8G("value",t)("showValue",!0)}}function pi(s,a){if(1&s&&(e.DNE(0,mi,1,0,"div",16),e.j41(1,"div",17),e.DNE(2,ui,1,2,"ngb-progressbar",18),e.k0s()),2&s){const t=a.data.row;e.Y8G("ngIf","Replaying"===t.state),e.R7$(2),e.Y8G("ngIf","Replaying"===t.state)}}function gi(s,a){if(1&s&&(e.j41(0,"span"),e.EFF(1),e.k0s()),2&s){const t=e.XpG().data.value;e.R7$(),e.SpI(" ",t," ")}}function fi(s,a){1&s&&(e.j41(0,"span",21),e.EFF(1,"-"),e.k0s())}function Ti(s,a){if(1&s&&e.DNE(0,gi,2,1,"span",16)(1,fi,2,0,"span",20),2&s){const t=a.data.row;e.Y8G("ngIf","journal"===t.mirror_mode),e.R7$(),e.Y8G("ngIf","snapshot"===t.mirror_mode)}}let Si=(()=>{class s{rbdMirroringService;stateTmpl;syncTmpl;progressTmpl;entriesBehindPrimaryTpl;subs;image_error={data:[],columns:{}};image_syncing={data:[],columns:{}};image_ready={data:[],columns:{}};tableStatus=new Te.m;constructor(t){this.rbdMirroringService=t}ngOnInit(){this.image_error.columns=[{prop:"pool_name",name:"\u5B58\u50A8\u6C60",flexGrow:2},{prop:"name",name:"\u6620\u50CF",flexGrow:2},{prop:"state",name:"\u72B6\u6001",cellTemplate:this.stateTmpl,flexGrow:1},{prop:"description",name:"\u95EE\u9898",flexGrow:4}],this.image_syncing.columns=[{prop:"pool_name",name:"\u5B58\u50A8\u6C60",flexGrow:2},{prop:"name",name:"\u6620\u50CF",flexGrow:2},{prop:"state",name:"\u72B6\u6001",cellTemplate:this.stateTmpl,flexGrow:1},{prop:"syncing_percent",name:"\u8FDB\u5EA6",cellTemplate:this.progressTmpl,flexGrow:2},{prop:"bytes_per_second",name:"Bytes per second",flexGrow:2},{prop:"entries_behind_primary",name:"Entries behind primary",cellTemplate:this.entriesBehindPrimaryTpl,flexGrow:2}],this.image_ready.columns=[{prop:"pool_name",name:"\u5B58\u50A8\u6C60",flexGrow:2},{prop:"name",name:"\u6620\u50CF",flexGrow:2},{prop:"state",name:"\u72B6\u6001",cellTemplate:this.stateTmpl,flexGrow:1},{prop:"description",name:"\u63CF\u8FF0",flexGrow:4}],this.subs=this.rbdMirroringService.subscribeSummary(t=>{this.image_error.data=t.content_data.image_error,this.image_syncing.data=t.content_data.image_syncing,this.image_ready.data=t.content_data.image_ready,this.tableStatus=new Te.m(t.status)})}ngOnDestroy(){this.subs.unsubscribe()}refresh(){this.rbdMirroringService.refresh()}static \u0275fac=function(o){return new(o||s)(e.rXU(fe.B))};static \u0275cmp=e.VBU({type:s,selectors:[["cd-mirroring-images"]],viewQuery:function(o,n){if(1&o&&(e.GBs(si,7),e.GBs(ii,7),e.GBs(ai,7),e.GBs(ri,7)),2&o){let i;e.mGM(i=e.lsd())&&(n.stateTmpl=i.first),e.mGM(i=e.lsd())&&(n.syncTmpl=i.first),e.mGM(i=e.lsd())&&(n.progressTmpl=i.first),e.mGM(i=e.lsd())&&(n.entriesBehindPrimaryTpl=i.first)}},decls:21,vars:4,consts:()=>{let t,o,n;return t="Issues (" + "\ufffd0\ufffd" + ")",o="Syncing (" + "\ufffd0\ufffd" + ")",n="Ready (" + "\ufffd0\ufffd" + ")",[["nav","ngbNav"],["stateTmpl",""],["progressTmpl",""],["entriesBehindPrimaryTpl",""],t,o,n,["ngbNav","","cdStatefulTab","image-list",1,"nav-tabs"],["ngbNavItem","issues"],["ngbNavLink",""],["ngbNavContent",""],["ngbNavItem","syncing"],["ngbNavItem","ready"],[3,"ngbNavOutlet"],["columnMode","flex",3,"fetchData","data","columns","autoReload","status"],[3,"ngClass"],[4,"ngIf"],[1,"w-100","h-100","d-flex","justify-content-center","align-items-center"],["type","info","class","w-100",3,"value","showValue",4,"ngIf"],["type","info",1,"w-100",3,"value","showValue"],["ngbTooltip","Not available with mirroring snapshot mode",4,"ngIf"],["ngbTooltip","Not available with mirroring snapshot mode"]]},template:function(o,n){if(1&o&&(e.j41(0,"nav",7,0),e.qex(2,8),e.j41(3,"a",9),e.pXf(4,4),e.k0s(),e.DNE(5,_i,1,4,"ng-template",10),e.bVm(),e.qex(6,11),e.j41(7,"a",9),e.pXf(8,5),e.k0s(),e.DNE(9,li,1,4,"ng-template",10),e.bVm(),e.qex(10,12),e.j41(11,"a",9),e.pXf(12,6),e.k0s(),e.DNE(13,ci,1,4,"ng-template",10),e.bVm(),e.k0s(),e.nrm(14,"div",13),e.DNE(15,di,3,4,"ng-template",null,1,e.C5r)(17,pi,3,2,"ng-template",null,2,e.C5r)(19,Ti,2,2,"ng-template",null,3,e.C5r)),2&o){const i=e.sdS(1);e.R7$(4),e.uP7(n.image_error.data.length),e.nnv(4),e.R7$(4),e.uP7(n.image_syncing.data.length),e.nnv(8),e.R7$(4),e.uP7(n.image_ready.data.length),e.nnv(12),e.R7$(2),e.Y8G("ngbNavOutlet",i)}},dependencies:[d.YU,d.bT,W.O,Ct.B,A.Um,A.X9,A.sy,A.Ri,A.WA,A.m_,A.EH,A.md,Et]})}return s})();var xt=m(68556);class Ei{cluster_name;client_id;mon_host;key;uuid}function Ci(s,a){1&s&&(e.j41(0,"span",33),e.pXf(1,11),e.k0s())}function Fi(s,a){1&s&&(e.j41(0,"span",33),e.pXf(1,12),e.k0s())}function Ri(s,a){if(1&s&&e.DNE(0,Ci,2,0,"span",32)(1,Fi,2,0,"span",32),2&s){const t=e.XpG(),o=e.sdS(6);e.Y8G("ngIf",t.editPeerForm.showError("clusterName",o,"required")),e.R7$(),e.Y8G("ngIf",t.editPeerForm.showError("clusterName",o,"invalidClusterName"))}}function Mi(s,a){1&s&&(e.j41(0,"span",33),e.pXf(1,13),e.k0s())}function Oi(s,a){1&s&&(e.j41(0,"span",33),e.pXf(1,14),e.k0s())}function hi(s,a){if(1&s&&e.DNE(0,Mi,2,0,"span",32)(1,Oi,2,0,"span",32),2&s){const t=e.XpG(),o=e.sdS(6);e.Y8G("ngIf",t.editPeerForm.showError("clientID",o,"required")),e.R7$(),e.Y8G("ngIf",t.editPeerForm.showError("clientID",o,"invalidClientID"))}}function bi(s,a){1&s&&(e.j41(0,"span",33),e.pXf(1,15),e.k0s())}function Ni(s,a){if(1&s&&e.DNE(0,bi,2,0,"span",32),2&s){const t=e.XpG(),o=e.sdS(6);e.Y8G("ngIf",t.editPeerForm.showError("monAddr",o,"invalidMonAddr"))}}function Pi(s,a){1&s&&(e.j41(0,"span",33),e.pXf(1,16),e.k0s())}function Ii(s,a){if(1&s&&e.DNE(0,Pi,2,0,"span",32),2&s){const t=e.XpG(),o=e.sdS(6);e.Y8G("ngIf",t.editPeerForm.showError("key",o,"invalidKey"))}}let Ai=(()=>{class s extends P.dW{actionLabels;rbdMirroringService;taskWrapper;poolName;peerUUID;mode;editPeerForm;bsConfig={containerClass:"theme-default"};pattern;response;constructor(t,o,n,i,r="",_=""){super(),this.actionLabels=t,this.rbdMirroringService=o,this.taskWrapper=n,this.poolName=i,this.peerUUID=r,this.mode=_,this.createForm()}createForm(){this.editPeerForm=new j.$({clusterName:new l.hs("",{validators:[l.k0.required,this.validateClusterName]}),clientID:new l.hs("",{validators:[l.k0.required,this.validateClientID]}),monAddr:new l.hs("",{validators:[this.validateMonAddr]}),key:new l.hs("",{validators:[this.validateKey]})})}ngOnInit(){this.pattern=`${this.poolName}/${this.peerUUID}`,"edit"===this.mode&&this.rbdMirroringService.getPeer(this.poolName,this.peerUUID).subscribe(t=>{this.setResponse(t)})}validateClusterName(t){if(!t.value.match(/^[\w\-_]*$/))return{invalidClusterName:{value:t.value}}}validateClientID(t){if(!t.value.match(/^(?!client\.)[\w\-_.]*$/))return{invalidClientID:{value:t.value}}}validateMonAddr(t){if(!t.value.match(/^[,; ]*([\w.\-_\[\]]+(:[\d]+)?[,; ]*)*$/))return{invalidMonAddr:{value:t.value}}}validateKey(t){try{if(""===t.value||atob(t.value))return null}catch{}return{invalidKey:{value:t.value}}}setResponse(t){this.response=t,this.editPeerForm.get("clusterName").setValue(t.cluster_name),this.editPeerForm.get("clientID").setValue(t.client_id),this.editPeerForm.get("monAddr").setValue(t.mon_host),this.editPeerForm.get("key").setValue(t.key)}update(){const t=new Ei;let o;t.cluster_name=this.editPeerForm.getValue("clusterName"),t.client_id=this.editPeerForm.getValue("clientID"),t.mon_host=this.editPeerForm.getValue("monAddr"),t.key=this.editPeerForm.getValue("key"),o=this.taskWrapper.wrapTaskAroundCall("edit"===this.mode?{task:new R.O("rbd/mirroring/peer/edit",{pool_name:this.poolName}),call:this.rbdMirroringService.updatePeer(this.poolName,this.peerUUID,t)}:{task:new R.O("rbd/mirroring/peer/add",{pool_name:this.poolName}),call:this.rbdMirroringService.addPeer(this.poolName,t)}),o.subscribe({error:()=>this.editPeerForm.setErrors({cdSubmitButton:!0}),complete:()=>{this.rbdMirroringService.refresh(),this.closeModal()}})}static \u0275fac=function(o){return new(o||s)(e.rXU(F.Ss),e.rXU(fe.B),e.rXU(I.a),e.rXU("poolName"),e.rXU("peerUUID",8),e.rXU("mode",8))};static \u0275cmp=e.VBU({type:s,selectors:[["cd-pool-edit-peer-modal"]],features:[e.Vt3],decls:37,vars:21,consts:()=>{let t,o,n,i,r,_,c,u,S,M,E,N,G,y,x,ae,re,_e;return t="\u540D\u79F0...",o="CephX ID...",n="\u9017\u53F7\u5206\u9694\u7684\u5730\u5740...",i="Base64 \u7F16\u7801\u7684\u5BC6\u94A5...",r="{VAR_SELECT, select, edit {\u7F16\u8F91} other {\u6DFB\u52A0}}",r=e.k04(r,{VAR_SELECT:"\ufffd0\ufffd"}),_=" " + r + " pool mirror peer ",c="{VAR_SELECT, select, edit {\u7F16\u8F91} other {\u6DFB\u52A0}}",c=e.k04(c,{VAR_SELECT:"\ufffd0\ufffd"}),u="" + c + "\u5B58\u50A8\u6C60 " + "[\ufffd#10\ufffd|\ufffd#11\ufffd]" + "" + "\ufffd1\ufffd" + "" + "[\ufffd/#10\ufffd|\ufffd/#11\ufffd]" + " \u7684\u5B58\u50A8\u6C60\u955C\u50CF\u5BF9\u7B49\u5C5E\u6027\uFF0C\u5E76\u70B9\u51FB" + "[\ufffd#10\ufffd|\ufffd#11\ufffd]" + "\u63D0\u4EA4" + "[\ufffd/#10\ufffd|\ufffd/#11\ufffd]" + "\u3002",u=e.k04(u),S="Cluster Name " + "\ufffd#15\ufffd\ufffd/#15\ufffd" + "",M="CephX ID " + "\ufffd#21\ufffd\ufffd/#21\ufffd" + "",E="Monitor Addresses " + "\ufffd#27\ufffd\ufffd/#27\ufffd" + "",N="CephX Key " + "\ufffd#33\ufffd\ufffd/#33\ufffd" + "",G="\u8FD9\u662F\u5FC5\u586B\u5B57\u6BB5\uFF01",y="\u8BE5\u96C6\u7FA4\u540D\u79F0\u65E0\u6548\u3002",x="\u8FD9\u662F\u5FC5\u586B\u5B57\u6BB5\uFF01",ae="\u8BE5 CephX ID \u65E0\u6548\u3002",re="\u8BE5 Monitor \u5730\u5740\u65E0\u6548\u3002",_e="CephX \u5BC6\u94A5\u5FC5\u987B\u4E3A base64 \u7F16\u7801\u3002",[["formDir","ngForm"],["clusterNameError",""],["clientIDError",""],["monAddrError",""],["keyError",""],_,u,S,M,E,N,G,y,x,ae,re,_e,["size","md",3,"overlaySelected","open","hasScrollingContent"],[3,"closeSelect"],["cdsModalHeaderHeading",""],["cdsModalContent",""],["name","editPeerForm","novalidate","",1,"form",3,"formGroup"],[1,"form-item"],["for","clusterName","cdRequiredField","Cluster Name",3,"invalid","invalidText"],["cdsText","","type","text","placeholder",t,"id","clusterName","name","clusterName","formControlName","clusterName","autofocus","",3,"invalid"],["for","clientID","cdRequiredField","CephX ID",3,"invalid","invalidText"],["cdsText","","type","text","placeholder",o,"id","clientID","name","clientID","formControlName","clientID",3,"invalid"],["for","monAddr",3,"invalid","invalidText"],["cdsText","","type","text","placeholder",n,"id","monAddr","name","monAddr","formControlName","monAddr",3,"invalid"],["for","key",3,"invalid","invalidText"],["cdsText","","type","text","placeholder",i,"id","key","name","key","formControlName","key",3,"invalid"],[3,"submitActionEvent","form","submitText","modalForm"],["class","invalid-feedback",4,"ngIf"],[1,"invalid-feedback"]]},template:function(o,n){if(1&o){const i=e.RV6();e.j41(0,"cds-modal",17),e.bIt("overlaySelected",function(){return e.eBV(i),e.Njj(n.closeModal())}),e.j41(1,"cds-modal-header",18),e.bIt("closeSelect",function(){return e.eBV(i),e.Njj(n.closeModal())}),e.j41(2,"h3",19),e.pXf(3,5),e.k0s()(),e.j41(4,"section",20)(5,"form",21,0)(7,"p")(8,"span"),e.PLo(9,6),e.nrm(10,"kbd")(11,"kbd"),e.YFu(),e.k0s()(),e.j41(12,"div",22)(13,"cds-text-label",23),e.PLo(14,7),e.nrm(15,"input",24),e.YFu(),e.k0s(),e.DNE(16,Ri,2,2,"ng-template",null,1,e.C5r),e.k0s(),e.j41(18,"div",22)(19,"cds-text-label",25),e.PLo(20,8),e.nrm(21,"input",26),e.YFu(),e.k0s(),e.DNE(22,hi,2,2,"ng-template",null,2,e.C5r),e.k0s(),e.j41(24,"div",22)(25,"cds-text-label",27),e.PLo(26,9),e.nrm(27,"input",28),e.YFu(),e.k0s(),e.DNE(28,Ni,1,1,"ng-template",null,3,e.C5r),e.k0s(),e.j41(30,"div",22)(31,"cds-text-label",29),e.PLo(32,10),e.nrm(33,"input",30),e.YFu(),e.k0s(),e.DNE(34,Ii,1,1,"ng-template",null,4,e.C5r),e.k0s()()(),e.j41(36,"cd-form-button-panel",31),e.bIt("submitActionEvent",function(){return e.eBV(i),e.Njj(n.update())}),e.k0s()()}if(2&o){const i=e.sdS(17),r=e.sdS(23),_=e.sdS(29),c=e.sdS(35);e.Y8G("open",n.open)("hasScrollingContent",!0),e.R7$(3),e.uP7(n.mode),e.nnv(3),e.R7$(2),e.Y8G("formGroup",n.editPeerForm),e.R7$(6),e.uP7(n.mode)(n.poolName),e.nnv(9),e.R7$(2),e.Y8G("invalid",n.editPeerForm.controls.clusterName.invalid&&n.editPeerForm.controls.clusterName.dirty)("invalidText",i),e.R7$(2),e.Y8G("invalid",n.editPeerForm.controls.clusterName.invalid&&n.editPeerForm.controls.clusterName.dirty),e.R7$(4),e.Y8G("invalid",n.editPeerForm.controls.clientID.invalid&&n.editPeerForm.controls.clientID.dirty)("invalidText",r),e.R7$(2),e.Y8G("invalid",n.editPeerForm.controls.clientID.invalid&&n.editPeerForm.controls.clientID.dirty),e.R7$(4),e.Y8G("invalid",n.editPeerForm.controls.monAddr.invalid&&n.editPeerForm.controls.monAddr.dirty)("invalidText",_),e.R7$(2),e.Y8G("invalid",n.editPeerForm.controls.monAddr.invalid&&n.editPeerForm.controls.monAddr.dirty),e.R7$(4),e.Y8G("invalid",n.editPeerForm.controls.key.invalid&&n.editPeerForm.controls.key.dirty)("invalidText",c),e.R7$(2),e.Y8G("invalid",n.editPeerForm.controls.key.invalid&&n.editPeerForm.controls.key.dirty),e.R7$(3),e.Y8G("form",n.editPeerForm)("submitText",n.actionLabels.SUBMIT)("modalForm",!0)}},dependencies:[d.bT,V.e,Xe.B,z.S,k.E,be.P,l.qT,l.me,l.BC,l.cb,l.j4,l.JD,P.aF,P.rQ,P.$m,P.hN,K.Zt,K.ks]})}return s})();var Ft=m(22453);const Di=["healthTmpl"],$i=["localTmpl"],vi=["remoteTmpl"];function Li(s,a){if(1&s&&(e.j41(0,"span",8),e.nI1(1,"mirrorHealthColor"),e.EFF(2),e.k0s()),2&s){const o=a.data.value;e.Y8G("ngClass",e.bMT(1,2,a.data.row.health_color)),e.R7$(2),e.JRh(o)}}function Gi(s,a){1&s&&(e.j41(0,"span",9),e.pXf(1,3),e.k0s())}function Bi(s,a){1&s&&(e.j41(0,"span",10),e.pXf(1,4),e.k0s())}let Xi=(()=>{class s{authStorageService;rbdMirroringService;modalService;taskWrapper;router;healthTmpl;localTmpl;remoteTmpl;subs;permission;tableActions;selection=new de.y;data;columns;tableStatus=new Te.m;constructor(t,o,n,i,r){this.authStorageService=t,this.rbdMirroringService=o,this.modalService=n,this.taskWrapper=i,this.router=r,this.data=[],this.permission=this.authStorageService.getPermissions().rbdMirroring;const _={permission:"update",icon:C.F.edit,click:()=>this.editModeModal(),name:"\u7F16\u8F91\u6A21\u5F0F",canBePrimary:()=>!0},c={permission:"create",icon:C.F.add,name:"\u6DFB\u52A0\u5BF9\u7B49",click:()=>this.editPeersModal("add"),disable:()=>!this.selection.first()||"disabled"===this.selection.first().mirror_mode,visible:()=>!this.getPeerUUID(),canBePrimary:()=>!1},u={permission:"update",icon:C.F.exchange,name:"\u7F16\u8F91\u5BF9\u7B49",click:()=>this.editPeersModal("edit"),visible:()=>!!this.getPeerUUID()},S={permission:"delete",icon:C.F.destroy,name:"\u5220\u9664\u5BF9\u7B49",click:()=>this.deletePeersModal(),visible:()=>!!this.getPeerUUID()};this.tableActions=[_,c,u,S]}ngOnInit(){this.columns=[{prop:"name",name:"\u540D\u79F0",flexGrow:2},{prop:"mirror_mode",name:"\u6A21\u5F0F",flexGrow:2},{prop:"leader_id",name:"\u4E3B\u7BA1",flexGrow:2},{prop:"image_local_count",name:"\u672C\u5730\u6570\u91CF",headerTemplate:this.localTmpl,flexGrow:2},{prop:"image_remote_count",name:"\u8FDC\u7A0B\u6570\u91CF",headerTemplate:this.remoteTmpl,flexGrow:2},{prop:"health",name:"\u5065\u5EB7\u72B6\u51B5",cellTemplate:this.healthTmpl,flexGrow:1}],this.subs=this.rbdMirroringService.subscribeSummary(t=>{this.data=t.content_data.pools,this.tableStatus=new Te.m(t.status)})}ngOnDestroy(){this.subs.unsubscribe()}refresh(){this.rbdMirroringService.refresh()}editModeModal(){this.router.navigate(["/block/mirroring",{outlets:{modal:[F.Qp.EDIT,this.selection.first().name]}}])}editPeersModal(t){const o={poolName:this.selection.first().name,mode:t};"edit"===t&&(o.peerUUID=this.getPeerUUID()),this.modalService.show(Ai,o)}deletePeersModal(){const t=this.selection.first().name,o=this.getPeerUUID();this.modalService.show(ce.D,{impact:Ft.r.high,itemDescription:"\u955C\u50CF\u5BF9\u7B49",itemNames:[`${t} (${o})`],submitActionObservable:()=>new xt.c(n=>{this.taskWrapper.wrapTaskAroundCall({task:new R.O("rbd/mirroring/peer/delete",{pool_name:t}),call:this.rbdMirroringService.deletePeer(t,o)}).subscribe({error:i=>n.error(i),complete:()=>{this.rbdMirroringService.refresh(),n.complete()}})})})}getPeerUUID(){const t=this.selection.first(),o=this.data.find(n=>t&&t.name===n.name);if(o&&o.peer_uuids)return o.peer_uuids[0]}updateSelection(t){this.selection=t}static \u0275fac=function(o){return new(o||s)(e.rXU(U.v),e.rXU(fe.B),e.rXU(me.V),e.rXU(I.a),e.rXU(p.Ix))};static \u0275cmp=e.VBU({type:s,selectors:[["cd-mirroring-pools"]],viewQuery:function(o,n){if(1&o&&(e.GBs(Di,7),e.GBs($i,7),e.GBs(vi,7)),2&o){let i;e.mGM(i=e.lsd())&&(n.healthTmpl=i.first),e.mGM(i=e.lsd())&&(n.localTmpl=i.first),e.mGM(i=e.lsd())&&(n.remoteTmpl=i.first)}},decls:9,vars:7,consts:()=>{let t,o,n,i;return t="Local image count",o="\u672C\u5730\u6570\u91CF",n="Remote image count",i="\u8FDC\u7A0B\u6570\u91CF",[["healthTmpl",""],["localTmpl",""],["remoteTmpl",""],o,i,["columnMode","flex","identifier","name","forceIdentifier","true","selectionType","single",3,"fetchData","updateSelection","data","columns","autoReload","status"],[1,"table-actions",3,"permission","selection","tableActions"],["name","modal"],[3,"ngClass"],["ngbTooltip",t],["ngbTooltip",n]]},template:function(o,n){if(1&o){const i=e.RV6();e.j41(0,"cd-table",5),e.bIt("fetchData",function(){return e.eBV(i),e.Njj(n.refresh())})("updateSelection",function(_){return e.eBV(i),e.Njj(n.updateSelection(_))}),e.nrm(1,"cd-table-actions",6),e.k0s(),e.DNE(2,Li,3,4,"ng-template",null,0,e.C5r)(4,Gi,2,0,"ng-template",null,1,e.C5r)(6,Bi,2,0,"ng-template",null,2,e.C5r),e.nrm(8,"router-outlet",7)}2&o&&(e.Y8G("data",n.data)("columns",n.columns)("autoReload",-1)("status",n.tableStatus),e.R7$(),e.Y8G("permission",n.permission)("selection",n.selection)("tableActions",n.tableActions))},dependencies:[d.YU,W.O,ge.j,p.n3,A.md,Et]})}return s})();const ki=()=>({md:4});function Vi(s,a){1&s&&(e.PLo(0,1,1),e.qSk(),e.nrm(1,"svg",22),e.YFu())}function wi(s,a){1&s&&(e.PLo(0,1,2),e.qSk(),e.nrm(1,"svg",23),e.YFu())}function xi(s,a){if(1&s){const t=e.RV6();e.qex(0),e.j41(1,"button",24),e.bIt("click",function(n){const i=e.eBV(t).$implicit;return e.Njj(i.click(n))}),e.j41(2,"span"),e.pXf(3,5),e.k0s(),e.qSk(),e.nrm(4,"svg",25),e.k0s(),e.bVm()}if(2&s){const t=a.$implicit;e.R7$(),e.Y8G("cdsButton",t.buttonKind)("title",t.name)("disabled",t.disable())("preserveFragment",t.preserveFragment?"":null),e.BMQ("aria-label",t.name)("data-testid",t.name),e.R7$(2),e.uP7(t.name),e.nnv(3),e.R7$(),e.Y8G("cdsIcon",t.icon)}}let Hi=(()=>{class s{authStorageService;rbdMirroringService;modalService;taskWrapper;rbdmirroringForm;permission;tableActions;selection=new de.y;modalRef;peersExist=!0;siteName;status;subs=new ys.y;editing=!1;icons=C.F;constructor(t,o,n,i){this.authStorageService=t,this.rbdMirroringService=o,this.modalService=n,this.taskWrapper=i,this.permission=this.authStorageService.getPermissions().rbdMirroring;const r={permission:"update",icon:"document--add",click:()=>this.createBootstrapModal(),name:"\u521B\u5EFA\u5F15\u5BFC\u4EE4\u724C",canBePrimary:()=>!0,disable:()=>!1,buttonKind:"primary"},_={permission:"update",icon:"document--import",click:()=>this.importBootstrapModal(),name:"\u5BFC\u5165\u5F15\u5BFC\u4EE4\u724C",disable:()=>!1,buttonKind:"tertiary"};this.tableActions=[r,_]}ngOnInit(){this.createForm(),this.subs.add(this.rbdMirroringService.startPolling()),this.subs.add(this.rbdMirroringService.subscribeSummary(t=>{this.status=t.content_data.status,this.peersExist=!!t.content_data.pools.find(o=>o.peer_uuids.length>0)})),this.rbdMirroringService.getSiteName().subscribe(t=>{this.siteName=t.site_name,this.rbdmirroringForm.get("siteName").setValue(this.siteName)})}createForm(){this.rbdmirroringForm=new j.$({siteName:new l.hs({value:"",disabled:!0})})}ngOnDestroy(){this.subs.unsubscribe()}updateSiteName(){this.editing&&this.taskWrapper.wrapTaskAroundCall({task:new R.O("rbd/mirroring/site_name/edit",{}),call:this.rbdMirroringService.setSiteName(this.rbdmirroringForm.getValue("siteName"))}).subscribe({complete:()=>{this.rbdMirroringService.refresh()}}),this.editing=!this.editing}createBootstrapModal(){this.modalRef=this.modalService.show(js,{siteName:this.siteName})}importBootstrapModal(){this.modalRef=this.modalService.show(Zs,{siteName:this.siteName})}static \u0275fac=function(o){return new(o||s)(e.rXU(U.v),e.rXU(fe.B),e.rXU(me.V),e.rXU(I.a))};static \u0275cmp=e.VBU({type:s,selectors:[["cd-mirroring"]],decls:32,vars:10,consts:()=>{let t,o,n,i,r;return t="Site Name " + "\ufffd#6\ufffd" + "" + "\ufffd#7\ufffd\ufffd/#7\ufffd" + "" + "\ufffd#8\ufffd" + "" + "\ufffd*9:1\ufffd\ufffd#1:1\ufffd" + "" + "[\ufffd/#1:1\ufffd\ufffd/*9:1\ufffd|\ufffd/#1:2\ufffd\ufffd/*10:2\ufffd]" + "" + "\ufffd*10:2\ufffd\ufffd#1:2\ufffd" + "" + "[\ufffd/#1:1\ufffd\ufffd/*9:1\ufffd|\ufffd/#1:2\ufffd\ufffd/*10:2\ufffd]" + "" + "\ufffd/#8\ufffd" + "" + "\ufffd#11\ufffd" + "" + "\ufffd/#11\ufffd" + "" + "\ufffd/#6\ufffd" + "",t=e.k04(t),o="\u5B88\u62A4\u8FDB\u7A0B",n="\u5B58\u50A8\u6C60",i="\u6620\u50CF",r="" + "\ufffd0\ufffd" + "",[["formDir","ngForm"],t,o,n,i,r,["name","rbdmirroringForm","novalidate","",3,"formGroup"],[1,"form-item"],["cdsCol","",1,"d-flex",3,"columnNumbers"],["for","siteName"],[1,"cds-input-group"],["type","text","id","siteName","name","siteName","formControlName","siteName","cdsText",""],["kind","ghost","size","md",3,"click","title"],["cdsIcon","edit","size","32","class","cds--btn__icon",4,"ngIf"],["cdsIcon","checkmark","size","32","class","cds--btn__icon",4,"ngIf"],[3,"source","byId"],["cdsCol","{md:5}"],[1,"d-flex","flex-row-reverse","gap-3"],[4,"ngFor","ngForOf"],[1,"row"],[1,"col-sm-6"],[1,"col-md-12"],["cdsIcon","edit","size","32",1,"cds--btn__icon"],["cdsIcon","checkmark","size","32",1,"cds--btn__icon"],["type","button",3,"click","cdsButton","title","disabled","preserveFragment"],["size","16",1,"cds--btn__icon",3,"cdsIcon"]]},template:function(o,n){if(1&o){const i=e.RV6();e.j41(0,"form",6,0)(2,"div",7)(3,"div",8)(4,"cds-text-label",9),e.PLo(5,1),e.j41(6,"div",10),e.nrm(7,"input",11),e.j41(8,"cds-icon-button",12),e.bIt("click",function(){return e.eBV(i),e.Njj(n.updateSiteName())}),e.DNE(9,Vi,2,0,"svg",13)(10,wi,2,0,"svg",14),e.k0s(),e.nrm(11,"cd-copy-2-clipboard-button",15),e.k0s(),e.YFu(),e.k0s()(),e.j41(12,"div",16)(13,"div",17),e.DNE(14,xi,5,8,"ng-container",18),e.k0s()()()(),e.j41(15,"div",19)(16,"div",20)(17,"legend"),e.pXf(18,2),e.k0s(),e.j41(19,"div"),e.nrm(20,"cd-mirroring-daemons"),e.k0s()(),e.j41(21,"div",20)(22,"legend"),e.pXf(23,3),e.k0s(),e.j41(24,"div"),e.nrm(25,"cd-mirroring-pools"),e.k0s()()(),e.j41(26,"div",19)(27,"div",21)(28,"legend"),e.pXf(29,4),e.k0s(),e.j41(30,"div"),e.nrm(31,"cd-mirroring-images"),e.k0s()()()}2&o&&(e.Y8G("formGroup",n.rbdmirroringForm),e.R7$(3),e.Y8G("columnNumbers",e.lJ4(9,ki)),e.R7$(4),e.BMQ("disabled",!n.editing||null),e.R7$(),e.Y8G("title",n.editing?"Save":"Edit"),e.R7$(),e.Y8G("ngIf",!n.editing),e.R7$(),e.Y8G("ngIf",n.editing),e.R7$(),e.Y8G("source",n.siteName)("byId",!1),e.R7$(3),e.Y8G("ngForOf",n.tableActions))},dependencies:[d.Sq,d.bT,it.N,z.S,k.E,l.qT,l.me,l.BC,l.cb,l.j4,l.JD,K.Zt,K.ks,je.ee,qe.$n,qe.K0,Ye.LJ,ni,Si,Xi]})}return s})();class ji{mirror_mode}function Yi(s,a){if(1&s&&(e.PLo(0,4,1),e.nrm(1,"option",15),e.YFu()),2&s){const t=a.$implicit;e.R7$(),e.Y8G("value",t.id),e.uP7(t.name),e.nnv(0)}}function Ki(s,a){1&s&&(e.j41(0,"span",17),e.pXf(1,5),e.k0s())}function zi(s,a){if(1&s&&e.DNE(0,Ki,2,0,"span",16),2&s){const t=e.XpG(),o=e.sdS(6);e.Y8G("ngIf",t.editModeForm.showError("mirrorMode",o,"cannotDisable"))}}let Ui=(()=>{class s extends P.dW{actionLabels;rbdMirroringService;taskWrapper;route;location;poolName;open=!1;subs;editModeForm;bsConfig={containerClass:"theme-default"};pattern;response;peerExists=!1;mirrorModes=[{id:"disabled",name:"\u5DF2\u7981\u7528"},{id:"pool",name:"\u5B58\u50A8\u6C60"},{id:"image",name:"\u6620\u50CF"}];constructor(t,o,n,i,r){super(),this.actionLabels=t,this.rbdMirroringService=o,this.taskWrapper=n,this.route=i,this.location=r,this.createForm()}createForm(){this.editModeForm=new j.$({mirrorMode:new l.hs("",{validators:[l.k0.required,this.validateMode.bind(this)]})})}ngOnInit(){this.open="modal"===this.route.outlet,this.route.params.subscribe(t=>{this.poolName=t.pool_name}),this.pattern=`${this.poolName}`,this.rbdMirroringService.getPool(this.poolName).subscribe(t=>{this.setResponse(t)}),this.subs=this.rbdMirroringService.subscribeSummary(t=>{this.peerExists=!1;const n=t.content_data.pools.find(i=>this.poolName===i.name);this.peerExists=n&&n.peer_uuids.length})}ngOnDestroy(){this.subs.unsubscribe()}validateMode(t){return"disabled"===t.value&&this.peerExists?{cannotDisable:{value:t.value}}:null}setResponse(t){this.editModeForm.get("mirrorMode").setValue(t.mirror_mode)}update(){const t=new ji;t.mirror_mode=this.editModeForm.getValue("mirrorMode"),this.taskWrapper.wrapTaskAroundCall({task:new R.O("rbd/mirroring/pool/edit",{pool_name:this.poolName}),call:this.rbdMirroringService.updatePool(this.poolName,t)}).subscribe({error:()=>this.editModeForm.setErrors({cdSubmitButton:!0}),complete:()=>{this.rbdMirroringService.refresh(),this.location.back()}})}closeModal(){this.location.back()}static \u0275fac=function(o){return new(o||s)(e.rXU(F.Ss),e.rXU(fe.B),e.rXU(I.a),e.rXU(p.nX),e.rXU(d.aZ))};static \u0275cmp=e.VBU({type:s,selectors:[["cd-pool-edit-mode-modal"]],features:[e.Vt3],decls:19,vars:9,consts:()=>{let t,o,n,i;return t="\u7F16\u8F91\u5B58\u50A8\u6C60\u955C\u50CF\u6A21\u5F0F",o="\u8981\u7F16\u8F91\u5B58\u50A8\u6C60 " + "[\ufffd#10\ufffd|\ufffd#11\ufffd]" + "" + "\ufffd0\ufffd" + "" + "[\ufffd/#10\ufffd|\ufffd/#11\ufffd]" + " \u7684\u955C\u50CF\u6A21\u5F0F\uFF0C\u8BF7\u4ECE\u5217\u8868\u4E2D\u9009\u62E9\u65B0\u6A21\u5F0F\uFF0C\u7136\u540E\u70B9\u51FB" + "[\ufffd#10\ufffd|\ufffd#11\ufffd]" + "\u66F4\u65B0" + "[\ufffd/#10\ufffd|\ufffd/#11\ufffd]" + "\u3002",o=e.k04(o),n="" + "\ufffd*15:1\ufffd\ufffd#1:1\ufffd" + "" + "\ufffd0:1\ufffd" + "" + "\ufffd/#1:1\ufffd\ufffd/*15:1\ufffd" + "",i="\u5728\u7981\u7528\u955C\u50CF\u529F\u80FD\u524D\u5FC5\u987B\u5148\u79FB\u9664\u540C\u4F34\u96C6\u7FA4\u3002",[["formDir","ngForm"],["mirrorModeError",""],t,o,n,i,["size","md",3,"overlaySelected","open"],[3,"closeSelect"],["cdsModalHeaderHeading",""],["cdsModalContent",""],["name","editModeForm","novalidate","",1,"form",3,"formGroup"],[1,"form-item"],["label","Mode","for","mirrorMode","formControlName","mirrorMode","name","mirrorMode","id","mirrorMode","cdRequiredField","Mode",3,"invalid","invalidText"],[3,"value",4,"ngFor","ngForOf"],[3,"submitActionEvent","form","submitText","modalForm"],[3,"value"],["class","invalid-feedback",4,"ngIf"],[1,"invalid-feedback"]]},template:function(o,n){if(1&o){const i=e.RV6();e.j41(0,"cds-modal",6),e.bIt("overlaySelected",function(){return e.eBV(i),e.Njj(n.closeModal())}),e.j41(1,"cds-modal-header",7),e.bIt("closeSelect",function(){return e.eBV(i),e.Njj(n.closeModal())}),e.j41(2,"h3",8),e.pXf(3,2),e.k0s()(),e.j41(4,"section",9)(5,"form",10,0)(7,"p"),e.qex(8),e.PLo(9,3),e.nrm(10,"kbd")(11,"kbd"),e.YFu(),e.bVm(),e.k0s(),e.j41(12,"div",11)(13,"cds-select",12),e.PLo(14,4),e.DNE(15,Yi,2,2,"option",13),e.YFu(),e.k0s(),e.DNE(16,zi,1,1,"ng-template",null,1,e.C5r),e.k0s()()(),e.j41(18,"cd-form-button-panel",14),e.bIt("submitActionEvent",function(){return e.eBV(i),e.Njj(n.update())}),e.k0s()()}if(2&o){const i=e.sdS(17);e.Y8G("open",n.open),e.R7$(5),e.Y8G("formGroup",n.editModeForm),e.R7$(6),e.uP7(n.poolName),e.nnv(9),e.R7$(2),e.Y8G("invalid",n.editModeForm.controls.mirrorMode.invalid&&n.editModeForm.controls.mirrorMode.dirty)("invalidText",i),e.R7$(2),e.Y8G("ngForOf",n.mirrorModes),e.R7$(3),e.Y8G("form",n.editModeForm)("submitText",n.actionLabels.UPDATE)("modalForm",!0)}},dependencies:[d.Sq,d.bT,V.e,k.E,be.P,l.qT,l.xH,l.y7,l.BC,l.cb,l.j4,l.JD,P.aF,P.rQ,P.$m,P.hN,g.l6,g.c$]})}return s})();var Ht=m(40598),qi=m(34935),Qi=m(48707),Qe=m(59870),Rt=m(6107),w=m(65218),ke=m(73651),Mt=m(12540);class Wi{id;unique_id;name;pool_name;namespace;image_format;cdExecuting}var at=function(s){return s[s.V1=1]="V1",s[s.V2=2]="V2",s}(at||{});class Ji{child_pool_name;child_namespace;child_image_name;obj_size;features=[];stripe_unit;stripe_count;data_pool;configuration}class Zi{dest_pool_name;dest_namespace;dest_image_name;snapshot_name;obj_size;features=[];stripe_unit;stripe_count;data_pool;configuration}class ea{name;pool_name;namespace;data_pool;size;obj_size;stripe_unit;stripe_count;configuration;source;enable_mirror;mirror_mode;schedule_interval;start_time}class ta extends ea{features=[]}class Ot{name;size;features=[];configuration;enable_mirror;mirror_mode;primary;force;schedule_interval;remove_scheduling=!1;image_mirror_mode}var jt=function(s){return s.editing="editing",s.cloning="cloning",s.copying="copying",s}(jt||{});const se={moveToTrash:"Move an image to the trash. Images, even ones actively in-use by clones, can be moved to the trash and deleted at a later time.",delete:"Delete an rbd image (including all data blocks). If the image has snapshots, this fails and nothing is deleted.",copy:"Copy the content of a source image into the newly created destination image",flatten:"If the image is a clone, copy all shared blocks from the parent snapshot and make the child independent of the parent, severing the link between parent snap and child. ",enableMirroring:"Mirroring needs to be enabled on the image to perform this action",clonedSnapshot:"This RBD has cloned snapshots. Please delete related RBDs before deleting this RBD",secondayImageDelete:"The image cannot be deleted as it is secondary",primaryImageResync:"Primary RBD images cannot be resynced",invalidNameDisable:"\u6B64 RBD \u6620\u50CF\u7684\u540D\u79F0\u65E0\u6548\uFF0C\u65E0\u6CD5\u901A\u8FC7 Ceph \u8FDB\u884C\u7BA1\u7406\u3002",removingStatus:"\u65E0\u6CD5\u5BF9\u5904\u4E8E \"\u6B63\u5728\u5220\u9664\" \u72B6\u6001\u7684 RBD \u6267\u884C\u64CD\u4F5C",journalTooltipText:"'Ensures reliable replication by logging changes before updating the image, but doubles write time, impacting performance. Not recommended for high-speed data processing tasks.",snapshotTooltipText:"This mode replicates RBD images between clusters using snapshots, efficiently copying data changes but requiring complete delta syncing during failover. Ideal for less demanding tasks due to its less granular approach compared to journaling."};var oa=m(39403),Se=m(64333),na=m(95131),sa=m(42865),ht=m(8415),bt=m(34878),ia=m(45413);const aa=()=>({md:4});function ra(s,a){if(1&s&&(e.PLo(0,8,1),e.nrm(1,"div"),e.YFu()),2&s){const t=e.XpG(2);e.R7$(),e.uP7(t.copyMessage),e.nnv(0)}}function _a(s,a){if(1&s&&(e.j41(0,"div",49)(1,"cds-text-label",72),e.PLo(2,16),e.nI1(3,"titlecase"),e.nrm(4,"input",73),e.YFu(),e.k0s()()),2&s){const t=e.XpG(2);e.R7$(4),e.uP7(e.bMT(3,1,t.action)),e.nnv(2)}}function la(s,a){1&s&&(e.j41(0,"span"),e.qex(1),e.pXf(2,17),e.bVm(),e.k0s())}function ca(s,a){1&s&&(e.j41(0,"span"),e.qex(1),e.pXf(2,18),e.bVm(),e.k0s())}function da(s,a){if(1&s&&e.DNE(0,la,3,0,"span",47)(1,ca,3,0,"span",47),2&s){e.XpG();const t=e.sdS(2),o=e.XpG();e.Y8G("ngIf",o.rbdForm.showError("name",t,"required")),e.R7$(),e.Y8G("ngIf",o.rbdForm.showError("name",t,"pattern"))}}function ma(s,a){1&s&&(e.j41(0,"cds-text-label",74),e.PLo(1,19),e.nrm(2,"input",75),e.YFu(),e.k0s())}function ua(s,a){1&s&&(e.j41(0,"option",68),e.pXf(1,20),e.k0s()),2&s&&e.Y8G("ngValue",null)}function pa(s,a){1&s&&(e.j41(0,"option",68),e.pXf(1,21),e.k0s()),2&s&&e.Y8G("ngValue",null)}function ga(s,a){1&s&&(e.j41(0,"option",68),e.pXf(1,22),e.k0s()),2&s&&e.Y8G("ngValue",null)}function fa(s,a){if(1&s&&(e.j41(0,"option",78),e.EFF(1),e.k0s()),2&s){const t=a.$implicit;e.Y8G("value",t.pool_name),e.R7$(),e.JRh(t.pool_name)}}function Ta(s,a){if(1&s&&(e.j41(0,"cds-select",76),e.DNE(1,ua,2,1,"option",77)(2,pa,2,1,"option",77)(3,ga,2,1,"option",77)(4,fa,2,2,"option",66),e.k0s()),2&s){e.XpG();const t=e.sdS(20),o=e.XpG();e.Y8G("invalid",!o.rbdForm.controls.pool.valid&&o.rbdForm.controls.pool.dirty)("invalidText",t),e.R7$(),e.Y8G("ngIf",null===o.pools),e.R7$(),e.Y8G("ngIf",null!==o.pools&&0===o.pools.length),e.R7$(),e.Y8G("ngIf",null!==o.pools&&o.pools.length>0),e.R7$(),e.Y8G("ngForOf",o.pools)}}function Sa(s,a){1&s&&(e.j41(0,"span",80),e.pXf(1,23),e.k0s())}function Ea(s,a){if(1&s&&e.DNE(0,Sa,2,0,"span",79),2&s){e.XpG();const t=e.sdS(2),o=e.XpG();e.Y8G("ngIf",o.rbdForm.showError("pool",t,"required"))}}function Ca(s,a){1&s&&(e.j41(0,"cd-alert-panel",81),e.EFF(1,"Mirroring can not be disabled on "),e.j41(2,"b"),e.EFF(3,"\xa0Pool\xa0"),e.k0s(),e.EFF(4," mirror mode. You need to change the mirror mode to enable this option. "),e.k0s()),2&s&&e.Y8G("showTitle",!1)}function Fa(s,a){if(1&s){const t=e.RV6();e.j41(0,"cd-alert-panel",82),e.bIt("action",function(n){e.eBV(t);const i=e.XpG(2);return e.Njj(i.onAlertAction(n))}),e.EFF(1," You need to set\xa0"),e.j41(2,"b"),e.EFF(3,"mirror mode"),e.k0s(),e.EFF(4,"\xa0in the selected pool to enable mirroring. "),e.k0s()}2&s&&e.Y8G("showTitle",!1)}function Ra(s,a){if(1&s){const t=e.RV6();e.j41(0,"cds-radio",85),e.bIt("change",function(){e.eBV(t);const n=e.XpG(3);return e.Njj(n.setExclusiveLock())}),e.EFF(1),e.nI1(2,"titlecase"),e.j41(3,"cd-helper"),e.EFF(4),e.k0s()()}if(2&s){const t=a.$implicit,o=e.XpG(3);e.Y8G("value",t.value)("id",t.value)("disabled",o.shouldDisable(t.value)),e.R7$(),e.SpI(" ",e.bMT(2,5,t.value)," "),e.R7$(3),e.SpI(" ",t.text," ")}}function Ma(s,a){if(1&s){const t=e.RV6();e.j41(0,"cd-alert-panel",82),e.bIt("action",function(n){e.eBV(t);const i=e.XpG(3);return e.Njj(i.onAlertAction(n))}),e.PLo(1,24),e.nrm(2,"b"),e.YFu(),e.k0s()}2&s&&e.Y8G("showTitle",!1)}function Oa(s,a){if(1&s&&(e.j41(0,"div",49)(1,"cds-radio-group",83),e.DNE(2,Ra,5,7,"cds-radio",84),e.k0s(),e.DNE(3,Ma,3,1,"cd-alert-panel",57),e.k0s()),2&s){const t=e.XpG(2);e.R7$(2),e.Y8G("ngForOf",t.mirroringOptions),e.R7$(),e.Y8G("ngIf","pool"===t.currentPoolMirrorMode&&"editing"!==t.mode)}}function ha(s,a){1&s&&(e.j41(0,"span",80),e.pXf(1,26),e.k0s())}function ba(s,a){if(1&s&&e.DNE(0,ha,2,0,"span",79),2&s){e.XpG(2);const t=e.sdS(2),o=e.XpG();e.Y8G("ngIf",o.rbdForm.showError("schedule",t,"required"))}}function Na(s,a){if(1&s&&(e.j41(0,"div",49)(1,"cds-text-label",86),e.PLo(2,25),e.nrm(3,"input",87),e.YFu(),e.k0s(),e.DNE(4,ba,1,1,"ng-template",null,6,e.C5r),e.k0s()),2&s){const t=e.sdS(5),o=e.XpG(2);e.R7$(),e.Y8G("invalid",!o.rbdForm.controls.schedule.valid&&o.rbdForm.controls.schedule.dirty)("invalidText",t),e.R7$(2),e.Y8G("disabled",!1===o.peerConfigured||null)("invalid",!o.rbdForm.controls.schedule.valid&&o.rbdForm.controls.schedule.dirty)}}function Pa(s,a){1&s&&(e.PLo(0,27,1),e.j41(1,"cd-helper"),e.nrm(2,"span"),e.k0s(),e.YFu())}function Ia(s,a){if(1&s){const t=e.RV6();e.j41(0,"div",49)(1,"cds-checkbox",88),e.bIt("change",function(){e.eBV(t);const n=e.XpG(2);return e.Njj(n.onUseDataPoolChange())}),e.PLo(2,27),e.nrm(3,"cd-help-text"),e.DNE(4,Pa,3,0,"cd-helper",47),e.YFu(),e.k0s()()}if(2&s){const t=e.XpG(2);e.R7$(4),e.Y8G("ngIf",t.allDataPools.length<=1&&"editing"!==t.mode)}}function Aa(s,a){1&s&&(e.j41(0,"option",68),e.pXf(1,28),e.k0s()),2&s&&e.Y8G("ngValue",null)}function Da(s,a){1&s&&(e.j41(0,"option",68),e.pXf(1,29),e.k0s()),2&s&&e.Y8G("ngValue",null)}function $a(s,a){1&s&&(e.j41(0,"option",68),e.pXf(1,30),e.k0s()),2&s&&e.Y8G("ngValue",null)}function va(s,a){if(1&s&&(e.j41(0,"option",78),e.EFF(1),e.k0s()),2&s){const t=a.$implicit;e.Y8G("value",t.pool_name),e.R7$(),e.JRh(t.pool_name)}}function La(s,a){if(1&s&&(e.j41(0,"cds-select",90),e.DNE(1,Aa,2,1,"option",77)(2,Da,2,1,"option",77)(3,$a,2,1,"option",77)(4,va,2,2,"option",66),e.k0s()),2&s){e.XpG();const t=e.sdS(3),o=e.XpG(2);e.Y8G("invalid",!o.rbdForm.controls.dataPool.valid&&o.rbdForm.controls.dataPool.dirty)("invalidText",t),e.R7$(),e.Y8G("ngIf",null===o.dataPools),e.R7$(),e.Y8G("ngIf",null!==o.dataPools&&0===o.dataPools.length),e.R7$(),e.Y8G("ngIf",null!==o.dataPools&&o.dataPools.length>0),e.R7$(),e.Y8G("ngForOf",o.dataPools)}}function Ga(s,a){1&s&&(e.j41(0,"span",80),e.pXf(1,31),e.k0s())}function Ba(s,a){if(1&s&&e.DNE(0,Ga,2,0,"span",79),2&s){e.XpG(2);const t=e.sdS(2),o=e.XpG();e.Y8G("ngIf",o.rbdForm.showError("dataPool",t,"required"))}}function ya(s,a){if(1&s&&(e.j41(0,"div",49),e.DNE(1,La,5,6,"cds-select",89)(2,Ba,1,1,"ng-template",null,7,e.C5r),e.k0s()),2&s){const t=e.XpG(2);e.R7$(),e.Y8G("ngIf","editing"!==t.mode&&t.poolPermission.read)}}function Xa(s,a){1&s&&(e.j41(0,"div",49)(1,"cds-select",91)(2,"option",68),e.pXf(3,32),e.k0s()()()),2&s&&(e.R7$(),e.Y8G("skeleton",!0),e.R7$(),e.Y8G("ngValue",null))}function ka(s,a){1&s&&(e.j41(0,"option",68),e.pXf(1,33),e.k0s()),2&s&&e.Y8G("ngValue",null)}function Va(s,a){1&s&&(e.j41(0,"option",68),e.pXf(1,34),e.k0s()),2&s&&e.Y8G("ngValue",null)}function wa(s,a){1&s&&(e.j41(0,"option",68),e.pXf(1,35),e.k0s()),2&s&&e.Y8G("ngValue",null)}function xa(s,a){if(1&s&&(e.j41(0,"option",78),e.EFF(1),e.k0s()),2&s){const t=a.$implicit;e.Y8G("value",t),e.R7$(),e.JRh(t)}}function Ha(s,a){if(1&s&&(e.j41(0,"cds-select",92),e.DNE(1,ka,2,1,"option",77)(2,Va,2,1,"option",77)(3,wa,2,1,"option",77)(4,xa,2,2,"option",66),e.k0s()),2&s){const t=e.XpG(2);e.R7$(),e.Y8G("ngIf",null===t.namespaces),e.R7$(),e.Y8G("ngIf",null!==t.namespaces&&0===t.namespaces.length),e.R7$(),e.Y8G("ngIf",null!==t.namespaces&&t.namespaces.length>0),e.R7$(),e.Y8G("ngForOf",t.namespaces)}}function ja(s,a){1&s&&(e.j41(0,"span",80),e.pXf(1,36),e.k0s())}function Ya(s,a){1&s&&(e.j41(0,"span",80),e.pXf(1,37),e.k0s())}function Ka(s,a){1&s&&(e.j41(0,"span",80),e.pXf(1,38),e.k0s())}function za(s,a){if(1&s&&e.DNE(0,ja,2,0,"span",79)(1,Ya,2,0,"span",79)(2,Ka,2,0,"span",79),2&s){e.XpG();const t=e.sdS(2),o=e.XpG();e.Y8G("ngIf",o.rbdForm.showError("size",t,"required")),e.R7$(),e.Y8G("ngIf",o.rbdForm.showError("size",t,"invalidSizeObject")),e.R7$(),e.Y8G("ngIf",o.rbdForm.showError("size",t,"pattern"))}}function Ua(s,a){if(1&s&&(e.j41(0,"cd-help-text"),e.EFF(1),e.k0s()),2&s){const t=e.XpG().$implicit;e.R7$(),e.SpI(" ",t.helperText," ")}}function qa(s,a){if(1&s&&(e.j41(0,"cd-alert-panel",95),e.EFF(1),e.k0s()),2&s){const t=e.XpG().$implicit;e.Y8G("showTitle",!1),e.R7$(),e.SpI(" ",t.helperHtml," ")}}function Qa(s,a){if(1&s&&(e.qex(0),e.j41(1,"cds-checkbox",93),e.EFF(2),e.nI1(3,"titlecase"),e.DNE(4,Ua,2,1,"cd-help-text",47)(5,qa,2,2,"cd-alert-panel",94),e.k0s(),e.bVm()),2&s){const t=a.$implicit,o=e.XpG(2);e.R7$(),e.Y8G("id",t.key)("name",t.key)("formControlName",t.key),e.R7$(),e.SpI(" ",e.bMT(3,6,t.key)," "),e.R7$(2),e.Y8G("ngIf",t.helperText),e.R7$(),e.Y8G("ngIf",t.helperHtml&&!1===o.rbdForm.getValue(t.key))}}function Wa(s,a){if(1&s&&(e.PLo(0,14,1),e.nrm(1,"option",78),e.YFu()),2&s){const t=a.$implicit;e.R7$(),e.Y8G("value",t),e.uP7(t),e.nnv(0)}}function Ja(s,a){if(1&s&&(e.PLo(0,15,1),e.nrm(1,"option",78),e.YFu()),2&s){const t=a.$implicit;e.R7$(),e.Y8G("value",t),e.uP7(t),e.nnv(0)}}function Za(s,a){1&s&&(e.j41(0,"span",80),e.pXf(1,39),e.k0s())}function er(s,a){1&s&&(e.j41(0,"span",80),e.pXf(1,40),e.k0s())}function tr(s,a){if(1&s&&e.DNE(0,Za,2,0,"span",79)(1,er,2,0,"span",79),2&s){e.XpG();const t=e.sdS(2),o=e.XpG();e.Y8G("ngIf",o.rbdForm.showError("stripingUnit",t,"required")),e.R7$(),e.Y8G("ngIf",o.rbdForm.showError("stripingUnit",t,"invalidStripingUnit"))}}function or(s,a){1&s&&(e.j41(0,"span",80),e.pXf(1,41),e.k0s())}function nr(s,a){1&s&&(e.j41(0,"span",80),e.pXf(1,42),e.k0s())}function sr(s,a){if(1&s&&e.DNE(0,or,2,0,"span",79)(1,nr,2,0,"span",79),2&s){e.XpG();const t=e.sdS(2),o=e.XpG();e.Y8G("ngIf",o.rbdForm.showError("stripingCount",t,"required")),e.R7$(),e.Y8G("ngIf",o.rbdForm.showError("stripingCount",t,"min"))}}function ir(s,a){if(1&s){const t=e.RV6();e.qex(0),e.j41(1,"form",45,0)(3,"div",46),e.PLo(4,8),e.nI1(5,"titlecase"),e.nI1(6,"upperFirst"),e.j41(7,"cd-help-text"),e.DNE(8,ra,2,1,"div",47),e.k0s(),e.YFu(),e.k0s(),e.DNE(9,_a,5,3,"div",48),e.j41(10,"div",49)(11,"cds-text-label",50),e.PLo(12,9),e.nrm(13,"input",51),e.YFu(),e.k0s(),e.DNE(14,da,2,2,"ng-template",null,1,e.C5r),e.k0s(),e.j41(16,"div",52),e.bIt("change",function(n){e.eBV(t);const i=e.XpG();return e.Njj(i.onPoolChange(n.target.value))}),e.DNE(17,ma,3,0,"cds-text-label",53)(18,Ta,5,6,"cds-select",54)(19,Ea,1,1,"ng-template",null,2,e.C5r),e.k0s(),e.j41(21,"div",49)(22,"cds-checkbox",55),e.bIt("checkedChange",function(){e.eBV(t);const n=e.XpG();return e.Njj(n.setMirrorMode())}),e.PLo(23,10),e.nrm(24,"cd-help-text"),e.YFu(),e.k0s(),e.DNE(25,Ca,5,1,"cd-alert-panel",56)(26,Fa,5,1,"cd-alert-panel",57),e.k0s(),e.DNE(27,Oa,4,2,"div",48)(28,Na,6,4,"div",48)(29,Ia,5,1,"div",48)(30,ya,4,1,"div",48)(31,Xa,4,2,"div",48),e.j41(32,"div",49),e.DNE(33,Ha,5,4,"cds-select",58),e.k0s(),e.j41(34,"div",49)(35,"cds-text-label",59),e.PLo(36,11),e.nrm(37,"input",60),e.YFu(),e.k0s(),e.DNE(38,za,3,3,"ng-template",null,3,e.C5r),e.k0s(),e.j41(40,"cd-form-advanced-fieldset")(41,"div",61)(42,"fieldset")(43,"label",62),e.pXf(44,12),e.k0s(),e.DNE(45,Qa,6,8,"ng-container",63),e.k0s()(),e.j41(46,"legend",64),e.pXf(47,13),e.k0s(),e.j41(48,"div",49)(49,"cds-select",65),e.PLo(50,14),e.DNE(51,Wa,2,2,"option",66),e.YFu(),e.k0s()(),e.j41(52,"div",49)(53,"cds-select",67),e.PLo(54,15),e.nrm(55,"option",68),e.DNE(56,Ja,2,2,"option",66),e.YFu(),e.k0s(),e.DNE(57,tr,2,2,"ng-template",null,4,e.C5r),e.k0s(),e.j41(59,"div",49),e.nrm(60,"cds-number",69),e.DNE(61,sr,2,2,"ng-template",null,5,e.C5r),e.k0s(),e.j41(63,"cd-rbd-configuration-form",70),e.bIt("changes",function(n){e.eBV(t);const i=e.XpG();return e.Njj(i.getDirtyConfigurationValues=n)}),e.k0s()(),e.j41(64,"cd-form-button-panel",71),e.nI1(65,"titlecase"),e.nI1(66,"upperFirst"),e.bIt("submitActionEvent",function(){e.eBV(t);const n=e.XpG();return e.Njj(n.submit())}),e.k0s()(),e.bVm()}if(2&s){const t=e.sdS(2),o=e.sdS(15),n=e.sdS(39),i=e.sdS(58),r=e.sdS(62),_=e.XpG();e.R7$(),e.Y8G("formGroup",_.rbdForm),e.R7$(7),e.Y8G("ngIf","Copy"===_.action),e.uP7(e.bMT(5,35,_.action))(e.bMT(6,37,_.resource)),e.nnv(4),e.R7$(),e.Y8G("ngIf",_.rbdForm.getValue("parent")),e.R7$(2),e.Y8G("invalid",!_.rbdForm.controls.name.valid&&_.rbdForm.controls.name.dirty)("invalidText",o),e.R7$(2),e.Y8G("invalid",!_.rbdForm.controls.name.valid&&_.rbdForm.controls.name.dirty),e.R7$(4),e.Y8G("ngIf","editing"===_.mode||!_.poolPermission.read),e.R7$(),e.Y8G("ngIf","editing"!==_.mode&&_.poolPermission.read),e.R7$(7),e.Y8G("ngIf",_.showMirrorDisableMessage),e.R7$(),e.Y8G("ngIf","disabled"===_.currentPoolMirrorMode),e.R7$(),e.Y8G("ngIf",_.mirroring&&"disabled"!==_.currentPoolMirrorMode),e.R7$(),e.Y8G("ngIf","snapshot"===_.rbdForm.getValue("mirroringMode")&&_.mirroring),e.R7$(),e.Y8G("ngIf",_.allDataPools.length>1||"editing"===_.mode),e.R7$(),e.Y8G("ngIf",_.rbdForm.getValue("useDataPool")),e.R7$(),e.Y8G("ngIf","editing"!==_.mode&&_.rbdForm.getValue("pool")&&null===_.namespaces),e.R7$(2),e.Y8G("ngIf","editing"===_.mode&&_.rbdForm.getValue("namespace")||"editing"!==_.mode&&(_.namespaces&&_.namespaces.length>0||!_.poolPermission.read)),e.R7$(2),e.Y8G("invalid",!_.rbdForm.controls.size.valid&&_.rbdForm.controls.size.dirty)("invalidText",n),e.R7$(2),e.Y8G("invalid",!_.rbdForm.controls.size.valid&&_.rbdForm.controls.size.dirty),e.R7$(8),e.Y8G("ngForOf",_.featuresList),e.R7$(6),e.Y8G("ngForOf",_.objectSizes),e.R7$(2),e.Y8G("invalid",!_.rbdForm.controls.stripingUnit.valid&&_.rbdForm.controls.stripingUnit.dirty)("invalidText",i),e.R7$(2),e.Y8G("ngValue",null),e.R7$(),e.Y8G("ngForOf",_.objectSizes),e.R7$(4),e.Y8G("min",1)("invalid",!_.rbdForm.controls.stripingCount.valid&&_.rbdForm.controls.stripingCount.dirty)("invalidText",r)("required",!0),e.R7$(3),e.Y8G("form",_.rbdForm)("initializeData",_.initializeConfigData),e.R7$(),e.Y8G("form",t)("submitText",e.bMT(65,39,_.action)+" "+e.bMT(66,41,_.resource))}}let We=(()=>{class s extends we.g{authStorageService;route;poolService;rbdService;formatter;taskWrapper;dimlessBinaryPipe;actionLabels;router;rbdMirroringService;poolPermission;rbdForm;getDirtyConfigurationValues;namespaces=[];namespacesByPoolCache={};pools=null;allPools=null;dataPools=null;allDataPools=[];features;featuresList=[];initializeConfigData=new Ht.m(1);pool;peerConfigured=!1;advancedEnabled=!1;rbdFormMode=jt;mode;response;snapName;defaultObjectSize="4 MiB";mirroringOptions=[{value:"journal",text:se.journalTooltipText},{value:"snapshot",text:se.snapshotTooltipText}];poolMirrorMode;mirroring=!1;currentPoolName="";currentPoolMirrorMode="";copyMessage=se.copy;objectSizes=["4 KiB","8 KiB","16 KiB","32 KiB","64 KiB","128 KiB","256 KiB","512 KiB","1 MiB","2 MiB","4 MiB","8 MiB","16 MiB","32 MiB"];defaultStripingUnit="4 MiB";defaultStripingCount=1;action;resource;rbdImage=new Ht.m(1);routerUrl;icons=C.F;currentImageMirrorMode="";showMirrorDisableMessage=!1;constructor(t,o,n,i,r,_,c,u,S,M){super(),this.authStorageService=t,this.route=o,this.poolService=n,this.rbdService=i,this.formatter=r,this.taskWrapper=_,this.dimlessBinaryPipe=c,this.actionLabels=u,this.router=S,this.rbdMirroringService=M,this.routerUrl=this.router.url,this.poolPermission=this.authStorageService.getPermissions().pool,this.resource="\u6620\u50CF",this.features={"deep-flatten":{desc:"\u5B8C\u5168\u5C55\u5F00",requires:null,allowEnable:!1,allowDisable:!0,helperHtml:"Feature can be disabled but can't be re-enabled later",helperText:"Speeds up the process of deleting a clone by removing the dependency on the parent image."},layering:{desc:"\u5206\u5C42",requires:null,allowEnable:!1,allowDisable:!1,helperHtml:"Feature flag can't be manipulated after the image is created. Disabling this option will also disable the Protect and Clone actions on Snapshot",helperText:"Allows the creation of snapshots and clones of an image."},"exclusive-lock":{desc:"\u4E92\u65A5\u9501",requires:null,allowEnable:!0,allowDisable:!0,helperText:"Ensures that only one client can write to the image at a time."},"object-map":{desc:"object map\uFF08\u9700\u8981\u4E92\u65A5\u9501\u652F\u6301\uFF09",requires:"exclusive-lock",allowEnable:!0,allowDisable:!0,initDisabled:!0,helperText:"Tracks which objects actually exist (have data stored on a device). Enabling object map support speeds up I/O operations for cloning, importing and exporting a sparsely populated image, and deleting."},"fast-diff":{desc:"Fast diff\uFF08\u4E0E object-map \u4E92\u9501\uFF09",requires:"object-map",allowEnable:!0,allowDisable:!0,interlockedWith:"object-map",initDisabled:!0,helperText:"Speeds up the process of comparing two images."}},this.featuresList=this.objToArray(this.features),this.createForm()}objToArray(t){return f().map(t,(o,n)=>Object.assign(o,{key:n}))}createForm(){this.rbdForm=new j.$({parent:new l.hs(""),name:new l.hs("",{validators:[l.k0.required,l.k0.pattern(/^[^@/]+?$/)]}),pool:new l.hs(null,{validators:[l.k0.required]}),namespace:new l.hs(null),useDataPool:new l.hs(!1),dataPool:new l.hs(null),size:new l.hs(null,{updateOn:"blur"}),obj_size:new l.hs(this.defaultObjectSize),features:new j.$(this.featuresList.reduce((t,o)=>(t[o.key]=new l.hs({value:!1,disabled:!!o.initDisabled}),t),{})),mirroring:new l.hs(!1),schedule:new l.hs("",{validators:[l.k0.pattern(/^([0-9]+)d|([0-9]+)h|([0-9]+)m$/),h.xQ.requiredIf({mirroringMode:"snapshot",mirroring:!0})]}),mirroringMode:new l.hs(""),stripingUnit:new l.hs(this.defaultStripingUnit),stripingCount:new l.hs(this.defaultStripingCount,{updateOn:"blur"})},this.validateRbdForm(this.formatter))}disableForEdit(){this.rbdForm.get("parent").disable(),this.rbdForm.get("pool").disable(),this.rbdForm.get("namespace").disable(),this.rbdForm.get("useDataPool").disable(),this.rbdForm.get("dataPool").disable(),this.rbdForm.get("obj_size").disable(),this.rbdForm.get("stripingUnit").disable(),this.rbdForm.get("stripingCount").disable(),this.rbdImage.subscribe(t=>{t.image_format===at.V1?(this.rbdForm.get("deep-flatten").disable(),this.rbdForm.get("layering").disable(),this.rbdForm.get("exclusive-lock").disable()):(this.rbdForm.get("deep-flatten").value||this.rbdForm.get("deep-flatten").disable(),this.rbdForm.get("layering").disable())})}disableForClone(){this.rbdForm.get("parent").disable(),this.rbdForm.get("size").disable()}disableForCopy(){this.rbdForm.get("parent").disable(),this.rbdForm.get("size").disable()}ngOnInit(){this.prepareFormForAction(),this.gatherNeededData().subscribe(this.handleExternalData.bind(this))}setExclusiveLock(){this.mirroring&&"journal"===this.rbdForm.get("mirroringMode").value?(this.rbdForm.get("exclusive-lock").setValue(!0),this.rbdForm.get("exclusive-lock").disable()):this.rbdForm.get("exclusive-lock").enable()}setMirrorMode(){this.mirroring=!this.mirroring,this.mirroring&&this.rbdForm.get("mirroringMode").setValue(this.mirroringOptions[0].value),this.setExclusiveLock(),this.checkPeersConfigured()}checkPeersConfigured(t){var o=t||this.rbdForm.get("pool").value;this.rbdMirroringService.getPeerForPool(o).subscribe(n=>{n.length>0&&(this.peerConfigured=!0)})}setPoolMirrorMode(){this.currentPoolName=this.mode===this.rbdFormMode.editing?this.response?.pool_name:this.rbdForm.getValue("pool"),this.currentPoolName?(this.rbdMirroringService.refresh(),this.rbdMirroringService.subscribeSummary(t=>{const o=t.content_data.pools.find(n=>n.name===this.currentPoolName);this.currentPoolMirrorMode=o.mirror_mode,this.mode===this.rbdFormMode.editing?(this.showMirrorDisableMessage="pool"===this.currentPoolMirrorMode,"image"!==this.currentPoolMirrorMode&&(this.rbdForm.get("mirroring").disable(),this.rbdForm.get("mirroringMode").disable())):"disabled"===o.mirror_mode?(this.mirroring=!1,this.rbdForm.get("mirroring").setValue(this.mirroring),this.rbdForm.get("mirroring").disable()):(this.mirroring=!0,this.rbdForm.get("mirroring").enable(),this.rbdForm.get("mirroring").setValue(this.mirroring),this.rbdForm.get("mirroringMode").setValue(this.mirroringOptions[0].value))})):this.mode!==this.rbdFormMode.editing&&this.rbdForm.get("mirroring").disable(),this.setExclusiveLock()}prepareFormForAction(){const t=this.routerUrl;t.startsWith("/block/rbd/edit")?(this.mode=this.rbdFormMode.editing,this.action=this.actionLabels.EDIT,this.disableForEdit()):t.startsWith("/block/rbd/clone")?(this.mode=this.rbdFormMode.cloning,this.disableForClone(),this.action=this.actionLabels.CLONE):t.startsWith("/block/rbd/copy")?(this.mode=this.rbdFormMode.copying,this.action=this.actionLabels.COPY,this.disableForCopy()):this.action=this.actionLabels.CREATE,f().each(this.features,o=>{this.rbdForm.get("features").get(o.key).valueChanges.subscribe(n=>this.featureFormUpdate(o.key,n))})}gatherNeededData(){const t={};return this.mode?this.route.params.subscribe(o=>{const n=w.J.fromString(decodeURIComponent(o.image_spec));o.snap&&(this.snapName=decodeURIComponent(o.snap)),t.rbd=this.rbdService.get(n),this.checkPeersConfigured(n.poolName)}):t.defaultFeatures=this.rbdService.defaultFeatures(),this.mode!==this.rbdFormMode.editing&&this.poolPermission.read&&(t.pools=this.poolService.list(["pool_name","type","flags_names","application_metadata"])),(0,J.p)(t)}handleExternalData(t){if(this.handlePoolData(t.pools),this.setPoolMirrorMode(),t.defaultFeatures&&this.setFeatures(t.defaultFeatures),t.rbd){const o=t.rbd;this.setResponse(o,this.snapName),this.rbdImage.next(o)}this.loadingReady()}handlePoolData(t){if(!t)return;const o=[],n=[];for(const i of t)this.rbdService.isRBDPool(i)&&("replicated"===i.type?(o.push(i),n.push(i)):"erasure"===i.type&&-1!==i.flags_names.indexOf("ec_overwrites")&&n.push(i));if(this.pools=o,this.allPools=o,this.dataPools=n,this.allDataPools=n,this.pools.length>=1){const r=this.pools.map(_=>_.pool_name).includes("rbd")?"rbd":this.pools[0].pool_name;this.rbdForm.get("pool").setValue(r),this.onPoolChange(r)}this.allDataPools.length<=1&&this.rbdForm.get("useDataPool").disable()}onPoolChange(t){const o=this.rbdForm.get("dataPool");o.value===t&&o.setValue(null),this.dataPools=this.allDataPools?this.allDataPools.filter(n=>n.pool_name!==t):[],this.namespaces=null,t in this.namespacesByPoolCache?this.namespaces=this.namespacesByPoolCache[t]:this.rbdService.listNamespaces(t).subscribe(n=>{n=n.map(i=>i.namespace),this.namespacesByPoolCache[t]=n,this.namespaces=n}),this.rbdForm.get("namespace").setValue(null)}onUseDataPoolChange(){this.rbdForm.getValue("useDataPool")||(this.rbdForm.get("dataPool").setValue(null),this.onDataPoolChange(null))}onDataPoolChange(t){const o=this.allPools.filter(n=>n.pool_name!==t);this.rbdForm.getValue("pool")===t&&this.rbdForm.get("pool").setValue(null),this.pools=o}validateRbdForm(t){return o=>{const n=o.get("useDataPool"),i=o.get("dataPool");let r=null;n.value&&null==i.value&&(r={required:!0}),i.setErrors(r);const _=o.get("size"),c=o.get("obj_size"),u=t.toBytes(null!=c.value?c.value:this.defaultObjectSize),S=o.get("stripingCount"),M=null!=S.value?S.value:this.defaultStripingCount;let E=null;null===_.value?E={required:!0}:M*u>=t.toBytes(_.value)&&(E={invalidSizeObject:!0}),_.setErrors(E);const N=o.get("stripingUnit");let G=null;null===N.value&&null!==S.value?G={required:!0}:null!==N.value&&t.toBytes(N.value)>u&&(G={invalidStripingUnit:!0}),N.setErrors(G);let y=null;return null===S.value&&null!==N.value?y={required:!0}:M<1&&(y={min:!0}),S.setErrors(y),null}}deepBoxCheck(t,o){this.getDependentChildFeatures(t).forEach(i=>{const r=this.rbdForm.get(i.key);o?r.enable({emitEvent:!1}):(r.disable({emitEvent:!1}),r.setValue(!1,{emitEvent:!1}),this.deepBoxCheck(i.key,o));const _=this.rbdForm.get("features");this.mode===this.rbdFormMode.editing&&_.get(i.key).enabled&&(-1!==this.response.features_name.indexOf(i.key)&&!i.allowDisable||-1===this.response.features_name.indexOf(i.key)&&!i.allowEnable)&&_.get(i.key).disable()})}getDependentChildFeatures(t){return f().filter(this.features,o=>o.requires===t)||[]}interlockCheck(t,o){const n=this.featuresList.find(i=>i.key===t);if(this.response){const i=null!=n.interlockedWith,r=this.featuresList.find(c=>c.interlockedWith===n.key),_=!!this.response.features_name.find(c=>c===n.key);if(i){if(_!==!!this.response.features_name.find(u=>u===n.interlockedWith))return}else if(r&&!!this.response.features_name.find(u=>u===r.key)!==_)return}o?f().filter(this.features,i=>i.interlockedWith===t).forEach(i=>this.rbdForm.get(i.key).setValue(!0,{emitEvent:!1})):n.interlockedWith&&this.rbdForm.get("features").get(n.interlockedWith).setValue(!1)}featureFormUpdate(t,o){if(o){const n=this.features[t].requires;if(n&&!this.rbdForm.getValue(n))return void this.rbdForm.get(`features.${t}`).setValue(!1)}this.deepBoxCheck(t,o),this.interlockCheck(t,o)}setFeatures(t){const o=this.rbdForm.get("features");f().forIn(this.features,n=>{-1!==t.indexOf(n.key)&&o.get(n.key).setValue(!0),this.featureFormUpdate(n.key,o.get(n.key).value)})}setResponse(t,o){this.response=t;const n=new w.J(t.pool_name,t.namespace,t.name).toString();if(this.mode===this.rbdFormMode.cloning)this.rbdForm.get("parent").setValue(`${n}@${o}`);else if(this.mode===this.rbdFormMode.copying)o?this.rbdForm.get("parent").setValue(`${n}@${o}`):this.rbdForm.get("parent").setValue(`${n}`);else if(t.parent){const i=t.parent;this.rbdForm.get("parent").setValue(`${i.pool_name}/${i.image_name}@${i.snap_name}`)}this.mode===this.rbdFormMode.editing&&(this.rbdForm.get("name").setValue(t.name),"snapshot"===t?.mirror_mode||t.features_name.includes("journaling")?(this.mirroring=!0,this.rbdForm.get("mirroring").setValue(this.mirroring),this.rbdForm.get("mirroringMode").setValue(t?.mirror_mode),this.currentImageMirrorMode=t?.mirror_mode,this.rbdForm.get("schedule").setValue(t?.schedule_interval)):(this.mirroring=!1,this.rbdForm.get("mirroring").setValue(this.mirroring)),this.setPoolMirrorMode()),this.rbdForm.get("pool").setValue(t.pool_name),this.onPoolChange(t.pool_name),this.rbdForm.get("namespace").setValue(t.namespace),t.data_pool&&(this.rbdForm.get("useDataPool").setValue(!0),this.rbdForm.get("dataPool").setValue(t.data_pool)),this.rbdForm.get("size").setValue(this.dimlessBinaryPipe.transform(t.size)),this.rbdForm.get("obj_size").setValue(this.dimlessBinaryPipe.transform(t.obj_size)),this.setFeatures(t.features_name),this.rbdForm.get("stripingUnit").setValue(this.dimlessBinaryPipe.transform(t.stripe_unit)),this.rbdForm.get("stripingCount").setValue(t.stripe_count),this.initializeConfigData.next({initialData:this.response.configuration,sourceType:Rt.M.image})}createRequest(){const t=new ta;return t.pool_name=this.rbdForm.getValue("pool"),t.namespace=this.rbdForm.getValue("namespace"),t.name=this.rbdForm.getValue("name"),t.schedule_interval=this.rbdForm.getValue("schedule"),t.size=this.formatter.toBytes(this.rbdForm.getValue("size")),this.addObjectSizeAndStripingToRequest(t),t.configuration=this.getDirtyConfigurationValues(),this.mirroring&&"image"===this.currentPoolMirrorMode&&(t.mirror_mode=this.rbdForm.getValue("mirroringMode")),t}addObjectSizeAndStripingToRequest(t){t.obj_size=this.formatter.toBytes(this.rbdForm.getValue("obj_size")),f().forIn(this.features,o=>{this.rbdForm.getValue(o.key)&&t.features.push(o.key)}),this.mirroring&&"journal"===this.rbdForm.getValue("mirroringMode")&&t.features.push("journaling"),t.stripe_unit=this.formatter.toBytes(this.rbdForm.getValue("stripingUnit")),t.stripe_count=this.rbdForm.getValue("stripingCount"),t.data_pool=this.rbdForm.getValue("dataPool")}createAction(){const t=this.createRequest();return this.taskWrapper.wrapTaskAroundCall({task:new R.O("rbd/create",{pool_name:t.pool_name,namespace:t.namespace,image_name:t.name,schedule_interval:t.schedule_interval,start_time:t.start_time,mirror_mode:t.mirror_mode}),call:this.rbdService.create(t)})}editRequest(){const t=new Ot;if(t.name=this.rbdForm.getValue("name"),t.schedule_interval=this.rbdForm.getValue("schedule"),t.enable_mirror=this.mirroring,t.size=this.formatter.toBytes(this.rbdForm.getValue("size")),f().forIn(this.features,o=>{this.rbdForm.getValue(o.key)&&t.features.push(o.key)}),t.enable_mirror)t.image_mirror_mode=this.currentImageMirrorMode,"journal"===this.rbdForm.getValue("mirroringMode")&&(t.mirror_mode="journal",t.features.push("journaling")),"image"===this.currentPoolMirrorMode&&(t.mirror_mode=this.rbdForm.getValue("mirroringMode"));else{const o=t.features.indexOf("journaling",0);o>-1&&t.features.splice(o,1)}return t.configuration=this.getDirtyConfigurationValues(),t}cloneRequest(){const t=new Ji;return t.child_pool_name=this.rbdForm.getValue("pool"),t.child_namespace=this.rbdForm.getValue("namespace"),t.child_image_name=this.rbdForm.getValue("name"),this.addObjectSizeAndStripingToRequest(t),t.configuration=this.getDirtyConfigurationValues(!0,Rt.M.image),t}editAction(){const t=new w.J(this.response.pool_name,this.response.namespace,this.response.name);return this.taskWrapper.wrapTaskAroundCall({task:new R.O("rbd/edit",{image_spec:t.toString()}),call:this.rbdService.update(t,this.editRequest())})}cloneAction(){const t=this.cloneRequest(),o=new w.J(this.response.pool_name,this.response.namespace,this.response.name);return this.taskWrapper.wrapTaskAroundCall({task:new R.O("rbd/clone",{parent_image_spec:o.toString(),parent_snap_name:this.snapName,child_pool_name:t.child_pool_name,child_namespace:t.child_namespace,child_image_name:t.child_image_name}),call:this.rbdService.cloneSnapshot(o,this.snapName,t)})}copyRequest(){const t=new Zi;return this.snapName&&(t.snapshot_name=this.snapName),t.dest_pool_name=this.rbdForm.getValue("pool"),t.dest_namespace=this.rbdForm.getValue("namespace"),t.dest_image_name=this.rbdForm.getValue("name"),this.addObjectSizeAndStripingToRequest(t),t.configuration=this.getDirtyConfigurationValues(!0,Rt.M.image),t}copyAction(){const t=this.copyRequest(),o=new w.J(this.response.pool_name,this.response.namespace,this.response.name);return this.taskWrapper.wrapTaskAroundCall({task:new R.O("rbd/copy",{src_image_spec:o.toString(),dest_pool_name:t.dest_pool_name,dest_namespace:t.dest_namespace,dest_image_name:t.dest_image_name}),call:this.rbdService.copy(o,t)})}shouldDisable(t){return"pool"===this.currentPoolMirrorMode&&"snapshot"===t||null}submit(){this.mode||this.rbdImage.next("create"),this.rbdImage.pipe((0,qi.$)(),(0,Qi.n)(()=>this.mode===this.rbdFormMode.editing?this.editAction():this.mode===this.rbdFormMode.cloning?this.cloneAction():this.mode===this.rbdFormMode.copying?this.copyAction():this.createAction())).subscribe(()=>{},()=>this.rbdForm.setErrors({cdSubmitButton:!0}),()=>this.router.navigate(["/block/rbd"]))}onAlertAction(){this.router.navigate(["/block/mirroring",{outlets:{modal:["edit",this.rbdForm.getValue("pool")]}}])}static \u0275fac=function(o){return new(o||s)(e.rXU(U.v),e.rXU(p.nX),e.rXU(Qe.m),e.rXU(Z.U),e.rXU(Mt.k),e.rXU(I.a),e.rXU(ke.l),e.rXU(F.Ss),e.rXU(p.Ix),e.rXU(fe.B))};static \u0275cmp=e.VBU({type:s,selectors:[["cd-rbd-form"]],features:[e.Vt3],decls:2,vars:3,consts:()=>{let t,o,n,i,r,_,c,u,S,M,E,N,G,y,x,ae,re,_e,H,Ee,L,Ne,Pe,Ie,Ae,De,$e,ve,Le,B,Ze,et,tt,ot,nt;return t="" + "\ufffd0\ufffd" + " " + "\ufffd1\ufffd" + " " + "\ufffd#7\ufffd" + "" + "\ufffd*8:1\ufffd\ufffd#1:1\ufffd" + "" + "\ufffd0:1\ufffd" + " " + "\ufffd/#1:1\ufffd\ufffd/*8:1\ufffd" + "" + "\ufffd/#7\ufffd" + "",o="Name " + "\ufffd#13\ufffd\ufffd/#13\ufffd" + "",n="Mirroring " + "\ufffd#24\ufffd" + "Allow data to be asynchronously mirrored between two Ceph clusters" + "\ufffd/#24\ufffd" + "",i="Size " + "\ufffd#37\ufffd\ufffd/#37\ufffd" + "",r="\u7279\u6027",_="\u6761\u5E26",c="" + "\ufffd*51:1\ufffd\ufffd#1:1\ufffd" + "" + "\ufffd0:1\ufffd" + "" + "\ufffd/#1:1\ufffd\ufffd/*51:1\ufffd" + "",u="" + "\ufffd#55\ufffd" + "-- Select stripe unit --" + "[\ufffd/#55\ufffd|\ufffd/#1:1\ufffd\ufffd/*56:1\ufffd]" + "" + "\ufffd*56:1\ufffd\ufffd#1:1\ufffd" + "" + "\ufffd0:1\ufffd" + "" + "[\ufffd/#55\ufffd|\ufffd/#1:1\ufffd\ufffd/*56:1\ufffd]" + "",u=e.k04(u),S="" + "\ufffd0\ufffd" + " from " + "\ufffd#4\ufffd\ufffd/#4\ufffd" + "",M="\u8FD9\u662F\u5FC5\u586B\u5B57\u6BB5\uFF01",E="\u4E0D\u5141\u8BB8\u4F7F\u7528 \"/\" \u548C \"@\"\u3002",N="Pool " + "\ufffd#2\ufffd\ufffd/#2\ufffd" + "",G="\u6B63\u5728\u52A0\u8F7D...",y="-- No block pools available --",x="-- \u8BF7\u9009\u62E9\u5B58\u50A8\u6C60 --",ae="\u8FD9\u662F\u5FC5\u586B\u5B57\u6BB5\uFF01",re=" You need to set mode as\xA0" + "\ufffd#2\ufffd" + "Image" + "\ufffd/#2\ufffd" + "\xA0in the selected pool to enable snapshot mirroring. ",_e="Schedule Interval " + "\ufffd#3\ufffd\ufffd/#3\ufffd" + "",H="\u8FD9\u662F\u5FC5\u586B\u5B57\u6BB5\uFF01",Ee=" Use a dedicated data pool " + "\ufffd#3\ufffd" + "Use a dedicated pool to store the image data. If not selected, the image data will be stored in the same pool as the image metadata. " + "\ufffd/#3\ufffd" + "" + "\ufffd*4:1\ufffd\ufffd#1:1\ufffd" + "" + "\ufffd#2:1\ufffd" + "You need more than one pool with the rbd application label use to use a dedicated data pool." + "\ufffd/#2:1\ufffd" + "" + "\ufffd/#1:1\ufffd\ufffd/*4:1\ufffd" + "",L="\u6B63\u5728\u52A0\u8F7D...",Ne="-- \u6CA1\u6709\u53EF\u7528\u7684\u6570\u636E\u6C60 --",Pe="-- Select a data pool --",Ie="\u8FD9\u662F\u5FC5\u586B\u5B57\u6BB5\uFF01",Ae="\u6B63\u5728\u52A0\u8F7D...",De="\u6B63\u5728\u52A0\u8F7D...",$e="-- \u6CA1\u6709\u53EF\u7528\u7684\u540D\u79F0\u7A7A\u95F4 --",ve="-- \u8BF7\u9009\u62E9\u540D\u79F0\u7A7A\u95F4 --",Le="\u8FD9\u662F\u5FC5\u586B\u5B57\u6BB5\uFF01",B="\u60A8\u5FC5\u987B\u63D0\u9AD8\u5BB9\u91CF\u3002",Ze="Size must be a number or in a valid format. eg: 5 GiB",et="\u56E0\u4E3A\u8BBE\u7F6E\u4E86\u6761\u5E26\u4E2A\u6570\uFF0C\u6240\u4EE5\u8FD9\u662F\u5FC5\u586B\u5B57\u6BB5\uFF01",tt="\u6761\u5E26\u5355\u5143\u5927\u5C0F\u8D85\u8FC7\u4E86\u5BF9\u8C61\u5927\u5C0F\u3002",ot="\u56E0\u4E3A\u8BBE\u7F6E\u4E86\u6761\u5E26\u5355\u5143\u5927\u5C0F\uFF0C\u6240\u4EE5\u8FD9\u662F\u5FC5\u586B\u5B57\u6BB5\uFF01",nt="\u6761\u5E26\u4E2A\u6570\u5FC5\u987B\u5927\u4E8E 0\u3002",[["formDir","ngForm"],["nameError",""],["poolError",""],["sizeError",""],["stripingUnitError",""],["stripingCountError",""],["scheduleError",""],["dataPoolError",""],t,o,n,i,r,_,c,u,S,M,E,N,G,y,x,ae,re,_e,H,Ee,L,Ne,Pe,Ie,Ae,De,$e,ve,Le,B,Ze,et,tt,ot,nt,["cdsCol","",3,"columnNumbers"],[4,"cdFormLoading"],["name","rbdForm","novalidate","",3,"formGroup"],[1,"form-header"],[4,"ngIf"],["class","form-item",4,"ngIf"],[1,"form-item"],["for","name","cdRequiredField","Name",3,"invalid","invalidText"],["cdsText","","type","text","placeholder","Name...","id","name","name","name","formControlName","name","autofocus","",3,"invalid"],[1,"form-item",3,"change"],["for","pool",4,"ngIf"],["label","Pool","for","pool","name","pool","id","pool","formControlName","pool","cdRequiredField","Pool",3,"invalid","invalidText",4,"ngIf"],["id","mirroring","name","mirroring","formControlName","mirroring",3,"checkedChange"],["spacingClass","mt-2","type","info",3,"showTitle",4,"ngIf"],["type","info","spacingClass","mt-2","actionName","Set mode",3,"showTitle","action",4,"ngIf"],["label","Namespace","helperText","Namespace allows you to logically group RBD images within your Ceph Cluster.Choosing a namespace makes it easier to locate and manage related RBD images efficiently","for","namespace","name","namespace","id","namespace","formControlName","namespace",4,"ngIf"],["for","size","cdRequiredField","Size",3,"invalid","invalidText"],["cdsText","","type","text","placeholder","e.g., 10GiB","id","size","name","size","formControlName","size","defaultUnit","GiB","cdDimlessBinary","",3,"invalid"],["formGroupName","features",1,"form-item"],["for","features",1,"cds--label"],[4,"ngFor","ngForOf"],[1,"cd-header"],["for","obj_size","label","Object size","helperText","Objects in the Ceph Storage Cluster have a maximum configurable size (e.g., 2MB, 4MB, etc.). The object size should be large enough to accommodate many stripe units, and should be a multiple of the stripe unit.","id","obj_size","name","obj_size","formControlName","obj_size"],[3,"value",4,"ngFor","ngForOf"],["for","stripingUnit","label","Stripe unit","helperText","Stripes have a configurable unit size (e.g., 64kb). The Ceph Client divides the data it will write to objects into equally sized stripe units, except for the last stripe unit. A stripe width, should be a fraction of the Object Size so that an object may contain many stripe units","id","stripingUnit","name","stripingUnit","formControlName","stripingUnit","cdRequiredField","Striping Unit",3,"invalid","invalidText"],[3,"ngValue"],["for","stripingCount","label","Stripe count","helperText","The Ceph Client writes a sequence of stripe units over a series of objects determined by the stripe count. The series of objects is called an object set. After the Ceph Client writes to the last object in the object set, it returns to the first object in the object set.","id","stripingCount","name","stripingCount","formControlName","stripingCount","cdRequiredField","Striping Count",3,"min","invalid","invalidText","required"],[3,"changes","form","initializeData"],["wrappingClass","text-right",3,"submitActionEvent","form","submitText"],["for","parent"],["cdsText","","type","text","id","parent","name","parent","formControlName","parent","autofocus",""],["for","pool"],["cdsText","","type","text","placeholder","Pool name...","id","pool","name","pool","formControlName","pool"],["label","Pool","for","pool","name","pool","id","pool","formControlName","pool","cdRequiredField","Pool",3,"invalid","invalidText"],[3,"ngValue",4,"ngIf"],[3,"value"],["class","invalid-feedback",4,"ngIf"],[1,"invalid-feedback"],["spacingClass","mt-2","type","info",3,"showTitle"],["type","info","spacingClass","mt-2","actionName","Set mode",3,"action","showTitle"],["formControlName","mirroringMode","name","mirroringMode"],[3,"value","id","disabled","change",4,"ngFor","ngForOf"],[3,"change","value","id","disabled"],["for","schedule","helperText","Create Mirror-Snapshots automatically on a periodic basis. The interval can be specified in days, hours, or minutes using d, h, m suffix respectively. To create mirror snapshots, you must import or create and have available peers to mirror","cdRequiredField","Schedule Interval",3,"invalid","invalidText"],["cdsText","","type","text","placeholder","e.g., 12h or 1d or 10m","id","schedule","name","schedule","formControlName","schedule",3,"disabled","invalid"],["id","useDataPool","name","useDataPool","formControlName","useDataPool",3,"change"],["label","Data pool","helperText","Dedicated pool that stores the object-data of the RBD","for","dataPool","name","dataPool","id","dataPool","formControlName","dataPool","cdRequiredField","Data pool",3,"invalid","invalidText",4,"ngIf"],["label","Data pool","helperText","Dedicated pool that stores the object-data of the RBD","for","dataPool","name","dataPool","id","dataPool","formControlName","dataPool","cdRequiredField","Data pool",3,"invalid","invalidText"],["label","Namespace","for","namespace","name","namespace","id","namespace","formControlName","namespace",3,"skeleton"],["label","Namespace","helperText","Namespace allows you to logically group RBD images within your Ceph Cluster.Choosing a namespace makes it easier to locate and manage related RBD images efficiently","for","namespace","name","namespace","id","namespace","formControlName","namespace"],[1,"spacing-03",3,"id","name","formControlName"],["type","warning","spacingClass","mt-2",3,"showTitle",4,"ngIf"],["type","warning","spacingClass","mt-2",3,"showTitle"]]},template:function(o,n){1&o&&(e.j41(0,"div",43),e.DNE(1,ir,67,43,"ng-container",44),e.k0s()),2&o&&(e.Y8G("columnNumbers",e.lJ4(2,aa)),e.R7$(),e.Y8G("cdFormLoading",n.loading))},dependencies:[d.Sq,d.bT,l.qT,l.xH,l.y7,l.me,l.BC,l.cb,l.YS,l.j4,l.JD,l.$R,oa.m,He.m,V.e,Se.O,na.e,Xe.B,sa.Y,Gt.G,z.S,k.E,be.P,K.Zt,K.ks,je.ee,ye.Sc,ht.sx,ht.z6,g.l6,g.c$,bt.jM,ia.c,d.PV,Be.r]})}return s})();var Yt=m(3912),Nt=m(34177),ar=m(54980),Pt=m(2361),rr=m(35025),Ve=m.n(rr),rt=m(43808),_r=m(41861);function lr(s,a){1&s&&(e.j41(0,"cd-alert-panel",17)(1,"span"),e.pXf(2,4),e.k0s()())}function cr(s,a){1&s&&(e.j41(0,"span",20),e.pXf(1,5),e.k0s())}function dr(s,a){1&s&&(e.j41(0,"span",20),e.pXf(1,6),e.k0s())}function mr(s,a){if(1&s&&(e.j41(0,"div",13),e.nrm(1,"cd-date-time-picker",18),e.DNE(2,cr,2,0,"span",19)(3,dr,2,0,"span",19),e.k0s()),2&s){const t=e.XpG(),o=e.sdS(6);e.R7$(),e.Y8G("control",t.moveForm.get("expiresAt")),e.R7$(),e.Y8G("ngIf",t.moveForm.showError("expiresAt",o,"format")),e.R7$(),e.Y8G("ngIf",t.moveForm.showError("expiresAt",o,"expired"))}}let ur=(()=>{class s extends P.dW{rbdService;actionLabels;fb;taskWrapper;poolName;namespace;imageName;hasSnapshots;imageSpec;imageSpecStr;executingTasks;moveForm;pattern;setExpirationDate=!1;constructor(t,o,n,i,r,_,c,u){super(),this.rbdService=t,this.actionLabels=o,this.fb=n,this.taskWrapper=i,this.poolName=r,this.namespace=_,this.imageName=c,this.hasSnapshots=u,this.createForm()}createForm(){this.moveForm=this.fb.group({expiresAt:["",[h.xQ.custom("format",t=>!(""===t||Ve()(t,"YYYY-MM-DD HH:mm:ss").isValid())),h.xQ.custom("expired",t=>Ve()().isAfter(t))]],setExpiry:[!1]})}ngOnInit(){this.imageSpec=new w.J(this.poolName,this.namespace,this.imageName),this.imageSpecStr=this.imageSpec.toString(),this.pattern=`${this.poolName}/${this.imageName}`}moveImage(){let t=0;const o=this.moveForm.getValue("expiresAt");o&&(t=Ve()(o,"YYYY-MM-DD HH:mm:ss").diff(Ve()(),"seconds",!0)),t<0&&(t=0),this.taskWrapper.wrapTaskAroundCall({task:new R.O("rbd/trash/move",{image_spec:this.imageSpecStr}),call:this.rbdService.moveTrash(this.imageSpec,t)}).subscribe({complete:()=>{this.closeModal()}})}toggleExpiration(){this.setExpirationDate=!this.setExpirationDate,this.setExpirationDate||(this.moveForm.get("expiresAt").setValue(""),this.moveForm.get("expiresAt").markAsPristine(),this.moveForm.get("expiresAt").updateValueAndValidity())}static \u0275fac=function(o){return new(o||s)(e.rXU(Z.U),e.rXU(F.Ss),e.rXU(rt.$),e.rXU(I.a),e.rXU("poolName"),e.rXU("namespace"),e.rXU("imageName"),e.rXU("hasSnapshots"))};static \u0275cmp=e.VBU({type:s,selectors:[["cd-rbd-trash-move-modal"]],features:[e.Vt3],decls:17,vars:8,consts:()=>{let t,o,n,i,r,_,c;return t="\u5C06\u6620\u50CF\u79FB\u81F3\u56DE\u6536\u7AD9",o="\u8981\u5C06 " + "[\ufffd#10\ufffd|\ufffd#11\ufffd]" + "" + "\ufffd0\ufffd" + "" + "[\ufffd/#10\ufffd|\ufffd/#11\ufffd]" + " \u79FB\u81F3\u56DE\u6536\u7AD9\uFF0C\u8BF7\u70B9\u51FB" + "[\ufffd#10\ufffd|\ufffd#11\ufffd]" + "\u79FB\u52A8" + "[\ufffd/#10\ufffd|\ufffd/#11\ufffd]" + "\u3002\u60A8\u53EF\u4EE5\u89C6\u9700\u8981\u9009\u62E9\u4E00\u4E2A\u8D85\u671F\u65E5\u671F\u3002",o=e.k04(o),n="Set expiration date",i="\u6B64\u6620\u50CF\u5305\u542B\u5FEB\u7167\uFF0C\u8FD9\u5C06\u963B\u6B62\u6620\u50CF\u79FB\u81F3\u56DE\u6536\u7AD9\u540E\u88AB\u5220\u9664\u3002",r="\u4FDD\u62A4\u671F\u622A\u81F3",_="\u65E5\u671F\u683C\u5F0F\u6709\u8BEF\u3002\u8BF7\u4F7F\u7528 \"YYYY-MM-DD HH:mm:ss\"\u3002",c="\u4FDD\u62A4\u671F\u9650\u5DF2\u8FC7\u3002\u8BF7\u9009\u62E9\u4E00\u4E2A\u5C06\u6765\u7684\u65E5\u671F\u6216\u7559\u7A7A\u3002",[["formDir","ngForm"],t,o,n,i,_,c,["size","sm",3,"overlaySelected","open"],[3,"closeSelect"],["cdsModalHeaderHeading",""],["cdsModalContent",""],["name","moveForm","novalidate","",1,"form",3,"formGroup"],["type","warning","spacingClass","mb-2",4,"ngIf"],[1,"form-item"],["formControlName","setExpiry","id","setExpiry","name","setExpiry","modal-primary-focus","",3,"checkedChange"],["class","form-item",4,"ngIf"],[3,"submitActionEvent","form","submitText","modalForm"],["type","warning","spacingClass","mb-2"],["name",r,3,"control"],["class","invalid-feedback",4,"ngIf"],[1,"invalid-feedback"]]},template:function(o,n){if(1&o){const i=e.RV6();e.j41(0,"cds-modal",7),e.bIt("overlaySelected",function(){return e.eBV(i),e.Njj(n.closeModal())}),e.j41(1,"cds-modal-header",8),e.bIt("closeSelect",function(){return e.eBV(i),e.Njj(n.closeModal())}),e.j41(2,"h3",9),e.pXf(3,1),e.k0s()(),e.j41(4,"section",10)(5,"form",11,0),e.DNE(7,lr,3,0,"cd-alert-panel",12),e.j41(8,"p"),e.PLo(9,2),e.nrm(10,"kbd")(11,"kbd"),e.YFu(),e.k0s(),e.j41(12,"div",13)(13,"cds-checkbox",14),e.bIt("checkedChange",function(){return e.eBV(i),e.Njj(n.toggleExpiration())}),e.pXf(14,3),e.k0s()(),e.DNE(15,mr,4,3,"div",15),e.k0s()(),e.j41(16,"cd-form-button-panel",16),e.bIt("submitActionEvent",function(){return e.eBV(i),e.Njj(n.moveImage())}),e.k0s()()}2&o&&(e.Y8G("open",n.open),e.R7$(5),e.Y8G("formGroup",n.moveForm),e.R7$(2),e.Y8G("ngIf",n.hasSnapshots),e.R7$(4),e.uP7(n.imageSpecStr),e.nnv(9),e.R7$(4),e.Y8G("ngIf",n.setExpirationDate),e.R7$(),e.Y8G("form",n.moveForm)("submitText",n.actionLabels.MOVE)("modalForm",!0))},dependencies:[d.bT,l.qT,l.BC,l.cb,l.j4,l.JD,He.m,_r.P,V.e,k.E,ye.Sc,P.aF,P.rQ,P.$m,P.hN]})}return s})();var pr=m(40837),_t=m(1505),Kt=m(15416),zt=m(32609),It=m(12959),Je=m(71138),gr=m(63882),Ut=m(60977),qt=m(96343);function fr(s,a){if(1&s&&(e.PLo(0,3,1),e.j41(1,"span"),e.nrm(2,"b"),e.k0s(),e.YFu()),2&s){const t=e.XpG();e.R7$(2),e.uP7(t.imageName),e.nnv(0)}}function Tr(s,a){1&s&&(e.j41(0,"span",18),e.pXf(1,4),e.k0s())}function Sr(s,a){1&s&&(e.j41(0,"span",18),e.pXf(1,5),e.k0s())}function Er(s,a){if(1&s&&e.DNE(0,Tr,2,0,"span",17)(1,Sr,2,0,"span",17),2&s){const t=e.XpG(),o=e.sdS(8);e.Y8G("ngIf",t.snapshotForm.showError("snapshotName",o,"required")),e.R7$(),e.Y8G("ngIf",t.snapshotForm.showError("snapshotName",o,"pattern"))}}function Cr(s,a){if(1&s){const t=e.RV6();e.j41(0,"div",12)(1,"cds-checkbox",20),e.bIt("checkedChange",function(){e.eBV(t);const n=e.XpG(2);return e.Njj(n.onMirrorCheckBoxChange())}),e.pXf(2,6),e.k0s()()}if(2&s){const t=a.ngIf;e.R7$(),e.BMQ("disabled",!t.length>0||null)}}function Fr(s,a){if(1&s&&(e.qex(0),e.DNE(1,Cr,3,1,"div",19),e.nI1(2,"async"),e.bVm()),2&s){const t=e.XpG();e.R7$(),e.Y8G("ngIf",e.bMT(2,1,t.peerConfigured$))}}let Rr=(()=>{class s extends P.dW{cdsModalService;rbdService;taskManagerService;notificationService;actionLabels;rbdMirrorService;poolName;namespace;imageName;mirroring;snapName;snapshotForm;editing=!1;action;resource;onSubmit=new qt.B7;peerConfigured$;constructor(t,o,n,i,r,_,c,u="",S="",M="",E=""){super(),this.cdsModalService=t,this.rbdService=o,this.taskManagerService=n,this.notificationService=i,this.actionLabels=r,this.rbdMirrorService=_,this.poolName=c,this.namespace=u,this.imageName=S,this.mirroring=M,this.snapName=E,this.action=this.actionLabels.CREATE,this.resource="RBD \u5FEB\u7167",this.createForm()}createForm(){this.snapshotForm=new j.$({snapshotName:new l.hs("",{validators:[l.k0.required,l.k0.pattern(/^(?!\.)[^/@]+$/)]}),mirrorImageSnapshot:new l.hs(!1,{})})}ngOnInit(){this.peerConfigured$=this.rbdMirrorService.getPeerForPool(this.poolName)}setSnapName(t){this.snapName=t,this.snapshotForm.get("snapshotName").setValue(t)}onMirrorCheckBoxChange(){!0===this.snapshotForm.getValue("mirrorImageSnapshot")?(this.snapshotForm.get("snapshotName").setValue(""),this.snapshotForm.get("snapshotName").clearValidators()):(this.snapshotForm.get("snapshotName").setValue(this.snapName),this.snapshotForm.get("snapshotName").setValidators([l.k0.required]),this.snapshotForm.get("snapshotName").updateValueAndValidity())}setEditing(t=!0){this.editing=t,this.action=this.editing?this.actionLabels.RENAME:this.actionLabels.CREATE}editAction(){const t=this.snapshotForm.getValue("snapshotName"),o=new w.J(this.poolName,this.namespace,this.imageName),n=new R.O;n.name="rbd/snap/edit",n.metadata={image_spec:o.toString(),snapshot_name:t},this.rbdService.renameSnapshot(o,this.snapName,t).toPromise().then(()=>{this.taskManagerService.subscribe(n.name,n.metadata,i=>{this.notificationService.notifyTask(i)}),this.cdsModalService.dismissAll(),this.onSubmit.next(this.snapName)}).catch(()=>{this.snapshotForm.setErrors({cdSubmitButton:!0})})}createAction(){const t=this.snapshotForm.getValue("snapshotName"),o=this.snapshotForm.getValue("mirrorImageSnapshot"),n=new w.J(this.poolName,this.namespace,this.imageName),i=new R.O;i.name="rbd/snap/create",i.metadata={image_spec:n.toString(),snapshot_name:t},this.rbdService.createSnapshot(n,t,o).toPromise().then(()=>{this.taskManagerService.subscribe(i.name,i.metadata,r=>{this.notificationService.notifyTask(r)}),this.cdsModalService.dismissAll(),this.onSubmit.next(t)}).catch(()=>{this.snapshotForm.setErrors({cdSubmitButton:!0})})}submit(){this.editing?this.editAction():this.createAction()}static \u0275fac=function(o){return new(o||s)(e.rXU(me.V),e.rXU(Z.U),e.rXU(Ut.C),e.rXU(Ue.J),e.rXU(F.Ss),e.rXU(fe.B),e.rXU("poolName"),e.rXU("namespace",8),e.rXU("imageName",8),e.rXU("mirroring",8),e.rXU("snapName",8))};static \u0275cmp=e.VBU({type:s,selectors:[["cd-rbd-snapshot-form-modal"]],features:[e.Vt3],decls:20,vars:21,consts:()=>{let t,o,n,i,r,_;return t="\u540D\u79F0",o="" + "\ufffd0\ufffd" + " " + "\ufffd1\ufffd" + "",n="" + "\ufffd#12\ufffd\ufffd/#12\ufffd" + "" + "\ufffd*13:1\ufffd\ufffd#1:1\ufffd" + " Snapshot mode is enabled on image " + "\ufffd#2:1\ufffd" + "" + "\ufffd0:1\ufffd" + "" + "\ufffd/#2:1\ufffd" + ": snapshot names are auto generated" + "\ufffd/#1:1\ufffd\ufffd/*13:1\ufffd" + "",i="\u8FD9\u662F\u5FC5\u586B\u5B57\u6BB5\uFF01",r="The snapshot name cannot start with \".\" and cannot contain \"/\" and \"@\".",_="Mirror Image Snapshot ",[["formDir","ngForm"],["snapshotError",""],o,n,i,r,_,["size","md",3,"overalSelected","open"],[3,"closeSelect"],["cdsModalHeaderHeading",""],["cdsModalContent",""],["name","snapshotForm","novalidate","",3,"formGroup"],[1,"form-item"],["label",t,"for","snapshotName","cdRequiredField","Name",3,"invalid","invalidText"],["cdsText","","type","text","placeholder","Snapshot name...","id","snapshotName","name","snapshotName","formControlName","snapshotName","autofocus","",3,"invalid"],[4,"ngIf"],[3,"submitActionEvent","form","submitText","modalForm"],["class","invalid-feedback",4,"ngIf"],[1,"invalid-feedback"],["class","form-item",4,"ngIf"],["id","mirrorImageSnapshot","formControlName","mirrorImageSnapshot","name","mirrorImageSnapshot",3,"checkedChange"]]},template:function(o,n){if(1&o){const i=e.RV6();e.j41(0,"cds-modal",7),e.bIt("overalSelected",function(){return e.eBV(i),e.Njj(n.closeModal())}),e.j41(1,"cds-modal-header",8),e.bIt("closeSelect",function(){return e.eBV(i),e.Njj(n.closeModal())}),e.j41(2,"h3",9),e.pXf(3,2),e.nI1(4,"titlecase"),e.nI1(5,"upperFirst"),e.k0s()(),e.j41(6,"section",10)(7,"form",11,0)(9,"div",12)(10,"cds-text-label",13),e.PLo(11,3),e.nrm(12,"input",14),e.DNE(13,fr,3,1,"span",15),e.YFu(),e.k0s(),e.DNE(14,Er,2,2,"ng-template",null,1,e.C5r),e.k0s(),e.DNE(16,Fr,3,3,"ng-container",15),e.k0s()(),e.j41(17,"cd-form-button-panel",16),e.nI1(18,"titlecase"),e.nI1(19,"upperFirst"),e.bIt("submitActionEvent",function(){return e.eBV(i),e.Njj(n.submit())}),e.k0s()()}if(2&o){const i=e.sdS(15);e.Y8G("open",n.open),e.R7$(5),e.uP7(e.bMT(4,13,n.action))(e.bMT(5,15,n.resource)),e.nnv(3),e.R7$(2),e.Y8G("formGroup",n.snapshotForm),e.R7$(3),e.Y8G("invalid",n.snapshotForm.controls.snapshotName.invalid&&n.snapshotForm.controls.snapshotName.dirty)("invalidText",i),e.R7$(2),e.Y8G("invalid",n.snapshotForm.controls.snapshotName.invalid&&n.snapshotForm.controls.snapshotName.dirty),e.BMQ("disabled","snapshot"===n.mirroring&&!0===n.snapshotForm.getValue("mirrorImageSnapshot")||null),e.R7$(),e.Y8G("ngIf","snapshot"===n.mirroring&&!0===n.snapshotForm.getValue("mirrorImageSnapshot")||null),e.R7$(3),e.Y8G("ngIf","snapshot"===n.mirroring),e.R7$(),e.Y8G("form",n.snapshotForm)("submitText",e.bMT(18,17,n.action)+" "+e.bMT(19,19,n.resource))("modalForm",!0)}},dependencies:[d.bT,l.qT,l.me,l.BC,l.cb,l.j4,l.JD,V.e,Xe.B,z.S,k.E,be.P,K.Zt,K.ks,ye.Sc,P.aF,P.rQ,P.$m,P.hN,d.Jj,d.PV,Be.r]})}return s})();class Mr{featuresName;create;rename;protect;unprotect;clone;copy;rollback;deleteSnap;ordering;cloneFormatVersion=1;constructor(a,t,o){this.featuresName=t,o.cloneFormatVersion().subscribe(n=>{this.cloneFormatVersion=n}),this.create={permission:"create",icon:C.F.add,name:a.CREATE},this.rename={permission:"update",icon:C.F.edit,name:a.RENAME,disable:n=>this.disableForMirrorSnapshot(n)||!n.hasSingleSelection},this.protect={permission:"update",icon:C.F.lock,visible:n=>n.hasSingleSelection&&!n.first().is_protected,name:a.PROTECT,disable:n=>this.disableForMirrorSnapshot(n)||this.getProtectDisableDesc(n,this.featuresName)},this.unprotect={permission:"update",icon:C.F.unlock,visible:n=>n.hasSingleSelection&&n.first().is_protected,name:a.UNPROTECT,disable:n=>this.disableForMirrorSnapshot(n)},this.clone={permission:"create",canBePrimary:n=>n.hasSingleSelection,disable:n=>this.getCloneDisableDesc(n)||this.disableForMirrorSnapshot(n),icon:C.F.clone,name:a.CLONE},this.copy={permission:"create",canBePrimary:n=>n.hasSingleSelection,disable:n=>!n.hasSingleSelection||n.first().cdExecuting||this.disableForMirrorSnapshot(n),icon:C.F.copy,name:a.COPY},this.rollback={permission:"update",icon:C.F.undo,name:a.ROLLBACK,disable:n=>this.disableForMirrorSnapshot(n)||!n.hasSingleSelection},this.deleteSnap={permission:"delete",icon:C.F.destroy,disable:n=>{const i=n.first();return!n.hasSingleSelection||i.cdExecuting||i.is_protected||this.disableForMirrorSnapshot(n)},name:a.DELETE},this.ordering=[this.create,this.rename,this.protect,this.unprotect,this.clone,this.copy,this.rollback,this.deleteSnap]}getProtectDisableDesc(a,t){return!(a.hasSingleSelection&&!a.first().cdExecuting)||!t?.includes("layering")&&"The layering feature needs to be enabled on parent image"}getCloneDisableDesc(a){return!(a.hasSingleSelection&&!a.first().cdExecuting)||1===this.cloneFormatVersion&&!a.first().is_protected&&"\u5FEB\u7167\u5FC5\u987B\u5904\u4E8E\u53D7\u4FDD\u62A4\u72B6\u6001\u624D\u80FD\u514B\u9686\u3002"}disableForMirrorSnapshot(a){return a.hasSingleSelection&&"snapshot"===a.first().mirror_mode&&a.first().name.includes(".mirror.")}}class Or{id;name;size;timestamp;is_protected;cdExecuting}const hr=["nameTpl"],br=["rollbackTpl"];function Nr(s,a){if(1&s&&(e.qex(0),e.pXf(1,1),e.bVm(),e.j41(2,"strong"),e.EFF(3),e.k0s(),e.EFF(4,".\n")),2&s){const t=a.$implicit;e.R7$(3),e.SpI(" ",t.snapName,"")}}let Pr=(()=>{class s{authStorageService;dimlessBinaryPipe;cdDatePipe;rbdService;taskManagerService;notificationService;summaryService;taskListService;actionLabels;cdr;cdsModalService;snapshots=[];featuresName;poolName;namespace;mirroring;primary;rbdName;nameTpl;rollbackTpl;permission;selection=new de.y;tableActions;rbdTableActions;imageSpec;data;columns;modalRef;builders={"rbd/snap/create":t=>{const o=new Or;return o.name=t.snapshot_name,o}};constructor(t,o,n,i,r,_,c,u,S,M,E){this.authStorageService=t,this.dimlessBinaryPipe=o,this.cdDatePipe=n,this.rbdService=i,this.taskManagerService=r,this.notificationService=_,this.summaryService=c,this.taskListService=u,this.actionLabels=S,this.cdr=M,this.cdsModalService=E,this.permission=this.authStorageService.getPermissions().rbdImage}ngOnInit(){this.columns=[{name:"\u540D\u79F0",prop:"name",cellTransformation:xe.x.executing,flexGrow:2},{name:"\u5BB9\u91CF",prop:"size",flexGrow:1,cellClass:"text-right",pipe:this.dimlessBinaryPipe},{name:"\u5DF2\u4F7F\u7528",prop:"disk_usage",flexGrow:1,cellClass:"text-right",pipe:this.dimlessBinaryPipe},{name:"\u72B6\u6001",prop:"is_protected",flexGrow:1,cellTransformation:xe.x.badge,customTemplateConfig:{map:{true:{value:"\u53D7\u4FDD\u62A4",class:"badge-success"},false:{value:"\u65E0\u4FDD\u62A4",class:"badge-info"}}}},{name:"\u5DF2\u521B\u5EFA",prop:"timestamp",flexGrow:1,pipe:this.cdDatePipe}],this.imageSpec=new w.J(this.poolName,this.namespace,this.rbdName),this.rbdTableActions=new Mr(this.actionLabels,this.featuresName,this.rbdService),this.rbdTableActions.create.click=()=>this.openCreateSnapshotModal(),this.rbdTableActions.rename.click=()=>this.openEditSnapshotModal(),this.rbdTableActions.protect.click=()=>this.toggleProtection(),this.rbdTableActions.unprotect.click=()=>this.toggleProtection();const t=()=>this.selection.first()&&`${this.imageSpec.toStringEncoded()}/${encodeURIComponent(this.selection.first().name)}`;this.rbdTableActions.clone.routerLink=()=>`/block/rbd/clone/${t()}`,this.rbdTableActions.copy.routerLink=()=>`/block/rbd/copy/${t()}`,this.rbdTableActions.rollback.click=()=>this.rollbackModal(),this.rbdTableActions.deleteSnap.click=()=>this.deleteSnapshotModal(),this.tableActions=this.rbdTableActions.ordering,this.taskListService.init(()=>(0,Kt.of)(this.snapshots),null,i=>{zt.c.updateChanged(this,{data:i})&&(this.cdr.detectChanges(),this.data=[...this.data])},()=>{zt.c.updateChanged(this,{data:this.snapshots})&&(this.cdr.detectChanges(),this.data=[...this.data])},i=>["rbd/snap/create","rbd/snap/delete","rbd/snap/edit","rbd/snap/rollback"].includes(i.name)&&this.imageSpec.toString()===i.metadata.image_spec,(i,r)=>i.name===r.metadata.snapshot_name,this.builders)}ngOnChanges(){this.columns&&(this.imageSpec=new w.J(this.poolName,this.namespace,this.rbdName),this.rbdTableActions&&(this.rbdTableActions.featuresName=this.featuresName),this.taskListService.fetch())}openSnapshotModal(t,o=null){this.modalRef=this.cdsModalService.show(Rr,{poolName:this.poolName,imageName:this.rbdName,namespace:this.namespace,mirroring:this.mirroring}),o?this.modalRef.setEditing():o=`${this.rbdName}_${Ve()().toISOString(!0)}`,this.modalRef.setSnapName(o),this.modalRef.onSubmit.subscribe(i=>{const r=new It.G;r.name=t,r.metadata={image_spec:this.imageSpec.toString(),snapshot_name:i},this.summaryService.addRunningTask(r)})}openCreateSnapshotModal(){this.openSnapshotModal("rbd/snap/create")}openEditSnapshotModal(){this.openSnapshotModal("rbd/snap/edit",this.selection.first().name)}toggleProtection(){const t=this.selection.first().name,o=this.selection.first().is_protected,n=new R.O;n.name="rbd/snap/edit";const i=new w.J(this.poolName,this.namespace,this.rbdName);n.metadata={image_spec:i.toString(),snapshot_name:t},this.rbdService.protectSnapshot(i,t,!o).toPromise().then(()=>{const r=new It.G;r.name=n.name,r.metadata=n.metadata,this.summaryService.addRunningTask(r),this.taskManagerService.subscribe(n.name,n.metadata,_=>{this.notificationService.notifyTask(_)})})}_asyncTask(t,o,n){const i=new R.O;i.name=o,i.metadata={image_spec:new w.J(this.poolName,this.namespace,this.rbdName).toString(),snapshot_name:n};const r=new w.J(this.poolName,this.namespace,this.rbdName);this.rbdService[t](r,n).toPromise().then(()=>{const _=new It.G;_.name=i.name,_.metadata=i.metadata,this.summaryService.addRunningTask(_),this.cdsModalService.dismissAll(),this.taskManagerService.subscribe(_.name,_.metadata,c=>{this.notificationService.notifyTask(c)})}).catch(()=>{this.cdsModalService.stopLoadingSpinner(this.modalRef.snapshotForm)})}rollbackModal(){const t=this.selection.selected[0].name,o=new w.J(this.poolName,this.namespace,this.rbdName).toString(),n={titleText:"RBD \u5FEB\u7167\u56DE\u6EDA",buttonText:"\u56DE\u6EDA",bodyTpl:this.rollbackTpl,bodyData:{snapName:`${o}@${t}`},onSubmit:()=>{this._asyncTask("rollbackSnapshot","rbd/snap/rollback",t)}};this.modalRef=this.cdsModalService.show(Nt.M,n)}deleteSnapshotModal(){const t=this.selection.selected[0].name;this.modalRef=this.cdsModalService.show(ce.D,{impact:Ft.r.high,itemDescription:"RBD \u5FEB\u7167",itemNames:[t],submitAction:()=>this._asyncTask("deleteSnapshot","rbd/snap/delete",t)})}updateSelection(t){this.selection=t}static \u0275fac=function(o){return new(o||s)(e.rXU(U.v),e.rXU(ke.l),e.rXU(Je.Q),e.rXU(Z.U),e.rXU(Ut.C),e.rXU(Ue.J),e.rXU(gr.E),e.rXU(Fe.D),e.rXU(F.Ss),e.rXU(e.gRc),e.rXU(me.V))};static \u0275cmp=e.VBU({type:s,selectors:[["cd-rbd-snapshot-list"]],viewQuery:function(o,n){if(1&o&&(e.GBs(hr,5),e.GBs(br,7)),2&o){let i;e.mGM(i=e.lsd())&&(n.nameTpl=i.first),e.mGM(i=e.lsd())&&(n.rollbackTpl=i.first)}},inputs:{snapshots:"snapshots",featuresName:"featuresName",poolName:"poolName",namespace:"namespace",mirroring:"mirroring",primary:"primary",rbdName:"rbdName"},features:[e.Jv_([Fe.D]),e.OA$],decls:4,vars:5,consts:()=>{let t;return t="\u60A8\u5373\u5C06\u8FDB\u884C\u56DE\u6EDA\u64CD\u4F5C",[["rollbackTpl",""],t,["columnMode","flex","selectionType","single",3,"updateSelection","data","columns"],[1,"table-actions",3,"permission","selection","tableActions"]]},template:function(o,n){if(1&o){const i=e.RV6();e.j41(0,"cd-table",2),e.bIt("updateSelection",function(_){return e.eBV(i),e.Njj(n.updateSelection(_))}),e.nrm(1,"cd-table-actions",3),e.k0s(),e.DNE(2,Nr,5,1,"ng-template",null,0,e.C5r)}2&o&&(e.Y8G("data",n.data)("columns",n.columns),e.R7$(),e.Y8G("permission",n.permission)("selection",n.selection)("tableActions",n.tableActions))},dependencies:[W.O,ge.j],changeDetection:0})}return s})();var Ir=m(15224),Ar=m(76139);const Dr=["poolConfigurationSourceTpl"];function $r(s,a){1&s&&(e.qex(0),e.PLo(1,4),e.nrm(2,"strong"),e.YFu(),e.bVm())}function vr(s,a){if(1&s&&(e.j41(0,"span")(1,"span",46),e.EFF(2),e.k0s()()),2&s){const t=a.$implicit;e.R7$(2),e.JRh(t)}}function Lr(s,a){if(1&s&&(e.j41(0,"span")(1,"span",47),e.pXf(2,25),e.k0s()()),2&s){e.XpG(3);const t=e.sdS(1);e.R7$(),e.Y8G("ngbTooltip",t)}}function Gr(s,a){if(1&s&&(e.j41(0,"span"),e.EFF(1),e.nI1(2,"dimlessBinary"),e.k0s()),2&s){const t=e.XpG(3);e.R7$(),e.SpI(" ",e.bMT(2,1,t.selection.disk_usage)," ")}}function Br(s,a){if(1&s&&(e.j41(0,"span")(1,"span",47),e.pXf(2,26),e.k0s()()),2&s){e.XpG(3);const t=e.sdS(1);e.R7$(),e.Y8G("ngbTooltip",t)}}function yr(s,a){if(1&s&&(e.j41(0,"span"),e.EFF(1),e.nI1(2,"dimlessBinary"),e.k0s()),2&s){const t=e.XpG(3);e.R7$(),e.SpI(" ",e.bMT(2,1,t.selection.total_disk_usage)," ")}}function Xr(s,a){if(1&s&&(e.j41(0,"span"),e.EFF(1),e.k0s()),2&s){const t=e.XpG(4);e.R7$(),e.SpI("/",t.selection.parent.pool_namespace,"")}}function kr(s,a){if(1&s&&(e.j41(0,"span"),e.EFF(1),e.DNE(2,Xr,2,1,"span",30),e.EFF(3),e.k0s()),2&s){const t=e.XpG(3);e.R7$(),e.JRh(t.selection.parent.pool_name),e.R7$(),e.Y8G("ngIf",t.selection.parent.pool_namespace),e.R7$(),e.Lme("/",t.selection.parent.image_name,"@",t.selection.parent.snap_name,"")}}function Vr(s,a){1&s&&(e.j41(0,"span"),e.EFF(1,"-"),e.k0s())}function wr(s,a){if(1&s&&(e.j41(0,"table",39)(1,"tbody")(2,"tr",40)(3,"td",41),e.pXf(4,9),e.k0s(),e.j41(5,"td",42),e.EFF(6),e.k0s()(),e.j41(7,"tr",40)(8,"td",43),e.pXf(9,10),e.k0s(),e.j41(10,"td"),e.EFF(11),e.k0s()(),e.j41(12,"tr",40)(13,"td",44),e.pXf(14,11),e.k0s(),e.j41(15,"td"),e.EFF(16),e.nI1(17,"empty"),e.k0s()(),e.j41(18,"tr",40)(19,"td",44),e.pXf(20,12),e.k0s(),e.j41(21,"td"),e.EFF(22),e.nI1(23,"cdDate"),e.k0s()(),e.j41(24,"tr",40)(25,"td",44),e.pXf(26,13),e.k0s(),e.j41(27,"td"),e.EFF(28),e.nI1(29,"dimlessBinary"),e.k0s()(),e.j41(30,"tr",40)(31,"td",44),e.pXf(32,14),e.k0s(),e.j41(33,"td"),e.EFF(34),e.nI1(35,"dimless"),e.k0s()(),e.j41(36,"tr",40)(37,"td",44),e.pXf(38,15),e.k0s(),e.j41(39,"td"),e.EFF(40),e.nI1(41,"dimlessBinary"),e.k0s()(),e.j41(42,"tr",40)(43,"td",44),e.pXf(44,16),e.k0s(),e.j41(45,"td"),e.DNE(46,vr,3,1,"span",45),e.k0s()(),e.j41(47,"tr",40)(48,"td",44),e.pXf(49,17),e.k0s(),e.j41(50,"td"),e.DNE(51,Lr,3,1,"span",30)(52,Gr,3,3,"span",30),e.k0s()(),e.j41(53,"tr",40)(54,"td",44),e.pXf(55,18),e.k0s(),e.j41(56,"td"),e.DNE(57,Br,3,1,"span",30)(58,yr,3,3,"span",30),e.k0s()(),e.j41(59,"tr",40)(60,"td",44),e.pXf(61,19),e.k0s(),e.j41(62,"td"),e.EFF(63),e.nI1(64,"dimlessBinary"),e.k0s()(),e.j41(65,"tr",40)(66,"td",44),e.pXf(67,20),e.k0s(),e.j41(68,"td"),e.EFF(69),e.k0s()(),e.j41(70,"tr",40)(71,"td",44),e.pXf(72,21),e.k0s(),e.j41(73,"td"),e.DNE(74,kr,4,4,"span",30)(75,Vr,2,0,"span",30),e.k0s()(),e.j41(76,"tr",40)(77,"td",44),e.pXf(78,22),e.k0s(),e.j41(79,"td"),e.EFF(80),e.k0s()(),e.j41(81,"tr",40)(82,"td",44),e.pXf(83,23),e.k0s(),e.j41(84,"td"),e.EFF(85),e.k0s()(),e.j41(86,"tr",40)(87,"td",44),e.pXf(88,24),e.k0s(),e.j41(89,"td"),e.EFF(90),e.k0s()()()()),2&s){const t=e.XpG(2);e.R7$(6),e.JRh(t.selection.name),e.R7$(5),e.JRh(t.selection.pool_name),e.R7$(5),e.JRh(e.bMT(17,19,t.selection.data_pool)),e.R7$(6),e.JRh(e.bMT(23,21,t.selection.timestamp)),e.R7$(6),e.JRh(e.bMT(29,23,t.selection.size)),e.R7$(6),e.JRh(e.bMT(35,25,t.selection.num_objs)),e.R7$(6),e.JRh(e.bMT(41,27,t.selection.obj_size)),e.R7$(6),e.Y8G("ngForOf",t.selection.features_name),e.R7$(5),e.Y8G("ngIf",-1===(null==t.selection.features_name?null:t.selection.features_name.indexOf("fast-diff"))),e.R7$(),e.Y8G("ngIf",-1!==(null==t.selection.features_name?null:t.selection.features_name.indexOf("fast-diff"))),e.R7$(5),e.Y8G("ngIf",-1===(null==t.selection.features_name?null:t.selection.features_name.indexOf("fast-diff"))),e.R7$(),e.Y8G("ngIf",-1!==(null==t.selection.features_name?null:t.selection.features_name.indexOf("fast-diff"))),e.R7$(5),e.JRh(e.bMT(64,29,t.selection.stripe_unit)),e.R7$(6),e.JRh(t.selection.stripe_count),e.R7$(5),e.Y8G("ngIf",t.selection.parent),e.R7$(),e.Y8G("ngIf",!t.selection.parent),e.R7$(5),e.JRh(t.selection.block_name_prefix),e.R7$(5),e.JRh(t.selection.order),e.R7$(5),e.JRh(t.selection.image_format)}}function xr(s,a){if(1&s&&e.nrm(0,"cd-rbd-snapshot-list",48),2&s){const t=e.XpG(2);e.Y8G("snapshots",t.selection.snapshots)("featuresName",t.selection.features_name)("poolName",t.selection.pool_name)("primary",t.selection.primary)("namespace",t.selection.namespace)("mirroring",t.selection.mirror_mode)("rbdName",t.selection.name)}}function Hr(s,a){if(1&s&&e.nrm(0,"cd-rbd-configuration-table",49),2&s){const t=e.XpG(2);e.Y8G("data",t.selection.configuration)}}function jr(s,a){if(1&s&&e.nrm(0,"cd-grafana",50),2&s){const t=e.XpG(2);e.Y8G("grafanaPath",t.rbdDashboardUrl)("type","metrics")}}function Yr(s,a){if(1&s&&(e.qex(0),e.j41(1,"nav",31,2),e.qex(3,32),e.j41(4,"a",33),e.pXf(5,5),e.k0s(),e.DNE(6,wr,91,31,"ng-template",34),e.bVm(),e.qex(7,35),e.j41(8,"a",33),e.pXf(9,6),e.k0s(),e.DNE(10,xr,1,7,"ng-template",34),e.bVm(),e.qex(11,36),e.j41(12,"a",33),e.pXf(13,7),e.k0s(),e.DNE(14,Hr,1,1,"ng-template",34),e.bVm(),e.qex(15,37),e.j41(16,"a",33),e.pXf(17,8),e.k0s(),e.DNE(18,jr,1,2,"ng-template",34),e.bVm(),e.k0s(),e.nrm(19,"div",38),e.bVm()),2&s){const t=e.sdS(2);e.R7$(19),e.Y8G("ngbNavOutlet",t)}}function Kr(s,a){1&s&&(e.qex(0),e.j41(1,"cd-alert-panel",51),e.pXf(2,27),e.k0s(),e.bVm())}function zr(s,a){1&s&&(e.qex(0),e.j41(1,"strong",53),e.pXf(2,28),e.k0s(),e.bVm())}function Ur(s,a){1&s&&(e.j41(0,"span",54),e.pXf(1,29),e.k0s())}function qr(s,a){if(1&s&&e.DNE(0,zr,3,0,"ng-container",52)(1,Ur,2,0,"ng-template",null,3,e.C5r),2&s){const t=a.data.value,o=e.sdS(2);e.Y8G("ngIf",+t)("ngIfElse",o)}}let Qr=(()=>{class s{selection;images;poolConfigurationSourceTpl;nav;rbdDashboardUrl;ngOnChanges(){this.selection&&(this.rbdDashboardUrl=`rbd-details?var-pool=${this.selection.pool_name}&var-image=${this.selection.name}`)}static \u0275fac=function(o){return new(o||s)};static \u0275cmp=e.VBU({type:s,selectors:[["cd-rbd-details"]],viewQuery:function(o,n){if(1&o&&(e.GBs(Dr,7),e.GBs(A.X9,7)),2&o){let i;e.mGM(i=e.lsd())&&(n.poolConfigurationSourceTpl=i.first),e.mGM(i=e.lsd())&&(n.nav=i.first)}},inputs:{selection:"selection",images:"images"},features:[e.OA$],decls:6,vars:2,consts:()=>{let t,o,n,i,r,_,c,u,S,M,E,N,G,y,x,ae,re,_e,H,Ee,L,Ne,Pe,Ie,Ae,De,$e,ve,Le;return t="\u4EC5\u53EF\u7528\u4E8E\u542F\u7528\u4E86 " + "\ufffd#2\ufffd" + "fast-diff" + "\ufffd/#2\ufffd" + " \u7684 RBD \u6620\u50CF",o="\u8BE6\u7EC6\u4FE1\u606F",n="\u5FEB\u7167",i="\u914D\u7F6E",r="\u6027\u80FD",_="\u540D\u79F0",c="\u5B58\u50A8\u6C60",u="\u6570\u636E\u6C60",S="\u5DF2\u521B\u5EFA",M="\u5BB9\u91CF",E="\u5BF9\u8C61\u6570",N="\u5BF9\u8C61\u5927\u5C0F",G="\u7279\u6027",y="\u5DF2\u4F9B\u7ED9\u5BB9\u91CF",x="\u603B\u4F9B\u7ED9\u5BB9\u91CF",ae="\u6761\u5E26\u5355\u5143\u5927\u5C0F",re="\u6761\u5E26\u4E2A\u6570",_e="\u7236\u9879",H="\u5757\u8BBE\u5907\u540D\u79F0\u524D\u7F00",Ee="\u987A\u5E8F",L="\u683C\u5F0F\u7248\u672C",Ne="\u4E0D\u9002\u7528",Pe="\u4E0D\u9002\u7528",Ie="RBD details",Ae="\u65E0\u6CD5\u663E\u793A\u5904\u4E8E \"\u6B63\u5728\u5220\u9664\" \u72B6\u6001\u7684 RBD \u7684\u4FE1\u606F\u3002",De="\u6B64\u8BBE\u7F6E\u4F1A\u8986\u76D6\u5168\u5C40\u503C",$e="\u6620\u50CF",ve="\u8BE5\u503C\u4E3A\u5168\u5C40\u503C\u3002\u6CA1\u6709\u4E3A\u6B64\u6620\u50CF\u8BBE\u7F6E\u6B64\u9009\u9879\u7684\u503C\u3002",Le="\u5168\u5C40",[["usageNotAvailableTooltipTpl",""],["poolConfigurationSourceTpl",""],["nav","ngbNav"],["global",""],t,o,n,i,r,_,c,u,S,M,E,N,G,y,x,ae,re,_e,H,Ee,L,Ne,Pe,Ae,$e,Le,[4,"ngIf"],["ngbNav","","cdStatefulTab","rbd-details",1,"nav-tabs"],["ngbNavItem","details"],["ngbNavLink",""],["ngbNavContent",""],["ngbNavItem","snapshots"],["ngbNavItem","configuration"],["ngbNavItem","performance"],[3,"ngbNavOutlet"],["data-testid","rbd-details-table",1,"cds--data-table--sort","cds--data-table--no-border","cds--data-table","cds--data-table--md"],["cdstablerow",""],["cdstabledata","",1,"bold","w-25"],[1,"w-75"],["cdstabledata","",1,"bold"],[1,"bold"],[4,"ngFor","ngForOf"],[1,"badge","badge-dark","me-2"],["placement","top",1,"form-text","text-muted",3,"ngbTooltip"],[3,"snapshots","featuresName","poolName","primary","namespace","mirroring","rbdName"],[3,"data"],["title",Ie,"uid","YhCYGcuZz","grafanaStyle","one",3,"grafanaPath","type"],["type","warning"],[4,"ngIf","ngIfElse"],["ngbTooltip",De],["ngbTooltip",ve]]},template:function(o,n){1&o&&e.DNE(0,$r,3,0,"ng-template",null,0,e.C5r)(2,Yr,20,1,"ng-container",30)(3,Kr,3,0,"ng-container",30)(4,qr,3,2,"ng-template",null,1,e.C5r),2&o&&(e.R7$(2),e.Y8G("ngIf",n.selection&&"REMOVING"!==n.selection.source),e.R7$(),e.Y8G("ngIf",n.selection&&"REMOVING"===n.selection.source))},dependencies:[d.Sq,d.bT,A.Um,A.X9,A.sy,A.Ri,A.WA,A.m_,A.md,_t.c,He.m,Ct.B,Pr,Ir.k,ke.l,Tt.u,Je.Q,Ar.y]})}return s})();const lt=()=>({exact:!0});function Wr(s,a){1&s&&(e.j41(0,"li",5)(1,"a",10),e.pXf(2,3),e.k0s()()),2&s&&(e.R7$(),e.Y8G("routerLinkActiveOptions",e.lJ4(1,lt)))}let ct=(()=>{class s{authStorageService;grafanaPermission;url;constructor(t){this.authStorageService=t,this.grafanaPermission=this.authStorageService.getPermissions().grafana}static \u0275fac=function(o){return new(o||s)(e.rXU(U.v))};static \u0275cmp=e.VBU({type:s,selectors:[["cd-rbd-tabs"]],decls:11,vars:7,consts:()=>{let t,o,n,i;return t="\u6620\u50CF",o="\u540D\u79F0\u7A7A\u95F4",n="\u56DE\u6536\u7AD9",i="\u603B\u4F53\u6027\u80FD",[t,o,n,i,[1,"nav","nav-tabs"],[1,"nav-item"],["routerLink","/block/rbd","routerLinkActive","active","ariaCurrentWhenActive","page",1,"nav-link",3,"routerLinkActiveOptions"],["routerLink","/block/rbd/namespaces","routerLinkActive","active","ariaCurrentWhenActive","page",1,"nav-link",3,"routerLinkActiveOptions"],["routerLink","/block/rbd/trash","routerLinkActive","active","ariaCurrentWhenActive","page",1,"nav-link",3,"routerLinkActiveOptions"],["class","nav-item",4,"ngIf"],["routerLink","/block/rbd/performance","routerLinkActive","active","ariaCurrentWhenActive","page",1,"nav-link",3,"routerLinkActiveOptions"]]},template:function(o,n){1&o&&(e.j41(0,"ul",4)(1,"li",5)(2,"a",6),e.pXf(3,0),e.k0s()(),e.j41(4,"li",5)(5,"a",7),e.pXf(6,1),e.k0s()(),e.j41(7,"li",5)(8,"a",8),e.pXf(9,2),e.k0s()(),e.DNE(10,Wr,3,2,"li",9),e.k0s()),2&o&&(e.R7$(2),e.Y8G("routerLinkActiveOptions",e.lJ4(4,lt)),e.R7$(3),e.Y8G("routerLinkActiveOptions",e.lJ4(5,lt)),e.R7$(3),e.Y8G("routerLinkActiveOptions",e.lJ4(6,lt)),e.R7$(2),e.Y8G("ngIf",n.grafanaPermission.read))},dependencies:[d.bT,p.Wk,p.wQ]})}return s})();const Jr=["usageTpl"],Zr=["parentTpl"],e_=["nameTpl"],t_=["ScheduleTpl"],o_=["mirroringTpl"],n_=["flattenTpl"],s_=["deleteTpl"],i_=["removingStatTpl"],a_=["forcePromoteConfirmation"],r_=["usedTmpl"],__=["totalUsedTmpl"],l_=["imageUsageTpl"],c_=(s,a)=>[s,a];function d_(s,a){if(1&s&&e.nrm(0,"cd-rbd-details",20),2&s){const t=e.XpG();e.Y8G("selection",t.expandedRow)}}function m_(s,a){if(1&s&&(e.j41(0,"span"),e.EFF(1),e.k0s()),2&s){const t=e.XpG(2).data.value;e.R7$(),e.SpI("/",t.pool_namespace,"")}}function u_(s,a){if(1&s&&(e.j41(0,"span"),e.EFF(1),e.DNE(2,m_,2,1,"span",21),e.EFF(3),e.k0s()),2&s){const t=e.XpG().data.value;e.R7$(),e.JRh(t.pool_name),e.R7$(),e.Y8G("ngIf",t.pool_namespace),e.R7$(),e.Lme("/",t.image_name,"@",t.snap_name,"")}}function p_(s,a){1&s&&(e.j41(0,"span"),e.EFF(1,"-"),e.k0s())}function g_(s,a){if(1&s&&e.DNE(0,u_,4,4,"span",21)(1,p_,2,0,"span",21),2&s){const t=a.data.value;e.Y8G("ngIf",t),e.R7$(),e.Y8G("ngIf",!t)}}function f_(s,a){if(1&s&&(e.j41(0,"span",24),e.EFF(1),e.k0s()),2&s){const t=e.XpG().data.value;e.R7$(),e.JRh(t[0])}}function T_(s,a){if(1&s&&(e.j41(0,"span",24),e.EFF(1),e.k0s()),2&s){const t=e.XpG().data.value;e.R7$(),e.JRh(t[1])}}function S_(s,a){1&s&&(e.j41(0,"span",24),e.pXf(1,12),e.k0s())}function E_(s,a){1&s&&(e.j41(0,"span",24),e.pXf(1,13),e.k0s())}function C_(s,a){if(1&s&&(e.j41(0,"span",24),e.EFF(1),e.k0s()),2&s){const t=e.XpG().data.value;e.R7$(),e.JRh(t)}}function F_(s,a){if(1&s&&(e.DNE(0,f_,2,1,"span",22),e.EFF(1,"\xa0 "),e.DNE(2,T_,2,1,"span",23),e.EFF(3,"\xa0 "),e.DNE(4,S_,2,0,"span",23)(5,E_,2,0,"span",23)(6,C_,2,1,"ng-template",null,10,e.C5r)),2&s){const t=a.data.value,o=a.data.row,n=e.sdS(7);e.Y8G("ngIf",3===(null==t?null:t.length))("ngIfElse",n),e.R7$(2),e.Y8G("ngIf",3===(null==t?null:t.length)),e.R7$(2),e.Y8G("ngIf",!0===(null==o?null:o.primary)),e.R7$(),e.Y8G("ngIf",!1===(null==o?null:o.primary))}}function R_(s,a){if(1&s&&(e.j41(0,"span",24),e.EFF(1),e.nI1(2,"cdDate"),e.k0s()),2&s){const t=e.XpG().data.value;e.R7$(),e.JRh(e.bMT(2,1,t[2]))}}function M_(s,a){if(1&s&&e.DNE(0,R_,3,3,"span",23),2&s){const t=a.data.value;e.Y8G("ngIf",3===(null==t?null:t.length))}}function O_(s,a){if(1&s&&(e.EFF(0," You are about to flatten "),e.j41(1,"strong"),e.EFF(2),e.k0s(),e.EFF(3,". "),e.nrm(4,"br")(5,"br"),e.EFF(6," All blocks will be copied from parent "),e.j41(7,"strong"),e.EFF(8),e.k0s(),e.EFF(9," to child "),e.j41(10,"strong"),e.EFF(11),e.k0s(),e.EFF(12,".\n")),2&s){const t=a.$implicit;e.R7$(2),e.JRh(t.child),e.R7$(6),e.JRh(t.parent),e.R7$(3),e.JRh(t.child)}}function h_(s,a){if(1&s&&(e.j41(0,"li"),e.EFF(1),e.k0s()),2&s){const t=a.$implicit;e.R7$(),e.JRh(t)}}function b_(s,a){if(1&s&&(e.qex(0),e.j41(1,"span"),e.pXf(2,15),e.k0s(),e.j41(3,"ul"),e.DNE(4,h_,2,1,"li",27),e.k0s(),e.bVm()),2&s){const t=e.XpG(2).snapshots;e.R7$(4),e.Y8G("ngForOf",t)}}function N_(s,a){if(1&s&&(e.j41(0,"div",26)(1,"span"),e.pXf(2,14),e.k0s(),e.nrm(3,"br"),e.DNE(4,b_,5,1,"ng-container",21),e.k0s()),2&s){const t=e.XpG().snapshots;e.R7$(4),e.Y8G("ngIf",t.length>0)}}function P_(s,a){1&s&&e.DNE(0,N_,5,1,"div",25),2&s&&e.Y8G("ngIf",a.hasSnapshots)}function I_(s,a){if(1&s&&e.nrm(0,"i",29),2&s){const t=e.XpG(2);e.Y8G("ngClass",e.l_i(1,c_,t.icons.spinner,t.icons.spin))}}function A_(s,a){if(1&s&&(e.j41(0,"span",29),e.EFF(1),e.k0s()),2&s){const t=e.XpG(),o=t.data.column,n=t.data.row;e.Y8G("ngClass",null!=o&&null!=o.customTemplateConfig&&o.customTemplateConfig.executingClass?o.customTemplateConfig.executingClass:"text-muted italic"),e.R7$(),e.SpI(" (",n.cdExecuting,") ")}}function D_(s,a){if(1&s&&e.nrm(0,"i",31),2&s){const t=e.XpG(2);e.ZvI("",t.icons.warning," warn")}}function $_(s,a){if(1&s&&(e.DNE(0,I_,1,4,"i",28),e.j41(1,"span",29),e.EFF(2),e.k0s(),e.DNE(3,A_,2,2,"span",28)(4,D_,1,3,"i",30)),2&s){const t=a.data.column,o=a.data.value,n=a.data.row;e.Y8G("ngIf",n.cdExecuting),e.R7$(),e.Y8G("ngClass",null==t||null==t.customTemplateConfig?null:t.customTemplateConfig.valueClass),e.R7$(),e.SpI(" ",o," "),e.R7$(),e.Y8G("ngIf",n.cdExecuting),e.R7$(),e.Y8G("ngIf",n.source&&"REMOVING"===n.source)}}function v_(s,a){if(1&s&&(e.j41(0,"cd-alert-panel",32),e.EFF(1),e.k0s(),e.j41(2,"div",33),e.PLo(3,16),e.nrm(4,"strong"),e.YFu(),e.k0s()),2&s){const t=e.XpG();e.R7$(),e.JRh(t.errorMessage)}}function L_(s,a){if(1&s&&(e.j41(0,"span",35)(1,"span"),e.EFF(2,"-"),e.k0s()()),2&s){e.XpG(2);const t=e.sdS(22);e.Y8G("ngbTooltip",t)}}function G_(s,a){if(1&s&&e.nrm(0,"cd-usage-bar",37),2&s){const t=e.XpG(2).data.row;e.Y8G("total",t.size)("used",t.disk_usage)("title",t.name)}}function B_(s,a){if(1&s&&e.DNE(0,G_,1,3,"cd-usage-bar",36),2&s){const t=e.XpG().data.row;e.Y8G("ngIf",t)}}function y_(s,a){if(1&s&&e.DNE(0,L_,3,1,"span",34)(1,B_,1,1,"ng-template",null,11,e.C5r),2&s){const t=a.data.row,o=e.sdS(2);e.Y8G("ngIf",t.features_name&&(!t.features_name.includes("fast-diff")||"snapshot"===t.mirror_mode))("ngIfElse",o)}}function X_(s,a){1&s&&e.nrm(0,"div",38),2&s&&e.Y8G("innerHtml","Only available for RBD images with <strong>fast-diff</strong> enabled and without snapshot mirroring",e.npT)}let V_=(()=>{class s extends pt.D{authStorageService;rbdService;dimlessBinaryPipe;dimlessPipe;taskWrapper;taskListService;urlBuilder;actionLabels;cdsModalService;table;usageTpl;parentTpl;nameTpl;ScheduleTpl;mirroringTpl;flattenTpl;deleteTpl;removingStatTpl;forcePromoteConfirmation;usedTmpl;totalUsedTmpl;imageUsageTpl;permission;tableActions;images;columns;retries;tableStatus=new Yt.F("ghost");selection=new de.y;icons=C.F;count=0;tableContext=null;errorMessage;builders={"rbd/create":t=>this.createRbdFromTask(t.pool_name,t.namespace,t.image_name),"rbd/delete":t=>this.createRbdFromTaskImageSpec(t.image_spec),"rbd/clone":t=>this.createRbdFromTask(t.child_pool_name,t.child_namespace,t.child_image_name),"rbd/copy":t=>this.createRbdFromTask(t.dest_pool_name,t.dest_namespace,t.dest_image_name)};remove_scheduling;createRbdFromTaskImageSpec(t){const o=w.J.fromString(t);return this.createRbdFromTask(o.poolName,o.namespace,o.imageName)}createRbdFromTask(t,o,n){const i=new Wi;return i.id="-1",i.unique_id="-1",i.name=n,i.namespace=o,i.pool_name=t,i.image_format=at.V2,i}constructor(t,o,n,i,r,_,c,u,S){super(),this.authStorageService=t,this.rbdService=o,this.dimlessBinaryPipe=n,this.dimlessPipe=i,this.taskWrapper=r,this.taskListService=_,this.urlBuilder=c,this.actionLabels=u,this.cdsModalService=S,this.permission=this.authStorageService.getPermissions().rbdImage;const M=()=>this.selection.first()&&new w.J(this.selection.first().pool_name,this.selection.first().namespace,this.selection.first().name).toStringEncoded();this.tableActions=[{permission:"create",icon:C.F.add,routerLink:()=>this.urlBuilder.getCreate(),canBePrimary:L=>!L.hasSingleSelection,name:this.actionLabels.CREATE},{permission:"update",icon:C.F.edit,routerLink:()=>this.urlBuilder.getEdit(M()),name:this.actionLabels.EDIT,disable:L=>this.getRemovingStatusDesc(L)||this.getInvalidNameDisable(L)},{permission:"create",canBePrimary:L=>L.hasSingleSelection,disable:L=>this.getRemovingStatusDesc(L)||this.getInvalidNameDisable(L)||!!L.first().cdExecuting,icon:C.F.copy,routerLink:()=>`/block/rbd/copy/${M()}`,name:this.actionLabels.COPY,title:se.copy},{permission:"update",disable:L=>this.getRemovingStatusDesc(L)||this.getInvalidNameDisable(L)||L.first().cdExecuting||!L.first().parent,icon:C.F.flatten,click:()=>this.flattenRbdModal(),name:this.actionLabels.FLATTEN,title:se.flatten},{permission:"update",icon:C.F.refresh,click:()=>this.resyncRbdModal(),name:this.actionLabels.RESYNC,disable:L=>this.getResyncDisableDesc(L)},{permission:"update",icon:C.F.edit,click:()=>this.removeSchedulingModal(),name:this.actionLabels.REMOVE_SCHEDULING,disable:L=>this.getRemovingStatusDesc(L)||this.getInvalidNameDisable(L)||void 0===L.first().schedule_info},{permission:"update",icon:C.F.edit,click:()=>this.actionPrimary(!0),name:this.actionLabels.PROMOTE,visible:()=>null!=this.selection.first()&&!this.selection.first().primary,disable:()=>"Disabled"===this.selection.first().mirror_mode?se.enableMirroring:""},{permission:"update",icon:C.F.edit,click:()=>this.actionPrimary(!1),name:this.actionLabels.DEMOTE,visible:()=>null!=this.selection.first()&&this.selection.first().primary,disable:()=>"Disabled"===this.selection.first().mirror_mode?se.enableMirroring:""},{permission:"delete",icon:C.F.trash,title:se.moveToTrash,click:()=>this.trashRbdModal(),name:this.actionLabels.TRASH,disable:L=>this.getRemovingStatusDesc(L)||this.getInvalidNameDisable(L)||L.first().image_format===at.V1},{permission:"delete",icon:C.F.destroy,click:()=>this.deleteRbdModal(),name:this.actionLabels.DELETE,title:se.delete,disable:L=>this.getDeleteDisableDesc(L)}]}ngOnInit(){this.columns=[{name:"\u540D\u79F0",prop:"name",flexGrow:2,cellTemplate:this.removingStatTpl},{name:"\u5B58\u50A8\u6C60",prop:"pool_name",flexGrow:2},{name:"\u540D\u79F0\u7A7A\u95F4",prop:"namespace",flexGrow:2},{name:"\u5BB9\u91CF",prop:"size",flexGrow:1,cellClass:"text-right",sortable:!1,pipe:this.dimlessBinaryPipe},{name:"\u4F7F\u7528\u7387",prop:"usage",cellTemplate:this.imageUsageTpl,flexGrow:1.5},{name:"\u5BF9\u8C61\u6570",prop:"num_objs",flexGrow:1,cellClass:"text-right",sortable:!1,pipe:this.dimlessPipe},{name:"\u5BF9\u8C61\u5927\u5C0F",prop:"obj_size",flexGrow:1,cellClass:"text-right",sortable:!1,pipe:this.dimlessBinaryPipe},{name:"\u7236\u9879",prop:"parent",flexGrow:2,sortable:!1,cellTemplate:this.parentTpl},{name:"\u955C\u50CF",prop:"mirror_mode",flexGrow:3,sortable:!1,cellTemplate:this.mirroringTpl},{name:"Next Scheduled Snapshot",prop:"mirror_mode",flexGrow:3,sortable:!1,cellTemplate:this.ScheduleTpl}],this.taskListService.init(n=>this.getRbdImages(n),n=>this.prepareResponse(n),n=>this.images=n,()=>this.onFetchError(),n=>["rbd/clone","rbd/copy","rbd/create","rbd/delete","rbd/edit","rbd/flatten","rbd/trash/move"].includes(n.name),(n,i)=>{let r;switch(i.name){case"rbd/copy":r=new w.J(i.metadata.dest_pool_name,i.metadata.dest_namespace,i.metadata.dest_image_name).toString();break;case"rbd/clone":r=new w.J(i.metadata.child_pool_name,i.metadata.child_namespace,i.metadata.child_image_name).toString();break;case"rbd/create":r=new w.J(i.metadata.pool_name,i.metadata.namespace,i.metadata.image_name).toString();break;default:r=i.metadata.image_spec}return r===new w.J(n.pool_name,n.namespace,n.name).toString()},this.builders)}onFetchError(){this.table.reset(),this.tableStatus=new Yt.F("danger")}getRbdImages(t){return null!==t&&(this.tableContext=t),null==this.tableContext&&(this.tableContext=new ee.n(()=>{})),this.rbdService.list(this.tableContext?.toParams())}prepareResponse(t){let o=[];return t.forEach(n=>{o=o.concat(n.value)}),o.forEach(n=>{if(void 0!==n.schedule_info){let i=[];const r="scheduled";let _=+new Date(n.schedule_info.schedule_time);const c=(new Date).getTimezoneOffset();_+=6e4*Math.abs(c),i.push(n.mirror_mode,r,_),n.mirror_mode=i,i=[]}}),this.count=o.length>0?ar.Z.getCount(t[0]):0,o}updateSelection(t){this.selection=t}deleteRbdModal(){const t=this.selection.first().pool_name,o=this.selection.first().namespace,n=this.selection.first().name,i=new w.J(t,o,n);this.cdsModalService.show(ce.D,{impact:Ft.r.high,itemDescription:"RBD",itemNames:[i.imageName],bodyTemplate:this.deleteTpl,bodyContext:{hasSnapshots:this.hasSnapshots(),snapshots:this.listProtectedSnapshots()},submitActionObservable:()=>this.taskWrapper.wrapTaskAroundCall({task:new R.O("rbd/delete",{image_spec:i.toString()}),call:this.rbdService.delete(i)})})}resyncRbdModal(){const t=this.selection.first().pool_name,o=this.selection.first().namespace,n=this.selection.first().name,i=new w.J(t,o,n);this.cdsModalService.show(ce.D,{itemDescription:"RBD",itemNames:[i],actionDescription:"resync",submitActionObservable:()=>this.taskWrapper.wrapTaskAroundCall({task:new R.O("rbd/edit",{image_spec:i.toString()}),call:this.rbdService.update(i,{resync:!0})})})}trashRbdModal(){const t={poolName:this.selection.first().pool_name,namespace:this.selection.first().namespace,imageName:this.selection.first().name,hasSnapshots:this.hasSnapshots()};this.cdsModalService.show(ur,t)}flattenRbd(t){this.taskWrapper.wrapTaskAroundCall({task:new R.O("rbd/flatten",{image_spec:t.toString()}),call:this.rbdService.flatten(t)}).subscribe({complete:()=>{this.cdsModalService.dismissAll()}})}flattenRbdModal(){const t=this.selection.first().pool_name,o=this.selection.first().namespace,n=this.selection.first().name,i=this.selection.first().parent,r=new w.J(i.pool_name,i.pool_namespace,i.image_name),_=new w.J(t,o,n),c={titleText:"RBD flatten",buttonText:"Flatten",bodyTpl:this.flattenTpl,bodyData:{parent:`${r}@${i.snap_name}`,child:_.toString()},onSubmit:()=>{this.flattenRbd(_)}};this.cdsModalService.show(Nt.M,c)}editRequest(){const t=new Ot;return t.remove_scheduling=!t.remove_scheduling,t}removeSchedulingModal(){const t=this.selection.first().name,o=new w.J(this.selection.first().pool_name,this.selection.first().namespace,this.selection.first().name);this.cdsModalService.show(ce.D,{actionDescription:"remove scheduling on",itemDescription:"image",itemNames:[`${t}`],submitActionObservable:()=>new xt.c(n=>{this.taskWrapper.wrapTaskAroundCall({task:new R.O("rbd/edit",{image_spec:o.toString()}),call:this.rbdService.update(o,this.editRequest())}).subscribe({error:i=>n.error(i),complete:()=>{this.cdsModalService.dismissAll()}})})})}actionPrimary(t){const o=new Ot;o.primary=t,o.features=null;const n=new w.J(this.selection.first().pool_name,this.selection.first().namespace,this.selection.first().name);this.taskWrapper.wrapTaskAroundCall({task:new R.O("rbd/edit",{image_spec:n.toString()}),call:this.rbdService.update(n,o)}).subscribe(()=>{},i=>{i.preventDefault(),t&&(this.errorMessage=i.error.detail.replace(/\[.*?\]\s*/,""),o.force=!0,this.cdsModalService.show(Nt.M,{titleText:"\u8B66\u62A5",buttonText:"Enforce",warning:!0,bodyTpl:this.forcePromoteConfirmation,onSubmit:()=>{this.rbdService.update(n,o).subscribe(()=>{this.cdsModalService.dismissAll()},()=>{this.cdsModalService.dismissAll()})}}))})}hasSnapshots(){return(this.selection.first().snapshots||[]).length>0}hasClonedSnapshots(t){return(t.snapshots||[]).some(n=>n.children&&n.children.length>0)}listProtectedSnapshots(){return this.selection.first().snapshots.reduce((n,i)=>(i.is_protected&&n.push(i.name),n),[])}getDeleteDisableDesc(t){const o=t.first();return o&&this.hasClonedSnapshots(o)?se.clonedSnapshot:o&&!1===o.primary?se.secondayImageDelete:this.getInvalidNameDisable(t)||this.hasClonedSnapshots(t.first())||!1===o.primary}getResyncDisableDesc(t){const o=t.first();return o&&this.imageIsPrimary(o)?se.primaryImageResync:this.getInvalidNameDisable(t)}imageIsPrimary(t){return t.primary}getInvalidNameDisable(t){return t.first()?.name?.match(/[@/]/)?se.invalidNameDisable:!t.first()||!t.hasSingleSelection}getRemovingStatusDesc(t){return"REMOVING"===t.first()?.source&&se.removingStatus}static \u0275fac=function(o){return new(o||s)(e.rXU(U.v),e.rXU(Z.U),e.rXU(ke.l),e.rXU(Tt.u),e.rXU(I.a),e.rXU(Fe.D),e.rXU(Pt.E),e.rXU(F.Ss),e.rXU(me.V))};static \u0275cmp=e.VBU({type:s,selectors:[["cd-rbd-list"]],viewQuery:function(o,n){if(1&o&&(e.GBs(W.O,7),e.GBs(Jr,5),e.GBs(Zr,7),e.GBs(e_,5),e.GBs(t_,7),e.GBs(o_,7),e.GBs(n_,7),e.GBs(s_,7),e.GBs(i_,7),e.GBs(a_,7),e.GBs(r_,7),e.GBs(__,7),e.GBs(l_,7)),2&o){let i;e.mGM(i=e.lsd())&&(n.table=i.first),e.mGM(i=e.lsd())&&(n.usageTpl=i.first),e.mGM(i=e.lsd())&&(n.parentTpl=i.first),e.mGM(i=e.lsd())&&(n.nameTpl=i.first),e.mGM(i=e.lsd())&&(n.ScheduleTpl=i.first),e.mGM(i=e.lsd())&&(n.mirroringTpl=i.first),e.mGM(i=e.lsd())&&(n.flattenTpl=i.first),e.mGM(i=e.lsd())&&(n.deleteTpl=i.first),e.mGM(i=e.lsd())&&(n.removingStatTpl=i.first),e.mGM(i=e.lsd())&&(n.forcePromoteConfirmation=i.first),e.mGM(i=e.lsd())&&(n.usedTmpl=i.first),e.mGM(i=e.lsd())&&(n.totalUsedTmpl=i.first),e.mGM(i=e.lsd())&&(n.imageUsageTpl=i.first)}},features:[e.Jv_([Fe.D,{provide:Pt.E,useValue:new Pt.E("block/rbd")}]),e.Vt3],decls:23,vars:12,consts:()=>{let t,o,n,i,r,_;return t="primary",o="secondary",n="\u5220\u9664\u6B64\u6620\u50CF\u65F6\u4E5F\u4F1A\u5220\u9664\u5B83\u7684\u6240\u6709\u5FEB\u7167\u3002",i="\u4EE5\u4E0B\u5FEB\u7167\u5F53\u524D\u53D7\u5230\u4FDD\u62A4\uFF0C\u5C06\u4F1A\u88AB\u5220\u9664\uFF1A",r="RBD \u5904\u4E8E \"\u6B63\u5728\u5220\u9664\" \u72B6\u6001",_="" + "\ufffd#4\ufffd" + " Do you want to force the operation? " + "\ufffd/#4\ufffd" + "",[["table",""],["parentTpl",""],["mirroringTpl",""],["ScheduleTpl",""],["flattenTpl",""],["deleteTpl",""],["removingStatTpl",""],["forcePromoteConfirmation",""],["imageUsageTpl",""],["usageTooltip",""],["probb",""],["usageBar",""],t,o,n,i,_,["columnMode","flex","identifier","unique_id","forceIdentifier","true","selectionType","single",3,"fetchData","setExpandedRow","updateSelection","data","columns","searchableObjects","serverSide","count","hasDetails","status","maxLimit","autoReload"],[1,"table-actions",3,"permission","selection","tableActions"],[3,"selection",4,"cdTableDetail"],[3,"selection"],[4,"ngIf"],["class","badge badge-info",4,"ngIf","ngIfElse"],["class","badge badge-info",4,"ngIf"],[1,"badge","badge-info"],["class","alert alert-warning","role","alert",4,"ngIf"],["role","alert",1,"alert","alert-warning"],[4,"ngFor","ngForOf"],[3,"ngClass",4,"ngIf"],[3,"ngClass"],["title",r,3,"class",4,"ngIf"],["title",r],["type","warning"],[1,"m-4"],[3,"ngbTooltip",4,"ngIf","ngIfElse"],[3,"ngbTooltip"],["decimals","2",3,"total","used","title",4,"ngIf"],["decimals","2",3,"total","used","title"],[3,"innerHtml"]]},template:function(o,n){if(1&o){const i=e.RV6();e.nrm(0,"cd-rbd-tabs"),e.j41(1,"cd-table",17,0),e.bIt("fetchData",function(_){return e.eBV(i),e.Njj(n.taskListService.fetch(_))})("setExpandedRow",function(_){return e.eBV(i),e.Njj(n.setExpandedRow(_))})("updateSelection",function(_){return e.eBV(i),e.Njj(n.updateSelection(_))}),e.nrm(3,"cd-table-actions",18),e.DNE(4,d_,1,1,"cd-rbd-details",19),e.k0s(),e.DNE(5,g_,2,2,"ng-template",null,1,e.C5r)(7,F_,8,5,"ng-template",null,2,e.C5r)(9,M_,1,1,"ng-template",null,3,e.C5r)(11,O_,13,3,"ng-template",null,4,e.C5r)(13,P_,1,1,"ng-template",null,5,e.C5r)(15,$_,5,5,"ng-template",null,6,e.C5r)(17,v_,5,1,"ng-template",null,7,e.C5r)(19,y_,3,2,"ng-template",null,8,e.C5r)(21,X_,1,1,"ng-template",null,9,e.C5r)}2&o&&(e.R7$(),e.Y8G("data",n.images)("columns",n.columns)("searchableObjects",!0)("serverSide",!0)("count",n.count)("hasDetails",!0)("status",n.tableStatus)("maxLimit",25)("autoReload",-1),e.R7$(2),e.Y8G("permission",n.permission)("selection",n.selection)("tableActions",n.tableActions))},dependencies:[d.YU,d.Sq,d.bT,A.md,pr.o,He.m,W.O,ge.j,ft.N,Qr,ct,Je.Q],styles:[".warn[_ngcontent-%COMP%]{color:#d48200}"]})}return s})();function w_(s,a){1&s&&(e.PLo(0,5,1),e.nrm(1,"option",22),e.YFu()),2&s&&(e.R7$(),e.Y8G("ngValue",null))}function x_(s,a){1&s&&(e.PLo(0,5,2),e.nrm(1,"option",22),e.YFu()),2&s&&(e.R7$(),e.Y8G("ngValue",null))}function H_(s,a){1&s&&(e.PLo(0,5,3),e.nrm(1,"option",22),e.YFu()),2&s&&(e.R7$(),e.Y8G("ngValue",null))}function j_(s,a){if(1&s&&(e.PLo(0,5,4),e.nrm(1,"option",23),e.YFu()),2&s){const t=a.$implicit;e.R7$(),e.Y8G("value",t.pool_name),e.uP7(t.pool_name),e.nnv(0)}}function Y_(s,a){if(1&s&&(e.j41(0,"cds-select",19),e.PLo(1,5),e.DNE(2,w_,2,1,"option",20)(3,x_,2,1,"option",20)(4,H_,2,1,"option",20)(5,j_,2,2,"option",21),e.YFu(),e.k0s()),2&s){const t=e.XpG(),o=e.sdS(10);e.Y8G("invalid",t.namespaceForm.controls.pool.invalid&&t.namespaceForm.controls.pool.dirty)("invalidText",o),e.R7$(2),e.Y8G("ngIf",null===t.pools),e.R7$(),e.Y8G("ngIf",null!==t.pools&&0===t.pools.length),e.R7$(),e.Y8G("ngIf",null!==t.pools&&t.pools.length>0),e.R7$(),e.Y8G("ngForOf",t.pools)}}function K_(s,a){1&s&&(e.j41(0,"span",25),e.pXf(1,6),e.k0s())}function z_(s,a){if(1&s&&e.DNE(0,K_,2,0,"span",24),2&s){const t=e.XpG(),o=e.sdS(6);e.Y8G("ngIf",t.namespaceForm.showError("pool",o,"required"))}}function U_(s,a){1&s&&(e.j41(0,"span",25),e.pXf(1,7),e.k0s())}function q_(s,a){1&s&&(e.j41(0,"span",25),e.pXf(1,8),e.k0s())}function Q_(s,a){if(1&s&&e.DNE(0,U_,2,0,"span",24)(1,q_,2,0,"span",24),2&s){const t=e.XpG(),o=e.sdS(6);e.Y8G("ngIf",t.namespaceForm.showError("namespace",o,"required")),e.R7$(),e.Y8G("ngIf",t.namespaceForm.showError("namespace",o,"namespaceExists"))}}let W_=(()=>{class s extends P.dW{actionLabels;authStorageService;notificationService;poolService;rbdService;modalService;poolPermission;pools=null;pool;namespace;namespaceForm;editing=!1;onSubmit=new qt.B7;constructor(t,o,n,i,r,_){super(),this.actionLabels=t,this.authStorageService=o,this.notificationService=n,this.poolService=i,this.rbdService=r,this.modalService=_,this.poolPermission=this.authStorageService.getPermissions().pool,this.createForm()}createForm(){this.namespaceForm=new j.$({pool:new l.hs(""),namespace:new l.hs("")},this.validator(),this.asyncValidator())}validator(){return t=>{const o=t.get("pool"),n=t.get("namespace");let i=null;o.value||(i={required:!0}),o.setErrors(i);let r=null;return n.value||(r={required:!0}),n.setErrors(r),null}}asyncValidator(){return t=>new Promise(o=>{const n=t.get("pool"),i=t.get("namespace");this.rbdService.listNamespaces(n.value).subscribe(r=>{if(r.some(_=>_.namespace===i.value)){const _={namespaceExists:!0};i.setErrors(_),o(_)}else o(null)})})}ngOnInit(){this.poolPermission.read&&this.poolService.list(["pool_name","type","application_metadata"]).then(t=>{const o=[];for(const n of t)this.rbdService.isRBDPool(n)&&"replicated"===n.type&&o.push(n);if(this.pools=o,1===this.pools.length){const n=this.pools[0].pool_name;this.namespaceForm.get("pool").setValue(n)}})}submit(){const t=this.namespaceForm.getValue("pool"),o=this.namespaceForm.getValue("namespace"),n=new R.O;n.name="rbd/namespace/create",n.metadata={pool:t,namespace:o},this.rbdService.createNamespace(t,o).toPromise().then(()=>{this.modalService.destroy(),this.notificationService.show(gt._.success,"\u5DF2\u521B\u5EFA\u540D\u79F0\u7A7A\u95F4 \"" + t + "/" + o + "\""),this.onSubmit.next()}).catch(()=>{this.namespaceForm.setErrors({cdSubmitButton:!0})})}static \u0275fac=function(o){return new(o||s)(e.rXU(F.Ss),e.rXU(U.v),e.rXU(Ue.J),e.rXU(Qe.m),e.rXU(Z.U),e.rXU(P.Bg))};static \u0275cmp=e.VBU({type:s,selectors:[["cd-rbd-namespace-form-modal"]],features:[e.Vt3],decls:18,vars:10,consts:()=>{let t,o,n,i,r,_;return t=" Create Namespace ",o="Namespace " + "\ufffd#14\ufffd\ufffd/#14\ufffd" + "",n="" + "\ufffd*2:1\ufffd\ufffd#1:1\ufffd" + "Loading..." + "[\ufffd/#1:1\ufffd\ufffd/*2:1\ufffd|\ufffd/#1:2\ufffd\ufffd/*3:2\ufffd|\ufffd/#1:3\ufffd\ufffd/*4:3\ufffd|\ufffd/#1:4\ufffd\ufffd/*5:4\ufffd]" + "" + "\ufffd*3:2\ufffd\ufffd#1:2\ufffd" + "-- No rbd pools available --" + "[\ufffd/#1:1\ufffd\ufffd/*2:1\ufffd|\ufffd/#1:2\ufffd\ufffd/*3:2\ufffd|\ufffd/#1:3\ufffd\ufffd/*4:3\ufffd|\ufffd/#1:4\ufffd\ufffd/*5:4\ufffd]" + "" + "\ufffd*4:3\ufffd\ufffd#1:3\ufffd" + "-- Select a pool --" + "[\ufffd/#1:1\ufffd\ufffd/*2:1\ufffd|\ufffd/#1:2\ufffd\ufffd/*3:2\ufffd|\ufffd/#1:3\ufffd\ufffd/*4:3\ufffd|\ufffd/#1:4\ufffd\ufffd/*5:4\ufffd]" + "" + "\ufffd*5:4\ufffd\ufffd#1:4\ufffd" + "" + "\ufffd0:4\ufffd" + "" + "[\ufffd/#1:1\ufffd\ufffd/*2:1\ufffd|\ufffd/#1:2\ufffd\ufffd/*3:2\ufffd|\ufffd/#1:3\ufffd\ufffd/*4:3\ufffd|\ufffd/#1:4\ufffd\ufffd/*5:4\ufffd]" + "",n=e.k04(n),i="\u8FD9\u662F\u5FC5\u586B\u5B57\u6BB5\uFF01",r="\u8FD9\u662F\u5FC5\u586B\u5B57\u6BB5\uFF01",_="The namespace already exists.",[["formDir","ngForm"],["poolError",""],["namespaceError",""],t,o,n,i,r,_,["size","md",3,"overlaySelected","open","hasScrollingContent"],[3,"closeSelect"],["cdsModalHeaderHeading",""],["cdsModalContent",""],["name","namespaceForm","novalidate","",3,"formGroup"],[1,"form-item"],["label","Pool","for","pool","formControlName","pool","name","pool","id","pool","cdRequiredField","Pool","modal-primary-focus","",3,"invalid","invalidText",4,"ngIf"],["label","Name","for","namespace","cdRequiredField","Namespace",3,"invalid","invalidText"],["cdsText","","type","text","placeholder","Namespace name...","id","namespace","name","namespace","formControlName","namespace","autofocus","",3,"invalid"],[3,"submitActionEvent","form","submitText","modalForm"],["label","Pool","for","pool","formControlName","pool","name","pool","id","pool","cdRequiredField","Pool","modal-primary-focus","",3,"invalid","invalidText"],[3,"ngValue",4,"ngIf"],[3,"value",4,"ngFor","ngForOf"],[3,"ngValue"],[3,"value"],["class","invalid-feedback",4,"ngIf"],[1,"invalid-feedback"]]},template:function(o,n){if(1&o){const i=e.RV6();e.j41(0,"cds-modal",9),e.bIt("overlaySelected",function(){return e.eBV(i),e.Njj(n.closeModal())}),e.j41(1,"cds-modal-header",10),e.bIt("closeSelect",function(){return e.eBV(i),e.Njj(n.closeModal())}),e.j41(2,"h3",11),e.pXf(3,3),e.k0s()(),e.j41(4,"section",12)(5,"form",13,0)(7,"div",14),e.DNE(8,Y_,6,6,"cds-select",15)(9,z_,1,1,"ng-template",null,1,e.C5r),e.k0s(),e.j41(11,"div",14)(12,"cds-text-label",16),e.PLo(13,4),e.nrm(14,"input",17),e.YFu(),e.k0s(),e.DNE(15,Q_,2,2,"ng-template",null,2,e.C5r),e.k0s()()(),e.j41(17,"cd-form-button-panel",18),e.bIt("submitActionEvent",function(){return e.eBV(i),e.Njj(n.submit())}),e.k0s()()}if(2&o){const i=e.sdS(16);e.Y8G("open",n.open)("hasScrollingContent",!0),e.R7$(5),e.Y8G("formGroup",n.namespaceForm),e.R7$(3),e.Y8G("ngIf",n.poolPermission.read),e.R7$(4),e.Y8G("invalid",n.namespaceForm.controls.namespace.invalid&&n.namespaceForm.controls.namespace.dirty)("invalidText",i),e.R7$(2),e.Y8G("invalid",n.namespaceForm.controls.namespace.invalid&&n.namespaceForm.controls.namespace.dirty),e.R7$(3),e.Y8G("form",n.namespaceForm)("submitText",n.actionLabels.CREATE)("modalForm",!0)}},dependencies:[d.Sq,d.bT,l.qT,l.xH,l.y7,l.me,l.BC,l.cb,l.j4,l.JD,V.e,Xe.B,z.S,k.E,be.P,K.Zt,K.ks,g.l6,g.c$,P.aF,P.rQ,P.$m,P.hN]})}return s})(),J_=(()=>{class s{authStorageService;rbdService;poolService;notificationService;actionLabels;cdsModalService;columns;namespaces;modalRef;permission;selection=new de.y;tableActions;constructor(t,o,n,i,r,_){this.authStorageService=t,this.rbdService=o,this.poolService=n,this.notificationService=i,this.actionLabels=r,this.cdsModalService=_,this.permission=this.authStorageService.getPermissions().rbdImage,this.tableActions=[{permission:"create",icon:C.F.add,click:()=>this.createModal(),name:this.actionLabels.CREATE},{permission:"delete",icon:C.F.destroy,click:()=>this.deleteModal(),name:this.actionLabels.DELETE,disable:()=>this.getDeleteDisableDesc()}]}ngOnInit(){this.columns=[{name:"\u540D\u79F0\u7A7A\u95F4",prop:"namespace",flexGrow:1},{name:"\u5B58\u50A8\u6C60",prop:"pool",flexGrow:1},{name:"\u6620\u50CF\u603B\u6570",prop:"num_images",flexGrow:1}],this.refresh()}refresh(){this.poolService.list(["pool_name","type","application_metadata"]).then(t=>{t=t.filter(n=>this.rbdService.isRBDPool(n)&&"replicated"===n.type);const o=[];t.forEach(n=>{o.push(this.rbdService.listNamespaces(n.pool_name))}),o.length>0?(0,J.p)(o).subscribe(n=>{const i=[];for(let r=0;r<n.length;r++){const c=t[r].pool_name;n[r].forEach(u=>{i.push({id:`${c}/${u.namespace}`,pool:c,namespace:u.namespace,num_images:u.num_images})})}this.namespaces=i}):this.namespaces=[]})}updateSelection(t){this.selection=t}createModal(){this.cdsModalService.show(W_).onSubmit?.subscribe(()=>this.refresh())}deleteModal(){const t=this.selection.first().pool,o=this.selection.first().namespace,n=this.cdsModalService.show(ce.D,{itemDescription:"Namespace",itemNames:[`${t}/${o}`],submitAction:()=>this.rbdService.deleteNamespace(t,o).subscribe(()=>{this.notificationService.show(gt._.success,"\u5DF2\u5220\u9664\u540D\u79F0\u7A7A\u95F4 \"" + t + "/" + o + "\""),this.cdsModalService.dismissAll(),this.refresh()},()=>{this.cdsModalService.stopLoadingSpinner(n.deletionForm)})})}getDeleteDisableDesc(){return this.selection.first()?.num_images>0?"\u540D\u79F0\u7A7A\u95F4\u5305\u542B\u6620\u50CF":!this.selection?.first()}static \u0275fac=function(o){return new(o||s)(e.rXU(U.v),e.rXU(Z.U),e.rXU(Qe.m),e.rXU(Ue.J),e.rXU(F.Ss),e.rXU(me.V))};static \u0275cmp=e.VBU({type:s,selectors:[["cd-rbd-namespace-list"]],features:[e.Jv_([Fe.D])],decls:4,vars:5,consts:[["columnMode","flex","identifier","id","forceIdentifier","true","selectionType","single",3,"fetchData","updateSelection","data","columns"],[1,"table-actions"],[1,"btn-group",3,"permission","selection","tableActions"]],template:function(o,n){1&o&&(e.nrm(0,"cd-rbd-tabs"),e.j41(1,"cd-table",0),e.bIt("fetchData",function(){return n.refresh()})("updateSelection",function(r){return n.updateSelection(r)}),e.j41(2,"div",1),e.nrm(3,"cd-table-actions",2),e.k0s()()),2&o&&(e.R7$(),e.Y8G("data",n.namespaces)("columns",n.columns),e.R7$(2),e.Y8G("permission",n.permission)("selection",n.selection)("tableActions",n.tableActions))},dependencies:[W.O,ge.j,ct]})}return s})(),Z_=(()=>{class s{static \u0275fac=function(o){return new(o||s)};static \u0275cmp=e.VBU({type:s,selectors:[["cd-rbd-performance"]],decls:2,vars:2,consts:()=>{let t;return t="RBD overview",[["title",t,"uid","41FrpeUiz","grafanaStyle","two",3,"grafanaPath","type"]]},template:function(o,n){1&o&&e.nrm(0,"cd-rbd-tabs")(1,"cd-grafana",0),2&o&&(e.R7$(),e.Y8G("grafanaPath","rbd-overview?")("type","metrics"))},dependencies:[_t.c,ct]})}return s})();var el=m(29130);function tl(s,a){if(1&s&&(e.j41(0,"option",15),e.EFF(1),e.k0s()),2&s){const t=a.$implicit;e.Y8G("value",t),e.R7$(),e.JRh(t)}}function ol(s,a){if(1&s&&(e.j41(0,"cds-select",12)(1,"option",13),e.pXf(2,3),e.k0s(),e.DNE(3,tl,2,2,"option",14),e.k0s()),2&s){const t=e.XpG();e.R7$(3),e.Y8G("ngForOf",t.pools)}}let nl=(()=>{class s extends P.dW{authStorageService;rbdService;actionLabels;fb;poolService;taskWrapper;poolPermission;purgeForm;pools;constructor(t,o,n,i,r,_){super(),this.authStorageService=t,this.rbdService=o,this.actionLabels=n,this.fb=i,this.poolService=r,this.taskWrapper=_,this.poolPermission=this.authStorageService.getPermissions().pool}createForm(){this.purgeForm=this.fb.group({poolName:""})}ngOnInit(){this.poolPermission.read&&this.poolService.list(["pool_name","application_metadata"]).then(t=>{this.pools=t.filter(o=>o.application_metadata.includes("rbd")).map(o=>o.pool_name)}),this.createForm()}purge(){const t=this.purgeForm.getValue("poolName")||"";this.taskWrapper.wrapTaskAroundCall({task:new R.O("rbd/trash/purge",{pool_name:t}),call:this.rbdService.purgeTrash(t)}).subscribe({error:()=>{this.purgeForm.setErrors({cdSubmitButton:!0})},complete:()=>{this.closeModal()}})}static \u0275fac=function(o){return new(o||s)(e.rXU(U.v),e.rXU(Z.U),e.rXU(F.Ss),e.rXU(rt.$),e.rXU(Qe.m),e.rXU(I.a))};static \u0275cmp=e.VBU({type:s,selectors:[["cd-rbd-trash-purge-modal"]],features:[e.Vt3],decls:14,vars:7,consts:()=>{let t,o,n;return t="\u6E05\u7A7A\u56DE\u6536\u7AD9",o="\u8981\u8FDB\u884C\u6E05\u9664\uFF0C\u8BF7\u9009\u62E9" + "[\ufffd#9\ufffd|\ufffd#10\ufffd]" + "\u6240\u6709" + "[\ufffd/#9\ufffd|\ufffd/#10\ufffd]" + "\u6216\u4E00\u4E2A\u5B58\u50A8\u6C60\uFF0C\u7136\u540E\u70B9\u51FB" + "[\ufffd#9\ufffd|\ufffd#10\ufffd]" + "\u6E05\u9664" + "[\ufffd/#9\ufffd|\ufffd/#10\ufffd]" + "\u3002",o=e.k04(o),n="\u6240\u6709",[["formDir","ngForm"],t,o,n,["size","md",3,"overlaySelected","open","hasScrollingContent"],[3,"closeSelect"],["cdsModalHeaderHeading",""],["cdsModalContent",""],["name","purgeForm","novalidate","",1,"form",3,"formGroup"],[1,"form-item"],["label","Pool","for","poolName","id","poolName","formControlName","poolName",4,"ngIf"],[3,"submitActionEvent","form","submitText","modalForm"],["label","Pool","for","poolName","id","poolName","formControlName","poolName"],["value",""],[3,"value",4,"ngFor","ngForOf"],[3,"value"]]},template:function(o,n){if(1&o){const i=e.RV6();e.j41(0,"cds-modal",4),e.bIt("overlaySelected",function(){return e.eBV(i),e.Njj(n.closeModal())}),e.j41(1,"cds-modal-header",5),e.bIt("closeSelect",function(){return e.eBV(i),e.Njj(n.closeModal())}),e.j41(2,"h3",6),e.pXf(3,1),e.k0s()(),e.j41(4,"section",7)(5,"form",8,0)(7,"p"),e.PLo(8,2),e.nrm(9,"kbd")(10,"kbd"),e.YFu(),e.k0s(),e.j41(11,"div",9),e.DNE(12,ol,4,1,"cds-select",10),e.k0s()()(),e.j41(13,"cd-form-button-panel",11),e.bIt("submitActionEvent",function(){return e.eBV(i),e.Njj(n.purge())}),e.k0s()()}2&o&&(e.Y8G("open",!0)("hasScrollingContent",!0),e.R7$(5),e.Y8G("formGroup",n.purgeForm),e.R7$(7),e.Y8G("ngIf",n.poolPermission.read),e.R7$(),e.Y8G("form",n.purgeForm)("submitText",n.actionLabels.PURGE)("modalForm",!0))},dependencies:[d.Sq,d.bT,l.qT,l.xH,l.y7,l.BC,l.cb,l.j4,l.JD,V.e,k.E,g.l6,g.c$,P.aF,P.rQ,P.$m,P.hN]})}return s})(),sl=(()=>{class s extends P.dW{rbdService;actionLabels;fb;taskWrapper;poolName;namespace;imageName;imageId;imageSpec;executingTasks;restoreForm;constructor(t,o,n,i,r,_,c,u,S=""){super(),this.rbdService=t,this.actionLabels=o,this.fb=n,this.taskWrapper=i,this.poolName=r,this.namespace=_,this.imageName=c,this.imageId=u,this.imageSpec=S}ngOnInit(){this.imageSpec=new w.J(this.poolName,this.namespace,this.imageName).toString(),this.restoreForm=this.fb.group({name:this.imageName})}restore(){const t=this.restoreForm.getValue("name"),o=new w.J(this.poolName,this.namespace,this.imageId);this.taskWrapper.wrapTaskAroundCall({task:new R.O("rbd/trash/restore",{image_id_spec:o.toString(),new_image_name:t}),call:this.rbdService.restoreTrash(o,t)}).subscribe({error:()=>{this.restoreForm.setErrors({cdSubmitButton:!0})},complete:()=>{this.closeModal()}})}static \u0275fac=function(o){return new(o||s)(e.rXU(Z.U),e.rXU(F.Ss),e.rXU(rt.$),e.rXU(I.a),e.rXU("poolName"),e.rXU("namespace"),e.rXU("imageName"),e.rXU("imageId"),e.rXU("imageSpec",8))};static \u0275cmp=e.VBU({type:s,selectors:[["cd-rbd-trash-restore-modal"]],features:[e.Vt3],decls:16,vars:8,consts:()=>{let t,o,n;return t="\u6062\u590D\u6620\u50CF",o="\u8981\u6062\u590D " + "[\ufffd#9\ufffd|\ufffd#10\ufffd]" + "" + "\ufffd0\ufffd" + "@" + "\ufffd1\ufffd" + "" + "[\ufffd/#9\ufffd|\ufffd/#10\ufffd]" + "\uFF0C\u8BF7\u952E\u5165\u6620\u50CF\u7684\u65B0\u540D\u79F0\uFF0C\u7136\u540E\u70B9\u51FB" + "[\ufffd#9\ufffd|\ufffd#10\ufffd]" + "\u6062\u590D" + "[\ufffd/#9\ufffd|\ufffd/#10\ufffd]" + "\u3002",o=e.k04(o),n="Name " + "\ufffd#14\ufffd\ufffd/#14\ufffd" + "",[["formDir","ngForm"],t,o,n,["size","sm",3,"overlaySelected","open"],[3,"closeSelect"],["cdsModalHeaderHeading",""],["cdsModalContent",""],["name","restoreForm","novalidate","",1,"form",3,"formGroup"],[1,"form-item"],["for","name","invalidText","The field is required","cdRequiredField","Name",3,"invalid"],["cdsText","","name","name","id","name","formControlName","name","autocomplete","off","autofocus",""],[3,"submitActionEvent","form","submitText","modalForm"]]},template:function(o,n){if(1&o){const i=e.RV6();e.j41(0,"cds-modal",4),e.bIt("overlaySelected",function(){return e.eBV(i),e.Njj(n.closeModal())}),e.j41(1,"cds-modal-header",5),e.bIt("closeSelect",function(){return e.eBV(i),e.Njj(n.closeModal())}),e.j41(2,"h3",6),e.pXf(3,1),e.k0s()(),e.j41(4,"section",7)(5,"form",8,0)(7,"p"),e.PLo(8,2),e.nrm(9,"kbd")(10,"kbd"),e.YFu(),e.k0s(),e.j41(11,"div",9)(12,"cds-text-label",10),e.PLo(13,3),e.nrm(14,"input",11),e.YFu(),e.k0s()()()(),e.j41(15,"cd-form-button-panel",12),e.bIt("submitActionEvent",function(){return e.eBV(i),e.Njj(n.restore())}),e.k0s()()}if(2&o){const i=e.sdS(6);e.Y8G("open",n.open),e.R7$(5),e.Y8G("formGroup",n.restoreForm),e.R7$(5),e.uP7(n.imageSpec)(n.imageId),e.nnv(8),e.R7$(2),e.Y8G("invalid",n.restoreForm.showError("name",i,"required")),e.R7$(3),e.Y8G("form",n.restoreForm)("submitText",n.actionLabels.RESTORE)("modalForm",!0)}},dependencies:[l.qT,l.me,l.BC,l.cb,l.j4,l.JD,V.e,Xe.B,z.S,k.E,be.P,K.Zt,K.ks,P.aF,P.rQ,P.$m,P.hN]})}return s})();const il=["expiresTpl"],al=["deleteTpl"];function rl(s,a){if(1&s){const t=e.RV6();e.j41(0,"button",10),e.bIt("click",function(){e.eBV(t);const n=e.XpG();return e.Njj(n.purgeModal())}),e.qex(1),e.pXf(2,2),e.bVm(),e.qSk(),e.nrm(3,"svg",11),e.k0s()}if(2&s){const t=e.XpG();e.Y8G("disabled",t.disablePurgeBtn)}}function _l(s,a){1&s&&(e.qex(0),e.pXf(1,3),e.bVm())}function ll(s,a){1&s&&(e.qex(0),e.pXf(1,4),e.bVm())}function cl(s,a){if(1&s&&(e.DNE(0,_l,2,0,"ng-container",12)(1,ll,2,0,"ng-container",12),e.EFF(2),e.nI1(3,"cdDate")),2&s){const t=a.data.row,o=a.data.value;e.Y8G("ngIf",t.cdIsExpired),e.R7$(),e.Y8G("ngIf",!t.cdIsExpired),e.R7$(),e.SpI(" ",e.bMT(3,3,o),"\n")}}function dl(s,a){if(1&s&&(e.j41(0,"p",14)(1,"strong"),e.qex(2),e.pXf(3,5),e.nI1(4,"cdDate"),e.bVm(),e.k0s()()),2&s){const t=e.XpG().expiresAt;e.R7$(4),e.uP7(e.bMT(4,1,t)),e.nnv(3)}}function ml(s,a){1&s&&e.DNE(0,dl,5,3,"p",13),2&s&&e.Y8G("ngIf",!a.isExpired)}let ul=(()=>{class s{authStorageService;rbdService;modalService;cdDatePipe;taskListService;taskWrapper;actionLabels;table;expiresTpl;deleteTpl;icons=C.F;columns;executingTasks=[];images;modalRef;permission;retries;selection=new de.y;tableActions;tableStatus=new Te.m;disablePurgeBtn=!0;constructor(t,o,n,i,r,_,c){this.authStorageService=t,this.rbdService=o,this.modalService=n,this.cdDatePipe=i,this.taskListService=r,this.taskWrapper=_,this.actionLabels=c,this.permission=this.authStorageService.getPermissions().rbdImage,this.tableActions=[{permission:"update",icon:C.F.undo,click:()=>this.restoreModal(),name:this.actionLabels.RESTORE},{permission:"delete",icon:C.F.destroy,click:()=>this.deleteModal(),name:this.actionLabels.DELETE}]}ngOnInit(){this.columns=[{name:"ID",prop:"id",flexGrow:1,cellTransformation:xe.x.executing},{name:"\u540D\u79F0",prop:"name",flexGrow:1},{name:"\u5B58\u50A8\u6C60",prop:"pool_name",flexGrow:1},{name:"\u540D\u79F0\u7A7A\u95F4",prop:"namespace",flexGrow:1},{name:"\u72B6\u6001",prop:"deferment_end_time",flexGrow:1,cellTemplate:this.expiresTpl},{name:"\u5220\u9664\u65F6\u95F4",prop:"deletion_time",flexGrow:1,pipe:this.cdDatePipe}],this.taskListService.init(()=>this.rbdService.listTrash(),n=>this.prepareResponse(n),n=>this.images=n,()=>this.onFetchError(),n=>["rbd/trash/remove","rbd/trash/restore"].includes(n.name),(n,i)=>new w.J(n.pool_name,n.namespace,n.id).toString()===i.metadata.image_id_spec,void 0)}prepareResponse(t){let o=[];const n={};let i;if(t.forEach(r=>{f().isUndefined(n[r.status])&&(n[r.status]=[]),n[r.status].push(r.pool_name),o=o.concat(r.value),this.disablePurgeBtn=!o.length}),n[3]?i=3:n[1]?i=1:n[2]&&(i=2),i){const r=(n[i].length>1?"pools ":"pool ")+n[i].join();this.tableStatus=new Te.m(i,r)}else this.tableStatus=new Te.m;return o.forEach(r=>{r.cdIsExpired=Ve()().isAfter(r.deferment_end_time)}),o}onFetchError(){this.table.reset(),this.tableStatus=new Te.m(el.k.ValueException)}updateSelection(t){this.selection=t}restoreModal(){const t={poolName:this.selection.first().pool_name,namespace:this.selection.first().namespace,imageName:this.selection.first().name,imageId:this.selection.first().id};this.modalRef=this.modalService.show(sl,t)}deleteModal(){const t=this.selection.first().pool_name,o=this.selection.first().namespace,n=this.selection.first().id,i=this.selection.first().deferment_end_time,r=Ve()().isAfter(i),_=new w.J(t,o,n);this.modalRef=this.modalService.show(ce.D,{itemDescription:"RBD",itemNames:[_],bodyTemplate:this.deleteTpl,bodyContext:{expiresAt:i,isExpired:r},submitActionObservable:()=>this.taskWrapper.wrapTaskAroundCall({task:new R.O("rbd/trash/remove",{image_id_spec:_.toString()}),call:this.rbdService.removeTrash(_,!0)})})}purgeModal(){this.modalService.show(nl)}static \u0275fac=function(o){return new(o||s)(e.rXU(U.v),e.rXU(Z.U),e.rXU(me.V),e.rXU(Je.Q),e.rXU(Fe.D),e.rXU(I.a),e.rXU(F.Ss))};static \u0275cmp=e.VBU({type:s,selectors:[["cd-rbd-trash-list"]],viewQuery:function(o,n){if(1&o&&(e.GBs(W.O,7),e.GBs(il,7),e.GBs(al,7)),2&o){let i;e.mGM(i=e.lsd())&&(n.table=i.first),e.mGM(i=e.lsd())&&(n.expiresTpl=i.first),e.mGM(i=e.lsd())&&(n.deleteTpl=i.first)}},features:[e.Jv_([Fe.D])],decls:9,vars:8,consts:()=>{let t,o,n,i;return t="\u6E05\u7A7A\u56DE\u6536\u7AD9",o="\u8FC7\u671F\u65F6\u95F4",n="\u4FDD\u62A4\u671F\u9650",i="\u6B64\u6620\u50CF\u5728 " + "\ufffd0\ufffd" + " \u524D\u59CB\u7EC8\u53D7\u5230\u4FDD\u62A4\u3002",[["expiresTpl",""],["deleteTpl",""],t,o,n,i,["columnMode","flex","identifier","id","forceIdentifier","true","selectionType","single",3,"fetchData","updateSelection","data","columns","status","autoReload"],[1,"table-actions"],[1,"btn-group",3,"permission","selection","tableActions"],["cdsButton","tertiary","type","button",3,"disabled","click",4,"ngIf"],["cdsButton","tertiary","type","button",3,"click","disabled"],["cdsIcon","close","size","16",1,"cds--btn__icon"],[4,"ngIf"],["class","text-danger",4,"ngIf"],[1,"text-danger"]]},template:function(o,n){if(1&o){const i=e.RV6();e.nrm(0,"cd-rbd-tabs"),e.j41(1,"cd-table",6),e.bIt("fetchData",function(){return e.eBV(i),e.Njj(n.taskListService.fetch())})("updateSelection",function(_){return e.eBV(i),e.Njj(n.updateSelection(_))}),e.j41(2,"div",7),e.nrm(3,"cd-table-actions",8),e.DNE(4,rl,4,1,"button",9),e.k0s()(),e.DNE(5,cl,4,5,"ng-template",null,0,e.C5r)(7,ml,1,1,"ng-template",null,1,e.C5r)}2&o&&(e.R7$(),e.Y8G("data",n.images)("columns",n.columns)("status",n.tableStatus)("autoReload",-1),e.R7$(2),e.Y8G("permission",n.permission)("selection",n.selection)("tableActions",n.tableActions),e.R7$(),e.Y8G("ngIf",n.permission.delete))},dependencies:[d.bT,W.O,ge.j,z.S,qe.$n,Ye.LJ,ct,Je.Q]})}return s})();var pl=m(77518),gl=m(874);const te="api/nvmeof",Qt="ui-api/nvmeof";let Re=(()=>{class s{http;constructor(t){this.http=t}formatGwGroupsList(t,o=!1){return t[0].reduce((n,i)=>(o&&i?.spec?.group&&i?.service_name?n.push({content:i.spec.group,serviceName:i.service_name}):i?.spec?.group&&n.push({content:i.spec.group}),n),[])}listGatewayGroups(){return this.http.get(`${te}/gateway/group`)}listGateways(){return this.http.get(`${te}/gateway`)}listSubsystems(t){return this.http.get(`${te}/subsystem?gw_group=${t}`)}getSubsystem(t,o){return this.http.get(`${te}/subsystem/${t}?gw_group=${o}`)}createSubsystem(t){return this.http.post(`${te}/subsystem`,t,{observe:"response"})}deleteSubsystem(t,o){return this.http.delete(`${te}/subsystem/${t}?gw_group=${o}`,{observe:"response"})}isSubsystemPresent(t,o){return this.getSubsystem(t,o).pipe((0,pl.u)(!0),(0,gl.W)(n=>(n?.preventDefault(),(0,Kt.of)(!1))))}getInitiators(t,o){return this.http.get(`${te}/subsystem/${t}/host?gw_group=${o}`)}addInitiators(t,o){return this.http.post(`${Qt}/subsystem/${t}/host`,o,{observe:"response"})}removeInitiators(t,o){return this.http.delete(`${Qt}/subsystem/${t}/host/${o.host_nqn}/${o.gw_group}`,{observe:"response"})}listListeners(t,o){return this.http.get(`${te}/subsystem/${t}/listener?gw_group=${o}`)}createListener(t,o){return this.http.post(`${te}/subsystem/${t}/listener`,o,{observe:"response"})}deleteListener(t,o,n,i,r){return this.http.delete(`${te}/subsystem/${t}/listener/${n}/${i}`,{observe:"response",params:{gw_group:o,trsvcid:r,force:"true"}})}listNamespaces(t,o){return this.http.get(`${te}/subsystem/${t}/namespace?gw_group=${o}`)}getNamespace(t,o,n){return this.http.get(`${te}/subsystem/${t}/namespace/${o}?gw_group=${n}`)}createNamespace(t,o){return this.http.post(`${te}/subsystem/${t}/namespace`,o,{observe:"response"})}updateNamespace(t,o,n){return this.http.patch(`${te}/subsystem/${t}/namespace/${o}`,n,{observe:"response"})}deleteNamespace(t,o,n){return this.http.delete(`${te}/subsystem/${t}/namespace/${o}?gw_group=${n}`,{observe:"response"})}static \u0275fac=function(o){return new(o||s)(e.KVO(Ge.Qq))};static \u0275prov=e.jDH({token:s,factory:s.\u0275fac,providedIn:"root"})}return s})();var Tl=m(28886),At=m(78799),Wt=m(31537),Dt=m(69138);let Jt=(()=>{class s{static \u0275fac=function(o){return new(o||s)};static \u0275cmp=e.VBU({type:s,selectors:[["cd-nvmeof-tabs"]],decls:7,vars:0,consts:()=>{let t,o;return t="Subsystems",o="\u7F51\u5173",[t,o,[1,"nav","nav-tabs"],[1,"nav-item"],["routerLink","/block/nvmeof/subsystems","routerLinkActive","active","ariaCurrentWhenActive","page",1,"nav-link"],["routerLink","/block/nvmeof/gateways","routerLinkActive","active","ariaCurrentWhenActive","page",1,"nav-link"]]},template:function(o,n){1&o&&(e.j41(0,"ul",2)(1,"li",3)(2,"a",4),e.pXf(3,0),e.k0s()(),e.j41(4,"li",3)(5,"a",5),e.pXf(6,1),e.k0s()()())},dependencies:[p.Wk,p.wQ]})}return s})();var Sl=m(45757);const El=["statusTpl"],Cl=()=>({md:4});function Fl(s,a){if(1&s&&(e.j41(0,"span",11),e.nI1(1,"pipeFunction"),e.EFF(2),e.k0s()),2&s){const t=a.data.row,o=e.XpG();e.Y8G("ngClass",e.i5U(1,2,t,o.getStatusClass)),e.R7$(2),e.SpI(" ",t.status_desc," ")}}function Rl(s,a){1&s&&(e.j41(0,"legend"),e.PLo(1,4),e.nrm(2,"cd-help-text"),e.YFu(),e.k0s())}function Ml(s,a){if(1&s){const t=e.RV6();e.DNE(0,Rl,3,0,"legend",12),e.j41(1,"div")(2,"cd-table",13),e.bIt("fetchData",function(){e.eBV(t);const n=e.XpG();return e.Njj(n.getGateways())}),e.k0s()()}if(2&s){const t=e.XpG();e.Y8G("ngIf",t.selectedTab===t.Tabs.gateways),e.R7$(2),e.Y8G("data",t.gateways)("columns",t.gatewayColumns)}}function Ol(s,a){if(1&s&&e.nrm(0,"cd-grafana",14),2&s){const t=e.XpG();e.Mz_("grafanaPath","ceph-nvme-of-gateways-overview?var-group=",t.selectedGatewayGroup,"&var-gateway=All"),e.Y8G("type","metrics")}}function hl(s,a){if(1&s&&e.nrm(0,"cd-grafana",15),2&s){const t=e.XpG();e.Mz_("grafanaPath","ceph-nvme-of-gateways-performance?var-group=",t.selectedGatewayGroup,""),e.Y8G("type","metrics")}}var Zt=function(s){return s[s.gateways=0]="gateways",s[s.overview=1]="overview",s}(Zt||{});const eo="Enter group name";let bl=(()=>{class s{nvmeofService;cephServiceService;actionLabels;selectedTab;onSelected(t){this.selectedTab=t}get Tabs(){return Zt}statusTpl;gateways=[];gatewayColumns;selection=new de.y;gwGroups=[];groupService=null;selectedGatewayGroup=null;gwGroupsEmpty=!1;gwGroupPlaceholder=eo;constructor(t,o,n){this.nvmeofService=t,this.cephServiceService=o,this.actionLabels=n}ngOnInit(){this.setGatewayGroups(),this.gatewayColumns=[{name:"Gateway ID",prop:"id"},{name:"\u4E3B\u673A\u540D",prop:"hostname"},{name:"\u72B6\u6001",prop:"status_desc",cellTemplate:this.statusTpl}]}getStatusClass(t){return f().get({"-1":"badge-danger",0:"badge-warning",1:"badge-success"},t.status,"badge-dark")}getGateways(){this.cephServiceService.getDaemons(this.groupService).subscribe(t=>{this.gateways=t.length?t.map(o=>({id:`client.${o.daemon_name}`,hostname:o.hostname,status_desc:o.status_desc,status:o.status})):[]})}onGroupSelection(t){t.selected=!0,this.groupService=t.serviceName,this.selectedGatewayGroup=t.content,this.getGateways()}onGroupClear(){this.groupService=null,this.getGateways()}setGatewayGroups(){this.nvmeofService.listGatewayGroups().subscribe(t=>{this.gwGroups=t?.[0]?.length?this.nvmeofService.formatGwGroupsList(t,!0):[],!this.groupService&&this.gwGroups.length?(this.onGroupSelection(this.gwGroups[0]),this.gwGroupsEmpty=!1,this.gwGroupPlaceholder=eo):(this.gwGroupsEmpty=!0,this.gwGroupPlaceholder="No groups available")})}static \u0275fac=function(o){return new(o||s)(e.rXU(Re),e.rXU(Tl.t),e.rXU(F.Ss))};static \u0275cmp=e.VBU({type:s,selectors:[["cd-nvmeof-gateway"]],viewQuery:function(o,n){if(1&o&&e.GBs(El,7),2&o){let i;e.mGM(i=e.lsd())&&(n.statusTpl=i.first)}},decls:16,vars:9,consts:()=>{let t,o,n,i,r,_,c;return t="Selected Gateway Group",o="\u7F51\u5173",n="\u6982\u89C8",i="\u6027\u80FD",r=" Gateways " + "\ufffd#2\ufffd" + " Ceph NVMe-oF gateways provide Ceph Block Device storage through NVMe/TCP. For VMware clients the NVMe/TCP volumes display as VMFS Datastores. For Linux clients the NVMe/TCP volumes display as as block devices. " + "\ufffd/#2\ufffd" + "",_="Gateway overview",c="Gateway performance",[["statusTpl",""],["gateways_content",""],["overview_content",""],["performance_content",""],r,["cdsCol","",1,"pb-3",3,"columnNumbers"],["type","single","label",t,3,"selected","clear","placeholder","items","disabled"],["type","contained","followFocus","true","isNavigation","true",3,"cacheActive"],["heading",o,3,"selected","tabContent"],["heading",n,3,"selected","tabContent"],["heading",i,3,"selected","tabContent"],[1,"badge",3,"ngClass"],[4,"ngIf"],[3,"fetchData","data","columns"],["title",_,"uid","feeuv1dno43r4ddjhjssdd","grafanaStyle","three",3,"grafanaPath","type"],["title",c,"uid","feeuv1dno43r4deed","grafanaStyle","three",3,"grafanaPath","type"]]},template:function(o,n){if(1&o){const i=e.RV6();e.nrm(0,"cd-nvmeof-tabs"),e.j41(1,"div",5)(2,"cds-combo-box",6),e.bIt("selected",function(_){return e.eBV(i),e.Njj(n.onGroupSelection(_))})("clear",function(){return e.eBV(i),e.Njj(n.onGroupClear())}),e.nrm(3,"cds-dropdown-list"),e.k0s()(),e.DNE(4,Fl,3,5,"ng-template",null,0,e.C5r),e.j41(6,"cds-tabs",7)(7,"cds-tab",8),e.bIt("selected",function(){return e.eBV(i),e.Njj(n.onSelected(n.Tabs.gateways))}),e.k0s(),e.j41(8,"cds-tab",9),e.bIt("selected",function(){return e.eBV(i),e.Njj(n.onSelected(n.Tabs.overview))}),e.k0s(),e.j41(9,"cds-tab",10),e.bIt("selected",function(){return e.eBV(i),e.Njj(n.onSelected(n.Tabs.overview))}),e.k0s()(),e.DNE(10,Ml,3,3,"ng-template",null,1,e.C5r)(12,Ol,1,3,"ng-template",null,2,e.C5r)(14,hl,1,3,"ng-template",null,3,e.C5r)}if(2&o){const i=e.sdS(11),r=e.sdS(13),_=e.sdS(15);e.R7$(),e.Y8G("columnNumbers",e.lJ4(8,Cl)),e.R7$(),e.Y8G("placeholder",n.gwGroupPlaceholder)("items",n.gwGroups)("disabled",n.gwGroupsEmpty),e.R7$(4),e.Y8G("cacheActive",!1),e.R7$(),e.Y8G("tabContent",i),e.R7$(),e.Y8G("tabContent",r),e.R7$(),e.Y8G("tabContent",_)}},dependencies:[d.YU,d.bT,_t.c,Se.O,W.O,je.ee,At.a,Wt.Q5,Dt.tU,Dt.oz,Jt,Sl.N]})}return s})();var Nl=m(37823);let Il=(()=>{class s{actionLabels;modalService;authStorageService;taskWrapper;nvmeofService;router;subsystemNQN;group;listenerColumns;tableActions;selection=new de.y;permission;listeners;constructor(t,o,n,i,r,_){this.actionLabels=t,this.modalService=o,this.authStorageService=n,this.taskWrapper=i,this.nvmeofService=r,this.router=_,this.permission=this.authStorageService.getPermissions().nvmeof}ngOnInit(){this.listenerColumns=[{name:"\u4E3B\u673A",prop:"host_name"},{name:"\u4F20\u8F93",prop:"trtype"},{name:"Address",prop:"full_addr",cellTransformation:xe.x.copy}],this.tableActions=[{name:this.actionLabels.CREATE,permission:"create",icon:C.F.add,click:()=>this.router.navigate(["block/nvmeof/subsystems",{outlets:{modal:[F.Qp.CREATE,this.subsystemNQN,"listener"]}}],{queryParams:{group:this.group}}),canBePrimary:t=>!t.hasSelection},{name:this.actionLabels.DELETE,permission:"delete",icon:C.F.destroy,click:()=>this.deleteListenerModal()}]}updateSelection(t){this.selection=t}listListeners(){this.nvmeofService.listListeners(this.subsystemNQN,this.group).subscribe(t=>{this.listeners=t.map((o,n)=>(o.id=n,o.full_addr=`${o.traddr}:${o.trsvcid}`,o))})}deleteListenerModal(){const t=this.selection.first();this.modalService.show(ce.D,{itemDescription:"Listener",actionDescription:"delete",infoMessage:"This action will delete listener despite any active connections.",itemNames:["listener"+` ${t.host_name} (${t.traddr}:${t.trsvcid})`],submitActionObservable:()=>this.taskWrapper.wrapTaskAroundCall({task:new R.O("nvmeof/listener/delete",{nqn:this.subsystemNQN,host_name:t.host_name}),call:this.nvmeofService.deleteListener(this.subsystemNQN,this.group,t.host_name,t.traddr,t.trsvcid)})})}static \u0275fac=function(o){return new(o||s)(e.rXU(F.Ss),e.rXU(me.V),e.rXU(U.v),e.rXU(I.a),e.rXU(Re),e.rXU(p.Ix))};static \u0275cmp=e.VBU({type:s,selectors:[["cd-nvmeof-listeners-list"]],inputs:{subsystemNQN:"subsystemNQN",group:"group"},decls:6,vars:5,consts:[["columnMode","flex","identifier","id","forceIdentifier","true","selectionType","single",3,"fetchData","updateSelection","data","columns"],[1,"table-actions"],[1,"btn-group",3,"permission","selection","tableActions"]],template:function(o,n){1&o&&(e.j41(0,"legend")(1,"cd-help-text"),e.EFF(2," A listener defines the IP address and port on the gateway that is used to process NVMe/TCP admin and I/O commands to a subsystem. "),e.k0s()(),e.j41(3,"cd-table",0),e.bIt("fetchData",function(){return n.listListeners()})("updateSelection",function(r){return n.updateSelection(r)}),e.j41(4,"div",1),e.nrm(5,"cd-table-actions",2),e.k0s()()),2&o&&(e.R7$(3),e.Y8G("data",n.listeners)("columns",n.listenerColumns),e.R7$(2),e.Y8G("permission",n.permission)("selection",n.selection)("tableActions",n.tableActions))},dependencies:[Se.O,W.O,ge.j]})}return s})();var Al=m(49658),Dl=m(25081);const to="block/nvmeof/subsystems";let $l=(()=>{class s{actionLabels;router;modalService;authStorageService;taskWrapper;nvmeofService;dimlessBinaryPipe;mbPerSecondPipe;iopsPipe;subsystemNQN;group;namespacesColumns;tableActions;selection=new de.y;permission;namespaces;constructor(t,o,n,i,r,_,c,u,S){this.actionLabels=t,this.router=o,this.modalService=n,this.authStorageService=i,this.taskWrapper=r,this.nvmeofService=_,this.dimlessBinaryPipe=c,this.mbPerSecondPipe=u,this.iopsPipe=S,this.permission=this.authStorageService.getPermissions().nvmeof}ngOnInit(){this.namespacesColumns=[{name:"ID",prop:"nsid"},{name:"Bdev Name",prop:"bdev_name"},{name:"Pool ",prop:"rbd_pool_name",flexGrow:2},{name:"\u6620\u50CF",prop:"rbd_image_name",flexGrow:3},{name:"Image Size",prop:"rbd_image_size",pipe:this.dimlessBinaryPipe},{name:"Block Size",prop:"block_size",pipe:this.dimlessBinaryPipe},{name:"IOPS",prop:"rw_ios_per_second",sortable:!1,pipe:this.iopsPipe,flexGrow:1.5},{name:"R/W Throughput",prop:"rw_mbytes_per_second",sortable:!1,pipe:this.mbPerSecondPipe,flexGrow:1.5},{name:"Read Throughput",prop:"r_mbytes_per_second",sortable:!1,pipe:this.mbPerSecondPipe,flexGrow:1.5},{name:"Write Throughput",prop:"w_mbytes_per_second",sortable:!1,pipe:this.mbPerSecondPipe,flexGrow:1.5},{name:"Load Balancing Group",prop:"load_balancing_group",flexGrow:1.5}],this.tableActions=[{name:this.actionLabels.CREATE,permission:"create",icon:C.F.add,click:()=>this.router.navigate([to,{outlets:{modal:[F.Qp.CREATE,this.subsystemNQN,"namespace"]}}],{queryParams:{group:this.group}}),canBePrimary:t=>!t.hasSelection},{name:this.actionLabels.EDIT,permission:"update",icon:C.F.edit,click:()=>this.router.navigate([to,{outlets:{modal:[F.Qp.EDIT,this.subsystemNQN,"namespace",this.selection.first().nsid]}}],{queryParams:{group:this.group}})},{name:this.actionLabels.DELETE,permission:"delete",icon:C.F.destroy,click:()=>this.deleteNamespaceModal()}]}updateSelection(t){this.selection=t}listNamespaces(){this.nvmeofService.listNamespaces(this.subsystemNQN,this.group).subscribe(t=>{this.namespaces=t})}deleteNamespaceModal(){const t=this.selection.first();this.modalService.show(ce.D,{itemDescription:"Namespace",itemNames:[t.nsid],actionDescription:"delete",submitActionObservable:()=>this.taskWrapper.wrapTaskAroundCall({task:new R.O("nvmeof/namespace/delete",{nqn:this.subsystemNQN,nsid:t.nsid}),call:this.nvmeofService.deleteNamespace(this.subsystemNQN,t.nsid,this.group)})})}static \u0275fac=function(o){return new(o||s)(e.rXU(F.Ss),e.rXU(p.Ix),e.rXU(me.V),e.rXU(U.v),e.rXU(I.a),e.rXU(Re),e.rXU(ke.l),e.rXU(Al.n),e.rXU(Dl.U))};static \u0275cmp=e.VBU({type:s,selectors:[["cd-nvmeof-namespaces-list"]],inputs:{subsystemNQN:"subsystemNQN",group:"group"},decls:6,vars:5,consts:[["columnMode","flex","selectionType","single",3,"fetchData","updateSelection","data","columns"],[1,"table-actions"],[1,"btn-group",3,"permission","selection","tableActions"]],template:function(o,n){1&o&&(e.j41(0,"legend")(1,"cd-help-text"),e.EFF(2," An NVMe namespace is a quantity of non-volatile storage that can be formatted into logical blocks and presented to a host as a standard block device. "),e.k0s()(),e.j41(3,"cd-table",0),e.bIt("fetchData",function(){return n.listNamespaces()})("updateSelection",function(r){return n.updateSelection(r)}),e.j41(4,"div",1),e.nrm(5,"cd-table-actions",2),e.k0s()()),2&o&&(e.R7$(3),e.Y8G("data",n.namespaces)("columns",n.namespacesColumns),e.R7$(2),e.Y8G("permission",n.permission)("selection",n.selection)("tableActions",n.tableActions))},dependencies:[Se.O,W.O,ge.j]})}return s})();const vl=["hostTpl"];function Ll(s,a){1&s&&(e.j41(0,"span",6),e.pXf(1,1),e.k0s())}function Gl(s,a){if(1&s&&(e.j41(0,"span",6),e.EFF(1),e.k0s()),2&s){const t=e.XpG().data.value;e.R7$(),e.JRh(t)}}function Bl(s,a){if(1&s&&e.DNE(0,Ll,2,0,"span",5)(1,Gl,2,1,"span",5),2&s){const t=a.data.value;e.Y8G("ngIf","*"===t),e.R7$(),e.Y8G("ngIf","*"!==t)}}let Xl=(()=>{class s{actionLabels;authStorageService;nvmeofService;modalService;router;taskWrapper;subsystemNQN;group;hostTpl;initiatorColumns;tableActions;selection=new de.y;permission;initiators=[];constructor(t,o,n,i,r,_){this.actionLabels=t,this.authStorageService=o,this.nvmeofService=n,this.modalService=i,this.router=r,this.taskWrapper=_,this.permission=this.authStorageService.getPermissions().nvmeof}ngOnInit(){this.initiatorColumns=[{name:"\u6388\u6743\u4EBA",prop:"nqn",cellTemplate:this.hostTpl}],this.tableActions=[{name:this.actionLabels.ADD,permission:"create",icon:C.F.add,click:()=>this.router.navigate(["block/nvmeof/subsystems",{outlets:{modal:[F.Qp.ADD,this.subsystemNQN,"initiator"]}}],{queryParams:{group:this.group}}),canBePrimary:t=>!t.hasSelection},{name:this.actionLabels.REMOVE,permission:"delete",icon:C.F.destroy,click:()=>this.removeInitiatorModal(),disable:()=>!this.selection.hasSelection,canBePrimary:t=>t.hasSelection}]}getAllowAllHostIndex(){return this.selection.selected.findIndex(t=>"*"===t.nqn)}updateSelection(t){this.selection=t}listInitiators(){this.nvmeofService.getInitiators(this.subsystemNQN,this.group).subscribe(t=>{this.initiators=t})}getSelectedNQNs(){return this.selection.selected.map(t=>t.nqn)}removeInitiatorModal(){const t=this.getSelectedNQNs(),o=this.getAllowAllHostIndex(),n=t.join(",");let i=t;-1!==o&&(t.splice(o,1),i=[...t,"Allow any host(*)"]),this.modalService.show(ce.D,{itemDescription:"Initiator",itemNames:i,actionDescription:"remove",submitActionObservable:()=>this.taskWrapper.wrapTaskAroundCall({task:new R.O("nvmeof/initiator/remove",{nqn:this.subsystemNQN,plural:i.length>1}),call:this.nvmeofService.removeInitiators(this.subsystemNQN,{host_nqn:n,gw_group:this.group})})})}static \u0275fac=function(o){return new(o||s)(e.rXU(F.Ss),e.rXU(U.v),e.rXU(Re),e.rXU(me.V),e.rXU(p.Ix),e.rXU(I.a))};static \u0275cmp=e.VBU({type:s,selectors:[["cd-nvmeof-initiators-list"]],viewQuery:function(o,n){if(1&o&&e.GBs(vl,7),2&o){let i;e.mGM(i=e.lsd())&&(n.hostTpl=i.first)}},inputs:{subsystemNQN:"subsystemNQN",group:"group"},decls:8,vars:5,consts:()=>{let t;return t="Any host allowed (*)",[["hostTpl",""],t,["columnMode","flex","selectionType","multiClick",3,"fetchData","updateSelection","data","columns"],[1,"table-actions"],[1,"btn-group",3,"permission","selection","tableActions"],["class","font-monospace",4,"ngIf"],[1,"font-monospace"]]},template:function(o,n){if(1&o){const i=e.RV6();e.j41(0,"legend")(1,"cd-help-text"),e.EFF(2," An initiator (or host) is the client that connects to the NVMe-oF target to access NVMe storage. The NVMe/TCP protocol allows initiators, to send NVMe-oF commands to storage devices, which are known as targets. "),e.k0s()(),e.j41(3,"cd-table",2),e.bIt("fetchData",function(){return e.eBV(i),e.Njj(n.listInitiators())})("updateSelection",function(_){return e.eBV(i),e.Njj(n.updateSelection(_))}),e.j41(4,"div",3),e.nrm(5,"cd-table-actions",4),e.k0s()(),e.DNE(6,Bl,2,2,"ng-template",null,0,e.C5r)}2&o&&(e.R7$(3),e.Y8G("data",n.initiators)("columns",n.initiatorColumns),e.R7$(2),e.Y8G("permission",n.permission)("selection",n.selection)("tableActions",n.tableActions))},dependencies:[d.bT,Se.O,W.O,ge.j]})}return s})();function kl(s,a){if(1&s&&e.nrm(0,"cd-table-key-value",16),2&s){const t=e.XpG(2);e.Y8G("data",t.data)}}function Vl(s,a){if(1&s&&e.nrm(0,"cd-nvmeof-listeners-list",17),2&s){const t=e.XpG(2);e.Y8G("subsystemNQN",t.subsystemNQN)("group",t.group)}}function wl(s,a){if(1&s&&e.nrm(0,"cd-nvmeof-namespaces-list",17),2&s){const t=e.XpG(2);e.Y8G("subsystemNQN",t.subsystemNQN)("group",t.group)}}function xl(s,a){if(1&s&&e.nrm(0,"cd-nvmeof-initiators-list",17),2&s){const t=e.XpG(2);e.Y8G("subsystemNQN",t.subsystemNQN)("group",t.group)}}function Hl(s,a){if(1&s&&e.nrm(0,"cd-grafana",19),2&s){const t=e.XpG(3);e.FCK("grafanaPath","ceph-nvme-of-gateways-performance?var-group=",t.group,"&var-subsystem=",t.subsystemNQN,""),e.Y8G("type","metrics")}}function jl(s,a){1&s&&(e.qex(0,18),e.j41(1,"a",9),e.pXf(2,5),e.k0s(),e.DNE(3,Hl,1,4,"ng-template",10),e.bVm())}function Yl(s,a){if(1&s&&(e.qex(0),e.j41(1,"nav",7,0),e.qex(3,8),e.j41(4,"a",9),e.pXf(5,1),e.k0s(),e.DNE(6,kl,1,1,"ng-template",10),e.bVm(),e.qex(7,11),e.j41(8,"a",9),e.pXf(9,2),e.k0s(),e.DNE(10,Vl,1,2,"ng-template",10),e.bVm(),e.qex(11,12),e.j41(12,"a",9),e.pXf(13,3),e.k0s(),e.DNE(14,wl,1,2,"ng-template",10),e.bVm(),e.qex(15,13),e.j41(16,"a",9),e.pXf(17,4),e.k0s(),e.DNE(18,xl,1,2,"ng-template",10),e.bVm(),e.DNE(19,jl,4,0,"ng-container",14),e.k0s(),e.nrm(20,"div",15),e.bVm()),2&s){const t=e.sdS(2),o=e.XpG();e.R7$(19),e.Y8G("ngIf",o.permissions.grafana.read),e.R7$(),e.Y8G("ngbNavOutlet",t)}}let Kl=(()=>{class s{selection;group;permissions;selectedItem;data;subsystemNQN;ngOnChanges(){this.selection&&(this.selectedItem=this.selection,this.subsystemNQN=this.selectedItem.nqn,this.data={},this.data["Serial Number"]=this.selectedItem.serial_number,this.data["Model Number"]=this.selectedItem.model_number,this.data["Minimum Controller Identifier"]=this.selectedItem.min_cntlid,this.data["Maximum Controller Identifier"]=this.selectedItem.max_cntlid,this.data["Subsystem Type"]=this.selectedItem.subtype)}static \u0275fac=function(o){return new(o||s)};static \u0275cmp=e.VBU({type:s,selectors:[["cd-nvmeof-subsystems-details"]],inputs:{selection:"selection",group:"group",permissions:"permissions"},features:[e.OA$],decls:1,vars:1,consts:()=>{let t,o,n,i,r,_;return t="\u8BE6\u7EC6\u4FE1\u606F",o="Listeners",n="\u540D\u79F0\u7A7A\u95F4",i="\u6388\u6743\u4EBA",r="\u6027\u80FD\u8BE6\u7EC6\u4FE1\u606F",_="Subsystem details",[["nav","ngbNav"],t,o,n,i,r,[4,"ngIf"],["ngbNav","","cdStatefulTab","subsystem-details",1,"nav-tabs"],["ngbNavItem","details"],["ngbNavLink",""],["ngbNavContent",""],["ngbNavItem","listeners"],["ngbNavItem","namespaces"],["ngbNavItem","initiators"],["ngbNavItem","performance-details",4,"ngIf"],[3,"ngbNavOutlet"],[3,"data"],[3,"subsystemNQN","group"],["ngbNavItem","performance-details"],["title",_,"uid","feeuv1dno43r4deed","grafanaStyle","three",3,"grafanaPath","type"]]},template:function(o,n){1&o&&e.DNE(0,Yl,21,2,"ng-container",6),2&o&&e.Y8G("ngIf",n.selection)},dependencies:[d.bT,A.Um,A.X9,A.sy,A.Ri,A.WA,A.m_,_t.c,Nl.i,Ct.B,Il,$l,Xl]})}return s})();const zl=()=>({md:4});function Ul(s,a){if(1&s&&e.nrm(0,"cd-nvmeof-subsystems-details",8),2&s){const t=e.XpG();e.Y8G("selection",t.expandedRow)("permissions",t.permissions)("group",t.group)}}const oo="Enter group name";let no=(()=>{class s extends pt.D{nvmeofService;authStorageService;actionLabels;router;modalService;taskWrapper;route;subsystems=[];subsystemsColumns;permissions;selection=new de.y;tableActions;subsystemDetails;gwGroups=[];group=null;gwGroupsEmpty=!1;gwGroupPlaceholder=oo;constructor(t,o,n,i,r,_,c){super(),this.nvmeofService=t,this.authStorageService=o,this.actionLabels=n,this.router=i,this.modalService=r,this.taskWrapper=_,this.route=c,this.permissions=this.authStorageService.getPermissions()}ngOnInit(){this.route.queryParams.subscribe(t=>{t?.group&&this.onGroupSelection({content:t?.group})}),this.setGatewayGroups(),this.subsystemsColumns=[{name:"NQN",prop:"nqn"},{name:"# Namespaces",prop:"namespace_count"},{name:"# Maximum Allowed Namespaces",prop:"max_namespaces"}],this.tableActions=[{name:this.actionLabels.CREATE,permission:"create",icon:C.F.add,click:()=>this.router.navigate(["block/nvmeof/subsystems",{outlets:{modal:[F.Qp.CREATE]}}],{queryParams:{group:this.group}}),canBePrimary:t=>!t.hasSelection,disable:()=>!this.group},{name:this.actionLabels.DELETE,permission:"delete",icon:C.F.destroy,click:()=>this.deleteSubsystemModal()}]}updateSelection(t){this.selection=t}getSubsystems(){this.group?this.nvmeofService.listSubsystems(this.group).subscribe(t=>{this.subsystems=Array.isArray(t)?t:[t]}):this.subsystems=[]}deleteSubsystemModal(){const t=this.selection.first();this.modalService.show(ce.D,{itemDescription:"Subsystem",itemNames:[t.nqn],actionDescription:"delete",submitActionObservable:()=>this.taskWrapper.wrapTaskAroundCall({task:new R.O("nvmeof/subsystem/delete",{nqn:t.nqn}),call:this.nvmeofService.deleteSubsystem(t.nqn,this.group)})})}onGroupSelection(t){t.selected=!0,this.group=t.content,this.getSubsystems()}onGroupClear(){this.group=null,this.getSubsystems()}setGatewayGroups(){this.nvmeofService.listGatewayGroups().subscribe(t=>{this.gwGroups=t?.[0]?.length?this.nvmeofService.formatGwGroupsList(t):[],!this.group&&this.gwGroups.length?(this.onGroupSelection(this.gwGroups[0]),this.gwGroupsEmpty=!1,this.gwGroupPlaceholder=oo):(this.gwGroupsEmpty=!0,this.gwGroupPlaceholder="No groups available")})}static \u0275fac=function(o){return new(o||s)(e.rXU(Re),e.rXU(U.v),e.rXU(F.Ss),e.rXU(p.Ix),e.rXU(me.V),e.rXU(I.a),e.rXU(p.nX))};static \u0275cmp=e.VBU({type:s,selectors:[["cd-nvmeof-subsystems"]],features:[e.Vt3],decls:12,vars:11,consts:()=>{let t,o;return t="Selected Gateway Group",o=" Subsystems " + "\ufffd#6\ufffd" + " A subsystem provides access control to which hosts can access the namespaces within the subsystem. " + "\ufffd/#6\ufffd" + "",[o,["cdsCol","",1,"pb-3",3,"columnNumbers"],["type","single","label",t,3,"selected","clear","placeholder","items","disabled"],["columnMode","flex","selectionType","single",3,"fetchData","setExpandedRow","updateSelection","data","columns","hasDetails"],[1,"table-actions"],[1,"btn-group",3,"permission","selection","tableActions"],[3,"selection","permissions","group",4,"cdTableDetail"],["name","modal"],[3,"selection","permissions","group"]]},template:function(o,n){1&o&&(e.nrm(0,"cd-nvmeof-tabs"),e.j41(1,"div",1)(2,"cds-combo-box",2),e.bIt("selected",function(r){return n.onGroupSelection(r)})("clear",function(){return n.onGroupClear()}),e.nrm(3,"cds-dropdown-list"),e.k0s()(),e.j41(4,"legend"),e.PLo(5,0),e.nrm(6,"cd-help-text"),e.YFu(),e.k0s(),e.j41(7,"cd-table",3),e.bIt("fetchData",function(){return n.getSubsystems()})("setExpandedRow",function(r){return n.setExpandedRow(r)})("updateSelection",function(r){return n.updateSelection(r)}),e.j41(8,"div",4),e.nrm(9,"cd-table-actions",5),e.k0s(),e.DNE(10,Ul,1,3,"cd-nvmeof-subsystems-details",6),e.k0s(),e.nrm(11,"router-outlet",7)),2&o&&(e.R7$(),e.Y8G("columnNumbers",e.lJ4(10,zl)),e.R7$(),e.Y8G("placeholder",n.gwGroupPlaceholder)("items",n.gwGroups)("disabled",n.gwGroupsEmpty),e.R7$(5),e.Y8G("data",n.subsystems)("columns",n.subsystemsColumns)("hasDetails",!0),e.R7$(2),e.Y8G("permission",n.permissions.nvmeof)("selection",n.selection)("tableActions",n.tableActions))},dependencies:[Se.O,W.O,ge.j,ft.N,p.n3,je.ee,At.a,Wt.Q5,Kl,Jt]})}return s})();function Ql(s,a){1&s&&(e.j41(0,"span",28),e.pXf(1,5),e.k0s())}function Wl(s,a){1&s&&(e.j41(0,"span",28),e.pXf(1,6),e.k0s())}function Jl(s,a){1&s&&(e.j41(0,"span",28),e.PLo(1,7),e.nrm(2,"br")(3,"code")(4,"br")(5,"code"),e.YFu(),e.k0s())}function Zl(s,a){1&s&&(e.j41(0,"span",28),e.pXf(1,8),e.k0s())}function ec(s,a){1&s&&(e.j41(0,"span",28),e.pXf(1,9),e.k0s())}function tc(s,a){if(1&s&&(e.j41(0,"span",28),e.pXf(1,10),e.k0s()),2&s){const t=e.XpG();e.R7$(),e.uP7(t.defaultMaxNamespace),e.nnv(1)}}function oc(s,a){1&s&&(e.j41(0,"span",28),e.pXf(1,11),e.k0s())}let nc=(()=>{class s{authStorageService;actionLabels;activeModal;nvmeofService;taskWrapperService;router;route;permission;subsystemForm;action;resource;pageURL;defaultMaxNamespace=1024;group;constructor(t,o,n,i,r,_,c){this.authStorageService=t,this.actionLabels=o,this.activeModal=n,this.nvmeofService=i,this.taskWrapperService=r,this.router=_,this.route=c,this.permission=this.authStorageService.getPermissions().nvmeof,this.resource="Subsystem",this.pageURL="block/nvmeof/subsystems"}DEFAULT_NQN="nqn.2001-07.com.ceph:"+Date.now();NQN_REGEX=/^nqn\.(19|20)\d\d-(0[1-9]|1[0-2])\.\D{2,3}(\.[A-Za-z0-9-]+)+(:[A-Za-z0-9-\.]+(:[A-Za-z0-9-\.]+)*)$/;NQN_REGEX_UUID=/^nqn\.2014-08\.org\.nvmexpress:uuid:[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}$/;customNQNValidator=h.xQ.custom("pattern",t=>!!t&&!(this.NQN_REGEX.test(t)||this.NQN_REGEX_UUID.test(t)));ngOnInit(){this.route.queryParams.subscribe(t=>{this.group=t?.group}),this.createForm(),this.action=this.actionLabels.CREATE}createForm(){this.subsystemForm=new j.$({nqn:new l.hs(this.DEFAULT_NQN,{validators:[this.customNQNValidator,l.k0.required,this.customNQNValidator,h.xQ.custom("maxLength",t=>(new TextEncoder).encode(t).length>223)],asyncValidators:[h.xQ.unique(this.nvmeofService.isSubsystemPresent,this.nvmeofService,null,null,this.group)]}),max_namespaces:new l.hs(this.defaultMaxNamespace,{validators:[h.xQ.number(!1),l.k0.max(this.defaultMaxNamespace),l.k0.min(1)]})})}onSubmit(){const t=this,o=this.subsystemForm.getValue("nqn"),n=Number(this.subsystemForm.getValue("max_namespaces"));let i=`nvmeof/subsystem/${F.Qp.CREATE}`;const r={nqn:o,enable_ha:!0,gw_group:this.group,max_namespaces:n};n||delete r.max_namespaces,this.taskWrapperService.wrapTaskAroundCall({task:new R.O(i,{nqn:o}),call:this.nvmeofService.createSubsystem(r)}).subscribe({error(){t.subsystemForm.setErrors({cdSubmitButton:!0})},complete:()=>{this.router.navigate([this.pageURL,{outlets:{modal:null}}])}})}static \u0275fac=function(o){return new(o||s)(e.rXU(U.v),e.rXU(F.Ss),e.rXU(A.Lw),e.rXU(Re),e.rXU(I.a),e.rXU(p.Ix),e.rXU(p.nX))};static \u0275cmp=e.VBU({type:s,selectors:[["cd-nvmeof-subsystems-form"]],decls:37,vars:23,consts:()=>{let t,o,n,i,r,_,c,u,S,M,E;return t="" + "\ufffd0\ufffd" + " " + "\ufffd1\ufffd" + "",o="NQN",n="Maximum Namespaces",i="The maximum namespaces per subsystem. Default is " + "\ufffd0\ufffd" + "",r="\u8FD9\u662F\u5FC5\u586B\u5B57\u6BB5\uFF01",_="This NQN is already in use.",c="Expected NQN format" + "[\ufffd#2\ufffd\ufffd/#2\ufffd|\ufffd#4\ufffd\ufffd/#4\ufffd]" + "<" + "[\ufffd#3\ufffd|\ufffd#5\ufffd]" + "nqn.$year-$month.$reverseDomainName:$utf8-string" + "[\ufffd/#3\ufffd|\ufffd/#5\ufffd]" + "\".> or " + "[\ufffd#2\ufffd\ufffd/#2\ufffd|\ufffd#4\ufffd\ufffd/#4\ufffd]" + "<" + "[\ufffd#3\ufffd|\ufffd#5\ufffd]" + "nqn.2014-08.org.nvmexpress:uuid:$UUID-string" + "[\ufffd/#3\ufffd|\ufffd/#5\ufffd]" + "\".>",c=e.k04(c),u="An NQN may not be more than 223 bytes in length.",S="\u503C\u5FC5\u987B\u81F3\u5C11\u4E3A 1\u3002",M="The value cannot be greater than " + "\ufffd0\ufffd" + ".",E="The value must be a positive integer.",[["formDir","ngForm"],t,o,n,i,r,_,c,u,S,M,E,[3,"pageURL","modalRef"],[1,"modal-title"],[1,"modal-content"],["name","subsystemForm","novalidate","",3,"formGroup"],[1,"modal-body"],[1,"form-group","row"],["for","nqn",1,"cd-col-form-label"],[1,"required"],[1,"cd-col-form-input"],["name","nqn","type","text","formControlName","nqn",1,"form-control"],["class","invalid-feedback",4,"ngIf"],["for","max_namespaces",1,"cd-col-form-label"],["id","max_namespaces","type","text","name","max_namespaces","formControlName","max_namespaces",1,"form-control"],[1,"modal-footer"],[1,"text-right"],[3,"submitActionEvent","form","submitText"],[1,"invalid-feedback"]]},template:function(o,n){if(1&o){const i=e.RV6();e.j41(0,"cd-modal",12)(1,"span",13),e.pXf(2,1),e.nI1(3,"titlecase"),e.nI1(4,"upperFirst"),e.k0s(),e.qex(5,14),e.j41(6,"form",15,0)(8,"div",16)(9,"div",17)(10,"label",18)(11,"span",19),e.pXf(12,2),e.k0s()(),e.j41(13,"div",20),e.nrm(14,"input",21),e.j41(15,"cd-help-text"),e.EFF(16," A unique and permanent name for the lifetime of the subsystem. "),e.k0s(),e.DNE(17,Ql,2,0,"span",22)(18,Wl,2,0,"span",22)(19,Jl,6,0,"span",22)(20,Zl,2,0,"span",22),e.k0s()(),e.j41(21,"div",17)(22,"label",23)(23,"span"),e.pXf(24,3),e.k0s()(),e.j41(25,"div",20),e.nrm(26,"input",24),e.j41(27,"cd-help-text"),e.pXf(28,4),e.k0s(),e.DNE(29,ec,2,0,"span",22)(30,tc,2,1,"span",22)(31,oc,2,0,"span",22),e.k0s()()(),e.j41(32,"div",25)(33,"div",26)(34,"cd-form-button-panel",27),e.nI1(35,"titlecase"),e.nI1(36,"upperFirst"),e.bIt("submitActionEvent",function(){return e.eBV(i),e.Njj(n.onSubmit())}),e.k0s()()()(),e.bVm(),e.k0s()}if(2&o){const i=e.sdS(7);e.Y8G("pageURL",n.pageURL)("modalRef",n.activeModal),e.R7$(4),e.uP7(e.bMT(3,15,n.action))(e.bMT(4,17,n.resource)),e.nnv(2),e.R7$(2),e.Y8G("formGroup",n.subsystemForm),e.R7$(11),e.Y8G("ngIf",n.subsystemForm.showError("nqn",i,"required")),e.R7$(),e.Y8G("ngIf",n.subsystemForm.showError("nqn",i,"unique")),e.R7$(),e.Y8G("ngIf",n.subsystemForm.showError("nqn",i,"pattern")),e.R7$(),e.Y8G("ngIf",n.subsystemForm.showError("nqn",i,"maxLength")),e.R7$(8),e.uP7(n.defaultMaxNamespace),e.nnv(28),e.R7$(),e.Y8G("ngIf",n.subsystemForm.showError("max_namespaces",i,"min")),e.R7$(),e.Y8G("ngIf",n.subsystemForm.showError("max_namespaces",i,"max")),e.R7$(),e.Y8G("ngIf",n.subsystemForm.showError("max_namespaces",i,"pattern")),e.R7$(3),e.Y8G("form",n.subsystemForm)("submitText",e.bMT(35,19,n.action)+" "+e.bMT(36,21,n.resource))}},dependencies:[d.bT,l.qT,l.me,l.BC,l.cb,l.j4,l.JD,Q.z,V.e,Se.O,z.S,pe.a,b.C,k.E,d.PV,Be.r]})}return s})();var sc=m(7466),ic=m(92123);function ac(s,a){1&s&&(e.j41(0,"option",31),e.pXf(1,6),e.k0s()),2&s&&e.Y8G("ngValue",null)}function rc(s,a){1&s&&(e.j41(0,"option",31),e.pXf(1,7),e.k0s()),2&s&&e.Y8G("ngValue",null)}function _c(s,a){1&s&&(e.j41(0,"option",31),e.pXf(1,8),e.k0s()),2&s&&e.Y8G("ngValue",null)}function lc(s,a){if(1&s&&(e.j41(0,"option",31),e.EFF(1),e.k0s()),2&s){const t=a.$implicit;e.Y8G("ngValue",t),e.R7$(),e.JRh(t.hostname)}}function cc(s,a){1&s&&(e.j41(0,"span",32),e.pXf(1,9),e.k0s())}function dc(s,a){1&s&&(e.j41(0,"span",32),e.pXf(1,10),e.k0s())}function mc(s,a){1&s&&(e.j41(0,"span",32),e.pXf(1,11),e.k0s())}function uc(s,a){1&s&&(e.j41(0,"span",32),e.pXf(1,12),e.k0s())}let pc=(()=>{class s{actionLabels;authStorageService;taskWrapperService;nvmeofService;hostService;router;route;activeModal;formatterService;dimlessBinaryPipe;action;permission;hostPermission;resource;pageURL;listenerForm;subsystemNQN;hosts=null;group;constructor(t,o,n,i,r,_,c,u,S,M){this.actionLabels=t,this.authStorageService=o,this.taskWrapperService=n,this.nvmeofService=i,this.hostService=r,this.router=_,this.route=c,this.activeModal=u,this.formatterService=S,this.dimlessBinaryPipe=M,this.permission=this.authStorageService.getPermissions().nvmeof,this.hostPermission=this.authStorageService.getPermissions().hosts,this.resource="Listener",this.pageURL="block/nvmeof/subsystems"}filterHostsByLabel(t,o){return t.filter(n=>{const i=n?.labels;return"string"==typeof o?i.includes(o):i?.length===o?.length&&f().isEqual(i,o)})}filterHostsByHostname(t,o){return t.filter(n=>o.includes(n.hostname))}getGwGroupPlacement(t){return t?.[0]?.find(o=>o?.spec?.group===this.group)?.placement||{hosts:[],label:[]}}setHosts(){(0,J.p)({gwGroups:this.nvmeofService.listGatewayGroups(),allHosts:this.hostService.getAllHosts()}).pipe((0,ic.T)(({gwGroups:t,allHosts:o})=>{const{hosts:n,label:i}=this.getGwGroupPlacement(t);return n?.length?this.filterHostsByHostname(o,n):i?.length?this.filterHostsByLabel(o,i):[]})).subscribe(t=>{this.hosts=t.map(o=>({hostname:o.hostname,addr:o.addr}))})}ngOnInit(){this.createForm(),this.action=this.actionLabels.CREATE,this.route.params.subscribe(t=>{this.subsystemNQN=t?.subsystem_nqn}),this.route.queryParams.subscribe(t=>{this.group=t?.group}),this.setHosts()}createForm(){this.listenerForm=new j.$({host:new l.hs(null,{validators:[l.k0.required]}),trsvcid:new l.hs(4420,[l.k0.required,h.xQ.number(!1),l.k0.max(65535)])})}buildRequest(){const t=this.listenerForm.getValue("host");let o=Number(this.listenerForm.getValue("trsvcid"));return o||(o=4420),{gw_group:this.group,host_name:t.hostname,traddr:t.addr,trsvcid:o}}onSubmit(){const t=this,o=`nvmeof/listener/${F.Qp.CREATE}`,n=this.buildRequest();this.taskWrapperService.wrapTaskAroundCall({task:new R.O(o,{nqn:this.subsystemNQN,host_name:n.host_name}),call:this.nvmeofService.createListener(this.subsystemNQN,n)}).subscribe({error(){t.listenerForm.setErrors({cdSubmitButton:!0})},complete:()=>{this.router.navigate([this.pageURL,{outlets:{modal:null}}])}})}static \u0275fac=function(o){return new(o||s)(e.rXU(F.Ss),e.rXU(U.v),e.rXU(I.a),e.rXU(Re),e.rXU(sc.I),e.rXU(p.Ix),e.rXU(p.nX),e.rXU(A.Lw),e.rXU(Mt.k),e.rXU(ke.l))};static \u0275cmp=e.VBU({type:s,selectors:[["cd-nvmeof-listeners-form"]],decls:38,vars:22,consts:()=>{let t,o,n,i,r,_,c,u,S,M,E,N;return t="" + "\ufffd0\ufffd" + " " + "\ufffd1\ufffd" + "",o="\u4E3B\u673A\u540D",n=" This hostname uniquely identifies the gateway on which the listener is being set up. ",i="Transport Service ID",r="The IP port to use. Default is 4420.",_="\u6B63\u5728\u52A0\u8F7D...",c="-- No hosts available --",u="-- Select a host --",S="\u8FD9\u662F\u5FC5\u586B\u5B57\u6BB5\uFF01",M="\u8FD9\u662F\u5FC5\u586B\u5B57\u6BB5\uFF01",E="The value cannot be greated than 65535.",N="The value must be a positive integer.",[["formDir","ngForm"],t,o,n,i,r,_,c,u,S,M,E,N,[3,"pageURL"],[1,"modal-title"],[1,"modal-content"],["name","listenerForm","novalidate","",3,"formGroup"],[1,"modal-body"],[1,"form-group","row"],["for","host",1,"cd-col-form-label"],[1,"required"],[1,"cd-col-form-input"],["id","host","name","host","formControlName","host",1,"form-select"],[3,"ngValue",4,"ngIf"],[3,"ngValue",4,"ngFor","ngForOf"],["class","invalid-feedback",4,"ngIf"],["for","trsvcid",1,"cd-col-form-label"],["id","trsvcid","type","text","name","trsvcid","formControlName","trsvcid",1,"form-control"],[1,"modal-footer"],[1,"text-right"],[3,"submitActionEvent","form","submitText"],[3,"ngValue"],[1,"invalid-feedback"]]},template:function(o,n){if(1&o){const i=e.RV6();e.j41(0,"cd-modal",13)(1,"span",14),e.pXf(2,1),e.nI1(3,"titlecase"),e.nI1(4,"upperFirst"),e.k0s(),e.qex(5,15),e.j41(6,"form",16,0)(8,"div",17)(9,"div",18)(10,"label",19)(11,"span",20),e.pXf(12,2),e.k0s()(),e.j41(13,"div",21)(14,"select",22),e.DNE(15,ac,2,1,"option",23)(16,rc,2,1,"option",23)(17,_c,2,1,"option",23)(18,lc,2,2,"option",24),e.k0s(),e.j41(19,"cd-help-text"),e.pXf(20,3),e.k0s(),e.DNE(21,cc,2,0,"span",25),e.k0s()(),e.j41(22,"div",18)(23,"label",26)(24,"span"),e.pXf(25,4),e.k0s()(),e.j41(26,"div",21),e.nrm(27,"input",27),e.j41(28,"cd-help-text"),e.pXf(29,5),e.k0s(),e.DNE(30,dc,2,0,"span",25)(31,mc,2,0,"span",25)(32,uc,2,0,"span",25),e.k0s()()(),e.j41(33,"div",28)(34,"div",29)(35,"cd-form-button-panel",30),e.nI1(36,"titlecase"),e.nI1(37,"upperFirst"),e.bIt("submitActionEvent",function(){return e.eBV(i),e.Njj(n.onSubmit())}),e.k0s()()()(),e.bVm(),e.k0s()}if(2&o){const i=e.sdS(7);e.Y8G("pageURL",n.pageURL),e.R7$(4),e.uP7(e.bMT(3,14,n.action))(e.bMT(4,16,n.resource)),e.nnv(2),e.R7$(2),e.Y8G("formGroup",n.listenerForm),e.R7$(9),e.Y8G("ngIf",null===n.hosts),e.R7$(),e.Y8G("ngIf",n.hosts&&0===n.hosts.length),e.R7$(),e.Y8G("ngIf",n.hosts&&n.hosts.length>0),e.R7$(),e.Y8G("ngForOf",n.hosts),e.R7$(3),e.Y8G("ngIf",n.listenerForm.showError("host",i,"required")),e.R7$(9),e.Y8G("ngIf",n.listenerForm.showError("trsvcid",i,"required")),e.R7$(),e.Y8G("ngIf",n.listenerForm.showError("trsvcid",i,"max")),e.R7$(),e.Y8G("ngIf",n.listenerForm.showError("trsvcid",i,"pattern")),e.R7$(3),e.Y8G("form",n.listenerForm)("submitText",e.bMT(36,18,n.action)+" "+e.bMT(37,20,n.resource))}},dependencies:[d.Sq,d.bT,l.qT,l.xH,l.y7,l.me,l.wz,l.BC,l.cb,l.j4,l.JD,Q.z,V.e,Se.O,z.S,pe.a,b.C,k.E,g.c$,d.PV,Be.r]})}return s})();const $t=s=>({required:s});function gc(s,a){1&s&&e.nrm(0,"input",36)}function fc(s,a){1&s&&(e.j41(0,"option",39),e.pXf(1,5),e.k0s()),2&s&&e.Y8G("ngValue",null)}function Tc(s,a){1&s&&(e.j41(0,"option",39),e.pXf(1,6),e.k0s()),2&s&&e.Y8G("ngValue",null)}function Sc(s,a){1&s&&(e.j41(0,"option",39),e.pXf(1,7),e.k0s()),2&s&&e.Y8G("ngValue",null)}function Ec(s,a){if(1&s&&(e.j41(0,"option",40),e.EFF(1),e.k0s()),2&s){const t=a.$implicit;e.Y8G("value",t.pool_name),e.R7$(),e.JRh(t.pool_name)}}function Cc(s,a){if(1&s&&(e.j41(0,"select",37),e.DNE(1,fc,2,1,"option",38)(2,Tc,2,1,"option",38)(3,Sc,2,1,"option",38)(4,Ec,2,2,"option",31),e.k0s()),2&s){const t=e.XpG();e.R7$(),e.Y8G("ngIf",null===t.rbdPools),e.R7$(),e.Y8G("ngIf",t.rbdPools&&0===t.rbdPools.length),e.R7$(),e.Y8G("ngIf",t.rbdPools&&t.rbdPools.length>0),e.R7$(),e.Y8G("ngForOf",t.rbdPools)}}function Fc(s,a){1&s&&(e.j41(0,"span",41),e.pXf(1,8),e.k0s())}function Rc(s,a){if(1&s&&(e.j41(0,"div",42)(1,"label",43)(2,"span",21),e.pXf(3,9),e.k0s()(),e.j41(4,"div",22),e.nrm(5,"cds-number",44),e.k0s()()),2&s){const t=e.XpG(),o=e.sdS(7);e.R7$(2),e.Y8G("ngClass",e.eq3(5,$t,!t.edit)),e.R7$(3),e.Y8G("min",t.MIN_NAMESPACE_CREATE)("max",t.MAX_NAMESPACE_CREATE)("invalid",t.nsForm.showError("nsCount",o,"max")||t.nsForm.showError("nsCount",o,"min")||t.nsForm.showError("nsCount",o,"required"))("invalidText",t.nsForm.get("nsCount").hasError("required")?t.requiredInvalidText:t.nsCountInvalidText)}}function Mc(s,a){if(1&s&&(e.j41(0,"option",40),e.pXf(1,10),e.k0s()),2&s){const t=a.$implicit;e.Y8G("value",t),e.R7$(),e.uP7(t),e.nnv(1)}}function Oc(s,a){1&s&&(e.j41(0,"span",41),e.qex(1),e.pXf(2,11),e.bVm(),e.k0s())}function hc(s,a){1&s&&(e.j41(0,"span",41),e.qex(1),e.pXf(2,12),e.bVm(),e.k0s())}function bc(s,a){1&s&&(e.j41(0,"span",45),e.qex(1),e.pXf(2,13),e.bVm(),e.k0s())}let so=(()=>{class s{actionLabels;authStorageService;taskWrapperService;nvmeofService;poolService;rbdService;router;route;activeModal;formatterService;dimlessBinaryPipe;action;permission;poolPermission;resource;pageURL;edit=!1;nsForm;subsystemNQN;rbdPools=null;units=["MiB","GiB","TiB"];nsid;currentBytes;invalidSizeError;group;MAX_NAMESPACE_CREATE=5;MIN_NAMESPACE_CREATE=1;requiredInvalidText="This field is required";nsCountInvalidText="The namespace count should be between 1 and 5";constructor(t,o,n,i,r,_,c,u,S,M,E){this.actionLabels=t,this.authStorageService=o,this.taskWrapperService=n,this.nvmeofService=i,this.poolService=r,this.rbdService=_,this.router=c,this.route=u,this.activeModal=S,this.formatterService=M,this.dimlessBinaryPipe=E,this.permission=this.authStorageService.getPermissions().nvmeof,this.poolPermission=this.authStorageService.getPermissions().pool,this.resource="\u540D\u79F0\u7A7A\u95F4",this.pageURL="block/nvmeof/subsystems"}init(){this.route.queryParams.subscribe(t=>{this.group=t?.group}),this.createForm(),this.action=this.actionLabels.CREATE,this.route.params.subscribe(t=>{this.subsystemNQN=t.subsystem_nqn,this.nsid=t?.nsid})}initForEdit(){this.edit=!0,this.action=this.actionLabels.EDIT,this.nvmeofService.getNamespace(this.subsystemNQN,this.nsid,this.group).subscribe(t=>{const o=this.dimlessBinaryPipe.transform(t.rbd_image_size).split(" ");this.currentBytes=t.rbd_image_size,this.nsForm.get("pool").setValue(t.rbd_pool_name),this.nsForm.get("unit").setValue(o[1]),this.nsForm.get("image_size").setValue(o[0]),this.nsForm.get("image_size").addValidators(l.k0.required),this.nsForm.get("pool").disable()})}initForCreate(){this.poolService.getList().subscribe(t=>{this.rbdPools=t.filter(this.rbdService.isRBDPool),this.rbdPools?.length&&this.nsForm.get("pool").setValue(this.rbdPools[0].pool_name)})}ngOnInit(){this.init(),this.router.url.includes("subsystems/(modal:edit")?this.initForEdit():this.initForCreate()}createForm(){this.nsForm=new j.$({pool:new l.hs(null,{validators:[l.k0.required]}),image_size:new l.hs(1,[h.xQ.number(!1),l.k0.min(1)]),unit:new l.hs(this.units[1]),nsCount:new l.hs(this.MAX_NAMESPACE_CREATE,[l.k0.required,l.k0.max(this.MAX_NAMESPACE_CREATE),l.k0.min(this.MIN_NAMESPACE_CREATE)])})}buildUpdateRequest(t){return this.nvmeofService.updateNamespace(this.subsystemNQN,this.nsid,{gw_group:this.group,rbd_image_size:t})}randomString(){return Math.random().toString(36).substring(2)}buildCreateRequest(t,o){const n=this.nsForm.getValue("pool"),i=[];for(let r=1;r<=o;r++){const _={gw_group:this.group,rbd_image_name:`nvme_${n}_${this.group}_${this.randomString()}`,rbd_pool:n,create_image:!0};t&&(_.rbd_image_size=t),i.push(this.nvmeofService.createNamespace(this.subsystemNQN,_))}return i}validateSize(){const t=this.nsForm.getValue("unit"),o=this.nsForm.getValue("image_size");return o&&t?this.formatterService.toBytes(o+t)<=this.currentBytes:null}onSubmit(){if(this.validateSize())this.invalidSizeError=!0,this.nsForm.setErrors({cdSubmitButton:!0});else{this.invalidSizeError=!1;const t=this,o=`nvmeof/namespace/${this.edit?F.Qp.EDIT:F.Qp.CREATE}`,n=this.nsForm.getValue("image_size"),i=this.nsForm.getValue("nsCount");let r,_=null;if(n){const c=this.nsForm.getValue("unit");_=this.formatterService.toBytes(n+c)}r=this.taskWrapperService.wrapTaskAroundCall(this.edit?{task:new R.O(o,{nqn:this.subsystemNQN,nsid:this.nsid}),call:this.buildUpdateRequest(_)}:{task:new R.O(o,{nqn:this.subsystemNQN,nsCount:i}),call:(0,J.p)(this.buildCreateRequest(_,i))}),r.subscribe({error(){t.nsForm.setErrors({cdSubmitButton:!0})},complete:()=>{this.router.navigate([this.pageURL,{outlets:{modal:null}}])}})}}static \u0275fac=function(o){return new(o||s)(e.rXU(F.Ss),e.rXU(U.v),e.rXU(I.a),e.rXU(Re),e.rXU(Qe.m),e.rXU(Z.U),e.rXU(p.Ix),e.rXU(p.nX),e.rXU(A.Lw),e.rXU(Mt.k),e.rXU(ke.l))};static \u0275cmp=e.VBU({type:s,selectors:[["cd-nvmeof-namespaces-form"]],decls:37,vars:29,consts:()=>{let t,o,n,i,r,_,c,u,S,M,E,N,G,y;return t="" + "\ufffd0\ufffd" + " " + "\ufffd1\ufffd" + "",o="\u5B58\u50A8\u6C60",n=" An RBD application-enabled pool where the image will be created. ",i="Image Size",r="\u6B63\u5728\u52A0\u8F7D...",_="-- No block pools available --",c="-- \u8BF7\u9009\u62E9\u5B58\u50A8\u6C60 --",u="\u8FD9\u662F\u5FC5\u586B\u5B57\u6BB5\uFF01",S="The number of namespaces to create",M="Namespace Count",E="" + "\ufffd0\ufffd" + "",N="Enter a positive integer.",G="This field is required",y="Enter a value above than previous. A block device image can be expanded but not reduced.",[["formDir","ngForm"],t,o,n,i,r,_,c,u,M,E,N,G,y,[3,"pageURL","modalRef"],[1,"modal-title"],[1,"modal-content"],["name","nsForm","novalidate","",3,"formGroup"],[1,"modal-body"],[1,"form-group","row"],["for","pool",1,"cd-col-form-label"],[3,"ngClass"],[1,"cd-col-form-input"],["class","form-control","type","text","id","pool-edit","formControlName","pool",4,"ngIf"],["id","pool-create","class","form-select","formControlName","pool",4,"ngIf"],["class","invalid-feedback",4,"ngIf"],["class","form-group row","id","namespace-count",4,"ngIf"],["for","image_size",1,"cd-col-form-label"],[1,"input-group"],["id","size","type","text","formControlName","image_size",1,"form-control"],["id","unit","formControlName","unit",1,"form-input","form-select"],[3,"value",4,"ngFor","ngForOf"],["class","invalid-feedback","id","image-size-invalid",4,"ngIf"],[1,"modal-footer"],[1,"text-right"],[3,"submitActionEvent","form","submitText"],["type","text","id","pool-edit","formControlName","pool",1,"form-control"],["id","pool-create","formControlName","pool",1,"form-select"],[3,"ngValue",4,"ngIf"],[3,"ngValue"],[3,"value"],[1,"invalid-feedback"],["id","namespace-count",1,"form-group","row"],["for","nsCount",1,"cd-col-form-label"],["formControlName","nsCount","helperText",S,"size","sm",3,"min","max","invalid","invalidText"],["id","image-size-invalid",1,"invalid-feedback"]]},template:function(o,n){if(1&o){const i=e.RV6();e.j41(0,"cd-modal",14)(1,"span",15),e.pXf(2,1),e.nI1(3,"titlecase"),e.nI1(4,"upperFirst"),e.k0s(),e.qex(5,16),e.j41(6,"form",17,0)(8,"div",18)(9,"div",19)(10,"label",20)(11,"span",21),e.pXf(12,2),e.k0s()(),e.j41(13,"div",22),e.DNE(14,gc,1,0,"input",23)(15,Cc,5,4,"select",24),e.j41(16,"cd-help-text"),e.pXf(17,3),e.k0s(),e.DNE(18,Fc,2,0,"span",25),e.k0s()(),e.DNE(19,Rc,6,7,"div",26),e.j41(20,"div",19)(21,"label",27)(22,"span",21),e.pXf(23,4),e.k0s()(),e.j41(24,"div",22)(25,"div",28),e.nrm(26,"input",29),e.j41(27,"select",30),e.DNE(28,Mc,2,2,"option",31),e.k0s(),e.DNE(29,Oc,3,0,"span",25)(30,hc,3,0,"span",25)(31,bc,3,0,"span",32),e.k0s()()()(),e.j41(32,"div",33)(33,"div",34)(34,"cd-form-button-panel",35),e.nI1(35,"titlecase"),e.nI1(36,"upperFirst"),e.bIt("submitActionEvent",function(){return e.eBV(i),e.Njj(n.onSubmit())}),e.k0s()()()(),e.bVm(),e.k0s()}if(2&o){const i=e.sdS(7);e.Y8G("pageURL",n.pageURL)("modalRef",n.activeModal),e.R7$(4),e.uP7(e.bMT(3,17,n.action))(e.bMT(4,19,n.resource)),e.nnv(2),e.R7$(2),e.Y8G("formGroup",n.nsForm),e.R7$(5),e.Y8G("ngClass",e.eq3(25,$t,!n.edit)),e.R7$(3),e.Y8G("ngIf",n.edit),e.R7$(),e.Y8G("ngIf",!n.edit),e.R7$(3),e.Y8G("ngIf",n.nsForm.showError("pool",i,"required")),e.R7$(),e.Y8G("ngIf",!n.edit),e.R7$(3),e.Y8G("ngClass",e.eq3(27,$t,n.edit)),e.R7$(6),e.Y8G("ngForOf",n.units),e.R7$(),e.Y8G("ngIf",n.nsForm.showError("image_size",i,"pattern")),e.R7$(),e.Y8G("ngIf",n.edit&&n.nsForm.showError("image_size",i,"required")),e.R7$(),e.Y8G("ngIf",n.edit&&n.invalidSizeError),e.R7$(3),e.Y8G("form",n.nsForm)("submitText",e.bMT(35,21,n.action)+" "+e.bMT(36,23,n.resource))}},dependencies:[d.YU,d.Sq,d.bT,l.qT,l.xH,l.y7,l.me,l.wz,l.BC,l.cb,l.j4,l.JD,Q.z,V.e,Se.O,z.S,pe.a,b.C,k.E,g.c$,bt.jM,d.PV,Be.r]})}return s})();function Nc(s,a){1&s&&(e.j41(0,"span",38),e.pXf(1,6),e.k0s())}function Pc(s,a){1&s&&(e.j41(0,"span",38),e.PLo(1,7),e.nrm(2,"br")(3,"code")(4,"br")(5,"code"),e.YFu(),e.k0s())}function Ic(s,a){1&s&&(e.j41(0,"span",38),e.pXf(1,8),e.k0s())}function Ac(s,a){if(1&s&&(e.qex(0),e.DNE(1,Nc,2,0,"span",31)(2,Pc,6,0,"span",31)(3,Ic,2,0,"span",31),e.bVm()),2&s){let t,o,n;const i=e.XpG().index,r=e.XpG(2);e.R7$(),e.Y8G("ngIf",null==(t=r.initiatorForm.get("addHost.addedHosts").controls[i].errors)?null:t.required),e.R7$(),e.Y8G("ngIf",null==(o=r.initiatorForm.get("addHost.addedHosts").controls[i].errors)?null:o.pattern),e.R7$(),e.Y8G("ngIf",null==(n=r.initiatorForm.get("addHost.addedHosts").controls[i].errors)?null:n.maxLength)}}function Dc(s,a){if(1&s){const t=e.RV6();e.j41(0,"div",32),e.nrm(1,"input",33),e.j41(2,"button",34),e.bIt("click",function(){e.eBV(t);const n=e.XpG(2);return e.Njj(n.addHost())}),e.nrm(3,"i",35),e.k0s(),e.j41(4,"button",34),e.bIt("click",function(){const n=e.eBV(t).index,i=e.XpG(2);return e.Njj(i.removeHost(n))}),e.nrm(5,"i",36),e.k0s(),e.DNE(6,Ac,4,3,"ng-container",37),e.k0s()}if(2&s){let t;const o=a.index,n=e.XpG(2);e.R7$(),e.Y8G("required",!n.initiatorForm.getValue("allowAnyHost"))("formControlName",o),e.R7$(),e.Mz_("id","add-button-",o,""),e.Y8G("disabled",n.initiatorForm.get("addHost.addedHosts").controls[o].invalid||(null==(t=n.initiatorForm.get("addHost.addedHosts").errors)?null:t.duplicate)||32===n.initiatorForm.get("addHost.addedHosts").controls.length||1!==n.initiatorForm.get("addHost.addedHosts").controls.length&&n.initiatorForm.get("addHost.addedHosts").controls.length!==o+1),e.R7$(2),e.Mz_("id","delete-button-",o,""),e.Y8G("disabled",1===n.addedHosts.controls.length),e.R7$(2),e.Y8G("ngIf",n.initiatorForm.get("addHost.addedHosts").controls[o].invalid&&(n.initiatorForm.get("addHost.addedHosts").controls[o].dirty||n.initiatorForm.get("addHost.addedHosts").controls[o].touched))}}function $c(s,a){1&s&&(e.j41(0,"span",38),e.pXf(1,9),e.k0s())}function vc(s,a){if(1&s&&(e.j41(0,"div",29),e.DNE(1,Dc,7,9,"div",30)(2,$c,2,0,"span",31),e.k0s()),2&s){let t;const o=e.XpG();e.R7$(),e.Y8G("ngForOf",o.addedHosts.controls),e.R7$(),e.Y8G("ngIf",null==(t=o.initiatorForm.get("addHost.addedHosts").errors)?null:t.duplicate)}}function Lc(s,a){1&s&&(e.j41(0,"cd-alert-panel",39),e.EFF(1,"Allowing any host to connect to the NVMe/TCP gateway may pose security risks. "),e.k0s()),2&s&&e.Y8G("showTitle",!1)}let Gc=(()=>{class s{authStorageService;actionLabels;nvmeofService;taskWrapperService;router;route;formBuilder;permission;initiatorForm;action;resource;pageURL;remove=!1;subsystemNQN;removeHosts=[];group;constructor(t,o,n,i,r,_,c){this.authStorageService=t,this.actionLabels=o,this.nvmeofService=n,this.taskWrapperService=i,this.router=r,this.route=_,this.formBuilder=c,this.permission=this.authStorageService.getPermissions().nvmeof,this.resource="\u6388\u6743\u4EBA",this.pageURL="block/nvmeof/subsystems"}NQN_REGEX=/^nqn\.(19|20)\d\d-(0[1-9]|1[0-2])\.\D{2,3}(\.[A-Za-z0-9-]+)+(:[A-Za-z0-9-\.]+(:[A-Za-z0-9-\.]+)*)$/;NQN_REGEX_UUID=/^nqn\.2014-08\.org\.nvmexpress:uuid:[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}$/;ALLOW_ALL_HOST="*";customNQNValidator=h.xQ.custom("pattern",t=>!!t&&!(this.NQN_REGEX.test(t)||this.NQN_REGEX_UUID.test(t)));ngOnInit(){this.route.queryParams.subscribe(t=>{this.group=t?.group}),this.createForm(),this.action=this.actionLabels.ADD,this.route.params.subscribe(t=>{this.subsystemNQN=t.subsystem_nqn})}createForm(){this.initiatorForm=new j.$({allowAnyHost:new l.hs(!1),addHost:new j.$({addHostCheck:new l.hs(!1),addedHosts:this.formBuilder.array([],[h.xQ.custom("duplicate",t=>!!t.length&&new Set(t)?.size!==t.length)])})})}get addedHosts(){return this.initiatorForm.get("addHost.addedHosts")}addHost(){let t;t=this.formBuilder.control("",[this.customNQNValidator,l.k0.required]),this.addedHosts.push(t)}removeHost(t){this.addedHosts.removeAt(t)}setAddHostCheck(){if(this.initiatorForm.get("addHost.addHostCheck").value)this.addHost();else for(;0!==this.addedHosts.length;)this.addedHosts.removeAt(0)}onSubmit(){const t=this,o=this.initiatorForm.getValue("allowAnyHost"),n=this.addedHosts.value;let i=`nvmeof/initiator/${F.Qp.ADD}`;const r={host_nqn:n.join(","),gw_group:this.group};o&&(n.push("*"),r.host_nqn=n.join(",")),this.taskWrapperService.wrapTaskAroundCall({task:new R.O(i,{nqn:this.subsystemNQN}),call:this.nvmeofService.addInitiators(this.subsystemNQN,r)}).subscribe({error(){t.initiatorForm.setErrors({cdSubmitButton:!0})},complete:()=>{this.router.navigate([this.pageURL,{outlets:{modal:null}}])}})}static \u0275fac=function(o){return new(o||s)(e.rXU(U.v),e.rXU(F.Ss),e.rXU(Re),e.rXU(I.a),e.rXU(p.Ix),e.rXU(p.nX),e.rXU(rt.$))};static \u0275cmp=e.VBU({type:s,selectors:[["cd-nvmeof-initiators-form"]],decls:31,vars:16,consts:()=>{let t,o,n,i,r,_,c,u,S,M;return t="" + "\ufffd0\ufffd" + " " + "\ufffd1\ufffd" + "",o="Hosts ",n="Add host",i="Allow specific hosts to run NVMe/TCP commands to the NVMe subsystem.",r="Allow any host",_="Add host nqn",c="\u8FD9\u662F\u5FC5\u586B\u5B57\u6BB5\uFF01",u="Expected NQN format" + "[\ufffd#2\ufffd\ufffd/#2\ufffd|\ufffd#4\ufffd\ufffd/#4\ufffd]" + "<" + "[\ufffd#3\ufffd|\ufffd#5\ufffd]" + "nqn.$year-$month.$reverseDomainName:$utf8-string" + "[\ufffd/#3\ufffd|\ufffd/#5\ufffd]" + "\".> or " + "[\ufffd#2\ufffd\ufffd/#2\ufffd|\ufffd#4\ufffd\ufffd/#4\ufffd]" + "<" + "[\ufffd#3\ufffd|\ufffd#5\ufffd]" + "nqn.2014-08.org.nvmexpress:uuid:$UUID-string" + "[\ufffd/#3\ufffd|\ufffd/#5\ufffd]" + "\".>",u=e.k04(u),S="An NQN may not be more than 223 bytes in length.",M="Duplicate entry detected. Enter a unique value.",[["formDir","ngForm"],t,o,n,i,r,c,u,S,M,[3,"pageURL"],[1,"modal-title"],[1,"modal-content"],["name","initiatorForm","novalidate","",3,"formGroup"],[1,"modal-body"],[1,"form-group","row"],[1,"cd-col-form-label","required"],[1,"cd-col-form-input"],["formGroupName","addHost",1,"custom-control","custom-checkbox"],["type","checkbox","id","addHostCheck","name","addHostCheck","formControlName","addHostCheck",1,"custom-control-input",3,"change"],["for","addHostCheck",1,"custom-control-label","mb-0"],["formArrayName","addedHosts",4,"ngIf"],[1,"custom-control","custom-checkbox","pt-0"],["type","checkbox","id","allowAnyHost","name","allowAnyHost","formControlName","allowAnyHost",1,"custom-control-input"],["for","allowAnyHost",1,"custom-control-label"],["type","warning",3,"showTitle",4,"ngIf"],[1,"modal-footer"],[1,"text-right"],[3,"submitActionEvent","form","submitText"],["formArrayName","addedHosts"],["class","input-group cd-mb my-1",4,"ngFor","ngForOf"],["class","invalid-feedback",4,"ngIf"],[1,"input-group","cd-mb","my-1"],["type","text","placeholder",_,1,"cd-form-control",3,"required","formControlName"],["type","button",1,"btn","btn-light",3,"click","id","disabled"],[1,"fa","fa-plus"],[1,"fa","fa-trash-o"],[4,"ngIf"],[1,"invalid-feedback"],["type","warning",3,"showTitle"]]},template:function(o,n){if(1&o){const i=e.RV6();e.j41(0,"cd-modal",10)(1,"span",11),e.pXf(2,1),e.nI1(3,"titlecase"),e.nI1(4,"upperFirst"),e.k0s(),e.qex(5,12),e.j41(6,"form",13,0)(8,"div",14)(9,"div",15)(10,"label",16),e.pXf(11,2),e.k0s(),e.j41(12,"div",17)(13,"div",18)(14,"input",19),e.bIt("change",function(){return e.eBV(i),e.Njj(n.setAddHostCheck())}),e.k0s(),e.j41(15,"label",20),e.pXf(16,3),e.k0s(),e.j41(17,"cd-help-text")(18,"span"),e.pXf(19,4),e.k0s()(),e.DNE(20,vc,3,2,"div",21),e.k0s(),e.j41(21,"div",22),e.nrm(22,"input",23),e.j41(23,"label",24),e.pXf(24,5),e.k0s(),e.DNE(25,Lc,2,1,"cd-alert-panel",25),e.k0s()()()(),e.j41(26,"div",26)(27,"div",27)(28,"cd-form-button-panel",28),e.nI1(29,"titlecase"),e.nI1(30,"upperFirst"),e.bIt("submitActionEvent",function(){return e.eBV(i),e.Njj(n.onSubmit())}),e.k0s()()()(),e.bVm(),e.k0s()}2&o&&(e.Y8G("pageURL",n.pageURL),e.R7$(4),e.uP7(e.bMT(3,8,n.action))(e.bMT(4,10,n.resource)),e.nnv(2),e.R7$(2),e.Y8G("formGroup",n.initiatorForm),e.R7$(14),e.Y8G("ngIf",n.initiatorForm.get("addHost.addHostCheck").value),e.R7$(5),e.Y8G("ngIf",n.initiatorForm.getValue("allowAnyHost")),e.R7$(3),e.Y8G("form",n.initiatorForm)("submitText",e.bMT(29,12,n.action)+" "+e.bMT(30,14,n.resource)))},dependencies:[d.Sq,d.bT,l.qT,l.me,l.Zm,l.BC,l.cb,l.YS,l.j4,l.JD,l.$R,l.v8,Q.z,He.m,V.e,Se.O,z.S,pe.a,b.C,k.E,d.PV,Be.r]})}return s})();var Bc=m(27665),yc=m(79939),Xc=m(97367),kc=m(99062),Vc=m(57697),wc=m(63566);let io=(()=>{class s{iconService;constructor(t){this.iconService=t,this.iconService.registerAll([Xc.A,kc.A,Vc.A,wc.A,Vt.A])}static \u0275fac=function(o){return new(o||s)(e.KVO(Ye.fM))};static \u0275mod=e.$C({type:s});static \u0275inj=e.G2t({imports:[d.MD,Bs,l.YN,l.X1,A.Pv,A.zr,A.n8,ue.Y,Ce.G,p.iI,kt.wx,Bc.Vd,K.x1,je.pc,qe.tm,Ye.op,ye.q4,ht.s7,g.py,bt.Yr,P.Q_,yc.t,At.e,Dt.jr]})}return s})();const xc=[{path:"",redirectTo:"rbd",pathMatch:"full"},{path:"rbd",canActivate:[ie.k,q.x],data:{moduleStatusGuardConfig:{uiApiPath:"block/rbd",redirectTo:"error",header:"Block Pool is not configured",button_name:"Configure Default pool",button_route:"/pool/create",component:"Default Pool",uiConfig:!0},breadcrumbs:"Images"},children:[{path:"",component:V_},{path:"namespaces",component:J_,data:{breadcrumbs:"Namespaces"}},{path:"trash",component:ul,data:{breadcrumbs:"Trash"}},{path:"performance",component:Z_,data:{breadcrumbs:"Overall Performance"}},{path:F.Qp.CREATE,component:We,data:{breadcrumbs:F.yY.CREATE}},{path:`${F.Qp.EDIT}/:image_spec`,component:We,data:{breadcrumbs:F.yY.EDIT}},{path:`${F.Qp.CLONE}/:image_spec/:snap`,component:We,data:{breadcrumbs:F.yY.CLONE}},{path:`${F.Qp.COPY}/:image_spec`,component:We,data:{breadcrumbs:F.yY.COPY}},{path:`${F.Qp.COPY}/:image_spec/:snap`,component:We,data:{breadcrumbs:F.yY.COPY}}]},{path:"mirroring",component:Hi,canActivate:[ie.k,q.x],data:{moduleStatusGuardConfig:{uiApiPath:"block/mirroring",redirectTo:"error",header:"Block Mirroring is not configured",button_name:"Configure Block Mirroring",button_title:"This will create \"rbd-mirror\" service and a replicated Block pool",component:"Block Mirroring",uiConfig:!0},breadcrumbs:"Mirroring"},children:[{path:`${F.Qp.EDIT}/:pool_name`,component:Ui,outlet:"modal"}]},{path:"iscsi",canActivate:[ie.k],data:{breadcrumbs:"iSCSI"},children:[{path:"",redirectTo:"overview",pathMatch:"full"},{path:"overview",component:Ds,data:{breadcrumbs:"Overview"}},{path:"targets",data:{breadcrumbs:"Targets"},children:[{path:"",component:fs},{path:F.Qp.CREATE,component:Bt,data:{breadcrumbs:F.yY.CREATE}},{path:`${F.Qp.EDIT}/:target_iqn`,component:Bt,data:{breadcrumbs:F.yY.EDIT}}]}]},{path:"nvmeof",canActivate:[q.x],data:{breadcrumbs:!0,text:"NVMe/TCP",path:"nvmeof",disableSplit:!0,moduleStatusGuardConfig:{uiApiPath:"nvmeof",redirectTo:"error",header:"NVMe/TCP Gateway not configured",button_name:"Configure NVMe/TCP",button_route:["/services",{outlets:{modal:["create","nvmeof"]}}],uiConfig:!1}},children:[{path:"",redirectTo:"subsystems",pathMatch:"full"},{path:"subsystems",component:no,data:{breadcrumbs:"Subsystems"},children:[{path:"",component:no},{path:F.Qp.CREATE,component:nc,outlet:"modal"},{path:`${F.Qp.CREATE}/:subsystem_nqn/listener`,component:pc,outlet:"modal"},{path:`${F.Qp.CREATE}/:subsystem_nqn/namespace`,component:so,outlet:"modal"},{path:`${F.Qp.EDIT}/:subsystem_nqn/namespace/:nsid`,component:so,outlet:"modal"},{path:`${F.Qp.ADD}/:subsystem_nqn/initiator`,component:Gc,outlet:"modal"}]},{path:"gateways",component:bl,data:{breadcrumbs:"Gateways"}}]}];let Hc=(()=>{class s{static \u0275fac=function(o){return new(o||s)};static \u0275mod=e.$C({type:s});static \u0275inj=e.G2t({imports:[io,p.iI.forChild(xc)]})}return s})()},45413:(ut,Me,m)=>{m.d(Me,{c:()=>pe});var d=m(23279),l=m(37222),p=m(36651),A=m.n(p),ue=m(40598),F=m(46045),ie=m(58384),q=m(6107),Ce=m(12540),X=m(77241),f=m(56610),J=m(19116);let Oe=(()=>{class b{elementRef;control;dimlessBinaryPerSecondPipe;formatter;ngModelChange=new d.bkB;ngDataReady;minBytes;maxBytes;roundPower;defaultUnit;el;constructor(g,T,$,v){this.elementRef=g,this.control=T,this.dimlessBinaryPerSecondPipe=$,this.formatter=v,this.el=this.elementRef.nativeElement}ngOnInit(){this.setValue(this.el.value),this.ngDataReady&&this.ngDataReady.subscribe(()=>this.setValue(this.el.value))}setValue(g){/^[\d.]+$/.test(g)&&(g+=this.defaultUnit||"m");const T=this.formatter.toBytes(g,0),$=this.round(T);this.el.value=this.dimlessBinaryPerSecondPipe.transform($),null!==T?(this.ngModelChange.emit(this.el.value),this.control.control.setValue(this.el.value)):(this.ngModelChange.emit(null),this.control.control.setValue(null))}round(g){if(null!==g&&0!==g){if(!A().isUndefined(this.minBytes)&&g<this.minBytes)return this.minBytes;if(!A().isUndefined(this.maxBytes)&&g>this.maxBytes)return this.maxBytes;if(!A().isUndefined(this.roundPower)){const T=Math.round(Math.log(g)/Math.log(this.roundPower));return Math.pow(this.roundPower,T)}}return g}onBlur(g){this.setValue(g)}static \u0275fac=function(T){return new(T||b)(d.rXU(d.aKT),d.rXU(l.vO),d.rXU(J.w),d.rXU(Ce.k))};static \u0275dir=d.FsC({type:b,selectors:[["","cdDimlessBinaryPerSecond",""]],hostBindings:function(T,$){1&T&&d.bIt("blur",function(Y){return $.onBlur(Y.target.value)})},inputs:{ngDataReady:"ngDataReady",minBytes:"minBytes",maxBytes:"maxBytes",roundPower:"roundPower",defaultUnit:"defaultUnit"},outputs:{ngModelChange:"ngModelChange"}})}return b})(),Ge=(()=>{class b{control;formatter;ngDataReady;constructor(g,T){this.control=g,this.formatter=T}setValue(g){const T=this.formatter.toMilliseconds(g);this.control.control.setValue(`${T} ms`)}ngOnInit(){this.setValue(this.control.value),this.ngDataReady&&this.ngDataReady.subscribe(()=>this.setValue(this.control.value))}onUpdate(g){this.setValue(g)}static \u0275fac=function(T){return new(T||b)(d.rXU(l.vO),d.rXU(Ce.k))};static \u0275dir=d.FsC({type:b,selectors:[["","cdMilliseconds",""]],hostBindings:function(T,$){1&T&&d.bIt("blur",function(Y){return $.onUpdate(Y.target.value)})},inputs:{ngDataReady:"ngDataReady"}})}return b})(),Ke=(()=>{class b{formatter;ngControl;ngDataReady;constructor(g,T){this.formatter=g,this.ngControl=T}setValue(g){const T=this.formatter.toIops(g);this.ngControl.control.setValue(`${T} IOPS`)}ngOnInit(){this.setValue(this.ngControl.value),this.ngDataReady&&this.ngDataReady.subscribe(()=>this.setValue(this.ngControl.value))}onUpdate(g){this.setValue(g)}static \u0275fac=function(T){return new(T||b)(d.rXU(Ce.k),d.rXU(l.vO))};static \u0275dir=d.FsC({type:b,selectors:[["","cdIops",""]],hostBindings:function(T,$){1&T&&d.bIt("blur",function(Y){return $.onUpdate(Y.target.value)})},inputs:{ngDataReady:"ngDataReady"}})}return b})();var e=m(90476),le=m(37966),Z=m(96930),he=m(43074),oe=m(13313);function C(b,k){if(1&b&&(d.qex(0),d.nrm(1,"input",19),d.bVm()),2&b){const g=d.XpG().$implicit,T=d.XpG(2);d.R7$(),d.Y8G("id",g.name)("name",g.name)("formControlName",g.name)("ngDataReady",T.ngDataReady)("invalid",T.form.get("configuration").controls[g.name].invalid&&T.form.get("configuration").controls[g.name].dirty)}}function we(b,k){if(1&b&&(d.qex(0),d.nrm(1,"input",20),d.bVm()),2&b){const g=d.XpG().$implicit,T=d.XpG(2);d.R7$(),d.Y8G("id",g.name)("name",g.name)("formControlName",g.name)("ngDataReady",T.ngDataReady)("invalid",T.form.get("configuration").controls[g.name].invalid&&T.form.get("configuration").controls[g.name].dirty)}}function j(b,k){if(1&b&&(d.qex(0),d.nrm(1,"input",21),d.bVm()),2&b){const g=d.XpG().$implicit,T=d.XpG(2);d.R7$(),d.Y8G("id",g.name)("name",g.name)("formControlName",g.name)("ngDataReady",T.ngDataReady)("invalid",T.form.get("configuration").controls[g.name].invalid&&T.form.get("configuration").controls[g.name].dirty)}}function h(b,k){1&b&&(d.qSk(),d.nrm(0,"svg",22))}function ee(b,k){1&b&&(d.qSk(),d.nrm(0,"svg",24))}function R(b,k){if(1&b&&d.DNE(0,ee,1,0,"svg",23),2&b){const g=d.XpG().$implicit,T=d.XpG(2);d.Y8G("ngIf",T.form.get("configuration").get(g.name).disabled)}}function I(b,k){1&b&&(d.j41(0,"span",26),d.pXf(1,4),d.k0s())}function Q(b,k){if(1&b&&d.DNE(0,I,2,0,"span",25),2&b){const g=d.XpG().$implicit,T=d.XpG(2),$=d.sdS(1);d.Y8G("ngIf",T.form.showError("configuration."+g.name,$,"min"))}}function V(b,k){if(1&b){const g=d.RV6();d.j41(0,"div",12)(1,"cds-text-label",13),d.EFF(2),d.j41(3,"div",14),d.qex(4,15),d.DNE(5,C,2,5,"ng-container",16)(6,we,2,5,"ng-container",16)(7,j,2,5,"ng-container",16),d.bVm(),d.j41(8,"cds-icon-button",17),d.bIt("click",function(){const $=d.eBV(g).$implicit,v=d.XpG(2);return d.Njj(v.reset($.name))}),d.DNE(9,h,1,0,"svg",18)(10,R,1,1,"ng-template",null,1,d.C5r),d.k0s(),d.DNE(12,Q,1,1,"ng-template",null,2,d.C5r),d.k0s()()()}if(2&b){const g=k.$implicit,T=d.sdS(11),$=d.sdS(13),v=d.XpG(2);d.R7$(),d.Y8G("helperText",g.description)("invalid",v.form.get("configuration").controls[g.name].invalid&&v.form.get("configuration").controls[g.name].dirty)("invalidText",$),d.R7$(),d.SpI(" ",g.displayName," "),d.R7$(2),d.Y8G("ngSwitch",g.type),d.R7$(),d.Y8G("ngSwitchCase",v.configurationType.milliseconds),d.R7$(),d.Y8G("ngSwitchCase",v.configurationType.bps),d.R7$(),d.Y8G("ngSwitchCase",v.configurationType.iops),d.R7$(2),d.Y8G("ngIf",!v.form.get("configuration").get(g.name).disabled)("ngIfElse",T)}}function z(b,k){if(1&b){const g=d.RV6();d.j41(0,"div")(1,"h5",7)(2,"legend",8),d.bIt("click",function(){const $=d.eBV(g).$implicit,v=d.XpG();return d.Njj(v.toggleSectionVisibility($.class))}),d.EFF(3),d.nrm(4,"i",9),d.k0s()(),d.j41(5,"div",10),d.DNE(6,V,14,10,"div",11),d.k0s()()}if(2&b){const g=k.$implicit,T=d.XpG();d.R7$(3),d.SpI(" ",g.heading," "),d.R7$(),d.Y8G("ngClass",T.sectionVisibility[g.class]?T.icons.minusCircle:T.icons.addCircle),d.R7$(),d.HbH(g.class),d.Y8G("hidden",!T.sectionVisibility[g.class]),d.R7$(),d.Y8G("ngForOf",g.options)}}let pe=(()=>{class b{formatterService;rbdConfigurationService;form;initializeData=new ue.m(1);changes=new d.bkB;icons=F.F;ngDataReady=new d.bkB;initialData;configurationType=q.T;sectionVisibility={};constructor(g,T){this.formatterService=g,this.rbdConfigurationService=T}ngOnInit(){const g=this.createConfigurationFormGroup();this.form.addControl("configuration",g),g.valueChanges.subscribe(()=>{this.changes.emit(this.getDirtyValues.bind(this))}),this.initializeData&&this.initializeData.subscribe(T=>{this.initialData=T.initialData;const $=T.sourceType;this.rbdConfigurationService.getWritableOptionFields().forEach(v=>{const Y=T.initialData.filter(ze=>ze.name===v.name).pop();Y&&Y.source===$&&this.form.get(`configuration.${v.name}`).setValue(Y.value)}),this.ngDataReady.emit()}),this.rbdConfigurationService.getWritableSections().forEach(T=>this.sectionVisibility[T.class]=!0)}getDirtyValues(g=!1,T){if(g&&!T)throw new Error("ProgrammingError: If local values shall be included, a proper localFieldType argument has to be provided, too");const $={};return this.rbdConfigurationService.getWritableOptionFields().forEach(v=>{const Y=this.form.get("configuration").get(v.name);this.initialData&&this.initialData[v.name]===Y.value||(Y.dirty||g&&Y.source===T)&&($[v.name]=null===Y.value?Y.value:v.type===q.T.bps?this.formatterService.toBytes(Y.value):v.type===q.T.milliseconds?this.formatterService.toMilliseconds(Y.value):v.type===q.T.iops?this.formatterService.toIops(Y.value):Y.value)}),$}createConfigurationFormGroup(){const g=new ie.$({});return this.rbdConfigurationService.getWritableOptionFields().forEach(T=>{let $;if(T.type!==q.T.milliseconds&&T.type!==q.T.iops&&T.type!==q.T.bps)throw new Error(`Type ${T.type} is unknown, you may need to add it to RbdConfiguration class`);{let v=0;A().forEach(this.initialData,Y=>{Y.name===T.name&&(v=Y.value)}),$=new l.hs(v,l.k0.min(0))}g.addControl(T.name,$)}),g}reset(g){const T=this.form.get("configuration").get(g);T.disabled?(T.setValue(T.previousValue||0),T.enable(),T.previousValue||T.markAsPristine()):(T.previousValue=T.value,T.setValue(null),T.markAsDirty(),T.disable())}isDisabled(g){return this.form.get("configuration").get(g).disabled}toggleSectionVisibility(g){this.sectionVisibility[g]=!this.sectionVisibility[g]}static \u0275fac=function(T){return new(T||b)(d.rXU(Ce.k),d.rXU(X.Q))};static \u0275cmp=d.VBU({type:b,selectors:[["cd-rbd-configuration-form"]],inputs:{form:"form",initializeData:"initializeData"},outputs:{changes:"changes"},decls:5,vars:2,consts:()=>{let g,T;return g="RBD \u914D\u7F6E",T="The minimum value is 0.",[["cfgFormGroup",""],["resetIcon",""],["formError",""],g,T,[3,"formGroup"],[4,"ngFor","ngForOf"],[1,"cd-header"],[1,"collapsible",3,"click"],["aria-hidden","true",3,"ngClass"],[3,"hidden"],["class","form-item",4,"ngFor","ngForOf"],[1,"form-item"],[3,"helperText","invalid","invalidText"],[1,"cds-input-group"],[3,"ngSwitch"],[4,"ngSwitchCase"],["kind","ghost","size","md","data-toggle","button",3,"click"],["cdsIcon","close","size","32","class","cds--btn__icon",4,"ngIf","ngIfElse"],["type","text","cdsText","","cdMilliseconds","",3,"id","name","formControlName","ngDataReady","invalid"],["type","text","cdsText","","defaultUnit","b","cdDimlessBinaryPerSecond","",3,"id","name","formControlName","ngDataReady","invalid"],["type","text","cdsText","","cdIops","",3,"id","name","formControlName","ngDataReady","invalid"],["cdsIcon","close","size","32",1,"cds--btn__icon"],["cdsIcon","reset","size","32","class","cds--btn__icon",4,"ngIf"],["cdsIcon","reset","size","32",1,"cds--btn__icon"],["class","invalid-feedback",4,"ngIf"],[1,"invalid-feedback"]]},template:function(T,$){1&T&&(d.j41(0,"fieldset",5,0)(2,"legend"),d.pXf(3,3),d.k0s(),d.DNE(4,z,7,7,"div",6),d.k0s()),2&T&&(d.Y8G("formGroup",$.form.get("configuration")),d.R7$(4),d.Y8G("ngForOf",$.rbdConfigurationService.sections))},dependencies:[f.YU,f.Sq,f.bT,f.ux,f.e1,l.me,l.BC,l.cb,l.j4,l.JD,Oe,Ge,Ke,e.S,le.E,Z.Zt,Z.ks,he.K0,oe.LJ],styles:[".collapsible[_ngcontent-%COMP%]{cursor:pointer;user-select:none}"]})}return b})()},15224:(ut,Me,m)=>{m.d(Me,{k:()=>j});var d=m(62847),l=m(6107),p=m(23279);let A=(()=>{class h{transform(R){return{0:"global",1:"pool",2:"image"}[R]}static \u0275fac=function(I){return new(I||h)};static \u0275pipe=p.EJ8({name:"rbdConfigurationSource",type:h,pure:!0})}return h})();var ue=m(12540),F=m(77241),ie=m(56610),q=m(19116),Ce=m(7752),X=m(25081);const f=["configurationSourceTpl"],J=["configurationValueTpl"],Oe=["poolConfTable"];function Ge(h,ee){1&h&&(p.j41(0,"span"),p.pXf(1,3),p.k0s())}function Ke(h,ee){1&h&&(p.j41(0,"strong"),p.pXf(1,4),p.k0s())}function e(h,ee){1&h&&(p.j41(0,"strong"),p.pXf(1,5),p.k0s())}function le(h,ee){1&h&&(p.j41(0,"div",7),p.DNE(1,Ge,2,0,"span",8)(2,Ke,2,0,"strong",8)(3,e,2,0,"strong",8),p.k0s()),2&h&&(p.Y8G("ngSwitch",ee.data.value),p.R7$(),p.Y8G("ngSwitchCase","global"),p.R7$(),p.Y8G("ngSwitchCase","image"),p.R7$(),p.Y8G("ngSwitchCase","pool"))}function Z(h,ee){if(1&h&&(p.j41(0,"span"),p.EFF(1),p.nI1(2,"dimlessBinaryPerSecond"),p.k0s()),2&h){const R=p.XpG().data.value;p.R7$(),p.JRh(p.bMT(2,1,R))}}function he(h,ee){if(1&h&&(p.j41(0,"span"),p.EFF(1),p.nI1(2,"milliseconds"),p.k0s()),2&h){const R=p.XpG().data.value;p.R7$(),p.JRh(p.bMT(2,1,R))}}function oe(h,ee){if(1&h&&(p.j41(0,"span"),p.EFF(1),p.nI1(2,"iops"),p.k0s()),2&h){const R=p.XpG().data.value;p.R7$(),p.JRh(p.bMT(2,1,R))}}function C(h,ee){if(1&h&&(p.j41(0,"span"),p.EFF(1),p.k0s()),2&h){const R=p.XpG().data.value;p.R7$(),p.JRh(R)}}function we(h,ee){if(1&h&&(p.j41(0,"div",7),p.DNE(1,Z,3,3,"span",8)(2,he,3,3,"span",8)(3,oe,3,3,"span",8)(4,C,2,1,"span",9),p.k0s()),2&h){const R=ee.data.row,I=p.XpG();p.Y8G("ngSwitch",R.type),p.R7$(),p.Y8G("ngSwitchCase",I.typeField.bps),p.R7$(),p.Y8G("ngSwitchCase",I.typeField.milliseconds),p.R7$(),p.Y8G("ngSwitchCase",I.typeField.iops)}}let j=(()=>{class h{formatterService;rbdConfigurationService;data;poolConfigurationColumns;configurationSourceTpl;configurationValueTpl;poolConfTable;sourceField=l.M;typeField=l.T;constructor(R,I){this.formatterService=R,this.rbdConfigurationService=I}ngOnInit(){this.poolConfigurationColumns=[{prop:"displayName",name:"\u540D\u79F0"},{prop:"description",name:"\u63CF\u8FF0"},{prop:"name",name:"\u5BC6\u94A5"},{prop:"source",name:"\u6765\u6E90",cellTemplate:this.configurationSourceTpl,pipe:new A},{prop:"value",name:"\u503C",cellTemplate:this.configurationValueTpl}]}ngOnChanges(){this.data&&(this.data=this.data.filter(R=>this.rbdConfigurationService.getOptionFields().map(I=>I.name).includes(R.name)))}static \u0275fac=function(I){return new(I||h)(p.rXU(ue.k),p.rXU(F.Q))};static \u0275cmp=p.VBU({type:h,selectors:[["cd-rbd-configuration-table"]],viewQuery:function(I,Q){if(1&I&&(p.GBs(f,7),p.GBs(J,7),p.GBs(Oe,7)),2&I){let V;p.mGM(V=p.lsd())&&(Q.configurationSourceTpl=V.first),p.mGM(V=p.lsd())&&(Q.configurationValueTpl=V.first),p.mGM(V=p.lsd())&&(Q.poolConfTable=V.first)}},inputs:{data:"data"},features:[p.OA$],decls:6,vars:2,consts:()=>{let R,I,Q;return R="\u5168\u5C40",I="\u6620\u50CF",Q="\u5B58\u50A8\u6C60",[["poolConfTable",""],["configurationSourceTpl",""],["configurationValueTpl",""],R,I,Q,["identifier","name",3,"data","columns"],[3,"ngSwitch"],[4,"ngSwitchCase"],[4,"ngSwitchDefault"]]},template:function(I,Q){1&I&&(p.nrm(0,"cd-table",6,0),p.DNE(2,le,4,4,"ng-template",null,1,p.C5r)(4,we,5,4,"ng-template",null,2,p.C5r)),2&I&&p.Y8G("data",Q.data)("columns",Q.poolConfigurationColumns)},dependencies:[ie.ux,ie.e1,ie.fG,d.O,q.w,Ce.f,X.U]})}return h})()},6872:(ut,Me,m)=>{m.d(Me,{B:()=>q});var d=m(53026),l=m(26409),p=m(5793),A=m(10683),ue=m(80697),F=m(15643),ie=m(23279);let q=class mt{http;timerService;REFRESH_INTERVAL=3e4;summaryDataSource=new p.t(null);summaryData$=this.summaryDataSource.asObservable();constructor(X,f){this.http=X,this.timerService=f}startPolling(){return this.timerService.get(()=>this.retrieveSummaryObservable(),this.REFRESH_INTERVAL).subscribe(this.retrieveSummaryObserver())}refresh(){return this.retrieveSummaryObservable().subscribe(this.retrieveSummaryObserver())}retrieveSummaryObservable(){return this.http.get("api/block/mirroring/summary")}retrieveSummaryObserver(){return X=>{this.summaryDataSource.next(X)}}subscribeSummary(X,f){return this.summaryData$.pipe((0,A.p)(J=>!!J)).subscribe(X,f)}getPool(X){return this.http.get(`api/block/mirroring/pool/${X}`)}updatePool(X,f){return this.http.put(`api/block/mirroring/pool/${X}`,f,{observe:"response"})}getSiteName(){return this.http.get("api/block/mirroring/site_name")}setSiteName(X){return this.http.put("api/block/mirroring/site_name",{site_name:X},{observe:"response"})}createBootstrapToken(X){return this.http.post(`api/block/mirroring/pool/${X}/bootstrap/token`,{})}importBootstrapToken(X,f,J){return this.http.post(`api/block/mirroring/pool/${X}/bootstrap/peer`,{direction:f,token:J},{observe:"response"})}getPeer(X,f){return this.http.get(`api/block/mirroring/pool/${X}/peer/${f}`)}getPeerForPool(X){return this.http.get(`api/block/mirroring/pool/${X}/peer`)}addPeer(X,f){return this.http.post(`api/block/mirroring/pool/${X}/peer`,f,{observe:"response"})}updatePeer(X,f,J){return this.http.put(`api/block/mirroring/pool/${X}/peer/${f}`,J,{observe:"response"})}deletePeer(X,f){return this.http.delete(`api/block/mirroring/pool/${X}/peer/${f}`,{observe:"response"})}static \u0275fac=function(f){return new(f||mt)(ie.KVO(l.Qq),ie.KVO(F.H))};static \u0275prov=ie.jDH({token:mt,factory:mt.\u0275fac,providedIn:"root"})};(0,d.Cg)([(0,d.Qj)(0,ue.R),(0,d.Sn)("design:type",Function),(0,d.Sn)("design:paramtypes",[String]),(0,d.Sn)("design:returntype",void 0)],q.prototype,"setSiteName",null),(0,d.Cg)([(0,d.Qj)(1,ue.R),(0,d.Qj)(2,ue.R),(0,d.Sn)("design:type",Function),(0,d.Sn)("design:paramtypes",[String,String,String]),(0,d.Sn)("design:returntype",void 0)],q.prototype,"importBootstrapToken",null),q=(0,d.Cg)([ue.G,(0,d.Sn)("design:paramtypes",[l.Qq,F.H])],q)}}]);